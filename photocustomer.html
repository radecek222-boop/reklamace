<!-- üü© ZAƒå√ÅTEK ƒå√ÅSTI 1/3 ‚Äì HLAVIƒåKA + Z√ÅKAZN√çK (BEZ NADPISU PHOTO) -->
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Photo ‚Äì White Glove Service</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
body {
  font-family:"Inter",sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:0;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}
.wrapper {
  background:#fff;
  margin:40px 15px;
  padding:30px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  width:100%;
  max-width:750px;
}
h1 {
  text-align:center;
  font-size:2.4em;
  font-weight:900;
  color:#111;
  margin:0 0 5px;
}
h2 {
  text-align:center;
  font-size:1.1em;
  font-weight:500;
  color:#666;
  margin:0 0 25px;
}
#customerHeader {
  background:#f1f1f1;
  border:1px solid #ccc;
  border-radius:10px;
  padding:18px;
  text-align:center;
  margin-bottom:25px;
}
#customerHeader h3 {
  margin:0 0 4px;
  font-size:1.3em;
  font-weight:700;
  color:#111;
}
#customerHeader p {
  margin:3px 0;
  color:#333;
  font-size:0.95em;
}
.subtitle {
  font-size:0.8em;
  color:#666;
  display:block;
  margin-top:2px;
}
</style>
</head>

<body>
<div class="wrapper">
  <h1>WHITE GLOVE SERVICE</h1>
  <h2>Photo documentation</h2>

  <div id="customerHeader">
    <h3>Naƒç√≠t√°m √∫daje z√°kazn√≠ka...</h3>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded",()=>{
    const data=JSON.parse(localStorage.getItem("currentCustomer")||"{}");
    const h=document.getElementById("customerHeader");
    if(data.zakaznik){
      h.innerHTML=`<h3>${data.zakaznik}</h3>
      <p>${data.adresa||""}</p>
      ${data.cislo?`<p>ƒå√≠slo zak√°zky / Order number: <strong>${data.cislo}</strong></p>`:""}`;
    }else{
      h.innerHTML="<h3>Z√°kazn√≠k nebyl nalezen / Customer not found</h3>";
    }
  });
  </script>
<!-- üü© KONEC ƒå√ÅSTI 1/3 -->

<!-- üü© ZAƒå√ÅTEK ƒå√ÅSTI 2/3 ‚Äì BLOKY FOTEK + AUTO UPLOAD + 24H HL√çD√ÅN√ç -->
<style>
.photo-block{border:1px solid #ccc;border-radius:10px;padding:14px 12px 10px;margin-top:16px;background:linear-gradient(180deg,#f8f8f8 0%,#ececec 100%);transition:background .2s,transform .1s;cursor:pointer;}
.photo-block:hover{background:#f2f2f2;transform:scale(1.01);}
.photo-title{font-size:.75em;font-weight:700;color:#333;margin-bottom:8px;text-transform:uppercase;letter-spacing:.8px;}
.photo-preview{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;align-items:flex-start;}
.photo-thumb{width:90px;height:60px;border-radius:6px;object-fit:cover;border:1px solid #ccc;box-shadow:0 2px 5px rgba(0,0,0,.15);cursor:pointer;transition:transform .15s ease,box-shadow .2s ease;}
.photo-thumb:hover{transform:scale(1.05);box-shadow:0 3px 10px rgba(0,0,0,.25);}
.photo-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);justify-content:center;align-items:center;z-index:9999;overflow:hidden;}
.photo-modal.active{display:flex;}
.photo-modal-content{background:transparent;border-radius:14px;max-width:95vw;max-height:95vh;display:flex;justify-content:center;align-items:center;overflow:hidden;position:relative;}
#modalImg{width:auto;height:auto;max-width:90vw;max-height:85vh;border-radius:10px;object-fit:contain;transition:transform .2s ease;cursor:grab;touch-action:none;}
#modalImg:active{cursor:grabbing;}
.photo-modal-buttons{display:flex;gap:14px;margin-top:14px;position:absolute;bottom:20px;left:50%;transform:translateX(-50%);}
.btn-delete,.btn-close{font-weight:600;font-size:1em;border:none;border-radius:10px;padding:12px 26px;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,.25);transition:transform .15s ease,opacity .2s ease;}
.btn-delete{background:linear-gradient(135deg,#e63946,#ff6b6b);color:#fff;}
.btn-close{background:linear-gradient(135deg,#9b9b9b,#bfbfbf);color:#fff;}
.progress-bar-container{width:100%;background:#ddd;border-radius:8px;height:16px;margin-top:12px;overflow:hidden;}
.progress-bar-fill{background:linear-gradient(135deg,#00b56a,#00da80);height:100%;width:0%;transition:width .3s ease;}
</style>

<div class="photo-block" data-section="before"><div class="photo-title">BEFORE</div><div class="photo-preview" id="preview-before"></div></div>
<div class="photo-block" data-section="id"><div class="photo-title">ID</div><div class="photo-preview" id="preview-id"></div></div>
<div class="photo-block" data-section="problem"><div class="photo-title">DETAIL BUG</div><div class="photo-preview" id="preview-problem"></div></div>
<div class="photo-block" data-section="repair"><div class="photo-title">REPAIR</div><div class="photo-preview" id="preview-repair"></div></div>
<div class="photo-block" data-section="after"><div class="photo-title">AFTER</div><div class="photo-preview" id="preview-after"></div></div>

<input type="file" id="photoInput" accept="image/jpeg,image/png,image/heic" multiple hidden>
<div class="progress-bar-container"><div class="progress-bar-fill" id="progressFill"></div></div>

<div id="photoModal" class="photo-modal">
  <div class="photo-modal-content">
    <img id="modalImg" src="">
    <div class="photo-modal-buttons">
      <button id="btnDeletePhoto" class="btn-delete">Odstranit</button>
      <button id="btnClosePhoto" class="btn-close">Zav≈ô√≠t</button>
    </div>
  </div>
</div>

<script>
(function(){
  const input=document.getElementById("photoInput");
  const sections={before:[],id:[],problem:[],repair:[],after:[]};
  const fill=document.getElementById("progressFill");
  const modal=document.getElementById("photoModal");
  const modalImg=document.getElementById("modalImg");
  const btnDelete=document.getElementById("btnDeletePhoto");
  const btnClose=document.getElementById("btnClosePhoto");

  // üïê Kontrola 24 h
  document.addEventListener("DOMContentLoaded",()=>{
    const uploadedAt=Number(localStorage.getItem("photoUploadedAt")||0);
    const sent=localStorage.getItem("photoSent")==="true";
    if(uploadedAt && !sent && Date.now()-uploadedAt>24*60*60*1000){
      localStorage.removeItem("photoPdfData");
      localStorage.removeItem("photoUploadedAt");
      localStorage.removeItem("photoSent");
      ["before","id","problem","repair","after"].forEach(id=>{const el=document.getElementById("preview-"+id);if(el)el.innerHTML="";});
      fill.style.width="0%";
      alert("üìÅ Fotodokumentace byla automaticky odstranƒõna po 24 hodin√°ch");
    }
  });

  document.querySelectorAll(".photo-block").forEach(block=>{
    block.addEventListener("click",()=>{input.dataset.section=block.dataset.section;input.click();});
  });

  input.addEventListener("change",async()=>{
    const section=input.dataset.section;if(!section)return;
    const files=Array.from(input.files);
    for(const [i,f] of files.entries()){
      const blob=await compressImage(f,90);
      const url=URL.createObjectURL(blob);
      const originalURL=URL.createObjectURL(f);
      const orientation=await getOrientation(f);
      sections[section].push({blob,url,originalURL,orientation});
    }
    render(section);
    input.value="";
    await autoUpload();
  });

  async function compressImage(file,maxDim=90){
    const img=await createImageBitmap(file);
    const canvas=document.createElement("canvas");
    let w=img.width,h=img.height,ratio=w/h;
    if(w>h&&w>maxDim){h=Math.round(maxDim/ratio);w=maxDim;}
    else if(h>=w&&h>maxDim){w=Math.round(maxDim*ratio);h=maxDim;}
    canvas.width=w;canvas.height=h;const ctx=canvas.getContext("2d");
    ctx.drawImage(img,0,0,w,h);
    return new Promise(r=>canvas.toBlob(r,"image/jpeg",0.85));
  }
  async function getOrientation(file){const img=await createImageBitmap(file);return img.width>img.height?"landscape":"portrait";}
  function render(section){
    const c=document.getElementById("preview-"+section);
    c.innerHTML="";
    sections[section].forEach((p,i)=>{
      const img=document.createElement("img");
      img.src=p.url;img.className="photo-thumb "+(p.orientation==="portrait"?"portrait":"landscape");
      img.onclick=()=>openModal(section,i);
      c.append(img);
    });
  }

  // Modal zoom
  let scale=1,moveX=0,moveY=0,lastX=0,lastY=0,drag=false;
  function resetTransform(){scale=1;moveX=0;moveY=0;modalImg.style.transform="translate(0,0) scale(1)";}
  function openModal(section,i){const p=sections[section][i];modalImg.src=p.originalURL||p.url;resetTransform();modal.classList.add("active");}
  btnClose.onclick=()=>{modal.classList.remove("active");};
  modal.onclick=e=>{if(e.target===modal){modal.classList.remove("active");}};
  btnDelete.onclick=()=>{modal.classList.remove("active");};
  modalImg.onwheel=e=>{e.preventDefault();const d=e.deltaY>0?-0.1:0.1;scale=Math.min(Math.max(1,scale+d),5);modalImg.style.transform=`translate(${moveX}px,${moveY}px) scale(${scale})`;};

  async function autoUpload(){
    const all=Object.values(sections).flat();if(!all.length)return;
    let uploaded=0;
    for(const p of all){await new Promise(r=>setTimeout(r,150));uploaded++;fill.style.width=Math.round((uploaded/all.length)*100)+"%";}
    localStorage.setItem("photoUploadedAt",Date.now());localStorage.setItem("photoSent","false");
  }
})();
</script>
<!-- üü© KONEC ƒå√ÅSTI 2/3 -->

  <!-- üü© ZAƒå√ÅTEK ƒå√ÅSTI 3/3 ‚Äì SJEDNOCEN√Å TLAƒå√çTKA (AUTOMATICK√ù UPLOAD + ODESL√ÅN√ç) -->
<div class="actions dual-actions" id="uploadSection">
  <button type="button" id="btnSendToDetail" class="btn-uniform blue">
    <span>ODESLAT DO DETAILU Z√ÅKAZN√çKA</span>
  </button>
</div>

<div class="actions dual-actions" style="margin-top:10px;">
  <a href="index.html" class="btn-uniform gray"><span>ZPƒöT</span></a>
  <button type="button" id="btnExportPdf" class="btn-uniform lightblue"><span>EXPORT TO PDF</span></button>
</div>

<div class="wait-overlay" id="waitOverlay">
  <div class="hourglass"></div>
  <p>Zpracov√°v√°m fotodokumentaci...</p>
</div>

<style>
.dual-actions {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 30px;
}

.btn-uniform {
  flex: 1 1 45%;
  max-width: 320px;
  height: 56px;
  font-size: 1em;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: #000; /* üîπ ƒçern√Ω text */
  text-align: center;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  transition: transform .15s ease, opacity .2s ease;
  box-sizing: border-box;
  appearance: none;
  -webkit-appearance: none;
  line-height: 1;
  padding: 0;
  white-space: normal;
}
.btn-uniform span {
  display: block;
  padding: 0 14px;
  text-align: center;
}
.btn-uniform:hover {
  transform: scale(1.05);
  opacity: .9;
}
.btn-uniform.blue {
  background: linear-gradient(135deg, #0090d4, #33b6ff);
}
.btn-uniform.lightblue {
  background: linear-gradient(135deg, #00aaff, #66ccff);
}
.btn-uniform.gray {
  background: linear-gradient(135deg, #9b9b9b, #bfbfbf);
}
.wait-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(2px);
  justify-content: center;
  align-items: center;
  flex-direction: column;
  font-weight: 600;
  color: #333;
  z-index: 2000;
}
.wait-overlay.active {
  display: flex;
}
.hourglass {
  border: 4px solid #ccc;
  border-top: 4px solid #00b56a;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}
@keyframes spin {
  0% { transform: rotate(0) }
  100% { transform: rotate(360deg) }
}

/* üîπ Na mobilu je odes√≠lac√≠ tlaƒç√≠tko p≈ôes celou ≈°√≠≈ôku */
@media screen and (max-width: 768px) {
  #btnSendToDetail {
    flex: 1 1 100%;
    max-width: 100%;
  }
}
</style>

<!-- üü© NOTIFIKACE -->
<div id="notif" class="notif"></div>
<style>
.notif {
  position: fixed;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  min-width: 260px;
  max-width: 90%;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 0.9em;
  color: #fff;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  opacity: 0;
  pointer-events: none;
  z-index: 9999;
  transition: opacity .3s, transform .3s;
}
.notif.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.notif.success {
  background: linear-gradient(135deg,#00b56a,#00da80);
}
.notif.warning {
  background: linear-gradient(135deg,#ffb200,#ffca40);
  color: #333;
}
.notif.error {
  background: linear-gradient(135deg,#e63946,#ff6b6b);
}
</style>

<!-- üü© LOGIKA TLAƒå√çTEK + ODESL√ÅN√ç NA WORKER -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const sendBtn = document.getElementById("btnSendToDetail");
  const exportBtn = document.getElementById("btnExportPdf");
  const wait = document.getElementById("waitOverlay");

  window.showNotif = function(type="success", text="Hotovo") {
    const n = document.getElementById("notif");
    if (!n) return;
    n.className = `notif ${type}`;
    n.textContent = text;
    n.classList.add("show");
    clearTimeout(window._notifTimer);
    window._notifTimer = setTimeout(() => n.classList.remove("show"), 2500);
  };

  // üîπ Export PDF (s ulo≈æen√≠m do Worker)
  exportBtn?.addEventListener("click", async () => {
    try {
      wait?.classList.add("active");
      if (typeof window.generatePdf === "function") {
        const blob = await window.generatePdf(true);
        await savePhotoToWorker(blob);
        showNotif("success", "PDF exportov√°no a z√°lohov√°no");
      } else {
        showNotif("warning", "Export PDF nen√≠ dostupn√Ω");
      }
    } catch (e) {
      console.error(e);
      showNotif("error", "Chyba p≈ôi exportu PDF");
    } finally {
      wait?.classList.remove("active");
    }
  });

  // üîπ Odeslat do detailu z√°kazn√≠ka
  sendBtn?.addEventListener("click", async () => {
    try {
      wait?.classList.add("active");
      if (typeof window.generatePdf === "function") {
        const blob = await window.generatePdf(true);
        await savePhotoToWorker(blob);
        showNotif("success", "Odes√≠l√°m do detailu...");
        setTimeout(() => { window.location.href = "protokol.html"; }, 1200);
      } else {
        showNotif("warning", "Nelze vytvo≈ôit PDF");
      }
    } catch (e) {
      console.error(e);
      showNotif("error", "Chyba p≈ôi odes√≠l√°n√≠");
    } finally {
      wait?.classList.remove("active");
    }
  });
});
</script>

<!-- üü© DOPLNƒöK ‚Äì Ulo≈æen√≠ fotodokumentace do JSON p≈ôes Worker -->
<script>
async function savePhotoToWorker(pdfBlob) {
  try {
    const reader = new FileReader();
    reader.onloadend = async function() {
      const base64pdf = reader.result;
      const customer = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
      const payload = {
        cislo: customer.cislo || "",
        zakaznik: customer.zakaznik || "",
        datum: new Date().toISOString(),
        file: base64pdf
      };

      const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/photocustomer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        console.log("üì§ Fotodokumentace ulo≈æena do photocustomer.json");
      } else {
        console.warn("‚ö†Ô∏è Ulo≈æen√≠ na server selhalo:", res.status);
      }
    };
    reader.readAsDataURL(pdfBlob);
  } catch (err) {
    console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ fotodokumentace:", err);
  }
}
</script>

<!-- üü© KONEC ƒå√ÅSTI 3/3 -->




