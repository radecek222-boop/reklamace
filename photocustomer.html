<!-- 
====================================================================
üíé WHITE GLOVE SERVICE ‚Äì PHOTO DOCUMENTATION
====================================================================
Verze syst√©mu:       v1.1
Datum sestaven√≠:     2025-10-11
Autor:               Radek Zikmund & Hugo (GPT-5)
Soubor:              photocustomer.html
Repozit√°≈ô:           https://github.com/radecek222-boop/reklamace
Popis:
  Nahr√°v√°n√≠ a export fotodokumentace z√°kazn√≠ka
  ‚Äì p≈ôipojeno k Cloudflare Worker /photocustomer
====================================================================
-->

<!-- üü® ZAƒå√ÅTEK SEKCE A/10 ‚Äì Z√ÅKLAD A STYL -->
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Photo ‚Äì White Glove Service</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
body{
  font-family:"Inter",sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:0;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}
.wrapper{
  background:#fff;
  margin:40px 15px;
  padding:30px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  width:100%;
  max-width:750px;
}
h1{text-align:center;font-size:2.4em;font-weight:900;color:#111;margin:0 0 5px;}
h2{text-align:center;font-size:1.1em;font-weight:500;color:#666;margin:0 0 25px;}
#customerHeader{
  background:#f1f1f1;
  border:1px solid #ccc;
  border-radius:10px;
  padding:18px;
  text-align:center;
  margin-bottom:25px;
}
#customerHeader h3{margin:0 0 4px;font-size:1.3em;font-weight:700;color:#111;}
#customerHeader p{margin:3px 0;color:#333;font-size:0.95em;}
.photo-block{
  border:1px solid #ccc;
  border-radius:10px;
  padding:14px;
  margin-top:16px;
  background:linear-gradient(180deg,#f8f8f8 0%,#ececec 100%);
  cursor:pointer;
}
.photo-title{font-size:.75em;font-weight:700;color:#333;margin-bottom:8px;text-transform:uppercase;}
.photo-preview{display:flex;flex-wrap:wrap;gap:10px;}
.photo-thumb{
  width:90px;
  height:60px;
  border-radius:6px;
  object-fit:cover;
  border:1px solid #ccc;
  box-shadow:0 2px 5px rgba(0,0,0,.15);
}
.progress-bar-container{
  width:100%;
  background:#ddd;
  border-radius:8px;
  height:16px;
  margin-top:12px;
  overflow:hidden;
}
.progress-bar-fill{
  background:linear-gradient(135deg,#00b56a,#00da80);
  height:100%;
  width:0%;
  transition:width .3s;
}

/* üé® Styl tlaƒç√≠tek ‚Äì t≈ôi vedle sebe */
.btn-uniform{
  flex:1 1 30%;
  max-width:250px;
  height:56px;
  font-size:1em;
  font-weight:600;
  border:none;
  border-radius:8px;
  cursor:pointer;
  color:#000;
  text-align:center;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 3px 8px rgba(0,0,0,.15);
}

/* üü© Zelen√© ‚Äì Odeslat do protokolu */
.btn-uniform.green{
  background:linear-gradient(135deg,#00b56a,#00da80);
  color:#fff;
}

/* üü¶ Modr√© ‚Äì Exportovat do PDF */
.btn-uniform.blue{
  background:linear-gradient(135deg,#0090d4,#33b6ff);
  color:#fff;
}

/* ‚¨úÔ∏è ≈†ed√© ‚Äì Zpƒõt */
.btn-uniform.gray{
  background:linear-gradient(135deg,#9b9b9b,#bfbfbf);
  color:#000;
}

.wait-overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(2px);
  justify-content:center;
  align-items:center;
  flex-direction:column;
  font-weight:600;
  color:#333;
  z-index:2000;
}
.wait-overlay.active{display:flex;}
.notif{
  position:fixed;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  min-width:260px;
  max-width:90%;
  padding:12px 20px;
  border-radius:10px;
  font-weight:600;
  font-size:.9em;
  color:#fff;
  text-align:center;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  opacity:0;
  pointer-events:none;
  z-index:9999;
  transition:opacity .3s,transform .3s;
}
.notif.show{opacity:1;transform:translateX(-50%) translateY(0);}
.notif.success{background:linear-gradient(135deg,#00b56a,#00da80);}
.notif.warning{background:linear-gradient(135deg,#ffb200,#ffca40);color:#333;}
.notif.error{background:linear-gradient(135deg,#e63946,#ff6b6b);}
</style>
</head>
<!-- üü® KONEC SEKCE A/10 ‚Äì Z√ÅKLAD A STYL -->


<body>
<div class="wrapper">

<!-- üü® ZAƒå√ÅTEK SEKCE B/10 ‚Äì HLAVIƒåKA + Z√ÅKAZN√çK -->
<h1>WHITE GLOVE SERVICE</h1>
<h2>Photo documentation</h2>
<div id="customerHeader"><h3>Naƒç√≠t√°m √∫daje z√°kazn√≠ka...</h3></div>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const data=JSON.parse(localStorage.getItem("currentCustomer")||"{}");
  const h=document.getElementById("customerHeader");
  if(data.zakaznik){
    h.innerHTML=`<h3>${data.zakaznik}</h3><p>${data.adresa||""}</p>${data.cislo?`<p>ƒå√≠slo zak√°zky / Order number: <strong>${data.cislo}</strong></p>`:""}`;
  }else h.innerHTML="<h3>Z√°kazn√≠k nebyl nalezen / Customer not found</h3>";
});
</script>
<!-- üü® KONEC SEKCE B/10 -->

<!-- üü® ZAƒå√ÅTEK SEKCE C/10 ‚Äì FOTKY A UPLOAD -->
<div class="photo-block" data-section="before"><div class="photo-title">BEFORE</div><div class="photo-preview" id="preview-before"></div></div>
<div class="photo-block" data-section="id"><div class="photo-title">ID</div><div class="photo-preview" id="preview-id"></div></div>
<div class="photo-block" data-section="problem"><div class="photo-title">DETAIL BUG</div><div class="photo-preview" id="preview-problem"></div></div>
<div class="photo-block" data-section="repair"><div class="photo-title">REPAIR</div><div class="photo-preview" id="preview-repair"></div></div>
<div class="photo-block" data-section="after"><div class="photo-title">AFTER</div><div class="photo-preview" id="preview-after"></div></div>

<input type="file" id="photoInput" accept="image/jpeg,image/png,image/heic" multiple hidden>
<div class="progress-bar-container"><div class="progress-bar-fill" id="progressFill"></div></div>

<div class="actions dual-actions" id="uploadSection" style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:30px;">
  <button type="button" id="btnSendToDetail" class="btn-uniform blue"><span>ODESLAT DO DETAILU Z√ÅKAZN√çKA</span></button>
</div>
<div class="actions dual-actions" style="margin-top:10px;display:flex;flex-wrap:wrap;justify-content:center;gap:10px;">
  <a href="index.html" class="btn-uniform gray"><span>ZPƒöT</span></a>
  <button type="button" id="btnExportPdf" class="btn-uniform lightblue"><span>EXPORT TO PDF</span></button>
</div>
<div class="wait-overlay" id="waitOverlay"><p>Zpracov√°v√°m fotodokumentaci...</p></div>
<div id="notif" class="notif"></div>
<script>
(function(){
  const input=document.getElementById("photoInput");
  const sections={before:[],id:[],problem:[],repair:[],after:[]};
  const fill=document.getElementById("progressFill");
  document.querySelectorAll(".photo-block").forEach(b=>b.addEventListener("click",()=>{input.dataset.section=b.dataset.section;input.click();}));
  input.addEventListener("change",async()=>{
    const s=input.dataset.section;if(!s)return;
    const files=Array.from(input.files);
    for(const f of files){const blob=await compressImage(f,90);const url=URL.createObjectURL(blob);const o=await getOrientation(f);sections[s].push({blob,url,orientation:o});}
    render(s);input.value="";await autoUpload();
  });
  async function compressImage(f,m=90){const i=await createImageBitmap(f);const c=document.createElement("canvas");let w=i.width,h=i.height,r=w/h;if(w>h&&w>m){h=Math.round(m/r);w=m;}else if(h>=w&&h>m){w=Math.round(m*r);h=m;}c.width=w;c.height=h;c.getContext("2d").drawImage(i,0,0,w,h);return new Promise(r=>c.toBlob(r,"image/jpeg",0.85));}
  async function getOrientation(f){const i=await createImageBitmap(f);return i.width>i.height?"landscape":"portrait";}
  function render(s){const c=document.getElementById("preview-"+s);c.innerHTML="";sections[s].forEach(p=>{const img=document.createElement("img");img.src=p.url;img.className="photo-thumb";c.append(img);});}
  async function autoUpload(){const all=Object.values(sections).flat();if(!all.length)return;let u=0;for(const p of all){await new Promise(r=>setTimeout(r,150));u++;fill.style.width=Math.round((u/all.length)*100)+"%";}localStorage.setItem("photoUploadedAt",Date.now());}
})();
</script>
<!-- üü® KONEC SEKCE C/10 -->

<!-- üü® ZAƒå√ÅTEK SEKCE D/10 ‚Äì PDF EXPORT A ODESL√ÅN√ç -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
window.generatePdf=async function(){const{jsPDF}=window.jspdf;const pdf=new jsPDF("p","pt","a4");const el=document.querySelector(".wrapper");try{const c=await html2canvas(el,{scale:2,useCORS:true});const img=c.toDataURL("image/png");const w=pdf.internal.pageSize.getWidth();const h=(c.height*w)/c.width;pdf.addImage(img,"PNG",0,0,w,h);}catch(e){pdf.text("‚ö†Ô∏è Nelze vykreslit fotodokumentaci",20,50);}return pdf.output("blob");};
</script>
<!-- üü® KONEC SEKCE D/10 -->
<!-- üü® ZAƒå√ÅTEK SEKCE E/10 ‚Äì ULO≈ΩEN√ç NA TEMPORARYFILES -->
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const sendBtn=document.getElementById("btnSendToDetail");
  const exportBtn=document.getElementById("btnExportPdf");
  const wait=document.getElementById("waitOverlay");

  window.showNotif=function(t="success",x="Hotovo"){
    const n=document.getElementById("notif");
    n.className=`notif ${t}`;
    n.textContent=x;
    n.classList.add("show");
    clearTimeout(window._notifTimer);
    window._notifTimer=setTimeout(()=>n.classList.remove("show"),2500);
  };

  // üíæ EXPORT TO PDF ‚Äì nab√≠dka sta≈æen√≠ + ulo≈æen√≠ na TEMPORARYFILES
  exportBtn?.addEventListener("click",async()=>{
    try{
      showWait("Exportuji PDF...");
      const b=await window.generatePdf(true);

      // üü¢ Nab√≠dka ulo≈æen√≠ PDF u≈æivateli
      const url=URL.createObjectURL(b);
      const a=document.createElement("a");
      a.href=url;
      a.download="WGS_photodocumentation.pdf";
      a.click();
      URL.revokeObjectURL(url);

      // ‚òÅÔ∏è Souƒçasn√© ulo≈æen√≠ na TEMPORARYFILES
      await savePhotoToWorker(b);

      hideWait(true);
      showNotif("success","PDF ulo≈æeno");
    }catch(e){
      hideWait(false);
      showNotif("error","Chyba PDF");
    }
  });

  // üì§ Odesl√°n√≠ do detailu z√°kazn√≠ka
  sendBtn?.addEventListener("click",async()=>{
    try{
      showWait("Odes√≠l√°m fotky...");
      const b=await window.generatePdf(true);
      await savePhotoToWorker(b);
      hideWait(true);
      showNotif("success","Odesl√°no do detailu");
      setTimeout(()=>window.location.href="protokol.html",1000);
    }catch(e){
      hideWait(false);
      showNotif("error","Chyba odesl√°n√≠");
    }
  });
});

async function savePhotoToWorker(pdfBlob){
  try{
    const r=new FileReader();
    r.onloadend=async()=>{
      const base64=r.result;
      const c=JSON.parse(localStorage.getItem("currentCustomer")||"{}");
      localStorage.setItem("photoPdfData",base64);
      const rec={
        cislo:c.cislo||"",
        zakaznik:c.zakaznik||"",
        datum:new Date().toISOString(),
        file:base64
      };
      const res=await fetch("https://wgs-token.72nvwf4pb2.workers.dev/temporaryfiles",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({record:rec})
      });
      const result=await res.json().catch(()=>({ok:false}));
      if(result.ok){
        hideWait(true);
        showNotif("success","Fotky ulo≈æeny ‚úÖ");
      }else{
        hideWait(false);
        showNotif("error","Chyba p≈ôi ukl√°d√°n√≠");
      }
    };
    r.readAsDataURL(pdfBlob);
  }catch(e){
    hideWait(false);
    showNotif("error","Chyba ulo≈æen√≠");
  }
}
</script>
<!-- üü® KONEC SEKCE E/10 ‚Äì ULO≈ΩEN√ç NA TEMPORARYFILES -->


<!-- üü® ZAƒå√ÅTEK SEKCE F/10 ‚Äì DIALOG ƒåEK√ÅN√ç -->
<style>
#waitDialog{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.55);z-index:9999;flex-direction:column;color:#fff;font-size:1.1em;}
#waitDialog.active{display:flex;}
.spinner{border:4px solid #ccc;border-top:4px solid #00aaff;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;margin-bottom:14px;}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
<div id="waitDialog"><div class="spinner"></div><div id="waitMsg">ƒåekejte na odpovƒõƒè serveru...</div></div>
<script>
function showWait(t="ƒåekejte na odpovƒõƒè serveru..."){const d=document.getElementById("waitDialog");const m=document.getElementById("waitMsg");m.textContent=t;d.classList.add("active");}
function hideWait(s=true){
  const d=document.getElementById("waitDialog");
  d.innerHTML=s?"<div style='font-size:52px;color:#00da80;'>‚úÖ</div><div>Hotovo</div>":"<div style='font-size:52px;color:#ff5555;'>‚ùå</div><div>Chyba</div>";
  setTimeout(()=>{d.classList.remove("active");d.innerHTML='<div class=\"spinner\"></div><div id=\"waitMsg\">ƒåekejte na odpovƒõƒè serveru...</div>';},2200);
}
</script>
<!-- üü® KONEC SEKCE F/10 -->

</div>
</body>
</html>
