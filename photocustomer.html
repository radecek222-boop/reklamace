<!-- üü® ZAƒå√ÅTEK SEKCE 1/10 ‚Äì Z√ÅKLADN√ç STRUKTURA -->
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fotodokumentace ‚Äì White Glove Service</title>

  <!-- üìç Leaflet mapa -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- üß© Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background: #f6f7fb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .wrapper {
      background: #fff;
      padding: 30px;
      margin: 40px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 700px;
      box-sizing: border-box;
    }
    h1, h2 {
      text-align: center;
      margin: 0 0 20px;
    }
    h1 {
      font-size: 2.4em;
      font-weight: 900;
      color: #111;
    }
    h2 {
      font-size: 1.1em;
      font-weight: 500;
      color: #666;
      margin-bottom: 25px;
    }

    /* üîπ Hlaviƒçka z√°kazn√≠ka */
    #customerHeader {
      background: linear-gradient(135deg,#e7f5ee,#d3f0e2);
      border: 1px solid #b6e3cc;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    #customerHeader h3 {
      margin: 0;
      font-size: 1.3em;
      font-weight: 700;
      color: #0a5c34;
    }
    #customerHeader p {
      margin: 6px 0 0;
      color: #333;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <h1>WHITE GLOVE SERVICE</h1>
    <h2>Fotodokumentace z√°kazn√≠ka</h2>

    <!-- üßæ Automaticky naƒçten√Ω z√°kazn√≠k -->
    <div id="customerHeader">
      <h3>Naƒç√≠t√°m √∫daje z√°kazn√≠ka‚Ä¶</h3>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const data = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
        const header = document.getElementById("customerHeader");
        if (data.zakaznik) {
          header.innerHTML = `
            <h3>${data.zakaznik}</h3>
            <p>${data.adresa || ""}</p>
            ${data.cislo ? `<p style="color:#555;font-size:0.9em;">ƒå√≠slo zak√°zky: <strong>${data.cislo}</strong></p>` : ""}
          `;
          // P≈ôedvyplnƒõn√≠ formul√°≈ôe, pokud existuje
          if (document.getElementById("zakaznik")) {
            document.getElementById("zakaznik").value = data.zakaznik || "";
            document.getElementById("ulice").value = (data.adresa || "").split(",")[0] || "";
            document.getElementById("cislo").value = data.cislo || "";
          }
        } else {
          header.innerHTML = "<h3>Z√°kazn√≠k nebyl nalezen</h3><p>Str√°nka byla otev≈ôena samostatnƒõ.</p>";
        }
      });
    </script>

    <form id="photoCustomerForm" novalidate>
<!-- üü® KONEC SEKCE 1/10 -->






      <!-- üü® ZAƒå√ÅTEK SEKCE 2/10 ‚Äì Z√ÅKAZN√çK + ADRESA + MAPA -->

<label>ƒå√≠slo zak√°zky / reklamace:</label>
<input type="text" id="cislo" name="cislo" required placeholder="nap≈ô. NBU25" />

<label>Z√°kazn√≠k:</label>
<input type="text" id="zakaznik" name="zakaznik" required placeholder="nap≈ô. Ji≈ô√≠ Nov√°k" />

<label>Ulice a ƒç√≠slo popisn√©:</label>
<div class="address-wrapper">
  <input type="text" id="ulice" name="ulice" required placeholder="nap≈ô. Vinohradsk√° 120" />
  <div id="suggestions" class="suggestions"></div>
</div>
<div id="mapPreview"></div>

<label>Mƒõsto:</label>
<input type="text" id="mesto" name="mesto" required placeholder="nap≈ô. Praha" />

<label>PSƒå:</label>
<input type="text" id="psc" name="psc" required pattern="\\d{3}\\s?\\d{2}" placeholder="nap≈ô. 110 00" />

<style>
  .address-wrapper { position: relative; }
  .suggestions {
    position: absolute;
    top: 100%; left: 0; width: 100%;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    max-height: 180px;
    overflow-y: auto;
    z-index: 1000;
  }
  .suggestions div { padding: 8px; cursor: pointer; }
  .suggestions div:hover { background: #f0f0f0; }

  #mapPreview {
    width: 100%;
    height: 250px;
    margin-top: 10px;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
</style>

<script>
(function(){
  const uliceInput = document.getElementById("ulice");
  const mestoInput = document.getElementById("mesto");
  const pscInput = document.getElementById("psc");
  const suggestionContainer = document.getElementById("suggestions");
  const GEOAPIFY_KEY = "b363199bb14e47189558d03b81ca9ba1";
  let suggestTimer = null;

  uliceInput.addEventListener("input", ()=>{
    clearTimeout(suggestTimer);
    suggestTimer = setTimeout(runAutocomplete, 300);
  });

  async function runAutocomplete(){
    const query = uliceInput.value.trim();
    suggestionContainer.innerHTML = "";
    if(query.length < 3) return;

    try {
      const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&lang=cs&limit=5&filter=countrycode:cze,svk,aut&apiKey=${GEOAPIFY_KEY}`;
      const res = await fetch(url);
      const data = await res.json();
      if(!data.features || !data.features.length) return;
      renderSuggestions(data.features.map(f=>f.properties));
    } catch(e) {
      console.error("Geoapify error", e);
    }
  }

  function renderSuggestions(items){
    suggestionContainer.innerHTML = "";
    items.forEach(p=>{
      const div = document.createElement("div");
      div.textContent = p.formatted || `${p.street || ""} ${p.housenumber || ""}, ${p.city || ""}`;
      div.onclick = ()=>{
        uliceInput.value = `${p.street||""} ${p.housenumber||""}`.trim();
        mestoInput.value = p.city || "";
        pscInput.value = p.postcode || "";
        suggestionContainer.innerHTML = "";

        const mapDiv = document.getElementById("mapPreview");
        mapDiv.innerHTML = "";
        const map = L.map(mapDiv, { center:[p.lat, p.lon], zoom:16, zoomControl:false, attributionControl:false });
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
        L.marker([p.lat, p.lon]).addTo(map);
        setTimeout(()=>map.invalidateSize(),300);
      };
      suggestionContainer.appendChild(div);
    });
  }

  document.addEventListener("click", e=>{
    if(!suggestionContainer.contains(e.target) && e.target!==uliceInput)
      suggestionContainer.innerHTML = "";
  });
})();
</script>

<!-- üü® KONEC SEKCE 2/10 ‚Äì Z√ÅKAZN√çK + ADRESA + MAPA -->





      <!-- üü® ZAƒå√ÅTEK SEKCE 3/10 ‚Äì FOTODOKUMENTACE (4 BLOKY) -->

<h3 style="margin-top:30px;">Fotodokumentace</h3>
<p style="font-size:0.9em;color:#555;margin-bottom:10px;">
  Ka≈æd√Ω blok umo≈æ≈àuje nahr√°t v√≠ce fotografi√≠. Obr√°zky se automaticky zmen≈°√≠ a ulo≈æ√≠.
</p>

<!-- üü© BLOK 1 ‚Äì BEFORE REPAIR -->
<div class="photo-block">
  <div class="photo-header">
    <h4>P≈ôed opravou</h4>
    <button type="button" class="btn-photo" data-section="before">P≈ôidat fotografie</button>
  </div>
  <div class="photo-preview" id="preview-before"></div>
</div>

<!-- üü© BLOK 2 ‚Äì ID ≈†T√çTEK -->
<div class="photo-block">
  <div class="photo-header">
    <h4>ID ≈°t√≠tek</h4>
    <button type="button" class="btn-photo" data-section="id">P≈ôidat fotografie</button>
  </div>
  <div class="photo-preview" id="preview-id"></div>
</div>

<!-- üü© BLOK 3 ‚Äì REPAIR -->
<div class="photo-block">
  <div class="photo-header">
    <h4>Bƒõhem opravy</h4>
    <button type="button" class="btn-photo" data-section="repair">P≈ôidat fotografie</button>
  </div>
  <div class="photo-preview" id="preview-repair"></div>
</div>

<!-- üü© BLOK 4 ‚Äì AFTER REPAIR -->
<div class="photo-block">
  <div class="photo-header">
    <h4>Po opravƒõ</h4>
    <button type="button" class="btn-photo" data-section="after">P≈ôidat fotografie</button>
  </div>
  <div class="photo-preview" id="preview-after"></div>
</div>

<input type="file" id="photoInput" accept="image/jpeg,image/png,image/heic" multiple hidden>

<style>
  .photo-block {
    border:1px solid #ccc;
    border-radius:10px;
    padding:14px;
    margin-top:18px;
    background:linear-gradient(180deg,#f8f8f8 0%,#ececec 100%);
  }
  .photo-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
  }
  .photo-header h4 {
    margin:0;
    font-size:1.05em;
    font-weight:700;
    color:#111;
  }
  .btn-photo {
    padding:8px 14px;
    border-radius:8px;
    border:1px solid #aaa;
    background:linear-gradient(180deg,#fff 0%,#f2f2f2 100%);
    font-weight:600;
    cursor:pointer;
    transition:all .2s ease;
  }
  .photo-preview {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .photo-thumb {
    width:90px;
    height:90px;
    border-radius:8px;
    object-fit:cover;
    box-shadow:0 2px 5px rgba(0,0,0,0.15);
    position:relative;
  }
  .photo-remove {
    position:absolute;
    top:2px;
    right:2px;
    width:22px;
    height:22px;
    border:none;
    border-radius:50%;
    background:rgba(255,255,255,0.95);
    color:#d40000;
    font-weight:bold;
    cursor:pointer;
    line-height:18px;
    font-size:16px;
    box-shadow:0 1px 3px rgba(0,0,0,0.25);
    transition:transform .15s ease;
  }
  .photo-remove:hover { transform:scale(1.15); }
</style>

<script>
(function(){
  const input = document.getElementById("photoInput");
  const photoSections = { before: [], id: [], repair: [], after: [] };

  // otev≈ôen√≠ v√Ωbƒõru soubor≈Ø podle sekce
  document.querySelectorAll(".btn-photo").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      input.dataset.section = btn.dataset.section;
      input.click();
    });
  });

  // v√Ωbƒõr a komprese
  input.addEventListener("change", async ()=>{
    const section = input.dataset.section;
    if(!section) return;
    const files = Array.from(input.files).slice(0,10);

    for(const file of files){
      const blob = await compressImage(file);
      const url = URL.createObjectURL(blob);
      photoSections[section].push({ file, blob, url });
    }

    renderPreviews(section);
    input.value = "";
  });

  // zmen≈°en√≠ obr√°zku
  async function compressImage(file, maxDim=900){
    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    let [w,h] = [img.width,img.height];
    if(w>h && w>maxDim){ h=Math.round(h*(maxDim/w)); w=maxDim; }
    else if(h>w && h>maxDim){ w=Math.round(w*(maxDim/h)); h=maxDim; }
    canvas.width=w; canvas.height=h;
    const ctx=canvas.getContext("2d");
    ctx.drawImage(img,0,0,w,h);
    return await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.85));
  }

  // zobrazen√≠ preview
  function renderPreviews(section){
    const container=document.getElementById("preview-"+section);
    container.innerHTML="";
    photoSections[section].forEach((p,i)=>{
      const wrap=document.createElement("div");
      wrap.style.position="relative";
      const img=document.createElement("img");
      img.src=p.url;
      img.className="photo-thumb";
      const btn=document.createElement("button");
      btn.className="photo-remove";
      btn.textContent="√ó";
      btn.onclick=()=>{
        photoSections[section].splice(i,1);
        renderPreviews(section);
      };
      wrap.append(img,btn);
      container.append(wrap);
    });
  }

  window.getPhotoSections = ()=>photoSections;
})();
</script>

<!-- üü® KONEC SEKCE 3/10 ‚Äì FOTODOKUMENTACE (4 BLOKY) -->





      <!-- üü® ZAƒå√ÅTEK SEKCE 4/10 ‚Äì ODESL√ÅN√ç FOTODOKUMENTACE NA WORKER -->

<div class="actions">
  <button type="button" id="btnUploadAll" class="btn-send">Nahr√°t v≈°echny fotografie</button>
</div>

<!-- üíæ Overlay naƒç√≠t√°n√≠ -->
<div class="wait-overlay" id="waitOverlay">
  <div class="hourglass"></div>
  <p>Prob√≠h√° nahr√°v√°n√≠ fotografi√≠‚Ä¶</p>
</div>

<!-- ‚úÖ Hotovo animace -->
<div class="success-check" id="successCheck">
  <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
    <defs>
      <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#00d084;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#00a86b;stop-opacity:1" />
      </linearGradient>
    </defs>
    <circle cx="26" cy="26" r="25" fill="none"/>
    <path fill="none" d="M14 27l7 7 16-16" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>

<style>
  .actions {
    text-align:center;
    margin:30px 0 10px;
  }
  .btn-send {
    background:linear-gradient(135deg,#00b56a,#00da80);
    color:#fff;
    font-weight:600;
    border:none;
    border-radius:8px;
    padding:12px 28px;
    cursor:pointer;
    font-size:1em;
    box-shadow:0 3px 8px rgba(0,0,0,0.15);
    transition:transform 0.15s ease-in-out,opacity 0.2s;
  }
  .btn-send:hover { transform:scale(1.05); opacity:0.9; }

  .wait-overlay {
    display:none; position:fixed; inset:0;
    background:rgba(255,255,255,0.85);
    backdrop-filter:blur(2px);
    justify-content:center; align-items:center;
    flex-direction:column;
    font-weight:600; color:#333;
    z-index:2000;
  }
  .wait-overlay.active { display:flex; }
  .hourglass {
    border:4px solid #ccc;
    border-top:4px solid #00b56a;
    border-radius:50%;
    width:40px; height:40px;
    animation:spin 1s linear infinite;
    margin-bottom:10px;
  }
  @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

  .success-check {
    display:none;
    position:fixed;
    inset:0;
    justify-content:center;
    align-items:center;
    background:rgba(255,255,255,0.9);
    z-index:2100;
  }
  .success-check.active { display:flex; }
  .checkmark {
    width:80px;
    height:80px;
    stroke-width:3;
    stroke:url(#grad1);
    fill:none;
    stroke-dasharray:48;
    stroke-dashoffset:48;
    animation:draw 1s ease forwards;
  }
  @keyframes draw { to { stroke-dashoffset:0; } }
</style>

<script>
(function(){
  const uploadBtn = document.getElementById("btnUploadAll");
  const wait = document.getElementById("waitOverlay");
  const success = document.getElementById("successCheck");

  uploadBtn.addEventListener("click", async ()=>{
    const sections = window.getPhotoSections();
    const cislo = document.getElementById("cislo").value.trim().toUpperCase();
    const zakaznik = document.getElementById("zakaznik").value.trim();
    const adresa = `${document.getElementById("ulice").value}, ${document.getElementById("mesto").value}, ${document.getElementById("psc").value}`;

    if(!cislo || !zakaznik) {
      alert("Vypl≈à ƒç√≠slo zak√°zky a jm√©no z√°kazn√≠ka.");
      return;
    }

    // pokud nejsou fotky
    const allPhotos = Object.values(sections).flat();
    if(!allPhotos.length) {
      alert("Nen√≠ vybr√°na ≈æ√°dn√° fotografie.");
      return;
    }

    wait.classList.add("active");

    const uploaded = { before: [], id: [], repair: [], after: [] };

    try {
      for(const [section, files] of Object.entries(sections)){
        for(const item of files){
          const formData = new FormData();
          formData.append("file", item.blob, `${cislo}_${section}_${Date.now()}.jpg`);
          const r = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/upload", {
            method:"POST",
            body:formData
          });
          const js = await r.json();
          if(js.filename) uploaded[section].push(js.filename);
        }
      }

      // z√°pis do JSON
      const record = {
        typ: "fotodokumentace",
        id: cislo,
        zakaznik,
        adresa,
        sekce: uploaded,
        fotky: Object.values(uploaded).flat(),
        timestamp: new Date().toISOString()
      };

      const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/photocustomer", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(record)
      });

      const json = await res.json();
      console.log("üì§ Odpovƒõƒè Workeru:", json);

      wait.classList.remove("active");
      success.classList.add("active");
      setTimeout(()=>success.classList.remove("active"), 2500);

    } catch(err){
      wait.classList.remove("active");
      alert("Chyba p≈ôi nahr√°v√°n√≠: "+err.message);
      console.error(err);
    }
  });
})();
</script>

<!-- üü® KONEC SEKCE 4/10 ‚Äì ODESL√ÅN√ç FOTODOKUMENTACE NA WORKER -->





<!-- üü® ZAƒå√ÅTEK SEKCE 5/10 ‚Äì P≈òEHLED NAHRAN√ùCH FOTEK PO ULO≈ΩEN√ç -->

<h3 style="margin-top:40px;">Ulo≈æen√© fotografie</h3>
<p style="font-size:0.85em;color:#555;">N√≠≈æe se zobraz√≠ p≈ôehled v≈°ech ulo≈æen√Ωch fotek k vybran√©mu z√°kazn√≠kovi.</p>

<div id="savedPhotos" class="saved-photos">
  <div class="placeholder">üì∑ Zat√≠m nebyly naƒçteny ≈æ√°dn√© fotografie.</div>
</div>

<style>
  .saved-photos {
    border:1px solid #ddd;
    border-radius:10px;
    background:#fafafa;
    margin-top:12px;
    padding:15px;
  }
  .saved-section {
    margin-bottom:18px;
  }
  .saved-section h4 {
    font-size:1em;
    font-weight:700;
    margin-bottom:8px;
    color:#222;
  }
  .saved-grid {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .saved-thumb {
    width:90px;
    height:90px;
    border-radius:8px;
    object-fit:cover;
    box-shadow:0 2px 5px rgba(0,0,0,0.15);
    cursor:pointer;
  }
  .placeholder {
    text-align:center;
    color:#777;
    font-size:0.9em;
    padding:20px 0;
  }
</style>

<script>
async function loadSavedPhotos() {
  const cislo = document.getElementById("cislo").value.trim().toUpperCase();
  const output = document.getElementById("savedPhotos");
  if(!cislo) {
    output.innerHTML = "<div class='placeholder'>Zadejte ƒç√≠slo zak√°zky pro naƒçten√≠ fotek.</div>";
    return;
  }

  try {
    const res = await fetch(`https://wgs-token.72nvwf4pb2.workers.dev/photocustomer?t=${Date.now()}`, { cache: "no-store" });
    const all = await res.json();
    const rec = all.find(r => r.id === cislo);
    if(!rec) {
      output.innerHTML = "<div class='placeholder'>Pro tuto zak√°zku nejsou ulo≈æen√© ≈æ√°dn√© fotografie.</div>";
      return;
    }

    output.innerHTML = "";
    for(const [sekce, list] of Object.entries(rec.sekce || {})){
      const block = document.createElement("div");
      block.className = "saved-section";
      const title = document.createElement("h4");
      title.textContent =
        sekce === "before" ? "P≈ôed opravou" :
        sekce === "id" ? "ID ≈°t√≠tek" :
        sekce === "repair" ? "Bƒõhem opravy" :
        sekce === "after" ? "Po opravƒõ" : sekce;

      const grid = document.createElement("div");
      grid.className = "saved-grid";

      list.forEach(name=>{
        const img = document.createElement("img");
        img.className = "saved-thumb";
        img.src = "https://raw.githubusercontent.com/radecek222-boop/reklamace/main/foto/" + name;
        img.title = name;
        grid.appendChild(img);
      });

      block.append(title, grid);
      output.append(block);
    }

  } catch(err){
    console.error(err);
    output.innerHTML = "<div class='placeholder' style='color:red;'>Chyba p≈ôi naƒç√≠t√°n√≠ fotek.</div>";
  }
}

// naƒçti fotky automaticky p≈ôi zmƒõnƒõ ƒç√≠sla zak√°zky
document.getElementById("cislo").addEventListener("change", loadSavedPhotos);
</script>

<!-- üü® KONEC SEKCE 5/10 ‚Äì P≈òEHLED NAHRAN√ùCH FOTEK PO ULO≈ΩEN√ç -->




<!-- üü® ZAƒå√ÅTEK SEKCE 6/10 ‚Äì EXPORT FOTODOKUMENTACE DO PDF -->

<div class="actions">
  <button type="button" id="btnExportPDF" class="btn-pdf">üìÑ Exportovat do PDF</button>
</div>

<!-- üì¶ jsPDF a html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  .btn-pdf {
    background: linear-gradient(135deg, #0046ff, #357aff);
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    padding: 12px 28px;
    cursor: pointer;
    font-size: 1em;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.15s ease-in-out, opacity 0.2s;
  }
  .btn-pdf:hover { transform: scale(1.05); opacity: 0.9; }
</style>

<script>
(async function(){
  const { jsPDF } = window.jspdf;

  document.getElementById("btnExportPDF").addEventListener("click", async ()=>{
    const cislo = document.getElementById("cislo").value.trim().toUpperCase();
    if(!cislo) return alert("Zadejte ƒç√≠slo zak√°zky pro export PDF.");

    const pdf = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 10;
    let y = 20;

    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(18);
    pdf.text("WHITE GLOVE SERVICE", pageWidth/2, y, { align:"center" });
    y += 8;
    pdf.setFontSize(13);
    pdf.text("Fotodokumentace ‚Äì " + cislo, pageWidth/2, y, { align:"center" });
    y += 10;

    // Naƒçteme z√°znam z JSON (‚ö°Ô∏è proti cache)
    const res = await fetch(`https://wgs-token.72nvwf4pb2.workers.dev/photocustomer?t=${Date.now()}`, { cache: "no-store" });
    const all = await res.json();
    const rec = all.find(r => r.id === cislo);
    if(!rec) return alert("Pro tuto zak√°zku nebyly nalezeny ≈æ√°dn√© fotografie.");

    const sekceNadpis = {
      before: "P≈ôed opravou",
      id: "ID ≈°t√≠tek",
      repair: "Bƒõhem opravy",
      after: "Po opravƒõ"
    };

    for(const [sekce, list] of Object.entries(rec.sekce || {})){
      if(!list.length) continue;

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      pdf.text(sekceNadpis[sekce] || sekce, margin, y);
      y += 6;

      for(const [i, name] of list.entries()){
        const imgUrl = "https://raw.githubusercontent.com/radecek222-boop/reklamace/main/foto/" + name;
        const img = await loadImage(imgUrl);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const scale = 0.4;
        const w = img.width * scale;
        const h = img.height * scale;
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(img,0,0,w,h);
        const dataUrl = canvas.toDataURL("image/jpeg",0.7);

        if(y + 60 > 280){
          pdf.addPage();
          y = 20;
        }

        pdf.addImage(dataUrl,"JPEG",margin,y,80,60);
        if((i+1)%2===0){
          y += 65;
        } else {
          pdf.addImage(dataUrl,"JPEG",margin + 100,y,80,60);
        }
      }

      y += 15;
    }

    pdf.save(`Fotodokumentace_${cislo}.pdf`);
  });

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = ()=>resolve(img);
      img.onerror = reject;
      img.src = url;
    });
  }
})();
</script>

<!-- üü® KONEC SEKCE 6/10 ‚Äì EXPORT FOTODOKUMENTACE DO PDF -->







      <!-- üü® ZAƒå√ÅTEK SEKCE 7/10 ‚Äì LOK√ÅLN√ç ULO≈ΩEN√ç + VALIDACE -->

<script>
(function(){
  const formFields = ["cislo","zakaznik","ulice","mesto","psc"];
  const storageKey = "wgs_photocustomer_data_v1";

  // üîπ Obnova p≈ôi otev≈ôen√≠
  window.addEventListener("DOMContentLoaded", ()=>{
    const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");
    for(const f of formFields){
      if(saved[f]) document.getElementById(f).value = saved[f];
    }
    if(saved.sections){
      const photoSections = window.getPhotoSections();
      Object.entries(saved.sections).forEach(([section,files])=>{
        photoSections[section] = files.map(f=>({
          file:null, blob:null, url:f.url, local:true
        }));
      });
      Object.keys(photoSections).forEach(s=>renderSectionPreviews(photoSections,s));
    }
  });

  // üîπ Automatick√© ukl√°d√°n√≠ p≈ôi zmƒõnƒõ
  formFields.forEach(id=>{
    document.getElementById(id).addEventListener("input", saveLocal);
  });

  function saveLocal(){
    const obj = {};
    for(const f of formFields){
      obj[f] = document.getElementById(f).value.trim();
    }
    obj.sections = serializePhotos();
    localStorage.setItem(storageKey, JSON.stringify(obj));
  }

  // üîπ P≈ôevod fotek na serializovatelnou strukturu
  function serializePhotos(){
    const sections = window.getPhotoSections();
    const out = {};
    for(const [key,list] of Object.entries(sections)){
      out[key] = list.map(p=>({ url: p.url }));
    }
    return out;
  }

  // üîπ Obnova sekc√≠ (po reloadu)
  function renderSectionPreviews(photoSections, section){
    const container = document.getElementById("preview-"+section);
    container.innerHTML="";
    photoSections[section].forEach((p,i)=>{
      const wrap=document.createElement("div");
      wrap.style.position="relative";
      const img=document.createElement("img");
      img.src=p.url;
      img.className="photo-thumb";
      const btn=document.createElement("button");
      btn.className="photo-remove";
      btn.textContent="√ó";
      btn.onclick=()=>{
        photoSections[section].splice(i,1);
        renderSectionPreviews(photoSections,section);
        saveLocal();
      };
      wrap.append(img,btn);
      container.append(wrap);
    });
  }

  // üîπ P≈ôi ka≈æd√©m nahr√°n√≠ nebo odstranƒõn√≠ ulo≈æit znovu
  const originalGet = window.getPhotoSections;
  window.getPhotoSections = function(){
    const result = originalGet();
    saveLocal();
    return result;
  };

  // üîπ Vymaz√°n√≠ lok√°ln√≠ch dat po √∫spƒõ≈°n√©m uploadu
  window.addEventListener("photoUploadSuccess", ()=>{
    localStorage.removeItem(storageKey);
  });
})();
</script>

<!-- üü® KONEC SEKCE 7/10 ‚Äì LOK√ÅLN√ç ULO≈ΩEN√ç + VALIDACE -->






      <!-- üü® ZAƒå√ÅTEK SEKCE 8/10 ‚Äì NOTIFIKACE A VIZU√ÅLN√ç HL√Å≈†KY -->

<div id="notif" class="notif"></div>

<style>
  .notif {
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    min-width: 280px;
    max-width: 90%;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.95em;
    color: #fff;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    opacity: 0;
    pointer-events: none;
    z-index: 9999;
    transition: opacity .3s ease, transform .3s ease;
  }
  .notif.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }
  .notif.success {
    background: linear-gradient(135deg,#00b56a,#00da80);
  }
  .notif.warning {
    background: linear-gradient(135deg,#ffb200,#ffca40);
    color: #333;
  }
  .notif.error {
    background: linear-gradient(135deg,#e63946,#ff6b6b);
  }
</style>

<script>
(function(){
  const notif = document.getElementById("notif");
  let notifTimer = null;

  window.showNotif = function(type="success", text="Ulo≈æeno."){
    notif.className = `notif ${type}`;
    notif.textContent = text;
    notif.classList.add("show");

    clearTimeout(notifTimer);
    notifTimer = setTimeout(()=>{
      notif.classList.remove("show");
    }, 3000);
  };

  // üîπ propojen√≠ s ud√°lostmi ze zbytku syst√©mu
  document.addEventListener("DOMContentLoaded", ()=>{
    const uploadBtn = document.getElementById("btnUploadAll");
    if(uploadBtn){
      uploadBtn.addEventListener("click", ()=>showNotif("warning","Nahr√°v√°n√≠ zah√°jeno..."));
    }

    window.addEventListener("photoUploadSuccess", ()=>showNotif("success","Fotodokumentace √∫spƒõ≈°nƒõ ulo≈æena"));
    window.addEventListener("photoUploadError", ()=>showNotif("error","Chyba p≈ôi nahr√°v√°n√≠"));
  });
})();
</script>

<!-- üü® KONEC SEKCE 8/10 ‚Äì NOTIFIKACE A VIZU√ÅLN√ç HL√Å≈†KY -->






<!-- üü® ZAƒå√ÅTEK SEKCE 9/10 ‚Äì MAPA S FOTODOKUMENTAC√ç Z√ÅKAZN√çK≈Æ -->

<h3 style="margin-top:40px;">Mapa z√°kazn√≠k≈Ø s fotodokumentac√≠</h3>
<div id="mapCustomers"></div>

<style>
  #mapCustomers {
    width: 100%;
    height: 400px;
    border-radius: 14px;
    margin-top: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  }
  .leaflet-popup-content {
    font-family: "Inter", system-ui, sans-serif;
    font-size: 0.9em;
  }
  .popup-photo {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.25);
    margin-top: 5px;
  }
</style>

<script>
(async function(){
  const mapDiv = document.getElementById("mapCustomers");
  if(!mapDiv) return;
  const map = L.map(mapDiv, { center:[49.8, 15.4], zoom:7, attributionControl:false });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ maxZoom:19 }).addTo(map);

  try {
    const res = await fetch(`https://wgs-token.72nvwf4pb2.workers.dev/photocustomer?t=${Date.now()}`, { cache: "no-store" });
    const all = await res.json();

    if(!all.length){
      L.popup().setLatLng(map.getCenter())
        .setContent("<b>≈Ω√°dn√© fotodokumentace zat√≠m nejsou ulo≈æeny.</b>")
        .openOn(map);
      return;
    }

    for(const rec of all){
      if(!rec.adresa || !rec.fotky?.length) continue;

      const coords = await geocodeAddress(rec.adresa);
      if(!coords) continue;

      const imgUrl = "https://raw.githubusercontent.com/radecek222-boop/reklamace/main/foto/" + rec.fotky[0];
      const popupHTML = `
        <div style="min-width:160px">
          <b>${rec.zakaznik || "Z√°kazn√≠k"}</b><br>
          <small>${rec.adresa}</small><br>
          <span style="color:#555;">${rec.fotky.length} fotek</span><br>
          <img src="${imgUrl}" class="popup-photo" alt="foto">
        </div>
      `;
      const marker = L.marker([coords.lat, coords.lon]).addTo(map);
      marker.bindPopup(popupHTML);
    }

  } catch(err){
    console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ mapy:", err);
  }

  async function geocodeAddress(address){
    try {
      const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(address)}&lang=cs&apiKey=b363199bb14e47189558d03b81ca9ba1`;
      const res = await fetch(url);
      const data = await res.json();
      if(data.features && data.features.length){
        return {
          lat: data.features[0].properties.lat,
          lon: data.features[0].properties.lon
        };
      }
    } catch(e){ console.warn("Geocode selhal:", address); }
    return null;
  }
})();
</script>

<!-- üü® KONEC SEKCE 9/10 ‚Äì MAPA S FOTODOKUMENTAC√ç Z√ÅKAZN√çK≈Æ -->





      <!-- üü® ZAƒå√ÅTEK SEKCE 10/10 ‚Äì Z√ÅVƒöR FORMUL√Å≈òE + KONEC HTML -->

<div class="actions" style="margin-top:40px;">
  <a href="index.html" class="btn-back">‚¨ÖÔ∏è Zpƒõt na hlavn√≠ menu</a>
  <button type="button" id="btnReloadData" class="btn-gray">üîÑ Naƒç√≠st ulo≈æen√©</button>
</div>

<style>
  .btn-back {
    background: linear-gradient(135deg, #9b9b9b, #bfbfbf);
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    padding: 12px 28px;
    cursor: pointer;
    font-size: 1em;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.15s ease, opacity 0.2s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .btn-gray {
    background: linear-gradient(135deg, #6c757d, #a0a4a7);
    color: #fff;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    padding: 12px 28px;
    cursor: pointer;
    font-size: 1em;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    transition: transform 0.15s ease, opacity 0.2s ease;
  }
  .btn-back:hover, .btn-gray:hover {
    transform: scale(1.05);
    opacity: 0.9;
  }
</style>

<script>
document.getElementById("btnReloadData").addEventListener("click", ()=>{
  showNotif("warning","Obnovuji ulo≈æen√° data...");
  setTimeout(()=>location.reload(), 800);
});
</script>

</form>
</div> <!-- konec wrapperu -->

<footer style="text-align:center;margin:30px 0 20px;font-size:0.8em;color:#888;">
  White Glove Service s.r.o. &nbsp;‚Ä¢&nbsp; ¬© 2025
</footer>

</body>
</html>

<!-- üü® KONEC SEKCE 10/10 ‚Äì Z√ÅVƒöR FORMUL√Å≈òE + KONEC HTML -->


