<!-- 
====================================================================
üíé WHITE GLOVE SERVICE ‚Äì PHOTO DOCUMENTATION
====================================================================
Verze syst√©mu:       v1.1
Datum sestaven√≠:     2025-10-11
Autor:               Radek Zikmund & Hugo (GPT-5)
Soubor:              photocustomer.html
Repozit√°≈ô:           https://github.com/radecek222-boop/reklamace
Popis:
  Nahr√°v√°n√≠ a export fotodokumentace z√°kazn√≠ka
  ‚Äì p≈ôipojeno k Cloudflare Worker /photocustomer
====================================================================
-->

<!-- üü® ZAƒå√ÅTEK SEKCE A/10 ‚Äì Z√ÅKLAD A STYL -->
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Photo ‚Äì White Glove Service</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
body{
  font-family:"Inter",sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:0;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}
.wrapper{
  background:#fff;
  margin:40px 15px;
  padding:30px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  width:100%;
  max-width:750px;
}
h1{text-align:center;font-size:2.4em;font-weight:900;color:#111;margin:0 0 5px;}
h2{text-align:center;font-size:1.1em;font-weight:500;color:#666;margin:0 0 25px;}
#customerHeader{
  background:#f1f1f1;
  border:1px solid #ccc;
  border-radius:10px;
  padding:18px;
  text-align:center;
  margin-bottom:25px;
}
#customerHeader h3{margin:0 0 4px;font-size:1.3em;font-weight:700;color:#111;}
#customerHeader p{margin:3px 0;color:#333;font-size:0.95em;}
.photo-block{
  border:1px solid #ccc;
  border-radius:10px;
  padding:14px;
  margin-top:16px;
  background:linear-gradient(180deg,#f8f8f8 0%,#ececec 100%);
  cursor:pointer;
}
.photo-title{font-size:.75em;font-weight:700;color:#333;margin-bottom:8px;text-transform:uppercase;}
.photo-preview{display:flex;flex-wrap:wrap;gap:10px;}
.photo-thumb{
  width:90px;
  height:60px;
  border-radius:6px;
  object-fit:cover;
  border:1px solid #ccc;
  box-shadow:0 2px 5px rgba(0,0,0,.15);
}
.progress-bar-container{
  width:100%;
  background:#ddd;
  border-radius:8px;
  height:16px;
  margin-top:12px;
  overflow:hidden;
}
.progress-bar-fill{
  background:linear-gradient(135deg,#00b56a,#00da80);
  height:100%;
  width:0%;
  transition:width .3s;
}

/* üé® Styl tlaƒç√≠tek ‚Äì t≈ôi vedle sebe */
.btn-uniform{
  flex:1 1 30%;
  max-width:250px;
  height:56px;
  font-size:1em;
  font-weight:600;
  border:none;
  border-radius:8px;
  cursor:pointer;
  color:#000;
  text-align:center;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 3px 8px rgba(0,0,0,.15);
}

/* üü© Zelen√© ‚Äì Odeslat do protokolu */
.btn-uniform.green{
  background:linear-gradient(135deg,#00b56a,#00da80);
  color:#fff;
}

/* üü¶ Modr√© ‚Äì Exportovat do PDF */
.btn-uniform.blue{
  background:linear-gradient(135deg,#0090d4,#33b6ff);
  color:#fff;
}

/* ‚¨úÔ∏è ≈†ed√© ‚Äì Zpƒõt */
.btn-uniform.gray{
  background:linear-gradient(135deg,#9b9b9b,#bfbfbf);
  color:#000;
}

.wait-overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(2px);
  justify-content:center;
  align-items:center;
  flex-direction:column;
  font-weight:600;
  color:#333;
  z-index:2000;
}
.wait-overlay.active{display:flex;}
.notif{
  position:fixed;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  min-width:260px;
  max-width:90%;
  padding:12px 20px;
  border-radius:10px;
  font-weight:600;
  font-size:.9em;
  color:#fff;
  text-align:center;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  opacity:0;
  pointer-events:none;
  z-index:9999;
  transition:opacity .3s,transform .3s;
}
.notif.show{opacity:1;transform:translateX(-50%) translateY(0);}
.notif.success{background:linear-gradient(135deg,#00b56a,#00da80);}
.notif.warning{background:linear-gradient(135deg,#ffb200,#ffca40);color:#333;}
.notif.error{background:linear-gradient(135deg,#e63946,#ff6b6b);}
</style>
</head>
<!-- üü® KONEC SEKCE A/10 ‚Äì Z√ÅKLAD A STYL -->


<body>
<div class="wrapper">

<!-- üü® ZAƒå√ÅTEK SEKCE B/10 ‚Äì HLAVIƒåKA + Z√ÅKAZN√çK -->
<h1>WHITE GLOVE SERVICE</h1>
<h2>Photo documentation</h2>
<div id="customerHeader"><h3>Naƒç√≠t√°m √∫daje z√°kazn√≠ka...</h3></div>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const data=JSON.parse(localStorage.getItem("currentCustomer")||"{}");
  const h=document.getElementById("customerHeader");
  if(data.zakaznik){
    h.innerHTML=`<h3>${data.zakaznik}</h3><p>${data.adresa||""}</p>${data.cislo?`<p>ƒå√≠slo zak√°zky / Order number: <strong>${data.cislo}</strong></p>`:""}`;
  }else h.innerHTML="<h3>Z√°kazn√≠k nebyl nalezen / Customer not found</h3>";
});
</script>
<!-- üü® KONEC SEKCE B/10 -->
<!-- üü® ZAƒå√ÅTEK SEKCE C/10 ‚Äì FOTKY A UPLOAD (v2.0 ‚Äì p≈ôesn√° komprese max 0.5 MB) -->
<div class="photo-block" data-section="before"><div class="photo-title">BEFORE</div><div class="photo-preview" id="preview-before"></div></div>
<div class="photo-block" data-section="id"><div class="photo-title">ID</div><div class="photo-preview" id="preview-id"></div></div>
<div class="photo-block" data-section="problem"><div class="photo-title">DETAIL BUG</div><div class="photo-preview" id="preview-problem"></div></div>
<div class="photo-block" data-section="repair"><div class="photo-title">REPAIR</div><div class="photo-preview" id="preview-repair"></div></div>
<div class="photo-block" data-section="after"><div class="photo-title">AFTER</div><div class="photo-preview" id="preview-after"></div></div>

<input type="file" id="photoInput" accept="image/jpeg,image/png,image/heic" multiple hidden>
<div class="progress-bar-container"><div class="progress-bar-fill" id="progressFill"></div></div>

<!-- üîπ Informaƒçn√≠ box o kompresi -->
<div id="compressionInfo" style="margin-top:15px;text-align:center;color:#555;font-size:0.9em;">
  üì∑ Zat√≠m ≈æ√°dn√© fotky nenahr√°ny.
</div>

<div class="actions dual-actions" id="uploadSection" style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:30px;">
  <button type="button" id="btnSendToDetail" class="btn-uniform blue"><span>ODESLAT DO DETAILU Z√ÅKAZN√çKA</span></button>
</div>
<div class="actions dual-actions" style="margin-top:10px;display:flex;flex-wrap:wrap;justify-content:center;gap:10px;">
  <a href="index.html" class="btn-uniform gray"><span>ZPƒöT</span></a>
  <button type="button" id="btnExportPdf" class="btn-uniform lightblue"><span>EXPORT TO PDF</span></button>
</div>
<div class="wait-overlay" id="waitOverlay"><p>Zpracov√°v√°m fotodokumentaci...</p></div>
<div id="notif" class="notif"></div>

<script>
(function(){
  const input = document.getElementById("photoInput");
  const sections = { before:[], id:[], problem:[], repair:[], after:[] };
  const fill = document.getElementById("progressFill");
  const info = document.getElementById("compressionInfo");

  // üì∏ Kliknut√≠ na blok ‚Äì vyvol√° v√Ωbƒõr soubor≈Ø
  document.querySelectorAll(".photo-block").forEach(b=>{
    b.addEventListener("click",()=>{
      input.dataset.section = b.dataset.section;
      input.click();
    });
  });

  // üîß Po v√Ωbƒõru fotek
  input.addEventListener("change", async ()=>{
    const section = input.dataset.section;
    if(!section) return;

    const files = Array.from(input.files);
    let originalSize = 0, compressedSize = 0;

    for (const file of files) {
      originalSize += file.size;
      const blob = await compressImageToMax(file, 500); // max 500 KB
      compressedSize += blob.size;
      const url = URL.createObjectURL(blob);
      const orientation = await getOrientation(file);
      sections[section].push({ blob, url, orientation });
    }

    render(section);
    input.value = "";
    await autoUpload();

    // ‚úÖ Skuteƒçn√© √∫daje po kompresi
    const ratio = ((compressedSize / originalSize) * 100).toFixed(1);
    const totalMB = (compressedSize / 1024 / 1024).toFixed(2);
    const avgMB = ((compressedSize / files.length) / 1024 / 1024).toFixed(2);
    info.innerHTML = `
      üì¶ Komprese dokonƒçena ‚Äì max 0.5 MB na fotku<br>
      Celkem: <strong>${totalMB} MB</strong> | Pr≈Ømƒõr: ${avgMB} MB / foto (${ratio}% p≈Øvodn√≠ velikosti)
    `;
  });

  // üß© Komprese fotky s limitem 0.5 MB
  async function compressImageToMax(file, maxKB = 500) {
    const img = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    let w = img.width, h = img.height;
    const maxDim = 1600;

    if (w > h && w > maxDim) { h = Math.round(h * (maxDim / w)); w = maxDim; }
    else if (h >= w && h > maxDim) { w = Math.round(w * (maxDim / h)); h = maxDim; }

    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    let q = 0.9;
    let blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", q));
    while (blob.size / 1024 > maxKB && q > 0.4) {
      q -= 0.05;
      blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", q));
    }
    return blob;
  }

  async function getOrientation(file){
    const img = await createImageBitmap(file);
    return img.width > img.height ? "landscape" : "portrait";
  }

  // üñºÔ∏è Vykreslen√≠ n√°hled≈Ø
  function render(section){
    const container = document.getElementById("preview-"+section);
    container.innerHTML = "";
    sections[section].forEach(p=>{
      const img = document.createElement("img");
      img.src = p.url;
      img.className = "photo-thumb";
      container.append(img);
    });
  }

  // üîÑ Simulace pr≈Øbƒõhu nahr√°v√°n√≠
  async function autoUpload(){
    const all = Object.values(sections).flat();
    if(!all.length) return;
    for (let i=0; i<all.length; i++){
      await new Promise(r=>setTimeout(r,150));
      fill.style.width = Math.round(((i+1)/all.length)*100) + "%";
    }
    localStorage.setItem("photoUploadedAt", Date.now());
  }
})();
</script>
<!-- üü® KONEC SEKCE C/10 ‚Äì FOTKY A UPLOAD (v2.0) -->



<!-- üü® ZAƒå√ÅTEK SEKCE D/10 ‚Äì PDF EXPORT A ODESL√ÅN√ç (v2.0 ‚Äì p≈ô√≠m√Ω n√°hled PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
window.generatePdf = async function () {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "pt", "a4");
  const el = document.querySelector(".wrapper");

  try {
    const canvas = await html2canvas(el, { scale: 2, useCORS: true });
    const img = canvas.toDataURL("image/png");
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(img, "PNG", 0, 0, w, h);
  } catch (e) {
    pdf.text("‚ö†Ô∏è Nelze vykreslit fotodokumentaci", 20, 50);
    console.error("Chyba p≈ôi generov√°n√≠ PDF:", e);
  }

  return pdf;
};

// üîµ Kliknut√≠ na tlaƒç√≠tko EXPORT TO PDF ‚Üí vytvo≈ô√≠ PDF a hned ho otev≈ôe
document.getElementById("btnExportPdf")?.addEventListener("click", async () => {
  try {
    const pdf = await window.generatePdf();
    const blob = pdf.output("blob");
    const blobUrl = URL.createObjectURL(blob);
    window.open(blobUrl, "_blank"); // üü¢ Otev≈ôe rovnou n√°hled PDF
    console.log("‚úÖ PDF exportov√°no a zobrazeno v nov√©m oknƒõ.");
  } catch (e) {
    console.error("‚ùå Chyba p≈ôi vytv√°≈ôen√≠ PDF:", e);
  }
});
</script>
<!-- üü® KONEC SEKCE D/10 ‚Äì PDF EXPORT A ODESL√ÅN√ç (v2.0) -->


<!-- üü® ZAƒå√ÅTEK SEKCE E/10 ‚Äì SKUTEƒåN√â PDF Z FOTEK (v3 ‚Äì pln√° A4 + vƒõt≈°√≠ n√°hled) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const sendBtn = document.getElementById("btnSendToDetail");

  sendBtn?.addEventListener("click", async () => {
    try {
      showWait("Vytv√°≈ô√≠m PDF z fotek...");
      const pdfBlob = await generatePhotoPdf();

      // üîπ ulo≈æit do localStorage pro protokol
      const reader = new FileReader();
      reader.onloadend = () => {
        localStorage.setItem("photoPdfData", reader.result);
        hideWait(true);
        showNotif("success", "Odesl√°no do detailu");
        setTimeout(() => (window.location.href = "protokol.html"), 1200);
      };
      reader.readAsDataURL(pdfBlob);

      // üîπ volitelnƒõ ulo≈æit i do Workeru (z√°loha)
      await savePhotoToWorker(pdfBlob);
    } catch (e) {
      hideWait(false);
      console.error("‚ùå Chyba p≈ôi vytv√°≈ôen√≠ PDF:", e);
      showNotif("error", "Chyba p≈ôi vytv√°≈ôen√≠ PDF");
    }
  });

  async function generatePhotoPdf() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const data = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
    const sections = {
      before: "BEFORE",
      id: "ID",
      problem: "DETAIL BUG",
      repair: "REPAIR",
      after: "AFTER"
    };

    // üü© Hlaviƒçka
    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(20);
    pdf.text("WHITE GLOVE SERVICE", pageW / 2, 20, { align: "center" });
    pdf.setFontSize(12);
    pdf.text("Photo documentation", pageW / 2, 28, { align: "center" });
    pdf.setLineWidth(0.3);
    pdf.line(20, 32, pageW - 20, 32);

    // üü¶ Box s √∫daji z√°kazn√≠ka
    pdf.setFontSize(10);
    pdf.setFont("helvetica", "normal");
    pdf.text(`Customer: ${data.zakaznik || "-"}`, 20, 40);
    pdf.text(`Address: ${data.adresa || "-"}`, 20, 46);
    pdf.text(`Order number: ${data.cislo || "-"}`, 20, 52);
    pdf.line(20, 56, pageW - 20, 56);

    let y = 65;

    for (const [key, title] of Object.entries(sections)) {
      const block = document.getElementById("preview-" + key);
      if (!block || !block.children.length) continue;

      if (y > pageH - 40) {
        pdf.addPage();
        y = 25;
      }

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(12);
      pdf.text(title, 20, y);
      y += 6;

      const photos = Array.from(block.children).map(img => img.src);
      let col = 0;
      for (let i = 0; i < photos.length; i++) {
        if (y > pageH - 60) {
          pdf.addPage();
          y = 25;
        }
        const imgW = (pageW - 60) / 2;
        const imgH = imgW * 0.75;
        const x = 20 + (col % 2) * (imgW + 20);

        const img = await loadImage(photos[i]);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const scale = Math.min(imgW * 3, img.width);
        canvas.width = scale;
        canvas.height = scale * (img.height / img.width);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
        pdf.addImage(dataUrl, "JPEG", x, y, imgW, imgH);

        col++;
        if (col % 2 === 0) y += imgH + 10;
      }

      y += 15;
    }

    // üü® Komprese PDF pod 2 MB
    let blob = pdf.output("blob");
    if (blob.size > 2_000_000) {
      const reduceQ = Math.max(0.5, 2_000_000 / blob.size);
      const pdf2 = new jsPDF("p", "mm", "a4");
      const arr = await pdf.output("arraybuffer");
      const url = URL.createObjectURL(new Blob([arr]));
      const img = await loadImage(url);
      const w = pdf2.internal.pageSize.getWidth();
      const h = (img.height * w) / img.width;
      pdf2.addImage(img, "JPEG", 0, 0, w, h, "", "FAST");
      blob = pdf2.output("blob");
    }

    console.log(`‚úÖ PDF vytvo≈ôeno (${(blob.size / 1024 / 1024).toFixed(2)} MB)`);
    return blob;
  }

  function loadImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }

  async function savePhotoToWorker(pdfBlob) {
    try {
      const customer = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
      await fetch("https://wgs-token.72nvwf4pb2.workers.dev/photocustomer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "save",
          cislo: customer.cislo || "UNKNOWN",
          file: await blobToBase64(pdfBlob)
        })
      });
      console.log("üì§ Fotodokumentace z√°lohov√°na na Worker");
    } catch (e) {
      console.warn("‚ö†Ô∏è Nelze ulo≈æit PDF na Worker:", e);
    }
  }

  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }
});
</script>

<style>
/* üü© PDF n√°hled v protokolu ‚Äì skuteƒçn√° A4 velikost */
#photoPreviewContainer {
  margin-top: 25px;
  width: 100%;
}
#photoPreviewFrame {
  width: 100%;
  aspect-ratio: 210 / 297; /* pomƒõr stran A4 */
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
</style>
<!-- üü® KONEC SEKCE E/10 ‚Äì SKUTEƒåN√â PDF Z FOTEK (v3) -->






<!-- üü® ZAƒå√ÅTEK SEKCE F/10 ‚Äì DIALOG ƒåEK√ÅN√ç -->
<style>
#waitDialog{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.55);z-index:9999;flex-direction:column;color:#fff;font-size:1.1em;}
#waitDialog.active{display:flex;}
.spinner{border:4px solid #ccc;border-top:4px solid #00aaff;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;margin-bottom:14px;}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
<div id="waitDialog"><div class="spinner"></div><div id="waitMsg">ƒåekejte na odpovƒõƒè serveru...</div></div>
<script>
function showWait(t="ƒåekejte na odpovƒõƒè serveru..."){const d=document.getElementById("waitDialog");const m=document.getElementById("waitMsg");m.textContent=t;d.classList.add("active");}
function hideWait(s=true){
  const d=document.getElementById("waitDialog");
  d.innerHTML=s?"<div style='font-size:52px;color:#00da80;'>‚úÖ</div><div>Hotovo</div>":"<div style='font-size:52px;color:#ff5555;'>‚ùå</div><div>Chyba</div>";
  setTimeout(()=>{d.classList.remove("active");d.innerHTML='<div class=\"spinner\"></div><div id=\"waitMsg\">ƒåekejte na odpovƒõƒè serveru...</div>';},2200);
}
</script>
<!-- üü® KONEC SEKCE F/10 -->

</div>

<!-- üü© Univerz√°ln√≠ notifikace -->
<div id="notif" class="notif"></div>
<style>
.notif {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #00b56a, #00da80);
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9em;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  opacity: 0;
  transition: opacity .3s, transform .3s;
  z-index: 3000;
}
.notif.show { opacity: 1; transform: translate(-50%, 10px); }
.notif.error { background: linear-gradient(135deg,#e63946,#ff6b6b); }
.notif.warning { background: linear-gradient(135deg,#ffb200,#ffca40); color:#222; }
</style>

<script>
function showNotif(type = "success", text = "Hotovo") {
  const n = document.getElementById("notif");
  if (!n) return;
  n.className = `notif ${type}`;
  n.textContent = text;
  n.classList.add("show");
  clearTimeout(window._notifTimer);
  window._notifTimer = setTimeout(() => n.classList.remove("show"), 2500);
}
</script>

  
</body>
</html>
