<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poz√°ruƒçn√≠ servis ‚Äì White Glove Service</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background: #f6f7fb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .wrapper {
      background: #fff;
      padding: 30px;
      margin: 40px 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 700px;
    }

    h1, h2 { text-align: center; margin: 0; }
    h1 { font-size: 1.8em; font-weight: 900; }
    h2 { font-size: 1.2em; color: #666; margin-top: 8px; margin-bottom: 25px; }

    label { display: block; font-weight: 600; margin-top: 15px; margin-bottom: 5px; }

    input, textarea, select {
      width: 100%; padding: 10px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
    }

    input[readonly] { background: #eee; color: #555; font-weight: 600; }
    textarea { height: 100px; resize: vertical; }
    input[type="file"] { margin-top: 5px; }

    .phone-row { display: flex; align-items: center; gap: 8px; }
    .phone-row select { flex: 0 0 90px; }
    .phone-icon { font-size: 1.3em; margin-right: 5px; }

    .btn {
      display: inline-block; text-decoration: none; padding: 12px 28px;
      border-radius: 8px; font-weight: 600; font-size: 1em;
      border: none; cursor: pointer; transition: 0.15s;
      margin: 10px 5px 0 0; color: #fff; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .btn:hover { transform: scale(1.03); opacity: 0.9; }
    .btn-back { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
    .btn-submit { background: linear-gradient(135deg, #0046ff, #357aff); }
    .actions { text-align: center; margin-top: 25px; }

    #suggestions {
      list-style: none; margin: 0; padding: 0; position: absolute;
      background: white; border: 1px solid #ccc; border-radius: 6px;
      width: 100%; max-height: 180px; overflow-y: auto; z-index: 1000; display: none;
    }
    #suggestions li { padding: 8px 10px; cursor: pointer; }
    #suggestions li:hover { background: #f1f3f5; }

    #map { width: 100%; height: 250px; border-radius: 8px; margin-top: 10px; }

    .preview-container {
      display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;
    }
    .preview-container img {
      width: 100px; height: 100px; object-fit: cover;
      border-radius: 6px; border: 1px solid #ddd;
    }

    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); display: none;
      justify-content: center; align-items: center; flex-direction: column;
      z-index: 2000; font-size: 1.2em; color: #333;
    }
    #overlay span { margin-top: 15px; font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>WHITE GLOVE SERVICE</h1>
    <h2>Poz√°ruƒçn√≠ servis</h2>

    <form id="servisForm">
      <label>ƒå√≠slo objedn√°vky:</label>
      <input type="text" name="cislo" value="Poz√°ruƒçn√≠ servis" readonly>

      <label>Jm√©no zadavatele:</label>
      <input type="text" name="zadavatel" required>

      <label>E-mail zadavatele:</label>
      <input type="email" name="email" required>

      <label>Telefon zadavatele:</label>
      <div class="phone-row">
        <span class="phone-icon">üìû</span>
        <select id="prefix" required>
          <option value="+420">üá®üáø +420</option>
          <option value="+421">üá∏üá∞ +421</option>
          <option value="+48">üáµüá± +48</option>
          <option value="+49">üá©üá™ +49</option>
        </select>
        <input type="tel" id="telefon" name="telefon" placeholder="Zadejte ƒç√≠slo" required pattern="[0-9]{9,12}">
      </div>

      <label>Adresa servisu:</label>
      <div style="position: relative;">
        <input type="text" name="adresa" id="adresa" placeholder="Zadejte ulici..." autocomplete="off" required>
        <ul id="suggestions"></ul>
      </div>

      <div id="map"></div>

      <label>Model / N√°zev produktu:</label>
      <input type="text" name="produkt">

      <label>Popis po≈æadavku:</label>
      <textarea name="popis" placeholder="Popi≈°te po≈æadavek na opravu..."></textarea>

      <label>P≈ôilo≈æit fotografie (max. 5, automaticky zmen≈°eno):</label>
      <input type="file" id="fotky" accept="image/*" multiple>
      <div class="preview-container" id="preview"></div>

      <div class="actions">
        <a href="index.html" class="btn btn-back">Zpƒõt</a>
        <button type="submit" class="btn btn-submit">Odeslat</button>
      </div>
    </form>
  </div>

  <div id="overlay">
    <div>‚è≥ Odes√≠l√°m...</div>
    <span>Pros√≠m ƒçekejte na potvrzen√≠</span>
  </div>

  <script>
    // üó∫Ô∏è Mapa (Leaflet)
    let map = L.map('map').setView([49.8, 15.5], 7);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap p≈ôispƒõvatel√©'
    }).addTo(map);
    let marker = null;

    // ‚ö° Rychl√Ω na≈°ept√°vaƒç (Nominatim)
    const adresaInput = document.getElementById("adresa");
    const suggestions = document.getElementById("suggestions");
    let timer = null;

    adresaInput.addEventListener("input", () => {
      adresaInput.dataset.selected = "false";
      clearTimeout(timer);
      const query = adresaInput.value.trim();
      if (query.length < 3) { suggestions.style.display = "none"; return; }
      timer = setTimeout(() => searchAddress(query), 200);
    });

    async function searchAddress(query) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=cz&q=${encodeURIComponent(query)}`);
      const data = await res.json();
      showSuggestions(data);
    }

    function showSuggestions(results) {
      suggestions.innerHTML = "";
      if (!results.length) { suggestions.style.display = "none"; return; }
      results.slice(0, 8).forEach(r => {
        const li = document.createElement("li");
        li.textContent = r.display_name;
        li.onclick = () => selectAddress(r);
        suggestions.appendChild(li);
      });
      suggestions.style.display = "block";
    }

    function selectAddress(r) {
      adresaInput.value = r.display_name;
      adresaInput.dataset.selected = "true";
      suggestions.style.display = "none";
      map.setView([r.lat, r.lon], 15);
      if (marker) marker.remove();
      marker = L.marker([r.lat, r.lon]).addTo(map);
    }

    // üñºÔ∏è N√°hledy fotek + zmen≈°en√≠
    const fileInput = document.getElementById("fotky");
    const preview = document.getElementById("preview");
    fileInput.addEventListener("change", () => {
      preview.innerHTML = "";
      const files = Array.from(fileInput.files).slice(0, 5);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement("img");
          img.src = e.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    async function resizeImage(file, maxWidth = 1280, maxHeight = 1280) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let [w, h] = [img.width, img.height];
            if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } }
            else { if (h > maxHeight) { w *= maxHeight / h; h = maxHeight; } }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.8);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // üîä Zvuky
    const soundSend = new Audio("https://cdn.jsdelivr.net/gh/filipelins/alert-sounds/send.mp3");
    const soundDone = new Audio("https://cdn.jsdelivr.net/gh/filipelins/alert-sounds/done.mp3");
    const soundError = new Audio("https://cdn.jsdelivr.net/gh/filipelins/alert-sounds/error.mp3");

    // üì® Odesl√°n√≠
    document.getElementById("servisForm").addEventListener("submit", async e => {
      e.preventDefault();
      const overlay = document.getElementById("overlay");
      overlay.style.display = "flex";
      soundSend.play();

      const f = e.target;
      const prefix = document.getElementById("prefix").value;
      const telefon = document.getElementById("telefon").value.trim();
      const fullPhone = `${prefix}${telefon}`;

      if (!adresaInput.dataset.selected || adresaInput.dataset.selected !== "true") {
        overlay.style.display = "none"; soundError.play();
        alert("‚ùó Vyberte adresu z nab√≠dky."); return;
      }
      if (telefon.length < 9) {
        overlay.style.display = "none"; soundError.play();
        alert("‚ùó Zadejte platn√© telefonn√≠ ƒç√≠slo."); return;
      }

      const files = Array.from(document.getElementById("fotky").files).slice(0, 5);
      const resizedFiles = [];
      for (const file of files) {
        const resized = await resizeImage(file);
        resizedFiles.push({ name: file.name, blob: resized });
      }

      const formData = {
        typ: "Poz√°ruƒçn√≠ servis",
        cislo: f.cislo.value,
        zakaznik: f.zadavatel.value,
        adresa: f.adresa.value,
        telefon: fullPhone,
        email: f.email.value,
        produkt: f.produkt.value,
        popis: f.popis.value,
        fotky: resizedFiles.map(f => f.name),
        datum: new Date().toISOString().split("T")[0]
      };

      try {
        const repo = "radecek222-boop";
        const path = "orders.json";
        const token = "ghp_TV≈ÆJ_TOKEN_SEM";
        const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`;

        const getRes = await fetch(apiUrl, { headers: { Authorization: `token ${token}` }});
        const getData = await getRes.json();
        const sha = getData.sha;
        let content = [];
        if (getData.content) {
          const existing = JSON.parse(atob(getData.content));
          content = Array.isArray(existing) ? existing : [];
        }

        content.push(formData);

        const updateRes = await fetch(apiUrl, {
          method: "PUT",
          headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            message: `Nov√Ω poz√°ruƒçn√≠ servis: ${formData.zakaznik}`,
            content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
            sha
          })
        });

        if (!updateRes.ok) throw new Error("Nepoda≈ôilo se ulo≈æit JSON.");

        for (const fz of resizedFiles) {
          const fotoUrl = `https://api.github.com/repos/${repo}/contents/foto/${encodeURIComponent(fz.name)}`;
          const arrayBuffer = await fz.blob.arrayBuffer();
          const base64String = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
          await fetch(fotoUrl, {
            method: "PUT",
            headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
            body: JSON.stringify({
              message: `Foto ‚Äì poz√°ruƒçn√≠ servis: ${formData.zakaznik}`,
              content: base64String
            })
          });
        }

        overlay.innerHTML = "<div>‚úÖ √öspƒõ≈°nƒõ odesl√°no</div><span>Dƒõkujeme za zad√°n√≠ poz√°ruƒçn√≠ho servisu</span>";
        soundDone.play();
        setTimeout(() => window.location.href = "index.html", 2500);

      } catch (err) {
        console.error(err);
        soundError.play();
        overlay.innerHTML = "<div>‚ùå Chyba p≈ôi odes√≠l√°n√≠</div><span>Zkuste to pros√≠m znovu</span>";
        setTimeout(() => {
          overlay.style.display = "none";
          overlay.innerHTML = "<div>‚è≥ Odes√≠l√°m...</div><span>Pros√≠m ƒçekejte na potvrzen√≠</span>";
        }, 2500);
      }
    });
  </script>
</body>
</html>
