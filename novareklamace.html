<!-- üü® ZAƒå√ÅTEK ƒå√ÅSTI 1/5 ‚Äì Z√ÅKLADN√ç STRUKTURA + STYL NEON TYRKYS -->
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Nov√° reklamace ‚Äì White Glove Service</title>

<!-- Leaflet pro mapu -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
  margin:0;
  font-family:"Inter",system-ui,sans-serif;
  background:#0f1816;
  color:#eafffa;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}
body::before{
  content:"";
  position:fixed;inset:0;
  background:
    radial-gradient(circle at 25% 25%,#00c89a33,#0f1816 70%),
    radial-gradient(circle at 80% 80%,#00ffcc22,#0f1816 60%);
  filter:blur(70px);
  z-index:-1;
}
.wrapper{
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:16px;
  backdrop-filter:blur(15px);
  padding:40px 28px;
  margin:40px 15px 100px;
  max-width:760px;width:100%;
  box-shadow:0 0 35px rgba(0,255,200,0.25);
}
h1{
  text-align:center;
  font-size:2.4em;
  font-weight:900;
  margin:0 0 6px;
  background:linear-gradient(90deg,#00ffc8,#00a87d);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
h2{
  text-align:center;
  font-size:1.1em;
  font-weight:500;
  color:#aefcd8;
  margin-bottom:25px;
}
label{display:block;font-weight:600;margin-top:14px;margin-bottom:5px;color:#d9fff0;}
input,textarea,select{
  width:100%;
  padding:12px;
  font-size:1em;
  border:none;
  border-radius:10px;
  background:#fff;
  color:#111;
  box-sizing:border-box;
}
input:focus,textarea:focus,select:focus{
  outline:2px solid #00c89a;
}
textarea{height:100px;resize:vertical;}
.btn{
  display:inline-block;
  padding:12px 26px;
  border:none;
  border-radius:10px;
  font-weight:600;
  color:#fff;
  cursor:pointer;
  box-shadow:0 0 12px rgba(0,255,200,0.3);
  transition:transform .15s ease,opacity .25s;
}
.btn:hover{transform:scale(1.05);opacity:.9;}
.btn-send{background:linear-gradient(135deg,#00b56a,#00ffb0);}
.btn-back{background:linear-gradient(135deg,#666,#999);}
.actions{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin-top:25px;}
@media(max-width:600px){.wrapper{padding:25px 18px;}}
</style>
</head>
<body>
<div class="wrapper">
<h1>WHITE GLOVE SERVICE</h1>
<h2>Nov√° reklamace</h2>
<form id="reklamaceForm" novalidate>
<!-- üü® KONEC ƒå√ÅSTI 1/5 -->
<!-- üü® ZAƒå√ÅTEK ƒå√ÅSTI 2/5 ‚Äì FORMUL√Å≈ò Z√ÅKAZN√çKA + LOGIKA -->
<label>ƒå√≠slo reklamace / objedn√°vky:</label>
<input type="text" id="cislo" name="cislo" required>

<label>Z√°kazn√≠k:</label>
<input type="text" id="zakaznik" name="zakaznik" required placeholder="nap≈ô. Ji≈ô√≠ Nov√°k">

<label>Ulice a ƒç√≠slo popisn√©:</label>
<div class="address-wrapper">
  <input type="text" id="ulice" name="ulice" required placeholder="nap≈ô. Vinohradsk√° 120">
  <div id="suggestions" class="suggestions"></div>
</div>
<div id="mapPreview" style="margin-top:10px;height:250px;border-radius:14px;overflow:hidden;"></div>

<label>Mƒõsto:</label>
<input type="text" id="mesto" name="mesto" required placeholder="nap≈ô. Praha">

<label>PSƒå:</label>
<input type="text" id="psc" name="psc" required pattern="\\d{3}\\s?\\d{2}" placeholder="nap≈ô. 110 00">

<label>Telefon:</label>
<div style="display:flex;gap:8px;">
  <select id="predvolba" style="max-width:130px;">
    <option value="+420">üá®üáø +420</option>
    <option value="+421">üá∏üá∞ +421</option>
    <option value="+43">üá¶üáπ +43</option>
  </select>
  <input type="tel" id="telefon" name="telefon" required placeholder="nap≈ô. 777123456">
</div>

<label>E-mail:</label>
<input type="email" id="email" name="email" required placeholder="nap≈ô. info@firma.cz">

<label>Model / N√°zev produktu:</label>
<input type="text" id="produkt" name="produkt" required placeholder="nap≈ô. C142">

<div id="dealerFields">
  <label>Objedn√°vku zpracoval:</label>
  <select id="zpracoval" name="zpracoval">
    <option value="">Vyber...</option>
    <option>Natuzzi Editions ‚Äì Strejcek</option>
    <option>Natuzzi Editions ‚Äì Vimrova</option>
    <option>Natuzzi Italia ‚Äì Jama</option>
    <option>Natuzzi Italia ‚Äì River</option>
    <option>Phase ‚Äì Klucarova</option>
    <option>Phase ‚Äì Jancova</option>
    <option>Softaly ‚Äì Soho</option>
    <option value="Jin√°">Jin√°</option>
  </select>

  <div id="jinaSekce" style="display:none;margin-top:10px;">
    <label>Zadej jin√©ho zadavatele:</label>
    <input type="text" id="jinaJmeno" placeholder="Jm√©no firmy">
    <label>Email:</label>
    <input type="email" id="jinaEmail" placeholder="nap≈ô. info@firma.cz">
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const isDealer=localStorage.getItem("isDealer")==="true";
  const poleCislo=document.getElementById("cislo");
  const dealerBox=document.getElementById("dealerFields");
  if(!isDealer){
    poleCislo.value="Poz√°ruƒçn√≠ servis";
    poleCislo.readOnly=true;
    dealerBox.style.display="none";
  }
  const select=document.getElementById("zpracoval");
  select.addEventListener("change",()=>{
    document.getElementById("jinaSekce").style.display=
      select.value==="Jin√°"?"block":"none";
  });
});
</script>
<!-- üü® KONEC ƒå√ÅSTI 2/5 -->
<!-- üü® ZAƒå√ÅTEK ƒå√ÅSTI 3/5 ‚Äì KALEND√Å≈òE -->
<label>Datum prodeje:</label>
<input type="date" id="datum_prodeje" name="datum_prodeje">

<label>Datum reklamace:</label>
<input type="date" id="datum_reklamace" name="datum_reklamace" required>
<!-- üü® KONEC ƒå√ÅSTI 3/5 -->
<!-- üü© ZAƒå√ÅTEK ƒå√ÅSTI 4/5 ‚Äì FOTKY + VALIDACE + LOCALSTORAGE + LIGHTBOX -->
<label>Popis z√°vady:</label>
<textarea id="popis" name="popis" required placeholder="Popi≈°te z√°vadu nebo probl√©m..."></textarea>

<div class="photo-frame">
  <div class="photo-frame__header">
    <div class="photo-frame__title">Fotodokumentace</div>
    <button type="button" id="addPhotoBtn" class="btn-photo">üì∑ P≈ôidat fotografie</button>
  </div>
  <div class="photo-frame__info">Max. 10 fotografi√≠ (JPG/PNG/HEIC, ‚â§ 0,5 MB ka≈æd√°)</div>
  <div id="photoPreviewMain" class="photo-preview-main"></div>
</div>

<input type="file" id="photoInput" accept="image/jpeg,image/png,image/heic" multiple hidden>

<!-- üîç Lightbox -->
<div id="lightbox" class="lightbox">
  <img id="lightboxImg" src="">
</div>

<style>
.photo-frame {
  border:1px solid #00bfa5; border-radius:10px; padding:14px; margin-top:18px;
  background:linear-gradient(180deg,#f8fdfd 0%,#eefafa 100%);
}
.photo-frame__header{display:flex;justify-content:space-between;align-items:center;}
.photo-frame__title{font-weight:700;color:#007f73;font-size:1.05em;}
.btn-photo{
  padding:8px 16px;border-radius:8px;
  border:1px solid #00bfa5;background:linear-gradient(135deg,#00d0b3,#00a891);
  color:#fff;font-weight:600;cursor:pointer;transition:all .2s ease;
}
.btn-photo:hover{transform:scale(1.04);opacity:.9;}
.photo-frame__info{font-size:.8em;color:#444;margin-top:3px;}
.photo-preview-main{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.photo-item{position:relative;width:90px;height:90px;border-radius:8px;overflow:hidden;
  box-shadow:0 2px 6px rgba(0,0,0,.2);cursor:pointer;}
.photo-item img{width:100%;height:100%;object-fit:contain;background:#fff;}
.photo-remove{position:absolute;top:3px;right:3px;width:20px;height:20px;
  border:none;border-radius:50%;background:rgba(255,255,255,.85);color:#d40000;
  font-weight:bold;font-size:14px;cursor:pointer;}
.photo-remove:hover{background:#fff;transform:scale(1.15);}
.lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
  justify-content:center;align-items:center;z-index:9999;}
.lightbox.active{display:flex;}
.lightbox img{max-width:95vw;max-height:90vh;border-radius:12px;box-shadow:0 0 20px #000;}
</style>

<script>
const photoInput=document.getElementById("photoInput");
const photoPreviewMain=document.getElementById("photoPreviewMain");
const addPhotoBtn=document.getElementById("addPhotoBtn");
const lightbox=document.getElementById("lightbox");
const lightboxImg=document.getElementById("lightboxImg");

let photos=[];

// üì∏ P≈ôid√°n√≠ fotek
addPhotoBtn.onclick=()=>photoInput.click();

photoInput.onchange=async()=>{
  const files=Array.from(photoInput.files);
  for(const f of files.slice(0,10-photos.length)){
    const blob=await compressImage(f);
    const reader=new FileReader();
    reader.onload=e=>{
      photos.push({name:f.name,blob,preview:e.target.result});
      renderPhotos();
      saveDraft();
    };
    reader.readAsDataURL(blob);
  }
  photoInput.value="";
};

// üß© Komprese obr√°zku (zachov√°n√≠ proporc√≠)
async function compressImage(file,maxKB=500,maxDim=1280){
  const img=await createImageBitmap(file);
  const canvas=document.createElement("canvas");
  let [w,h]=[img.width,img.height];
  if(w>h&&w>maxDim){h=Math.round(h*(maxDim/w));w=maxDim;}
  else if(h>=w&&h>maxDim){w=Math.round(w*(maxDim/h));h=maxDim;}
  canvas.width=w;canvas.height=h;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(img,0,0,w,h);
  let q=0.9,blob;
  do{blob=await new Promise(r=>canvas.toBlob(r,"image/jpeg",q));q-=0.1;}
  while(blob.size/1024>maxKB&&q>0.4);
  return blob;
}

// üñºÔ∏è Zobrazen√≠ miniatur
function renderPhotos(){
  photoPreviewMain.innerHTML="";
  photos.forEach((p,i)=>{
    const item=document.createElement("div");
    item.className="photo-item";
    const img=document.createElement("img");
    img.src=p.preview;
    img.onclick=()=>showLightbox(p.preview);
    const del=document.createElement("button");
    del.className="photo-remove";
    del.textContent="√ó";
    del.onclick=(e)=>{e.stopPropagation();photos.splice(i,1);renderPhotos();saveDraft();};
    item.append(img,del);
    photoPreviewMain.append(item);
  });
}

// üîç Lightbox
function showLightbox(src){
  lightboxImg.src=src;
  lightbox.classList.add("active");
}
lightbox.onclick=()=>lightbox.classList.remove("active");

// üíæ Ulo≈æen√≠ rozpracovan√Ωch dat
function saveDraft(){
  const form=document.getElementById("reklamaceForm");
  const data=new FormData(form);
  const obj=Object.fromEntries(data.entries());
  obj.photos=photos.map(p=>p.preview);
  localStorage.setItem("novaReklamaceDraft",JSON.stringify(obj));
}

// üîÅ Obnoven√≠ dat p≈ôi otev≈ôen√≠
window.addEventListener("DOMContentLoaded",()=>{
  const draft=localStorage.getItem("novaReklamaceDraft");
  if(draft){
    const obj=JSON.parse(draft);
    Object.keys(obj).forEach(k=>{
      const el=document.querySelector(`[name='${k}']`);
      if(el)el.value=obj[k];
    });
    if(obj.photos){
      photos=obj.photos.map(p=>({preview:p,name:"ulo≈æeno",blob:null}));
      renderPhotos();
    }
  }
});

// üßæ Validace jm√©na, emailu, telefonu
const nameField=document.querySelector("input[name='zakaznik']");
nameField.addEventListener("input",()=>{
  nameField.value=nameField.value
    .split(" ")
    .map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase())
    .join(" ");
});
document.getElementById("email").addEventListener("input",e=>{
  e.target.setCustomValidity(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.target.value)?"":"Neplatn√Ω email");
});
document.getElementById("telefon").addEventListener("input",e=>{
  e.target.setCustomValidity(/^\d{6,}$/.test(e.target.value)?"":"Min. 6 ƒç√≠sel");
});
</script>
<!-- üü© KONEC ƒå√ÅSTI 4/5 ‚Äì FOTKY + VALIDACE + LOCALSTORAGE + LIGHTBOX -->
<!-- üü© ZAƒå√ÅTEK ƒå√ÅSTI 5/5 ‚Äì ODESL√ÅN√ç, ANIMACE, P≈òESMƒöROV√ÅN√ç -->

<!-- üíæ Overlay naƒç√≠t√°n√≠ -->
<div class="wait-overlay" id="waitOverlay">
  <div class="hourglass"></div>
  <p>ƒåekejte pros√≠m, prob√≠h√° odes√≠l√°n√≠‚Ä¶</p>
</div>

<!-- ‚úÖ Hotovo animace -->
<div class="success-check" id="successCheck">
  <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
    <defs>
      <linearGradient id="gradTurq" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#00e0c0;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#00a88f;stop-opacity:1" />
      </linearGradient>
    </defs>
    <circle cx="26" cy="26" r="25" fill="none" stroke="#e0e0e0"/>
    <path fill="none" stroke="url(#gradTurq)" d="M14 27l7 7 16-16"
      stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>

<style>
.wait-overlay {
  display:none; position:fixed; inset:0; z-index:3000;
  background:rgba(255,255,255,0.9);
  backdrop-filter:blur(3px);
  justify-content:center; align-items:center;
  flex-direction:column; color:#007f73; font-weight:600;
  font-size:1.1em;
}
.wait-overlay.active{display:flex;}
.hourglass{
  border:4px solid #ccc; border-top:4px solid #00bfa5;
  border-radius:50%; width:40px; height:40px;
  animation:spin 1s linear infinite; margin-bottom:10px;
}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

.success-check {
  display:none; position:fixed; inset:0;
  justify-content:center; align-items:center;
  background:rgba(255,255,255,0.95);
  z-index:3100;
}
.success-check.active{display:flex;}
.checkmark{
  width:90px;height:90px;stroke-width:3;
  fill:none;stroke-dasharray:48;stroke-dashoffset:48;
  animation:draw 1s ease forwards;
}
@keyframes draw{to{stroke-dashoffset:0;}}
</style>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const form=document.getElementById("reklamaceForm");
  const wait=document.getElementById("waitOverlay");
  const success=document.getElementById("successCheck");

  if(!form)return;

  form.addEventListener("submit",async(e)=>{
    e.preventDefault();
    wait.classList.add("active");

    const f=e.target;
    const predvolba=document.getElementById("predvolba");
    const photos=(window.photos||[]).map(p=>p.preview);
    const dataObj={
      typ:"reklamace",
      cislo:f.cislo.value.trim()||"Poz√°ruƒçn√≠ servis",
      zakaznik:f.zakaznik.value,
      adresa:`${f.ulice.value}, ${f.mesto.value}, ${f.psc.value}`,
      telefon:`${predvolba.value} ${f.telefon.value}`,
      email:f.email.value,
      produkt:f.produkt.value,
      datum_prodeje:f.datum_prodeje?.value||"",
      datum_reklamace:f.datum_reklamace?.value||"",
      popis:f.popis.value,
      fotky:photos
    };

    try{
      const res=await fetch("https://wgs-token.72nvwf4pb2.workers.dev/temporaryfiles",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({record:dataObj})
      });

      if(!res.ok)throw new Error("Chybn√° odpovƒõƒè: "+res.status);
      const json=await res.json();
      console.log("üì§ Worker odpovƒõƒè:",json);

      // ‚úÖ Hotovo
      localStorage.removeItem("novaReklamaceDraft");
      wait.classList.remove("active");
      success.classList.add("active");

      setTimeout(()=>{window.location.href="index.html";},2500);
    }catch(err){
      console.error(err);
      alert("‚ùå Chyba p≈ôi odes√≠l√°n√≠: "+err.message);
      wait.classList.remove("active");
    }
  });
});
</script>

<!-- üü© KONEC ƒå√ÅSTI 5/5 ‚Äì ODESL√ÅN√ç, ANIMACE, P≈òESMƒöROV√ÅN√ç -->
