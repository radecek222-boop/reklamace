<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Protokol – White Glove Service</title>

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background: #f6f7fb;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .wrapper {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }
    .header {
      text-align: center;
      margin-bottom: 25px;
    }
    .header div:first-child {
      font-size: 26px;
      font-weight: 900;
      color: #111;
    }
    .header div:last-child {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    td {
      padding: 6px;
      vertical-align: top;
      border-bottom: 1px solid #eee;
    }
    .label {
      font-weight: 600;
      color: #111;
      width: 35%;
    }

    .signature-box {
      margin-top: 25px;
    }
    canvas {
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
      height: 160px;
    }

    .actions {
      text-align: center;
      margin-top: 25px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .btn {
      display: inline-block;
      padding: 12px 26px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1em;
      border: none;
      cursor: pointer;
      text-decoration: none;
      color: white;
      transition: transform 0.15s ease-in-out, opacity 0.2s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      min-width: 150px;
    }
    .btn:hover { transform: scale(1.04); opacity: 0.9; }
    .btn-back { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
    .btn-pdf { background: linear-gradient(135deg, #0046ff, #357aff); }

    @media (max-width:700px){
      td { display: block; width: 100%; border: none; padding: 4px 0; }
      .label { color:#555; font-weight:700; margin-top:10px; }
      table { border-bottom:1px solid #ddd; }
    }
  </style>
</head>

<body>
  <div class="wrapper" id="protokolWrapper">
    <div class="header">
      <div>WHITE GLOVE SERVICE</div>
      <div>Servisní a reklamační protokol</div>
    </div>

    <table>
      <tr><td class="label">Číslo reklamace / objednávky:</td><td id="cislo"></td></tr>
      <tr><td class="label">Zákazník:</td><td id="zakaznik"></td></tr>
      <tr><td class="label">Adresa:</td><td id="adresa"></td></tr>
      <tr><td class="label">Telefon:</td><td id="telefon"></td></tr>
      <tr><td class="label">E-mail:</td><td id="email"></td></tr>
      <tr><td class="label">Zadavatel:</td><td id="zadavatel"></td></tr>
      <tr><td class="label">Produkt:</td><td id="produkt"></td></tr>
      <tr><td class="label">Datum prodeje:</td><td id="datum_prodeje"></td></tr>
      <tr><td class="label">Datum reklamace:</td><td id="datum_reklamace"></td></tr>
      <tr><td class="label">Popis závady:</td><td id="popis"></td></tr>
    </table>

    <div class="signature-box">
      <label>Podpis zákazníka:</label>
      <canvas id="signaturePad"></canvas>
      <button id="clearSig" style="margin-top:10px;padding:8px 12px;border:none;border-radius:6px;background:#ccc;cursor:pointer;">Vymazat podpis</button>
    </div>

    <div class="actions">
      <a href="seznam.html" class="btn btn-back">Zpět</a>
      <button id="exportPDF" class="btn btn-pdf">Exportovat PDF</button>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script>
/* ==========================
   NAČTENÍ DAT Z LOCALSTORAGE
========================== */
window.addEventListener("DOMContentLoaded", () => {
  const record = JSON.parse(localStorage.getItem("selectedRecord") || "{}");
  if (!record || !record.cislo) {
    alert("Nebyl nalezen žádný záznam k zobrazení.");
    window.location.href = "seznam.html";
    return;
  }

  document.getElementById("cislo").textContent = record.cislo || "";
  document.getElementById("zakaznik").textContent = record.zakaznik || "";
  document.getElementById("adresa").textContent = record.adresa || "";
  document.getElementById("telefon").textContent = record.telefon || "";
  document.getElementById("email").textContent = record.email || "";
  document.getElementById("zadavatel").textContent =
    record.contract || record.jinaZadavatel?.jmeno || "";
  document.getElementById("produkt").textContent = record.produkt || "";
  document.getElementById("datum_prodeje").textContent = record.datum_prodeje || "";
  document.getElementById("datum_reklamace").textContent = record.datum_reklamace || "";
  document.getElementById("popis").textContent = record.popis || "";

  initSignaturePad();
});

/* ==========================
   SIGNATURE PAD
========================== */
let signaturePad;

function initSignaturePad() {
  const canvas = document.getElementById("signaturePad");
  resizeCanvas(canvas);
  signaturePad = new SignaturePad(canvas, {
    backgroundColor: "rgb(255,255,255)",
    penColor: "rgb(0,0,0)"
  });

  document.getElementById("clearSig").addEventListener("click", () => {
    signaturePad.clear();
  });

  window.addEventListener("resize", () => resizeCanvas(canvas));
}

function resizeCanvas(canvas) {
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  canvas.getContext("2d").scale(ratio, ratio);
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ==========================
   EXPORT DO PDF
========================== */
document.getElementById("exportPDF").addEventListener("click", async () => {
  const wrapper = document.getElementById("protokolWrapper");

  // Skryj tlačítka při exportu
  const actions = document.querySelector(".actions");
  actions.style.display = "none";

  // Ujisti se, že podpis existuje (i prázdný)
  let podpisData = "";
  if (signaturePad && !signaturePad.isEmpty()) {
    podpisData = signaturePad.toDataURL("image/png");
    const img = document.createElement("img");
    img.src = podpisData;
    img.style.width = "250px";
    img.style.marginTop = "15px";
    document.querySelector(".signature-box").appendChild(img);
  }

  // Vykreslení HTML do canvasu
  const canvas = await html2canvas(wrapper, { scale: 2 });
  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgWidth = pageWidth - 20;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);

  // název PDF: Protokol_[Číslo]_[Zákazník].pdf
  const cislo = document.getElementById("cislo").textContent.trim().replace(/\s+/g, "_");
  const zak = document.getElementById("zakaznik").textContent.trim().replace(/\s+/g, "_");
  const fileName = `Protokol_${cislo}_${zak || "zakaznik"}.pdf`;

  pdf.save(fileName);

  // Vrátit stránku zpět do původního stavu
  actions.style.display = "flex";
  if (podpisData) {
    const imgEl = document.querySelector(".signature-box img");
    if (imgEl) imgEl.remove();
  }
});
</script>
</body>
</html>
