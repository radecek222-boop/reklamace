<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol ‚Äì White Glove Service</title>

<style>
body {
  font-family: Inter, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:20px;
  font-size:12px;
  display:flex;
  justify-content:center;
}
.wrapper {
  width:100%;
  max-width:900px;
  background:white;
  padding:20px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
}
.header {
  text-align:center;
  margin-bottom:20px;
}
.header div:first-child {
  font-size:28px;
  font-weight:900;
}
.header div:last-child {
  font-size:12px;
  margin-top:4px;
  font-weight:normal;
}
table {
  width:100%;
  border-collapse:collapse;
  margin:10px 0;
}
td { padding:6px; vertical-align:top; }
.label { font-weight:600; display:block; }
.label .en-label { display:block; font-size:0.85em; color:#666; font-weight:normal; margin:0; }
.section-title { font-weight:700; margin-top:20px; display:flex; flex-direction:column; align-items:flex-start; }
.section-title .en-label { font-size:0.9em; color:#666; font-weight:normal; margin-top:2px; }

input, select, textarea {
  width:100%; padding:6px 8px;
  border:1px solid #ccc; border-radius:4px;
  font-size:1em; color:#111; background:#fff;
  box-sizing:border-box;
}
textarea { min-height:80px; resize:vertical; }

.split-section { display:flex; gap:10px; margin:10px 0; }
.two-col-table { display:flex; gap:30px; flex-wrap:wrap; }
.two-col-table .col { flex:1; min-width:300px; }

#signature-pad {
  border:2px dashed #888;
  width:100%;
  height:200px;
  background:white;
  touch-action: none;
}
.signature-label { font-size:0.9em; color:#444; margin:4px 0 20px; }

.btns {
  margin-top:20px;
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:12px;
}
button {
  height:44px; font-size:0.9em; border:none; border-radius:8px;
  cursor:pointer; font-weight:600; color:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
  transition:transform 0.1s ease-in-out, opacity 0.2s;
}
button:hover { transform:scale(1.03); opacity:0.9; }

.btn-clear { background:linear-gradient(135deg,#a83232,#ff4d4d); }
.btn-back { background:linear-gradient(135deg,#6c757d,#a0a4a7); }
.btn-pdf { background:linear-gradient(135deg,#0046ff,#357aff); }
.btn-email { background:linear-gradient(135deg,#00b36b,#3cd67a); }

.wait-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(2px);
  justify-content:center; align-items:center;
  flex-direction:column; font-weight:600; color:#333;
  z-index:2000;
}
.wait-overlay.active { display:flex; }
.hourglass {
  border:4px solid #ccc; border-top:4px solid #0046ff;
  border-radius:50%; width:40px; height:40px;
  animation:spin 1s linear infinite; margin-bottom:10px;
}
@keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

.success-check {
  display:none; position:fixed; inset:0;
  justify-content:center; align-items:center;
  background:rgba(255,255,255,0.9);
  z-index:2100;
}
.success-check.active { display:flex; }
.checkmark {
  width:80px; height:80px; stroke-width:3;
  stroke:url(#grad1); fill:none;
  stroke-dasharray:48; stroke-dashoffset:48;
  animation:draw 1s ease forwards;
}
@keyframes draw { to{stroke-dashoffset:0;} }

.force-desktop { width:794px !important; max-width:794px !important; }

@media screen and (max-width:768px){
  .two-col-table, .split-section { flex-direction:column !important; gap:10px; }
  input, select, textarea { font-size:1em; height:auto; }
  #signature-pad { height:180px; }
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO 09769684</div>
  </div>

  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ƒå√≠slo objedn√°vky<span class="en-label">Order number</span></td><td><input id="order-number"></td></tr>
        <tr><td class="label">ƒå√≠slo reklamace<span class="en-label">Claim number</span></td><td><input id="claim-number"></td></tr>
        <tr><td class="label">Z√°kazn√≠k<span class="en-label">Customer</span></td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa z√°kazn√≠ka<span class="en-label">Customer address</span></td><td><input id="address"></td></tr>
        <tr><td class="label">Telefon<span class="en-label">Phone</span></td><td><input id="phone"></td></tr>
        <tr><td class="label">Email<span class="en-label">Email</span></td><td><input id="email"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik<span class="en-label">Technician</span></td><td><select id="technician"><option>Milan Kol√≠n</option><option>Radek Zikmund</option><option>Kol√≠n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum n√°v≈°tƒõvy<span class="en-label">Visit date</span></td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruƒçen√≠<span class="en-label">Delivery date</span></td><td><input id="delivery-date" type="date"></td></tr>
        <tr><td class="label">Datum pod√°n√≠ reklamace<span class="en-label">Complaint date</span></td><td><input id="claim-date" type="date"></td></tr>
        <tr><td class="label">Znaƒçka / Contract<span class="en-label">Brand / Contract</span></td><td><input id="brand"></td></tr>
        <tr><td class="label">Model<span class="en-label">Model</span></td><td><input id="model"></td></tr>
      </table>
    </div>
  </div>

  <div class="section-title">Z√°kazn√≠k reklamuje<span class="en-label">Customer complaint</span></div>
  <div class="split-section"><textarea id="description-cz" placeholder="CZ"></textarea><textarea id="description-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">Probl√©m zji≈°tƒõn√Ω technikem<span class="en-label">Detected problem</span></div>
  <div class="split-section"><textarea id="problem-cz" placeholder="CZ"></textarea><textarea id="problem-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">N√°vrh opravy<span class="en-label">Repair proposal</span></div>
  <div class="split-section"><textarea id="repair-cz" placeholder="CZ"></textarea><textarea id="repair-en" placeholder="EN" readonly></textarea></div>
  <!-- üü® Sekce I ‚Äì Auto-p≈ôedvyplnƒõn√≠ dat -->
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    try {
      const saved = localStorage.getItem("protokolData");
      if (!saved) return;
      const data = JSON.parse(saved);
      console.log("üßæ Naƒç√≠t√°m data z localStorage.protokolData:", data);

      if (data.cislo) claimNumber.value = data.cislo;
      if (data.contract) brand.value = data.contract;
      if (data.zakaznik) customer.value = data.zakaznik;
      if (data.adresa) address.value = data.adresa;
      if (data.telefon) phone.value = data.telefon;
      if (data.email) email.value = data.email;
      if (data.produkt) model.value = data.produkt;
      if (data.popis) {
        descriptionCz.value = data.popis;
        descriptionEn.value = data.popis;
      }
      if (data.datum_reklamace) claimDate.value = data.datum_reklamace;
      if (data.datum) visitDate.value = data.datum;
    } catch (err) {
      console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat:", err);
    }
  });
  </script>

  <!-- üü® Sekce I.2 ‚Äì P≈ôekladaƒç CZ ‚Üí EN (libretranslate.com) -->
  <script>
  async function translateCZtoEN(text) {
    if (!text.trim()) return "";
    try {
      const res = await fetch("https://libretranslate.com/translate", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ q:text, source:"cs", target:"en", format:"text" })
      });
      const data = await res.json();
      return data.translatedText || "";
    } catch(e) {
      console.warn("‚ö†Ô∏è P≈ôeklad selhal:", e.message);
      return "";
    }
  }

  function initTranslator(prefix) {
    const cz=document.getElementById(`${prefix}-cz`);
    const en=document.getElementById(`${prefix}-en`);
    if(!cz||!en) return;
    let t;
    cz.addEventListener("input",()=>{
      clearTimeout(t);
      if(!cz.value.trim()){en.value="";return;}
      en.value="‚è≥ P≈ôekl√°d√°m...";
      t=setTimeout(async()=>{
        en.value=await translateCZtoEN(cz.value);
      },600);
    });
  }

  window.addEventListener("DOMContentLoaded",async()=>{
    ["description","problem","repair"].forEach(initTranslator);
    for(const f of ["description","problem","repair"]){
      const cz=document.getElementById(`${f}-cz`);
      const en=document.getElementById(`${f}-en`);
      if(cz&&en&&cz.value&&!en.value.trim()){
        en.value="‚è≥ P≈ôekl√°d√°m...";
        en.value=await translateCZtoEN(cz.value);
      }
    }
  });
  </script>

  <!-- üü® Sekce I.3 ‚Äì Naƒçten√≠ dat z orders.json podle URL -->
  <script>
  async function loadProtocolFromOrders() {
    const urlParams = new URLSearchParams(window.location.search);
    const claim = urlParams.get("cislo");
    if (!claim) return;
    try {
      console.log("üì• Naƒç√≠t√°m z√°znam z Workeru:", claim);
      const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/orders");
      const all = await res.json();
      const record = all.find(r => r.cislo === claim);
      if (!record) return console.warn("‚ö†Ô∏è Reklamace s t√≠mto ƒç√≠slem nebyla nalezena.");
      localStorage.setItem("protokolData", JSON.stringify(record));

      document.getElementById("claim-number").value = record.cislo || "";
      document.getElementById("brand").value = record.contract || "";
      document.getElementById("customer").value = record.zakaznik || "";
      document.getElementById("address").value = record.adresa || "";
      document.getElementById("phone").value = record.telefon || "";
      document.getElementById("email").value = record.email || "";
      document.getElementById("model").value = record.produkt || "";
      document.getElementById("claim-date").value = record.datum_reklamace || "";
      document.getElementById("visit-date").value = record.datum || "";
      if (record.popis) {
        document.getElementById("description-cz").value = record.popis;
        document.getElementById("description-en").value = record.popis;
      }
      console.log("‚úÖ Data z reklamace naƒçtena:", record.cislo);
    } catch (e) {
      console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ z Workeru:", e);
    }
  }
  window.addEventListener("DOMContentLoaded", loadProtocolFromOrders);
  </script>

  <!-- üü® Sekce J ‚Äì PDF, e-mail, ulo≈æen√≠ -->
  <script>
  let signaturePad;

  window.addEventListener("DOMContentLoaded",()=>{
    const canvas=document.getElementById("signature-pad");
    function resizeCanvas(){
      canvas.width=canvas.offsetWidth;
      canvas.height=canvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener("resize",resizeCanvas,{passive:true});
    signaturePad=new SignaturePad(canvas,{backgroundColor:"white"});
    const today=new Date().toISOString().split("T")[0];
    visitDate.value ||= today;
    signDate.value ||= today;
  });

  // üßæ GENEROV√ÅN√ç PDF ‚Äì tlaƒç√≠tka p≈ôekryta b√≠lou vrstvou
  async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const wrapper=document.querySelector(".wrapper");
    const doc=new jsPDF("p","mm","a4");

    // üíß vodoznak
    doc.setFont("helvetica","bold");
    doc.setFontSize(48);
    doc.setTextColor(220,220,220);
    doc.text("WHITE GLOVE SERVICE",105,150,{align:"center",angle:45});

    // doƒçasn√© skryt√≠ tlaƒç√≠tek (p≈ôekryt√≠ b√≠lou)
    const btns = document.querySelector(".btns");
    const originalDisplay = btns.style.display;
    btns.style.opacity = "0";

    // p≈ôevod cel√© str√°nky do obr√°zku
    wrapper.classList.add("force-desktop");
    const canvas = await html2canvas(wrapper,{scale:2,backgroundColor:"#fff"});
    const imgData = canvas.toDataURL("image/jpeg",0.95);
    wrapper.classList.remove("force-desktop");

    // vr√°tit tlaƒç√≠tka zpƒõt
    btns.style.opacity = "1";

    if(!signaturePad.isEmpty()){
      const sig=signaturePad.toDataURL("image/png");
      doc.addImage(sig,"PNG",30,250,60,20);
    }

    doc.addImage(imgData,"JPEG",0,0,210,297);
    return doc;
  }

  async function exportPDF(){
    const doc=await generatePDF();
    const blob=doc.output("blob");
    const url=URL.createObjectURL(blob);
    window.open(url,"_blank");
    saveProtocolToCustomer(blob);
  }

  async function mailCustomer(){
    const doc=await generatePDF();
    const blob=doc.output("blob");
    saveProtocolToCustomer(blob);
    const email=document.getElementById("email").value||"";
    const subject="Reklamaƒçn√≠ protokol White Glove Service";
    const body="Dobr√Ω den,\n\nv p≈ô√≠loze zas√≠l√°me reklamaƒçn√≠ protokol z n√°v≈°tƒõvy.\n\nS pozdravem,\nWHITE GLOVE SERVICE s.r.o.";
    window.location.href=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }

  async function saveProtocolToCustomer(pdfBlob){
    try{
      const reader=new FileReader();
      reader.onloadend=async()=>{
        const base64pdf=reader.result.split(",")[1];
        const claim=claimNumber.value;
        const customerName=customer.value;
        const today=new Date().toISOString().split("T")[0];
        const fileName=`Protokol_${customerName}_${claim}_${today}.pdf`;
        const record={ cislo:claim, protokol:{name:fileName,date:today,file:base64pdf} };
        if(typeof saveCustomerEdit==="function"){
          saveCustomerEdit(record);
          console.log("üìé Protokol ulo≈æen:",fileName);
        } else console.warn("‚ö†Ô∏è Funkce saveCustomerEdit() nen√≠ dostupn√°.");
      };
      reader.readAsDataURL(pdfBlob);
    }catch(e){
      console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠:",e);
    }
  }
  </script>
</div>
</body>
</html>
