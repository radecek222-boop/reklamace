<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol ‚Äì White Glove Service</title>

<style>
body {
  font-family: Inter, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:20px;
  font-size:12px;
  display:flex;
  justify-content:center;
}
.wrapper {
  width:100%;
  max-width:900px;
  background:white;
  padding:20px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  box-sizing:border-box;
}
.header {
  text-align:center;
  margin-bottom:20px;
  width:100%;
}
.header div:first-child {
  font-size:28px;
  font-weight:900;
}
.header div:last-child {
  font-size:12px;
  margin-top:4px;
  font-weight:normal;
}
table {
  width:100%;
  border-collapse:collapse;
  margin:10px 0;
}
td { 
  padding:6px; 
  vertical-align:top;
  width:50%;
}
.label { 
  font-weight:600; 
  display:block; 
  text-align:left;
}
.label .en-label { 
  display:block; 
  font-size:0.85em; 
  color:#666; 
  font-weight:normal; 
  margin:0;
}
.section-title { 
  font-weight:700; 
  margin-top:20px; 
  width:100%;
  text-align:left;
}
.section-title .en-label { 
  font-size:0.9em; 
  color:#666; 
  font-weight:normal; 
  margin-top:2px;
}
input, select, textarea {
  width:100%; 
  padding:6px 8px;
  border:1px solid #ccc; 
  border-radius:4px;
  font-size:1em; 
  color:#111; 
  background:#fff;
  box-sizing:border-box;
}
textarea { 
  min-height:80px; 
  resize:vertical;
}
.two-col-table {
  display:flex;
  flex-direction:row;
  justify-content:space-between;
  gap:20px;
  width:100%;
}
.two-col-table .col {
  flex:1;
  min-width:320px;
}
.split-section {
  display:flex;
  gap:10px;
  width:100%;
}
textarea[readonly] {
  background:#f7f7f7;
  color:#444;
}
#signature-pad {
  border:2px dashed #888;
  width:100%;
  height:200px;
  background:white;
  touch-action:none;
  display:block;
}
.btns {
  margin-top:20px;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap:12px;
  width:100%;
}
button {
  height:44px; 
  font-size:0.9em; 
  border:none; 
  border-radius:8px;
  cursor:pointer; 
  font-weight:600; 
  color:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
  transition:transform 0.1s ease-in-out, opacity 0.2s;
}
button:hover { transform:scale(1.03); opacity:0.9; }

@media screen and (max-width:768px){
  .two-col-table { flex-direction:column; }
  td { width:100%; display:block; }
  .split-section { flex-direction:column; }
  #signature-pad { height:180px; }
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO 09769684</div>
  </div>

  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ƒå√≠slo objedn√°vky<span class="en-label">Order number</span></td><td><input id="order-number"></td></tr>
        <tr><td class="label">ƒå√≠slo reklamace<span class="en-label">Claim number</span></td><td><input id="claim-number"></td></tr>
        <tr><td class="label">Z√°kazn√≠k<span class="en-label">Customer</span></td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa z√°kazn√≠ka<span class="en-label">Customer address</span></td><td><input id="address"></td></tr>
        <tr><td class="label">Telefon<span class="en-label">Phone</span></td><td><input id="phone"></td></tr>
        <tr><td class="label">Email<span class="en-label">Email</span></td><td><input id="email"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik<span class="en-label">Technician</span></td><td><select id="technician"><option>Milan Kol√≠n</option><option>Radek Zikmund</option><option>Kol√≠n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum n√°v≈°tƒõvy<span class="en-label">Visit date</span></td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruƒçen√≠<span class="en-label">Delivery date</span></td><td><input id="delivery-date" type="date"></td></tr>
        <tr><td class="label">Datum pod√°n√≠ reklamace<span class="en-label">Complaint date</span></td><td><input id="claim-date" type="date"></td></tr>
        <tr><td class="label">Znaƒçka / Contract<span class="en-label">Brand / Contract</span></td><td><input id="brand"></td></tr>
        <tr><td class="label">Model<span class="en-label">Model</span></td><td><input id="model"></td></tr>
      </table>
    </div>
  </div>

  <div class="section-title">Z√°kazn√≠k reklamuje<span class="en-label">Customer complaint</span></div>
  <div class="split-section"><textarea id="description-cz" placeholder="CZ"></textarea><textarea id="description-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">Probl√©m zji≈°tƒõn√Ω technikem<span class="en-label">Detected problem</span></div>
  <div class="split-section"><textarea id="problem-cz" placeholder="CZ"></textarea><textarea id="problem-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">N√°vrh opravy<span class="en-label">Repair proposal</span></div>
  <div class="split-section"><textarea id="repair-cz" placeholder="CZ"></textarea><textarea id="repair-en" placeholder="EN" readonly></textarea></div>
  <!-- üü® Sekce E ‚Äì Ceny a stavy -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">Poƒçet opravovan√Ωch d√≠l≈Ø<span class="en-label">Number of repaired parts</span></td><td><input id="parts" type="number" min="0"></td></tr>
        <tr><td class="label">Cena za pr√°ci<span class="en-label">Work cost</span></td><td><input id="price-work" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za materi√°l<span class="en-label">Material cost</span></td><td><input id="price-material" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za druh√©ho technika<span class="en-label">Second technician cost</span></td><td><input id="price-second" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za dopravu<span class="en-label">Transport cost</span></td><td><input id="price-transport" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena celkem<span class="en-label">Total cost</span></td><td><input id="price-total" readonly></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Reklamace vy≈ôe≈°ena?<span class="en-label">Complaint solved?</span></td><td><select id="solved"><option>ANO</option><option>NE</option></select></td></tr>
        <tr><td class="label">ƒåek√° se na vyj√°d≈ôen√≠ prodejce?<span class="en-label">Waiting for dealer?</span></td><td><select id="dealer"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Po≈°kozen√≠ technikem?<span class="en-label">Damage by technician?</span></td><td><select id="damage"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">√öhradu provede z√°kazn√≠k?<span class="en-label">Customer will pay?</span></td><td><select id="payment"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Datum podpisu<span class="en-label">Signature date</span></td><td><input id="sign-date" type="date"></td></tr>
      </table>
    </div>
  </div>

  <script>
  function updateTotal() {
    const work = parseFloat(priceWork.value) || 0;
    const material = parseFloat(priceMaterial.value) || 0;
    const second = parseFloat(priceSecond.value) || 0;
    const transport = parseFloat(priceTransport.value) || 0;
    priceTotal.value = (work + material + second + transport).toFixed(2);
  }
  const priceWork=document.getElementById("price-work");
  const priceMaterial=document.getElementById("price-material");
  const priceSecond=document.getElementById("price-second");
  const priceTransport=document.getElementById("price-transport");
  const priceTotal=document.getElementById("price-total");
  </script>

  <!-- üü® Sekce F ‚Äì Podpis a tlaƒç√≠tka -->
  <div class="section-title">Podpis z√°kazn√≠ka<span class="en-label">Customer signature</span></div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>

  <div class="btns">
    <button class="btn-clear" type="button" onclick="signaturePad.clear()">Vymazat podpis</button>
    <button class="btn-back" type="button" onclick="window.location.href='index.html'">Zpƒõt</button>
    <button class="btn-pdf" type="button" onclick="exportPDF()">Exportovat PDF</button>
    <button class="btn-email" type="button" onclick="mailCustomer()">Odeslat z√°kazn√≠kovi</button>
  </div>

  <!-- üü® Sekce G ‚Äì P≈ôekryvn√© vrstvy -->
  <div class="wait-overlay" id="waitOverlay">
    <div class="hourglass"></div><p>Sv√Ωm podpisem z√°kazn√≠k potvrzuje, ≈æe v≈°e uveden√© je pravdiv√©, reklamace nebo servisn√≠ z√°sah byl ≈ô√°dnƒõ proveden a souhlas√≠ s uchov√°n√≠m a zpracov√°n√≠m osobn√≠ch √∫daj≈Ø spoleƒçnost√≠ White Glove Service s.r.o. pro √∫ƒçely vy≈ô√≠zen√≠ reklamace, servisu a p≈ôed√°n√≠ v√Ωrobci v souladu s platnou legislativou (GDPR)</p>
  </div>
  <div class="success-check" id="successCheck">
    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
      <defs>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#00d084"/><stop offset="100%" style="stop-color:#00a86b"/>
        </linearGradient>
      </defs>
      <circle cx="26" cy="26" r="25" fill="none"/>
      <path fill="none" d="M14 27l7 7 16-16" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>

  <!-- üü® Sekce H ‚Äì Extern√≠ knihovny -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="wgs-sync.js"></script>
  <!-- üü® Sekce I ‚Äì Auto-p≈ôedvyplnƒõn√≠ dat z localStorage -->
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    try {
      const saved = localStorage.getItem("protokolData");
      if (!saved) return;
      const data = JSON.parse(saved);
      console.log("üßæ Naƒç√≠t√°m data z localStorage.protokolData:", data);

      if (data.cislo) claimNumber.value = data.cislo;
      if (data.contract) brand.value = data.contract;
      if (data.zakaznik) customer.value = data.zakaznik;
      if (data.adresa) address.value = data.adresa;
      if (data.telefon) phone.value = data.telefon;
      if (data.email) email.value = data.email;
      if (data.produkt) model.value = data.produkt;
      if (data.popis) {
        descriptionCz.value = data.popis;
        descriptionEn.value = data.popis;
      }
      if (data.datum_reklamace) claimDate.value = data.datum_reklamace;
      if (data.datum) visitDate.value = data.datum;
    } catch (err) {
      console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat:", err);
    }
  });
  </script>

  <!-- üü® Sekce I.2 ‚Äì P≈ôekladaƒç CZ ‚Üí EN (MyMemory API ‚Äì bez kl√≠ƒçe) -->
  <script>
  async function translateCZtoEN(text) {
    if (!text.trim()) return "";
    try {
      const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=cs|en`;
      const res = await fetch(url);
      const data = await res.json();
      return data.responseData?.translatedText || "";
    } catch(e) {
      console.warn("‚ö†Ô∏è P≈ôeklad selhal:", e.message);
      return "";
    }
  }

  function initTranslator(prefix) {
    const cz = document.getElementById(`${prefix}-cz`);
    const en = document.getElementById(`${prefix}-en`);
    if (!cz || !en) return;
    let t;
    cz.addEventListener("input", () => {
      clearTimeout(t);
      if (!cz.value.trim()) { en.value = ""; return; }
      en.value = "‚è≥ P≈ôekl√°d√°m...";
      t = setTimeout(async () => {
        en.value = await translateCZtoEN(cz.value);
      }, 700);
    });
  }

  window.addEventListener("DOMContentLoaded", async () => {
    ["description", "problem", "repair"].forEach(initTranslator);
    for (const f of ["description", "problem", "repair"]) {
      const cz = document.getElementById(`${f}-cz`);
      const en = document.getElementById(`${f}-en`);
      if (cz && en && cz.value && !en.value.trim()) {
        en.value = "‚è≥ P≈ôekl√°d√°m...";
        en.value = await translateCZtoEN(cz.value);
      }
    }
  });
  </script>

  <!-- üü® Sekce I.3 ‚Äì Naƒçten√≠ dat z orders.json podle URL -->
  <script>
  async function loadProtocolFromOrders() {
    const urlParams = new URLSearchParams(window.location.search);
    const claim = urlParams.get("cislo");
    if (!claim) return;
    try {
      console.log("üì• Naƒç√≠t√°m z√°znam z Workeru:", claim);
      const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/orders");
      const all = await res.json();
      const record = all.find(r => r.cislo === claim);
      if (!record) return console.warn("‚ö†Ô∏è Reklamace s t√≠mto ƒç√≠slem nebyla nalezena.");
      localStorage.setItem("protokolData", JSON.stringify(record));

      document.getElementById("claim-number").value = record.cislo || "";
      document.getElementById("brand").value = record.contract || "";
      document.getElementById("customer").value = record.zakaznik || "";
      document.getElementById("address").value = record.adresa || "";
      document.getElementById("phone").value = record.telefon || "";
      document.getElementById("email").value = record.email || "";
      document.getElementById("model").value = record.produkt || "";
      document.getElementById("claim-date").value = record.datum_reklamace || "";
      document.getElementById("visit-date").value = record.datum || "";
      if (record.popis) {
        document.getElementById("description-cz").value = record.popis;
        document.getElementById("description-en").value = record.popis;
      }
      console.log("‚úÖ Data z reklamace naƒçtena:", record.cislo);
    } catch (e) {
      console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ z Workeru:", e);
    }
  }
  window.addEventListener("DOMContentLoaded", loadProtocolFromOrders);
  </script>

  <!-- üü® Sekce J ‚Äì PDF, e-mail, ulo≈æen√≠, podpis fix -->
  <script>
  let signaturePad;

  // üñäÔ∏è Inicializace podpisu
  window.addEventListener("DOMContentLoaded", () => {
    const canvas = document.getElementById("signature-pad");
    if (!canvas) return;
    setTimeout(() => {
      canvas.style.display = "block";
      canvas.style.background = "#fff";
      canvas.style.border = "2px dashed #888";
      canvas.style.width = "100%";
      canvas.style.height = "200px";
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      signaturePad = new SignaturePad(canvas, { backgroundColor: "white" });
    }, 50);

    const today = new Date().toISOString().split("T")[0];
    document.getElementById("visit-date").value ||= today;
    document.getElementById("sign-date").value ||= today;
  });

  // üßæ PDF export
  async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const wrapper=document.querySelector(".wrapper");
    const doc=new jsPDF("p","mm","a4");
    doc.setFont("helvetica","bold");
    doc.setFontSize(48);
    doc.setTextColor(220,220,220);
    doc.text("WHITE GLOVE SERVICE",105,150,{align:"center",angle:45});

    const btns=document.querySelector(".btns");
    const originalVis=btns.style.visibility;
    btns.style.visibility="hidden";

    wrapper.classList.add("force-desktop");
    const canvas=await html2canvas(wrapper,{scale:2,backgroundColor:"#fff"});
    const imgData=canvas.toDataURL("image/jpeg",0.95);
    wrapper.classList.remove("force-desktop");
    btns.style.visibility=originalVis;

    if(!signaturePad.isEmpty()){
      const sig=signaturePad.toDataURL("image/png");
      doc.addImage(sig,"PNG",30,250,60,20);
    } else {
      doc.setFontSize(10);
      doc.setTextColor(150);
      doc.text("‚úò Bez podpisu z√°kazn√≠ka",30,260);
    }

    doc.addImage(imgData,"JPEG",0,0,210,297);
    return doc;
  }

  async function exportPDF(){
    const doc=await generatePDF();
    const blob=doc.output("blob");
    const url=URL.createObjectURL(blob);
    window.open(url,"_blank");
    saveProtocolToCustomer(blob);
  }

  async function mailCustomer(){
    const doc=await generatePDF();
    const blob=doc.output("blob");
    saveProtocolToCustomer(blob);
    const email=document.getElementById("email").value||"";
    const subject="Reklamaƒçn√≠ protokol White Glove Service";
    const body="Dobr√Ω den,\n\nv p≈ô√≠loze zas√≠l√°me reklamaƒçn√≠ protokol z n√°v≈°tƒõvy.\n\nS pozdravem,\nWHITE GLOVE SERVICE s.r.o.";
    window.location.href=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }

  async function saveProtocolToCustomer(pdfBlob){
    try{
      const reader=new FileReader();
      reader.onloadend=async()=>{
        const base64pdf=reader.result.split(",")[1];
        const claim=claimNumber.value;
        const customerName=customer.value;
        const today=new Date().toISOString().split("T")[0];
        const fileName=`Protokol_${customerName}_${claim}_${today}.pdf`;
        const record={ cislo:claim, protokol:{name:fileName,date:today,file:base64pdf} };
        if(typeof saveCustomerEdit==="function"){
          saveCustomerEdit(record);
          console.log("üìé Protokol ulo≈æen:",fileName);
        } else console.warn("‚ö†Ô∏è Funkce saveCustomerEdit() nen√≠ dostupn√°.");
      };
      reader.readAsDataURL(pdfBlob);
    }catch(e){
      console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠:",e);
    }
  }
async function exportPDF() {
  const doc = await generatePDF();
  const blob = doc.output("blob");
  const url = URL.createObjectURL(blob);
  window.open(url, "_blank");
  saveProtocolToCustomer(blob);
  markAsCompleted(); // ‚úÖ oznaƒç√≠ hotovo
}

async function mailCustomer() {
  const doc = await generatePDF();
  const blob = doc.output("blob");
  saveProtocolToCustomer(blob);
  markAsCompleted(); // ‚úÖ oznaƒç√≠ hotovo
  const email = document.getElementById("email").value || "";
  const subject = "Reklamaƒçn√≠ protokol White Glove Service";
  const body = "Dobr√Ω den,\n\nv p≈ô√≠loze zas√≠l√°me reklamaƒçn√≠ protokol z n√°v≈°tƒõvy.\n\nS pozdravem,\nWHITE GLOVE SERVICE s.r.o.";
  window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

/* üü¢ Oznaƒçen√≠ reklamace jako hotov√© */
function markAsCompleted() {
  const protokol = JSON.parse(localStorage.getItem("protokolData") || "{}");
  if (!protokol.cislo) return;

  // üîÑ ulo≈æ√≠ do localStorage
  const stavy = JSON.parse(localStorage.getItem("stavyReklamaci") || "{}");
  stavy[protokol.cislo] = "hotovo";
  localStorage.setItem("stavyReklamaci", JSON.stringify(stavy));

  // üü© voliteln√Ω toast (zobraz√≠ po n√°vratu do seznam.html)
  sessionStorage.setItem("wgsToastMsg", `‚úÖ Reklamace ${protokol.cislo} oznaƒçena jako hotov√°`);
  sessionStorage.setItem("wgsToastType", "success");
}
</script>

  </script>

</div> <!-- ‚úÖ konec hlavn√≠ho wrapperu -->
</body>
</html>
