<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol ‚Äì White Glove Service</title>

<style>
body {
  font-family: Inter, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:20px;
  font-size:12px;
  display:flex;
  justify-content:center;
}
.wrapper {
  width:100%;
  max-width:900px;
  background:white;
  padding:20px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  box-sizing:border-box;
}
.header {
  text-align:center;
  margin-bottom:20px;
  width:100%;
}
.header div:first-child {
  font-size:28px;
  font-weight:900;
}
.header div:last-child {
  font-size:12px;
  margin-top:4px;
  font-weight:normal;
}
table {
  width:100%;
  border-collapse:collapse;
  margin:10px 0;
}
td { 
  padding:6px; 
  vertical-align:top;
  width:50%;
}
.label { 
  font-weight:600; 
  display:block; 
  text-align:left;
}
.label .en-label { 
  display:block; 
  font-size:0.85em; 
  color:#666; 
  font-weight:normal; 
  margin:0;
}
.section-title { 
  font-weight:700; 
  margin-top:20px; 
  width:100%;
  text-align:left;
}
.section-title .en-label { 
  font-size:0.9em; 
  color:#666; 
  font-weight:normal; 
  margin-top:2px;
}
input, select, textarea {
  width:100%; 
  padding:6px 8px;
  border:1px solid #ccc; 
  border-radius:4px;
  font-size:1em; 
  color:#111; 
  background:#fff;
  box-sizing:border-box;
}
textarea { 
  min-height:80px; 
  resize:vertical;
}
.two-col-table {
  display:flex;
  flex-direction:row;
  justify-content:space-between;
  gap:20px;
  width:100%;
}
.two-col-table .col {
  flex:1;
  min-width:320px;
}
.split-section {
  display:flex;
  gap:10px;
  width:100%;
}
textarea[readonly] {
  background:#f7f7f7;
  color:#444;
}
#signature-pad {
  border:2px dashed #888;
  width:100%;
  height:200px;
  background:white;
  touch-action:none;
  display:block;
}
.btns {
  margin-top:20px;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap:12px;
  width:100%;
}
button {
  height:44px; 
  font-size:0.9em; 
  border:none; 
  border-radius:8px;
  cursor:pointer; 
  font-weight:600; 
  color:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
  transition:transform 0.1s ease-in-out, opacity 0.2s;
}
button:hover { transform:scale(1.03); opacity:0.9; }

@media screen and (max-width:768px){
  .two-col-table { flex-direction:column; }
  td { width:100%; display:block; }
  .split-section { flex-direction:column; }
  #signature-pad { height:180px; }
}
</style>
</head>
  
<body>

  <!-- üü© SEKCE A ‚Äì AUTOMATICK√â NAƒåTEN√ç √öDAJ≈Æ Z√ÅKAZN√çKA (Z LOCALSTORAGE) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  try {
    const data = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
    if (!data || Object.keys(data).length === 0) {
      console.warn("‚ö†Ô∏è Nebyla nalezena data z√°kazn√≠ka v localStorage");
      return;
    }

    // üîπ Propis z√°kladn√≠ch √∫daj≈Ø do protokolu
    const map = {
      "order-number": data.cislo,
      "claim-number": data.reklamace || "",
      "customer": data.zakaznik,
      "address": data.adresa,
      "phone": data.telefon,
      "email": data.email,
      "brand": data.contract,
      "model": data.model
    };

    Object.entries(map).forEach(([id, val]) => {
      const el = document.getElementById(id);
      if (el && val) el.value = val;
    });

    console.log("‚úÖ √ödaje z√°kazn√≠ka naƒçteny do protokolu:", data);
  } catch (err) {
    console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ dat z√°kazn√≠ka:", err);
  }
});
</script>
<!-- üü© KONEC SEKCE A -->

<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO 09769684</div>
  </div>

  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ƒå√≠slo objedn√°vky<span class="en-label">Order number</span></td><td><input id="order-number"></td></tr>
        <tr><td class="label">ƒå√≠slo reklamace<span class="en-label">Claim number</span></td><td><input id="claim-number"></td></tr>
        <tr><td class="label">Z√°kazn√≠k<span class="en-label">Customer</span></td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa z√°kazn√≠ka<span class="en-label">Customer address</span></td><td><input id="address"></td></tr>
        <tr><td class="label">Telefon<span class="en-label">Phone</span></td><td><input id="phone"></td></tr>
        <tr><td class="label">Email<span class="en-label">Email</span></td><td><input id="email"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik<span class="en-label">Technician</span></td><td><select id="technician"><option>Milan Kol√≠n</option><option>Radek Zikmund</option><option>Kol√≠n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum n√°v≈°tƒõvy<span class="en-label">Visit date</span></td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruƒçen√≠<span class="en-label">Delivery date</span></td><td><input id="delivery-date" type="date"></td></tr>
        <tr><td class="label">Datum pod√°n√≠ reklamace<span class="en-label">Complaint date</span></td><td><input id="claim-date" type="date"></td></tr>
        <tr><td class="label">Znaƒçka / Contract<span class="en-label">Brand / Contract</span></td><td><input id="brand"></td></tr>
        <tr><td class="label">Model<span class="en-label">Model</span></td><td><input id="model"></td></tr>
      </table>
    </div>
  </div>

  <div class="section-title">Z√°kazn√≠k reklamuje<span class="en-label">Customer complaint</span></div>
  <div class="split-section"><textarea id="description-cz" placeholder="CZ"></textarea><textarea id="description-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">Probl√©m zji≈°tƒõn√Ω technikem<span class="en-label">Detected problem</span></div>
  <div class="split-section"><textarea id="problem-cz" placeholder="CZ"></textarea><textarea id="problem-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">N√°vrh opravy<span class="en-label">Repair proposal</span></div>
  <div class="split-section"><textarea id="repair-cz" placeholder="CZ"></textarea><textarea id="repair-en" placeholder="EN" readonly></textarea></div>
  <!-- üü® Sekce E ‚Äì Ceny a stavy -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">Poƒçet opravovan√Ωch d√≠l≈Ø<span class="en-label">Number of repaired parts</span></td><td><input id="parts" type="number" min="0"></td></tr>
        <tr><td class="label">Cena za pr√°ci<span class="en-label">Work cost</span></td><td><input id="price-work" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za materi√°l<span class="en-label">Material cost</span></td><td><input id="price-material" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za druh√©ho technika<span class="en-label">Second technician cost</span></td><td><input id="price-second" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za dopravu<span class="en-label">Transport cost</span></td><td><input id="price-transport" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena celkem<span class="en-label">Total cost</span></td><td><input id="price-total" readonly></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Reklamace vy≈ôe≈°ena?<span class="en-label">Complaint solved?</span></td><td><select id="solved"><option>ANO</option><option>NE</option></select></td></tr>
        <tr><td class="label">ƒåek√° se na vyj√°d≈ôen√≠ prodejce?<span class="en-label">Waiting for dealer?</span></td><td><select id="dealer"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Po≈°kozen√≠ technikem?<span class="en-label">Damage by technician?</span></td><td><select id="damage"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">√öhradu provede z√°kazn√≠k?<span class="en-label">Customer will pay?</span></td><td><select id="payment"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Datum podpisu<span class="en-label">Signature date</span></td><td><input id="sign-date" type="date"></td></tr>
      </table>
    </div>
  </div>

  <script>
  function updateTotal() {
    const work = parseFloat(priceWork.value) || 0;
    const material = parseFloat(priceMaterial.value) || 0;
    const second = parseFloat(priceSecond.value) || 0;
    const transport = parseFloat(priceTransport.value) || 0;
    priceTotal.value = (work + material + second + transport).toFixed(2);
  }
  const priceWork=document.getElementById("price-work");
  const priceMaterial=document.getElementById("price-material");
  const priceSecond=document.getElementById("price-second");
  const priceTransport=document.getElementById("price-transport");
  const priceTotal=document.getElementById("price-total");
  </script>

 
<!-- üü® Sekce F ‚Äì Podpis a tlaƒç√≠tka -->
<div class="section-title">Podpis z√°kazn√≠ka<span class="en-label">Customer signature</span></div>
<canvas id="signature-pad"></canvas>
<div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>

<div class="btns">
  <button class="btn-clear" type="button" onclick="signaturePad.clear()">Vymazat podpis</button>
  <button class="btn-back" type="button" onclick="window.location.href='index.html'">Zpƒõt</button>
  <button class="btn-photos" type="button" onclick="attachPhotos()">P≈ôidat fotky</button>
  <button class="btn-pdf" type="button" onclick="exportPDF()">Exportovat PDF</button>
  <button class="btn-email" type="button" onclick="mailCustomer()">Odeslat z√°kazn√≠kovi</button>
</div>

<!-- üü© N√°hled p≈ôipojen√Ωch fotek -->
<div id="photoPreviewContainer" style="display:none;margin-top:20px;width:100%;">
  <h3 style="font-size:1em;font-weight:700;margin-bottom:10px;">üì∑ P≈ôipojen√° fotodokumentace</h3>
  <iframe id="photoPreviewFrame"
          style="width:100%;height:480px;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);"></iframe>
</div>

<!-- üü® Sekce G ‚Äì Notifikace -->
<div id="notif" class="notif"></div>
<style>
.notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);
background:linear-gradient(135deg,#00b56a,#00da80);color:#fff;
padding:10px 20px;border-radius:8px;font-weight:600;font-size:0.9em;
box-shadow:0 3px 10px rgba(0,0,0,0.2);opacity:0;transition:opacity .3s,transform .3s;
z-index:3000;}
.notif.show{opacity:1;transform:translate(-50%,10px);}
.notif.error{background:linear-gradient(135deg,#e63946,#ff6b6b);}
.notif.warning{background:linear-gradient(135deg,#ffb200,#ffca40);color:#222;}
</style>
<script>
function showNotif(type="success",text="Hotovo"){
 const n=document.getElementById("notif");
 n.className=`notif ${type}`;
 n.textContent=text;
 n.classList.add("show");
 clearTimeout(window._notifTimer);
 window._notifTimer=setTimeout(()=>n.classList.remove("show"),2500);
}
</script>

<!-- üü® Sekce H ‚Äì Extern√≠ knihovny -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- üü® Sekce I ‚Äì P≈ôekladaƒç CZ ‚Üí EN (obnoven√° funkƒçnost) -->
<script>
async function translateCZtoEN(text) {
  if (!text.trim()) return "";
  try {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=cs|en`;
    const res = await fetch(url);
    const data = await res.json();
    return data.responseData?.translatedText || "";
  } catch (e) {
    console.warn("‚ö†Ô∏è P≈ôeklad selhal:", e.message);
    return "";
  }
}

function initTranslator(prefix) {
  const cz = document.getElementById(`${prefix}-cz`);
  const en = document.getElementById(`${prefix}-en`);
  if (!cz || !en) return;
  let t;
  cz.addEventListener("input", () => {
    clearTimeout(t);
    if (!cz.value.trim()) { en.value = ""; return; }
    en.value = "‚è≥ P≈ôekl√°d√°m...";
    t = setTimeout(async () => {
      en.value = await translateCZtoEN(cz.value);
    }, 700);
  });
}

/* üü© Inicializace p≈ôekladaƒçe po naƒçten√≠ str√°nky */
window.addEventListener("load", () => {
  ["description", "problem", "repair"].forEach(initTranslator);
});
</script>


<!-- üü® Sekce J ‚Äì Generov√°n√≠ + podpis + export PDF + spojen√≠ s fotkami (verze 2025-10-11) -->
<script>
/* üß© Inicializace podpisu */
let signaturePad;
window.addEventListener("load", () => {
  const canvas = document.getElementById("signature-pad");
  if (!canvas) return;

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  signaturePad = new SignaturePad(canvas, {
    minWidth: 1,
    maxWidth: 2,
    penColor: "black",
    backgroundColor: "white",
  });
});

/* üßæ Pomocn√° funkce pro notifikace */
function showNotif(type = "success", text = "Hotovo") {
  const n = document.getElementById("notif");
  if (!n) return;
  n.className = `notif ${type}`;
  n.textContent = text;
  n.classList.add("show");
  clearTimeout(window._notifTimer);
  window._notifTimer = setTimeout(() => n.classList.remove("show"), 2500);
}

/* üì∏ P≈ôipojen√≠ fotodokumentace z localStorage */
let attachedPhotos = null;
function attachPhotos() {
  const photoPdfData = localStorage.getItem("photoPdfData");
  const preview = document.getElementById("photoPreviewContainer");
  const frame = document.getElementById("photoPreviewFrame");

  if (!photoPdfData) {
    showNotif("warning", "≈Ω√°dn√© fotky nebyly nalezeny");
    preview.style.display = "none";
    return;
  }
  attachedPhotos = photoPdfData;
  preview.style.display = "block";
  frame.src = photoPdfData;
  showNotif("success", "Fotodokumentace p≈ôipojena");
}

/* üìÑ Vytvo≈ôen√≠ PDF protokolu s podpisem */
async function generateProtocolPDF() {
  const { jsPDF } = window.jspdf;
  const wrapper = document.querySelector(".wrapper");
  const doc = new jsPDF("p", "mm", "a4");

  const btns = document.querySelector(".btns");
  const vis = btns.style.visibility;
  btns.style.visibility = "hidden";

  const canvas = await html2canvas(wrapper, { scale: 3, backgroundColor: "#fff" });
  const imgData = canvas.toDataURL("image/jpeg", 0.98);
  doc.addImage(imgData, "JPEG", 0, 0, 210, 297);
  btns.style.visibility = vis;

  // ‚úçÔ∏è P≈ôid√°n√≠ podpisu
  if (signaturePad && !signaturePad.isEmpty()) {
    const sig = signaturePad.toDataURL("image/png");
    doc.addPage();
    doc.text("Podpis z√°kazn√≠ka / Customer signature", 20, 30);
    doc.addImage(sig, "PNG", 20, 40, 120, 60);
  } else {
    doc.addPage();
    doc.text("Bez podpisu z√°kazn√≠ka / No customer signature", 20, 30);
  }

  return doc;
}

/* üîó Spojen√≠ PDF protokolu + fotodokumentace z Workeru nebo localStorage */
async function mergeWithPhotos(doc) {
  try {
    let pdfData = attachedPhotos;

    // üß© Pokud nejsou fotky v localStorage, zkus naƒç√≠st z Workeru
    if (!pdfData) {
      const data = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
      const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/photocustomer", { cache: "no-store" });
      if (res.ok) {
        const all = await res.json();
        const record = all.find(r => r.cislo === data.cislo);
        if (record && record.file) pdfData = record.file;
      }
    }

    if (!pdfData) {
      console.warn("‚ö†Ô∏è ≈Ω√°dn√° fotodokumentace pro spojen√≠ PDF");
      return doc;
    }

    // üßæ Bezpeƒçn√© naƒçten√≠ PDF-Lib
    if (!window.PDFLib) {
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js";
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    const { PDFDocument } = window.PDFLib;

    // üìé Naƒçten√≠ fotodokumentace z Base64
    const base64 = pdfData.split(",")[1];
    const bytes = atob(base64);
    const arr = new Uint8Array(bytes.length);
    for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
    const photosPdf = await PDFDocument.load(arr);
    const mainPdf = await PDFDocument.load(await doc.output("arraybuffer"));

    const copiedPages = await mainPdf.copyPages(photosPdf, photosPdf.getPageIndices());
    copiedPages.forEach((p) => mainPdf.addPage(p));

    const mergedBytes = await mainPdf.save();
    return new Blob([mergedBytes], { type: "application/pdf" });
  } catch (e) {
    console.error("‚ùå Chyba p≈ôi spojen√≠ PDF:", e);
    showNotif("error", "Nelze spojit PDF s fotkami");
    return doc;
  }
}

/* üíæ Export PDF (s podpisem a fotkami) */
async function exportPDF() {
  try {
    showNotif("success", "Generuji PDF...");
    const proto = await generateProtocolPDF();
    const merged = await mergeWithPhotos(proto);
    const blob = merged instanceof Blob ? merged : new Blob([proto.output("arraybuffer")]);
    const url = URL.createObjectURL(blob);

    // üì± iPhone / Android ‚Äì nab√≠dne ulo≈æen√≠
    if (/iPhone|iPad|Android/i.test(navigator.userAgent)) {
      const a = document.createElement("a");
      a.href = url;
      a.download = "WGS_protokol.pdf";
      a.click();
    } else {
      window.open(url, "_blank");
    }

    showNotif("success", "PDF √∫spƒõ≈°nƒõ vytvo≈ôeno");
  } catch (e) {
    console.error("‚ùå Chyba exportu PDF:", e);
    showNotif("error", "Chyba p≈ôi exportu PDF");
  }
}

/* üìß Odesl√°n√≠ z√°kazn√≠kovi */
async function mailCustomer() {
  try {
    const email = document.getElementById("email").value || "";
    if (!email) return showNotif("warning", "Nen√≠ uveden e-mail");

    const proto = await generateProtocolPDF();
    await mergeWithPhotos(proto);

    const subject = "Reklamaƒçn√≠ protokol White Glove Service";
    const body =
      "Dobr√Ω den,\n\nv p≈ô√≠loze zas√≠l√°me reklamaƒçn√≠ protokol s fotodokumentac√≠.\n\nS pozdravem,\nWHITE GLOVE SERVICE s.r.o.";
    showNotif("success", "Otev√≠r√°m po≈°tovn√≠ aplikaci...");
    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  } catch (e) {
    console.error("‚ùå Chyba odes√≠l√°n√≠ e-mailu:", e);
    showNotif("error", "Chyba p≈ôi odes√≠l√°n√≠ e-mailu");
  }
}
</script>
<!-- üü© KONEC SEKCE J -->


  <!-- üü® Sekce K ‚Äì Automatick√© naƒçten√≠ fotodokumentace z Worker -->
<script>
async function loadCustomerPhotosFromWorker(orderNumber) {
  try {
    const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/photocustomer", {
      cache: "no-store"
    });
    if (!res.ok) {
      console.warn("‚ö†Ô∏è Nelze naƒç√≠st photocustomer.json");
      return;
    }
    const all = await res.json();
    const record = all.find(r => r.cislo === orderNumber);
    if (!record || !record.file) return;

    const container = document.getElementById("photoPreviewContainer");
    const frame = document.getElementById("photoPreviewFrame");
    container.style.display = "block";
    frame.src = record.file;

    showNotif("success", "Fotodokumentace naƒçtena z Workeru");
  } catch (err) {
    console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ fotodokumentace:", err);
    showNotif("error", "Nelze naƒç√≠st fotodokumentaci");
  }
}

window.addEventListener("DOMContentLoaded", () => {
  // 1Ô∏è‚É£ Pokud u≈æ jsou data v localStorage, p≈ôeƒçti ƒç√≠slo objedn√°vky
  const data = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
  const orderNum =
    document.getElementById("order-number")?.value ||
    data.cislo ||
    "";

  // 2Ô∏è‚É£ Zkus naƒç√≠st fotky podle ƒç√≠sla objedn√°vky
  if (orderNum) {
    loadCustomerPhotosFromWorker(orderNum);
  }
});
</script>

</body>
</html>
