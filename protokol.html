<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol - White Glove Service</title>
<style>
body { font-family: Inter, sans-serif; background:#f6f7fb; margin:0; padding:20px; font-size:12px; display:flex; justify-content:center; }
.wrapper { width:100%; max-width:900px; background:white; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
.header { text-align:center; margin-bottom:20px; }
.header div:first-child { font-size:28px; font-weight:900; }
.header div:last-child { font-size:12px; margin-top:4px; font-weight:normal; }
table { width:100%; border-collapse:collapse; margin:10px 0; }
td { padding:6px; vertical-align:top; }
.label { font-weight:600; display:block; }
.label .en-label { display:block; font-size:0.85em; color:#666; font-weight:normal; margin:0; }
.section-title { font-weight:700; margin-top:20px; display:flex; flex-direction:column; align-items:flex-start; }
.section-title .en-label { font-size:0.9em; color:#666; font-weight:normal; margin-top:2px; }

input, select { width:100%; height:36px; line-height:36px; padding:4px 8px; font-size:1em; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; color:#111; background:#fff; }
textarea { width:100%; min-height:80px; resize:vertical; padding:4px 8px; font-size:1em; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; color:#111; background:#fff; }

.split-section { display:flex; gap:10px; margin:10px 0; }
.two-col-table { display:flex; gap:30px; flex-wrap:wrap; }
.two-col-table .col { flex:1; min-width:300px; }

#signature-pad { border:2px dashed #888; width:100%; height:200px; background:white; touch-action: none; }
.signature-label { font-size:0.9em; color:#444; margin:4px 0 20px; }

.btns { margin-top:20px; display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
.btns button { height:42px; font-size:0.9em; border:none; border-radius:8px; cursor:pointer; font-weight:600; color:white; box-shadow:0 2px 5px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; gap:8px; transition:transform 0.1s ease-in-out, box-shadow 0.2s; width:100%; }
.btns button:hover { transform:scale(1.02); box-shadow:0 4px 8px rgba(0,0,0,0.3); }

.btn-clear { background: linear-gradient(145deg, #7a0f0f, #ff4d4d, #a83232); }
.btn-back { background: linear-gradient(145deg, #808080, #dcdcdc, #a9a9a9); color:#000; }
.btn-back svg { width:20px; height:20px; fill:#000; }
.btn-pdf { background: linear-gradient(145deg, #004080, #1e90ff, #003366); }
.btn-email { background: linear-gradient(145deg, #006600, #28a745, #004d00); }

@media screen and (max-width:768px){
  .two-col-table, .split-section { flex-direction: column !important; gap:10px; }
  .two-col-table .col, .split-section textarea { min-width:auto; width:100%; }
  input, select, textarea { font-size:1em; height:36px; box-sizing:border-box; }
  textarea { min-height:80px; }
  #signature-pad { height:180px; }
}

.force-desktop { width:794px !important; max-width:794px !important; }
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO: 09769684</div>
  </div>

  <!-- FORMUL√Å≈òOV√â POLE JSOU ZACHOVAN√â (bez zmƒõn) -->
  <!-- ... cel√Ω obsah formul√°≈ôe jako d≈ô√≠v ... -->

  <div class="section-title">Podpis z√°kazn√≠ka<span class="en-label">Customer signature</span></div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>

  <div class="btns">
    <button class="btn-clear" type="button" onclick="signaturePad.clear()">üóëÔ∏è Vymazat podpis</button>
    <button class="btn-back" type="button" onclick="window.location.href='index.html'">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
      ZPƒöT
    </button>
    <button class="btn-pdf" type="button" onclick="downloadPDF()">üìÑ Exportovat do PDF</button>
    <button class="btn-email" type="button" onclick="saveAndMail()">‚úâÔ∏è Odeslat e-mail z√°kazn√≠kovi</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let signaturePad;
let lastPdfName = "protokol.pdf";

window.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("signature-pad");
  function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas, { passive: true });
  signaturePad = new SignaturePad(canvas, { backgroundColor: "white" });
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("visit-date").value = today;
  document.getElementById("sign-date").value = today;
});

function stripDiacritics(str){ return (str||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"_").replace(/[<>:"/\\|?*\u0000-\u001F]/g,"-"); }
function buildPdfFileName(){ 
  const today = new Date().toISOString().split("T")[0];
  const customer = stripDiacritics(document.getElementById("customer").value || "neznamy_zakaznik");
  const claim = stripDiacritics(document.getElementById("claim-number").value || "bez_claimu");
  const order = stripDiacritics(document.getElementById("order-number").value || "bez_objednavky");
  return `${customer}_${claim}_${order}_${today}.pdf`;
}

// ‚úÖ V≈ædy jen 1 str√°nka A4 ‚Äì obsah se zmen≈°√≠
function generatePdf(callback){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");
  const wrapper = document.querySelector(".wrapper");
  wrapper.classList.add("force-desktop");

  html2canvas(wrapper,{ 
      scale:2, 
      scrollX:0, 
      scrollY:0, 
      windowWidth:794, 
      windowHeight:wrapper.scrollHeight 
  }).then(canvas => {
      const imgData = canvas.toDataURL("image/jpeg",0.95);
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      const imgProps = doc.getImageProperties(imgData);
      const ratio = imgProps.width / imgProps.height;

      let pdfWidth = pageW;
      let pdfHeight = pdfWidth / ratio;

      if(pdfHeight > pageH){
        pdfHeight = pageH;
        pdfWidth = pdfHeight * ratio;
      }

      const x = (pageW - pdfWidth) / 2;
      const y = (pageH - pdfHeight) / 2;

      doc.addImage(imgData,"JPEG",x,y,pdfWidth,pdfHeight);

      if(signaturePad && !signaturePad.isEmpty()){
        doc.addImage(signaturePad.toDataURL("image/png"),"PNG",15,pageH-45,80,30);
      }

      lastPdfName = buildPdfFileName();
      doc.save(lastPdfName);

      wrapper.classList.remove("force-desktop");
      if(callback) callback();
  });
}

function downloadPDF(){ generatePdf(); }
function saveAndMail(){ openMailClient(); generatePdf(); }

function openMailClient(){
  const customer = document.getElementById("customer").value || "";
  const order = document.getElementById("order-number").value || "";
  const claim = document.getElementById("claim-number").value || "";
  const visitDate = document.getElementById("visit-date").value || "";
  const email = document.getElementById("email").value || "";
  const subject = `Reklamace Natuzzi - ${customer} (${order})`;
  const body = `Dobr√Ω den ${customer},\n\nzas√≠l√°me V√°m protokol z n√°v≈°tƒõvy technika.\n\nƒå√≠slo reklamace: ${claim}\nDatum n√°v≈°tƒõvy: ${visitDate}\n\nSoubor ${lastPdfName} byl ulo≈æen ‚Äì pros√≠m p≈ôilo≈æte jej do e-mailu jako p≈ô√≠lohu.\n\n=====================\nWHITE GLOVE SERVICE\n=====================\nDo Dubƒçe 364, Bƒõchovice 190 11\n+420 725 965 826\nreklamace-wgs@email.cz`;
  window.location.href=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}
</script>
</body>
</html>
