<!-- üü© ZAƒå√ÅTEK PROTOKOL.HTML ‚Äì ƒå√ÅST 1/3 -->
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol ‚Äì White Glove Service</title>

<style>
body {
  font-family: Inter, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:20px;
  font-size:12px;
  display:flex;
  justify-content:center;
}
.wrapper {
  width:100%;
  max-width:900px;
  background:white;
  padding:20px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  box-sizing:border-box;
}
.header {
  text-align:center;
  margin-bottom:20px;
  width:100%;
}
.header div:first-child {
  font-size:28px;
  font-weight:900;
}
.header div:last-child {
  font-size:12px;
  margin-top:4px;
  font-weight:normal;
}
table { width:100%; border-collapse:collapse; margin:10px 0; }
td { padding:6px; vertical-align:top; width:50%; }
.label { font-weight:600; display:block; text-align:left; }
.label .en-label { display:block; font-size:0.85em; color:#666; font-weight:normal; margin:0; }
.section-title { font-weight:700; margin-top:20px; width:100%; text-align:left; }
.section-title .en-label { font-size:0.9em; color:#666; font-weight:normal; margin-top:2px; }
input, select, textarea {
  width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:4px;
  font-size:1em; color:#111; background:#fff; box-sizing:border-box;
}
textarea { min-height:80px; resize:vertical; }
.two-col-table { display:flex; flex-direction:row; justify-content:space-between; gap:20px; width:100%; }
.two-col-table .col { flex:1; min-width:320px; }
.split-section { display:flex; gap:10px; width:100%; }
textarea[readonly] { background:#f7f7f7; color:#444; }
#signature-pad { border:2px dashed #888; width:100%; height:200px; background:white; touch-action:none; display:block; }
.btns {
  margin-top:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap:12px; width:100%;
}
button {
  height:44px; font-size:0.9em; border:none; border-radius:8px;
  cursor:pointer; font-weight:600; color:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
  transition:transform 0.1s ease-in-out, opacity 0.2s;
}
button:hover { transform:scale(1.03); opacity:0.9; }
@media screen and (max-width:768px){
  .two-col-table { flex-direction:column; }
  td { width:100%; display:block; }
  .split-section { flex-direction:column; }
  #signature-pad { height:180px; }
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO 09769684</div>
  </div>

<!-- üü© KONEC PROTOKOL.HTML ‚Äì ƒå√ÅST 1/3 -->
<!-- üü© ZAƒå√ÅTEK PROTOKOL.HTML ‚Äì ƒå√ÅST 2/3 -->

  <!-- üîπ Naƒçten√≠ √∫daj≈Ø z√°kazn√≠ka z localStorage -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    try {
      const d = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
      if (!d || Object.keys(d).length === 0) return;

      const map = {
        "order-number": d.cislo,
        "claim-number": d.reklamace || "",
        "customer": d.zakaznik,
        "address": d.adresa,
        "phone": d.telefon,
        "email": d.email,
        "brand": d.contract,
        "model": d.model
      };
      Object.entries(map).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el && val) el.value = val;
      });
    } catch (e) { console.error("Naƒçten√≠ dat z√°kazn√≠ka selhalo:", e); }
  });
  </script>

  <!-- üîπ Z√°kladn√≠ tabulky √∫daj≈Ø -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ƒå√≠slo objedn√°vky<span class="en-label">Order number</span></td><td><input id="order-number"></td></tr>
        <tr><td class="label">ƒå√≠slo reklamace<span class="en-label">Claim number</span></td><td><input id="claim-number"></td></tr>
        <tr><td class="label">Z√°kazn√≠k<span class="en-label">Customer</span></td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa z√°kazn√≠ka<span class="en-label">Customer address</span></td><td><input id="address"></td></tr>
        <tr><td class="label">Telefon<span class="en-label">Phone</span></td><td><input id="phone"></td></tr>
        <tr><td class="label">Email<span class="en-label">Email</span></td><td><input id="email"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik<span class="en-label">Technician</span></td><td><select id="technician"><option>Milan Kol√≠n</option><option>Radek Zikmund</option><option>Kol√≠n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum n√°v≈°tƒõvy<span class="en-label">Visit date</span></td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruƒçen√≠<span class="en-label">Delivery date</span></td><td><input id="delivery-date" type="date"></td></tr>
        <tr><td class="label">Datum pod√°n√≠ reklamace<span class="en-label">Complaint date</span></td><td><input id="claim-date" type="date"></td></tr>
        <tr><td class="label">Znaƒçka / Contract<span class="en-label">Brand / Contract</span></td><td><input id="brand"></td></tr>
        <tr><td class="label">Model<span class="en-label">Model</span></td><td><input id="model"></td></tr>
      </table>
    </div>
  </div>

  <!-- üîπ Popisy -->
  <div class="section-title">Z√°kazn√≠k reklamuje<span class="en-label">Customer complaint</span></div>
  <div class="split-section"><textarea id="description-cz" placeholder="CZ"></textarea><textarea id="description-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">Probl√©m zji≈°tƒõn√Ω technikem<span class="en-label">Detected problem</span></div>
  <div class="split-section"><textarea id="problem-cz" placeholder="CZ"></textarea><textarea id="problem-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">N√°vrh opravy<span class="en-label">Repair proposal</span></div>
  <div class="split-section"><textarea id="repair-cz" placeholder="CZ"></textarea><textarea id="repair-en" placeholder="EN" readonly></textarea></div>

  <!-- üîπ Ceny -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">Poƒçet opravovan√Ωch d√≠l≈Ø<span class="en-label">Number of repaired parts</span></td><td><input id="parts" type="number" min="0"></td></tr>
        <tr><td class="label">Cena za pr√°ci<span class="en-label">Work cost</span></td><td><input id="price-work" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za materi√°l<span class="en-label">Material cost</span></td><td><input id="price-material" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za druh√©ho technika<span class="en-label">Second technician cost</span></td><td><input id="price-second" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za dopravu<span class="en-label">Transport cost</span></td><td><input id="price-transport" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena celkem<span class="en-label">Total cost</span></td><td><input id="price-total" readonly></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Reklamace vy≈ôe≈°ena?<span class="en-label">Complaint solved?</span></td><td><select id="solved"><option>ANO</option><option>NE</option></select></td></tr>
        <tr><td class="label">ƒåek√° se na vyj√°d≈ôen√≠ prodejce?<span class="en-label">Waiting for dealer?</span></td><td><select id="dealer"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Po≈°kozen√≠ technikem?<span class="en-label">Damage by technician?</span></td><td><select id="damage"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">√öhradu provede z√°kazn√≠k?<span class="en-label">Customer will pay?</span></td><td><select id="payment"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Datum podpisu<span class="en-label">Signature date</span></td><td><input id="sign-date" type="date"></td></tr>
      </table>
    </div>
  </div>

  <script>
  function updateTotal() {
    const w=parseFloat(priceWork.value)||0,m=parseFloat(priceMaterial.value)||0,
          s=parseFloat(priceSecond.value)||0,t=parseFloat(priceTransport.value)||0;
    priceTotal.value=(w+m+s+t).toFixed(2);
  }
  const priceWork=document.getElementById("price-work"),
        priceMaterial=document.getElementById("price-material"),
        priceSecond=document.getElementById("price-second"),
        priceTransport=document.getElementById("price-transport"),
        priceTotal=document.getElementById("price-total");
  </script>

  <!-- üîπ Podpis -->
  <div class="section-title">Podpis z√°kazn√≠ka<span class="en-label">Customer signature</span></div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>

  <!-- üîπ Tlaƒç√≠tka -->
  <div class="btns">
    <button type="button" onclick="signaturePad.clear()">Vymazat podpis</button>
    <button type="button" onclick="window.location.href='index.html'">Zpƒõt</button>
    <button type="button" onclick="attachPhotos()">P≈ôidat fotky</button>
    <button type="button" onclick="exportPDF()">Exportovat PDF</button>
    <button type="button" onclick="mailCustomer()">Odeslat z√°kazn√≠kovi</button>
  </div>

  <!-- üîπ N√°hled fotek -->
  <div id="photoPreviewContainer" style="display:none;margin-top:20px;width:100%;">
    <h3 style="font-size:1em;font-weight:700;margin-bottom:10px;">üì∑ P≈ôipojen√° fotodokumentace</h3>
    <iframe id="photoPreviewFrame" style="width:100%;height:480px;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);"></iframe>
  </div>

  <!-- üîπ Notifikace -->
  <div id="notif" class="notif"></div>
  <style>
  .notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:linear-gradient(135deg,#00b56a,#00da80);color:#fff;
  padding:10px 20px;border-radius:8px;font-weight:600;font-size:0.9em;
  box-shadow:0 3px 10px rgba(0,0,0,0.2);opacity:0;transition:opacity .3s,transform .3s;
  z-index:3000;}
  .notif.show{opacity:1;transform:translate(-50%,10px);}
  .notif.error{background:linear-gradient(135deg,#e63946,#ff6b6b);}
  .notif.warning{background:linear-gradient(135deg,#ffb200,#ffca40);color:#222;}
  </style>
  <script>
  function showNotif(type="success",text="Hotovo"){
    const n=document.getElementById("notif");
    n.className=`notif ${type}`;
    n.textContent=text;
    n.classList.add("show");
    clearTimeout(window._notifTimer);
    window._notifTimer=setTimeout(()=>n.classList.remove("show"),2500);
  }
  </script>

<!-- üü© KONEC PROTOKOL.HTML ‚Äì ƒå√ÅST 2/3 -->
<!-- üü© ZAƒå√ÅTEK PROTOKOL.HTML ‚Äì ƒå√ÅST 3/3 -->

<!-- üì¶ Extern√≠ knihovny -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- üü© Inicializace podpisu -->
<script>
let signaturePad;
window.addEventListener("load",()=>{
  const canvas=document.getElementById("signature-pad");
  if(!canvas)return;
  function resizeCanvas(){
    const ratio=Math.max(window.devicePixelRatio||1,1);
    canvas.width=canvas.offsetWidth*ratio;
    canvas.height=canvas.offsetHeight*ratio;
    canvas.getContext("2d").scale(ratio,ratio);
  }
  window.addEventListener("resize",resizeCanvas);
  resizeCanvas();
  signaturePad=new SignaturePad(canvas,{minWidth:1,maxWidth:2,penColor:"black",backgroundColor:"white"});
});
</script>

<!-- üü© P≈ôeklad CZ ‚Üí EN -->
<script>
async function translateCZtoEN(text){
  if(!text.trim())return"";
  try{
    const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=cs|en`);
    const j=await r.json();
    return j.responseData?.translatedText||"";
  }catch{return"";}
}
function initTranslator(prefix){
  const cz=document.getElementById(`${prefix}-cz`);
  const en=document.getElementById(`${prefix}-en`);
  if(!cz||!en)return;
  let t;
  cz.addEventListener("input",()=>{
    clearTimeout(t);
    if(!cz.value.trim()){en.value="";return;}
    en.value="‚è≥ P≈ôekl√°d√°m...";
    t=setTimeout(async()=>{en.value=await translateCZtoEN(cz.value);},700);
  });
}
window.addEventListener("load",()=>["description","problem","repair"].forEach(initTranslator));
</script>

<!-- üü© P≈ôipojen√≠ fotodokumentace -->
<script>
let attachedPhotos=null;
function attachPhotos(){
  const pdf=localStorage.getItem("photoPdfData");
  const box=document.getElementById("photoPreviewContainer");
  const frame=document.getElementById("photoPreviewFrame");
  if(!pdf){showNotif("warning","≈Ω√°dn√© fotky nebyly nalezeny");box.style.display="none";return;}
  attachedPhotos=pdf;box.style.display="block";frame.src=pdf;
  showNotif("success","Fotodokumentace p≈ôipojena");
}
</script>

<!-- üü© GENEROV√ÅN√ç PDF ‚Äì jedna str√°nka, podpis vlo≈æen dole -->
<script>
async function generateProtocolPDF(){
  const {jsPDF}=window.jspdf;
  const wrapper=document.querySelector(".wrapper");
  const doc=new jsPDF("p","mm","a4");

  const btns=document.querySelector(".btns");
  const prevVis=btns.style.visibility;
  btns.style.visibility="hidden";

  const canvas=await html2canvas(wrapper,{scale:3,backgroundColor:"#fff",ignoreElements:(el)=>el.id==="notif"});
  const img=canvas.toDataURL("image/jpeg",0.98);
  doc.addImage(img,"JPEG",0,0,210,297);
  btns.style.visibility=prevVis;

  // podpis do spodn√≠ ƒç√°sti
  if(signaturePad&&!signaturePad.isEmpty()){
    const sig=signaturePad.toDataURL("image/png");
    doc.addImage(sig,"PNG",40,235,120,40);
  }
  return doc;
}
</script>

<!-- üü© EXPORT + ODESL√ÅN√ç + P≈òESUN DO HOTOV√â -->
<script>
async function exportPDF(){
  try{
    showNotif("success","Generuji PDF...");
    const proto=await generateProtocolPDF();
    const blob=new Blob([await proto.output("arraybuffer")],{type:"application/pdf"});
    const url=URL.createObjectURL(blob);
    window.open(url,"_blank");
    showNotif("success","PDF vytvo≈ôeno");
    await moveToHotove();
  }catch(e){console.error(e);showNotif("error","Chyba exportu PDF");}
}

async function mailCustomer(){
  try{
    const email=document.getElementById("email").value||"";
    if(!email)return showNotif("warning","Nen√≠ uveden e-mail");
    await generateProtocolPDF();
    const subject="Reklamaƒçn√≠ protokol White Glove Service";
    const body="Dobr√Ω den,\n\nv p≈ô√≠loze zas√≠l√°me reklamaƒçn√≠ protokol.\n\nS pozdravem,\nWhite Glove Service s.r.o.";
    window.location.href=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    showNotif("success","Otev√≠r√°m po≈°tovn√≠ aplikaci...");
    await moveToHotove();
  }catch(e){console.error(e);showNotif("error","Chyba p≈ôi odes√≠l√°n√≠ e-mailu");}
}

/* üîÅ Automatick√Ω p≈ôesun hotov√© reklamace */
async function moveToHotove(){
  try{
    const d=JSON.parse(localStorage.getItem("currentCustomer")||"{}");
    if(!d.cislo)return;
    const record={...d,stav:"hotovo",moved:new Date().toISOString()};
    await fetch("https://wgs-token.72nvwf4pb2.workers.dev/hotove",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({record})
    });
    console.log("‚úÖ Reklamace p≈ôesunuta do hotove.json");
  }catch(e){console.warn("‚ö†Ô∏è Nelze p≈ôesunout do hotov√Ωch:",e);}
}
</script>

<!-- üü© KONEC PROTOKOL.HTML ‚Äì ƒå√ÅST 3/3 -->
</div> <!-- konec wrapperu -->
</body>
</html>
