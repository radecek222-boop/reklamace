<div class="btns">
  <button class="btn-clear" type="button" onclick="signaturePad.clear()">ğŸ—‘ï¸ Vymazat podpis</button>
  <button class="btn-back" type="button" onclick="window.location.href='index.html'">â¬…ï¸ ZPÄšT</button>
  <button class="btn-pdf" type="button" onclick="downloadPDF()">ğŸ“„ Exportovat do PDF</button>
  <button class="btn-send" type="button" onclick="sendToServer()">ğŸ“¨ Odeslat zÃ¡kaznÃ­kovi</button>
  <button class="btn-test" type="button" onclick="testPing()">ğŸ” Otestovat spojenÃ­ (POST)</button>
</div>

<div id="status-message"></div>

<script>
  function testPing() {
    fetch("https://script.google.com/macros/s/AKfycbyYjzbOeJ85bzRnBnBXKMeMwTZi7gHQ_RymOVbgAFobuJ3wsHWqpY0P1e14B5xDDZrmjg/exec", {
      method: "POST",
      body: JSON.stringify({ test: true }),
      headers: { "Content-Type": "application/json" }
    })
    .then(res => res.text())
    .then(txt => {
      const statusEl = document.getElementById("status-message");
      statusEl.style.color = "green";
      statusEl.innerText = "âœ… SpojenÃ­ OK (POST): " + txt;
    })
    .catch(err => {
      const statusEl = document.getElementById("status-message");
      statusEl.style.color = "red";
      statusEl.innerText = "âŒ SpojenÃ­ selhalo: " + err;
    });
  }

  function sendToServer() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");
    const wrapper = document.querySelector(".wrapper");
    wrapper.classList.add("force-desktop");

    html2canvas(wrapper, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      doc.addImage(imgData, "PNG", 0, 0, 210, 297);

      if (signaturePad && !signaturePad.isEmpty()) {
        const signData = signaturePad.toDataURL("image/png");
        doc.addImage(signData, "PNG", 15, 260, 80, 30);
      }

      const pdfBase64 = doc.output("datauristring").split(",")[1];
      const customer = document.getElementById("customer")?.value || "";
      const order = document.getElementById("order-number")?.value || "";
      const email = document.getElementById("email")?.value || "";

      fetch("https://script.google.com/macros/s/AKfycbyYjzbOeJ85bzRnBnBXKMeMwTZi7gHQ_RymOVbgAFobuJ3wsHWqpY0P1e14B5xDDZrmjg/exec", {
        method: "POST",
        body: JSON.stringify({
          to: email,
          subject: `Reklamace Natuzzi - ${customer} (${order})`,
          body: `DobrÃ½ den ${customer},\n\nzasÃ­lÃ¡me vÃ¡m protokol z nÃ¡vÅ¡tÄ›vy technika.\n\n=====================\nWHITE GLOVE SERVICE\n=====================\nDo DubÄe 364, BÄ›chovice 190 11\n+420 725 965 826\nreklamace-wgs@email.cz`,
          filename: `Protokol_${order}.pdf`,
          pdf: pdfBase64
        }),
        headers: { "Content-Type": "application/json" }
      })
      .then(res => res.text())
      .then(msg => {
        const statusEl = document.getElementById("status-message");
        if (msg.includes("OK")) {
          statusEl.style.color = "green";
          statusEl.innerText = "âœ… Email byl odeslÃ¡n a PDF uloÅ¾en do sloÅ¾ky ODESLANÃ‰ PROTOKOLY.";
        } else {
          statusEl.style.color = "red";
          statusEl.innerText = "âš ï¸ OdpovÄ›Ä serveru: " + msg;
        }
      })
      .catch(err => {
        const statusEl = document.getElementById("status-message");
        statusEl.style.color = "red";
        statusEl.innerText = "âŒ Chyba pÅ™i odesÃ­lÃ¡nÃ­: " + err;
      });

      wrapper.classList.remove("force-desktop");
    });
  }
</script>
