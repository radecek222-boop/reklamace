<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol â€“ White Glove Service</title>

<style>
body {
  font-family: Inter, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:20px;
  font-size:12px;
  display:flex;
  justify-content:center;
}
.wrapper {
  width:100%;
  max-width:900px;
  background:white;
  padding:20px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  box-sizing:border-box;
}
.header {
  text-align:center;
  margin-bottom:20px;
  width:100%;
}
.header div:first-child {
  font-size:28px;
  font-weight:900;
}
.header div:last-child {
  font-size:12px;
  margin-top:4px;
  font-weight:normal;
}
table {
  width:100%;
  border-collapse:collapse;
  margin:10px 0;
}
td { 
  padding:6px; 
  vertical-align:top;
  width:50%;
}
.label { 
  font-weight:600; 
  display:block; 
  text-align:left;
}
.label .en-label { 
  display:block; 
  font-size:0.85em; 
  color:#666; 
  font-weight:normal; 
  margin:0;
}
.section-title { 
  font-weight:700; 
  margin-top:20px; 
  width:100%;
  text-align:left;
}
.section-title .en-label { 
  font-size:0.9em; 
  color:#666; 
  font-weight:normal; 
  margin-top:2px;
}
input, select, textarea {
  width:100%; 
  padding:6px 8px;
  border:1px solid #ccc; 
  border-radius:4px;
  font-size:1em; 
  color:#111; 
  background:#fff;
  box-sizing:border-box;
}
textarea { 
  min-height:80px; 
  resize:vertical;
}
.two-col-table {
  display:flex;
  flex-direction:row;
  justify-content:space-between;
  gap:20px;
  width:100%;
}
.two-col-table .col {
  flex:1;
  min-width:320px;
}
.split-section {
  display:flex;
  gap:10px;
  width:100%;
}
textarea[readonly] {
  background:#f7f7f7;
  color:#444;
}
#signature-pad {
  border:2px dashed #888;
  width:100%;
  height:200px;
  background:white;
  touch-action:none;
  display:block;
}
.btns {
  margin-top:20px;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap:12px;
  width:100%;
}
button {
  height:44px; 
  font-size:0.9em; 
  border:none; 
  border-radius:8px;
  cursor:pointer; 
  font-weight:600; 
  color:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
  transition:transform 0.1s ease-in-out, opacity 0.2s;
}
button:hover { transform:scale(1.03); opacity:0.9; }

@media screen and (max-width:768px){
  .two-col-table { flex-direction:column; }
  td { width:100%; display:block; }
  .split-section { flex-direction:column; }
  #signature-pad { height:180px; }
}
</style>
</head>
  
<body>

<!-- ğŸŸ© SEKCE A â€“ AUTOMATICKÃ‰ NAÄŒTENÃ ÃšDAJÅ® ZÃKAZNÃKA (Z LOCALSTORAGE) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  try {
    const raw = JSON.parse(localStorage.getItem("protokolData") || "{}");
    const data = raw.data || raw; // ğŸŸ¢ podpora obou formÃ¡tÅ¯ (temporaryfiles.json i pÅ¯vodnÃ­)

    if (!data || Object.keys(data).length === 0) {
      console.warn("âš ï¸ Nebyla nalezena data zÃ¡kaznÃ­ka v localStorage");
      return;
    }

    // ğŸ”¹ Propis zÃ¡kladnÃ­ch ÃºdajÅ¯ do protokolu
    const map = {
      "order-number": data.cislo || "",
      "claim-number": data.reklamace || "",
      "customer": data.zakaznik || "",
      "address": data.adresa || "",
      "phone": data.telefon || "",
      "email": data.email || "",
      "brand": data.contract || "",
      "model": data.model || "",
      "visit-date": data.datum || "",
      "delivery-date": data.datum_doruceni || "",
      "claim-date": data.datum_reklamace || ""
    };

    Object.entries(map).forEach(([id, val]) => {
      const el = document.getElementById(id);
      if (el && val) el.value = val;
    });

    console.log("âœ… Ãšdaje zÃ¡kaznÃ­ka naÄteny do protokolu:", data);
  } catch (err) {
    console.error("âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ dat zÃ¡kaznÃ­ka:", err);
  }
});
</script>
<!-- ğŸŸ© KONEC SEKCE A -->


<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do DubÄe 364, BÄ›chovice 190 11 Â· +420 725 965 826 Â· reklamace-wgs@email.cz Â· IÄŒO 09769684</div>
  </div>

  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ÄŒÃ­slo objednÃ¡vky<span class="en-label">Order number</span></td><td><input id="order-number"></td></tr>
        <tr><td class="label">ÄŒÃ­slo reklamace<span class="en-label">Claim number</span></td><td><input id="claim-number"></td></tr>
        <tr><td class="label">ZÃ¡kaznÃ­k<span class="en-label">Customer</span></td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa zÃ¡kaznÃ­ka<span class="en-label">Customer address</span></td><td><input id="address"></td></tr>
        <tr><td class="label">Telefon<span class="en-label">Phone</span></td><td><input id="phone"></td></tr>
        <tr><td class="label">Email<span class="en-label">Email</span></td><td><input id="email"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik<span class="en-label">Technician</span></td><td><select id="technician"><option>Milan KolÃ­n</option><option>Radek Zikmund</option><option>KolÃ­n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum nÃ¡vÅ¡tÄ›vy<span class="en-label">Visit date</span></td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruÄenÃ­<span class="en-label">Delivery date</span></td><td><input id="delivery-date" type="date"></td></tr>
        <tr><td class="label">Datum podÃ¡nÃ­ reklamace<span class="en-label">Complaint date</span></td><td><input id="claim-date" type="date"></td></tr>
        <tr><td class="label">ZnaÄka / Contract<span class="en-label">Brand / Contract</span></td><td><input id="brand"></td></tr>
        <tr><td class="label">Model<span class="en-label">Model</span></td><td><input id="model"></td></tr>
      </table>
    </div>
  </div>

  <div class="section-title">ZÃ¡kaznÃ­k reklamuje<span class="en-label">Customer complaint</span></div>
  <div class="split-section"><textarea id="description-cz" placeholder="CZ"></textarea><textarea id="description-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">ProblÃ©m zjiÅ¡tÄ›nÃ½ technikem<span class="en-label">Detected problem</span></div>
  <div class="split-section"><textarea id="problem-cz" placeholder="CZ"></textarea><textarea id="problem-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">NÃ¡vrh opravy<span class="en-label">Repair proposal</span></div>
  <div class="split-section"><textarea id="repair-cz" placeholder="CZ"></textarea><textarea id="repair-en" placeholder="EN" readonly></textarea></div>
  <!-- ğŸŸ¨ Sekce E â€“ Ceny a stavy -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">PoÄet opravovanÃ½ch dÃ­lÅ¯<span class="en-label">Number of repaired parts</span></td><td><input id="parts" type="number" min="0"></td></tr>
        <tr><td class="label">Cena za prÃ¡ci<span class="en-label">Work cost</span></td><td><input id="price-work" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za materiÃ¡l<span class="en-label">Material cost</span></td><td><input id="price-material" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za druhÃ©ho technika<span class="en-label">Second technician cost</span></td><td><input id="price-second" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena za dopravu<span class="en-label">Transport cost</span></td><td><input id="price-transport" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Cena celkem<span class="en-label">Total cost</span></td><td><input id="price-total" readonly></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Reklamace vyÅ™eÅ¡ena?<span class="en-label">Complaint solved?</span></td><td><select id="solved"><option>ANO</option><option>NE</option></select></td></tr>
        <tr><td class="label">ÄŒekÃ¡ se na vyjÃ¡dÅ™enÃ­ prodejce?<span class="en-label">Waiting for dealer?</span></td><td><select id="dealer"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">PoÅ¡kozenÃ­ technikem?<span class="en-label">Damage by technician?</span></td><td><select id="damage"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Ãšhradu provede zÃ¡kaznÃ­k?<span class="en-label">Customer will pay?</span></td><td><select id="payment"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Datum podpisu<span class="en-label">Signature date</span></td><td><input id="sign-date" type="date"></td></tr>
      </table>
    </div>
  </div>

  <script>
  function updateTotal() {
    const work = parseFloat(priceWork.value) || 0;
    const material = parseFloat(priceMaterial.value) || 0;
    const second = parseFloat(priceSecond.value) || 0;
    const transport = parseFloat(priceTransport.value) || 0;
    priceTotal.value = (work + material + second + transport).toFixed(2);
  }
  const priceWork=document.getElementById("price-work");
  const priceMaterial=document.getElementById("price-material");
  const priceSecond=document.getElementById("price-second");
  const priceTransport=document.getElementById("price-transport");
  const priceTotal=document.getElementById("price-total");
  </script>

 
<!-- ğŸŸ¨ Sekce F â€“ Podpis a tlaÄÃ­tka -->
<div class="section-title">Podpis zÃ¡kaznÃ­ka<span class="en-label">Customer signature</span></div>
<canvas id="signature-pad"></canvas>
<div class="signature-label">PodepiÅ¡te se prstem nebo myÅ¡Ã­</div>

<div class="btns">
  <button class="btn-clear" type="button" onclick="signaturePad.clear()">Vymazat podpis</button>
  <button class="btn-back" type="button" onclick="window.location.href='index.html'">ZpÄ›t</button>
  <button class="btn-photos" type="button" onclick="attachPhotos()">PÅ™idat fotky</button>
  <button class="btn-pdf" type="button" onclick="exportPDF()">Exportovat PDF</button>
  <button class="btn-email" type="button" onclick="mailCustomer()">Odeslat zÃ¡kaznÃ­kovi</button>
</div>

<!-- ğŸŸ© NÃ¡hled pÅ™ipojenÃ½ch fotek -->
<div id="photoPreviewContainer" style="display:none;margin-top:20px;width:100%;">
  <h3 style="font-size:1em;font-weight:700;margin-bottom:10px;">ğŸ“· PÅ™ipojenÃ¡ fotodokumentace</h3>
  <iframe id="photoPreviewFrame"
          style="width:100%;height:480px;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);"></iframe>
</div>

<!-- ğŸŸ¨ Sekce G â€“ Notifikace -->
<div id="notif" class="notif"></div>
<style>
.notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);
background:linear-gradient(135deg,#00b56a,#00da80);color:#fff;
padding:10px 20px;border-radius:8px;font-weight:600;font-size:0.9em;
box-shadow:0 3px 10px rgba(0,0,0,0.2);opacity:0;transition:opacity .3s,transform .3s;
z-index:3000;}
.notif.show{opacity:1;transform:translate(-50%,10px);}
.notif.error{background:linear-gradient(135deg,#e63946,#ff6b6b);}
.notif.warning{background:linear-gradient(135deg,#ffb200,#ffca40);color:#222;}
</style>
<script>
function showNotif(type="success",text="Hotovo"){
 const n=document.getElementById("notif");
 n.className=`notif ${type}`;
 n.textContent=text;
 n.classList.add("show");
 clearTimeout(window._notifTimer);
 window._notifTimer=setTimeout(()=>n.classList.remove("show"),2500);
}
</script>

<!-- ğŸŸ¨ Sekce H â€“ ExternÃ­ knihovny -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- ğŸŸ¨ Sekce I â€“ PÅ™ekladaÄ CZ â†’ EN (obnovenÃ¡ funkÄnost) -->
<script>
async function translateCZtoEN(text) {
  if (!text.trim()) return "";
  try {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=cs|en`;
    const res = await fetch(url);
    const data = await res.json();
    return data.responseData?.translatedText || "";
  } catch (e) {
    console.warn("âš ï¸ PÅ™eklad selhal:", e.message);
    return "";
  }
}

function initTranslator(prefix) {
  const cz = document.getElementById(`${prefix}-cz`);
  const en = document.getElementById(`${prefix}-en`);
  if (!cz || !en) return;
  let t;
  cz.addEventListener("input", () => {
    clearTimeout(t);
    if (!cz.value.trim()) { en.value = ""; return; }
    en.value = "â³ PÅ™eklÃ¡dÃ¡m...";
    t = setTimeout(async () => {
      en.value = await translateCZtoEN(cz.value);
    }, 700);
  });
}

/* ğŸŸ© Inicializace pÅ™ekladaÄe po naÄtenÃ­ strÃ¡nky */
window.addEventListener("load", () => {
  ["description", "problem", "repair"].forEach(initTranslator);
});
</script>


<!-- ğŸŸ¨ Sekce J â€“ GenerovÃ¡nÃ­ + podpis + export PDF + spojenÃ­ s fotkami (v1 s bloky J-Aâ€“G) -->
<script>

/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU J-A â€“ Inicializace podpisu */
let signaturePad;
window.addEventListener("load", () => {
  const canvas = document.getElementById("signature-pad");
  if (!canvas) return;

  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  signaturePad = new SignaturePad(canvas, {
    minWidth: 1,
    maxWidth: 2,
    penColor: "black",
    backgroundColor: "white",
  });
});
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU J-A â€“ Inicializace podpisu */


/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU J-B â€“ PomocnÃ¡ funkce pro notifikace */
function showNotif(type = "success", text = "Hotovo") {
  const n = document.getElementById("notif");
  if (!n) return;
  n.className = `notif ${type}`;
  n.textContent = text;
  n.classList.add("show");
  clearTimeout(window._notifTimer);
  window._notifTimer = setTimeout(() => n.classList.remove("show"), 2500);
}
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU J-B â€“ PomocnÃ¡ funkce pro notifikace */


/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU J-C â€“ PÅ™ipojenÃ­ fotodokumentace */
let attachedPhotos = null;
function attachPhotos() {
  const photoPdfData = localStorage.getItem("photoPdfData");
  const preview = document.getElementById("photoPreviewContainer");
  const frame = document.getElementById("photoPreviewFrame");

  if (!photoPdfData) {
    showNotif("warning", "Å½Ã¡dnÃ© fotky nebyly nalezeny");
    preview.style.display = "none";
    return;
  }
  attachedPhotos = photoPdfData;
  preview.style.display = "block";
  frame.src = photoPdfData;
  showNotif("success", "Fotodokumentace pÅ™ipojena");
}
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU J-C â€“ PÅ™ipojenÃ­ fotodokumentace */


/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU J-D â€“ GenerovÃ¡nÃ­ PDF protokolu */
async function generateProtocolPDF() {
  const { jsPDF } = window.jspdf;
  const wrapper = document.querySelector(".wrapper");
  const doc = new jsPDF("p", "mm", "a4");

  const btns = document.querySelector(".btns");
  const vis = btns.style.visibility;
  btns.style.visibility = "hidden";

  const canvas = await html2canvas(wrapper, { scale: 3, backgroundColor: "#fff" });
  const imgData = canvas.toDataURL("image/jpeg", 0.98);
  doc.addImage(imgData, "JPEG", 0, 0, 210, 297);
  btns.style.visibility = vis;

  // âœï¸ Podpis uÅ¾ je zahrnut v HTML (canvas je souÄÃ¡stÃ­ wrapperu)
  // NenÃ­ potÅ™eba pÅ™idÃ¡vat novou strÃ¡nku ani samostatnÄ› vklÃ¡dat podpis

  return doc;
}
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU J-D â€“ GenerovÃ¡nÃ­ PDF protokolu */



/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU J-E â€“ SpojenÃ­ PDF s fotkami */
async function mergeWithPhotos(doc) {
  try {
    let pdfData = attachedPhotos;

    if (!pdfData) {
      const data = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
     const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/photocustomer", { cache: "no-store" });
if (res.ok) {
  const all = await res.json();
  const arr = Array.isArray(all) ? all : all.data || [];
  const record = arr.find(r => r.cislo === data.cislo);
  if (record && record.file) pdfData = record.file;
}

    }

    if (!pdfData) {
      console.warn("âš ï¸ Å½Ã¡dnÃ¡ fotodokumentace pro spojenÃ­ PDF");
      return doc;
    }

    if (!window.PDFLib) {
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js";
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    const { PDFDocument } = window.PDFLib;
    const base64 = pdfData.split(",")[1];
    const bytes = atob(base64);
    const arr = new Uint8Array(bytes.length);
    for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
    const photosPdf = await PDFDocument.load(arr);
    const mainPdf = await PDFDocument.load(await doc.output("arraybuffer"));

    const copiedPages = await mainPdf.copyPages(photosPdf, photosPdf.getPageIndices());
    copiedPages.forEach(p => mainPdf.addPage(p));

    const mergedBytes = await mainPdf.save();
    return new Blob([mergedBytes], { type: "application/pdf" });
  } catch (e) {
    console.error("âŒ Chyba pÅ™i spojenÃ­ PDF:", e);
    showNotif("error", "Nelze spojit PDF s fotkami");
    return doc;
  }
}
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU J-E â€“ SpojenÃ­ PDF s fotkami */


/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU J-F â€“ Export PDF + oznaÄenÃ­ hotovo */
async function exportPDF() {
  try {
    showNotif("success", "Generuji PDF...");
    const proto = await generateProtocolPDF();
    const merged = await mergeWithPhotos(proto);
    const blob = merged instanceof Blob ? merged : new Blob([proto.output("arraybuffer")]);
    const url = URL.createObjectURL(blob);

    if (/iPhone|iPad|Android/i.test(navigator.userAgent)) {
      const a = document.createElement("a");
      a.href = url;
      a.download = "WGS_protokol.pdf";
      a.click();
    } else {
      window.open(url, "_blank");
    }

    // ğŸŸ¢ OznaÄit jako hotovo po exportu
    try {
      const data = JSON.parse(localStorage.getItem("protokolData") || "{}");
      if (data.cislo) {
        data.stav = "hotovo";
        await fetch("https://wgs-token.72nvwf4pb2.workers.dev/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "update", record: data })
        });
        console.log("âœ… Reklamace oznaÄena jako hotovÃ¡:", data.cislo);
      }
    } catch (err) {
      console.warn("âš ï¸ Nelze uloÅ¾it stav hotovo:", err);
    }

    showNotif("success", "PDF ÃºspÄ›Å¡nÄ› vytvoÅ™eno");
  } catch (e) {
    console.error("âŒ Chyba exportu PDF:", e);
    showNotif("error", "Chyba pÅ™i exportu PDF");
  }
}
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU J-F â€“ Export PDF + oznaÄenÃ­ hotovo */



/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU J-G â€“ OdeslÃ¡nÃ­ zÃ¡kaznÃ­kovi + oznaÄenÃ­ hotovo */
async function mailCustomer() {
  try {
    const email = document.getElementById("email").value || "";
    if (!email) return showNotif("warning", "NenÃ­ uveden e-mail");

    const proto = await generateProtocolPDF();
    await mergeWithPhotos(proto);

    // ğŸŸ¢ OznaÄit jako hotovo po odeslÃ¡nÃ­
    try {
      const data = JSON.parse(localStorage.getItem("protokolData") || "{}");
      if (data.cislo) {
        data.stav = "hotovo";
        await fetch("https://wgs-token.72nvwf4pb2.workers.dev/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "update", record: data })
        });
        console.log("âœ… Reklamace oznaÄena jako hotovÃ¡:", data.cislo);
      }
    } catch (err) {
      console.warn("âš ï¸ Nelze uloÅ¾it stav hotovo:", err);
    }

    const subject = "ReklamaÄnÃ­ protokol White Glove Service";
    const body =
      "DobrÃ½ den,\n\nv pÅ™Ã­loze zasÃ­lÃ¡me reklamaÄnÃ­ protokol s fotodokumentacÃ­.\n\nS pozdravem,\nWHITE GLOVE SERVICE s.r.o.";
    showNotif("success", "OtevÃ­rÃ¡m poÅ¡tovnÃ­ aplikaci...");
    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  } catch (e) {
    console.error("âŒ Chyba odesÃ­lÃ¡nÃ­ e-mailu:", e);
    showNotif("error", "Chyba pÅ™i odesÃ­lÃ¡nÃ­ e-mailu");
  }
}
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU J-G */
/* ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ ZAÄŒÃTEK BLOKU WAIT-DIALOG */

</script>
<style>
#waitOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}
#waitBox {
  background: white;
  padding: 30px 40px;
  border-radius: 12px;
  text-align: center;
  font-family: "Inter", sans-serif;
  font-size: 1.1em;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}
.wait-spinner {
  border: 4px solid #eee;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  margin: 0 auto 15px;
  animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<div id="waitOverlay">
  <div id="waitBox">
    <div class="wait-spinner"></div>
    <div id="waitText">ÄŒekejte na odpovÄ›Ä ze serveru...</div>
  </div>
</div>

<script>
function showWait(text="ÄŒekejte na odpovÄ›Ä ze serveru...") {
  const overlay = document.getElementById("waitOverlay");
  const t = document.getElementById("waitText");
  t.innerText = text;
  overlay.style.display = "flex";
}
function hideWait(success=true) {
  const overlay = document.getElementById("waitOverlay");
  const box = document.getElementById("waitBox");
  const t = document.getElementById("waitText");

  // âœ… zelenÃ¡ fajfka nebo âŒ ÄervenÃ½ kÅ™Ã­Å¾

  box.innerHTML = success
    ? "<div style='font-size:50px;color:#28a745;'>âœ…</div><div>Hotovo</div>"
    : "<div style='font-size:50px;color:#e63946;'>âŒ</div><div>Chyba pÅ™i uklÃ¡dÃ¡nÃ­</div>";

  setTimeout(() => {
    overlay.style.display = "none";
    box.innerHTML = `<div class="wait-spinner"></div><div id="waitText">ÄŒekejte na odpovÄ›Ä ze serveru...</div>`;
  }, 2500);
}
</script>

<!-- ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ğŸŸ¨ KONEC BLOKU WAIT-DIALOG -->

<!-- ğŸŸ¨ Sekce K â€“ AutomatickÃ© naÄtenÃ­ fotodokumentace z Worker -->
<script>
async function loadCustomerPhotosFromWorker(orderNumber) {
  try {
    const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/photocustomer", {
      cache: "no-store"
    });
    if (!res.ok) {
      console.warn("âš ï¸ Nelze naÄÃ­st photocustomer.json");
      return;
    }
  
  const all = await res.json();
const arr = Array.isArray(all) ? all : all.records || [];

const record = arr.find(r => r.cislo === orderNumber);
if (!record || !record.file) {
  console.warn("âš ï¸ Fotodokumentace pro tuto objednÃ¡vku nebyla nalezena");
  return;
}

const container = document.getElementById("photoPreviewContainer");
const frame = document.getElementById("photoPreviewFrame");
container.style.display = "block";
frame.src = record.file;

showNotif("success", "Fotodokumentace naÄtena z Workeru");
  } catch (err) {
    console.error("âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ fotodokumentace:", err);
    showNotif("error", "Nelze naÄÃ­st fotodokumentaci");
  }
}

window.addEventListener("DOMContentLoaded", () => {
  // 1ï¸âƒ£ Pokud uÅ¾ jsou data v localStorage, pÅ™eÄti ÄÃ­slo objednÃ¡vky
  const data = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
  const orderNum =
    document.getElementById("order-number")?.value ||
    data.cislo ||
    "";

  // 2ï¸âƒ£ Zkus naÄÃ­st fotky podle ÄÃ­sla objednÃ¡vky
  if (orderNum) {
    loadCustomerPhotosFromWorker(orderNum);
  }
});
</script>

</body>
</html>
