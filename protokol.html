<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol - White Glove Service</title>
<style>
body {
  font-family: Inter, sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:20px;
  font-size:12px;
  display:flex;
  justify-content:center;
}
.wrapper {
  width:100%;
  max-width:900px;
  background:white;
  padding:20px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);
  border:2px solid transparent;
  transition:border-color 0.3s ease;
  position:relative;
}
.wrapper.archive-border { border-color:#ccc; }
.header { text-align:center; margin-bottom:20px; }
.header div:first-child { font-size:28px; font-weight:900; }
.header div:last-child { font-size:12px; margin-top:4px; font-weight:normal; }

.archive-banner, .draft-banner {
  position:absolute; top:0; left:0; right:0;
  padding:10px 0; font-weight:600; text-align:center;
  border-bottom:1px solid #bbb; box-shadow:0 2px 4px rgba(0,0,0,0.1);
}
.archive-banner {
  background:linear-gradient(135deg,#e0e0e0,#f0f0f0); color:#333; display:none;
}
.draft-banner {
  background:linear-gradient(135deg,#d1f7c4,#e6ffe6); color:#1b6b1b; display:none;
}

table { width:100%; border-collapse:collapse; margin:10px 0; }
td { padding:6px; vertical-align:top; }
.label { font-weight:600; display:block; }
.label .en-label { display:block; font-size:0.85em; color:#666; font-weight:normal; margin:0; }

input, select, textarea {
  width:100%; padding:4px 8px; border:1px solid #ccc; border-radius:4px;
  box-sizing:border-box; font-size:1em; color:#111; background:#fff;
}
textarea { min-height:80px; resize:vertical; }

.split-section { display:flex; gap:10px; margin:10px 0; }
.two-col-table { display:flex; gap:30px; flex-wrap:wrap; }
.two-col-table .col { flex:1; min-width:300px; }

#signature-pad { border:2px dashed #888; width:100%; height:200px; background:white; touch-action:none; }
.signature-label { font-size:0.9em; color:#444; margin:4px 0 20px; }

.btns { margin-top:20px; display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
button {
  height:44px; font-size:0.9em; border:none; border-radius:8px;
  cursor:pointer; font-weight:600; color:white;
  box-shadow:0 2px 5px rgba(0,0,0,0.2);
  transition:transform 0.1s ease-in-out, opacity 0.2s;
}
button:hover { transform:scale(1.03); opacity:0.9; }
.btn-clear { background:linear-gradient(135deg,#a83232,#ff4d4d); }
.btn-back { background:linear-gradient(135deg,#6c757d,#a0a4a7); color:#fff; }
.btn-pdf { background:linear-gradient(135deg,#0046ff,#357aff); }
.btn-email { background:linear-gradient(135deg,#00b36b,#3cd67a); }

@media screen and (max-width:768px){
  .two-col-table, .split-section { flex-direction: column !important; gap:10px; }
  input, select, textarea { font-size:1em; height:36px; }
  #signature-pad { height:180px; }
}
.force-desktop { width:794px !important; max-width:794px !important; }
</style>
</head>
<body>
<div class="wrapper" id="wrapper">
  <div id="archiveBanner" class="archive-banner">üóÇÔ∏è Archivovan√Ω protokol (jen pro zobrazen√≠)</div>
  <div id="draftBanner" class="draft-banner">üíæ Naƒçten rozpracovan√Ω protokol</div>

  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO: 09769684</div>
  </div>

  <!-- FORMUL√Å≈ò -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ƒå√≠slo objedn√°vky<span class="en-label">Order number</span></td><td><input id="order-number"></td></tr>
        <tr><td class="label">ƒå√≠slo reklamace<span class="en-label">Claim number</span></td><td><input id="claim-number"></td></tr>
        <tr><td class="label">Z√°kazn√≠k<span class="en-label">Customer</span></td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa z√°kazn√≠ka<span class="en-label">Customer address</span></td><td><input id="address"></td></tr>
        <tr><td class="label">Telefon<span class="en-label">Phone</span></td><td><input id="phone"></td></tr>
        <tr><td class="label">Email<span class="en-label">Email</span></td><td><input id="email"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik<span class="en-label">Technician</span></td><td><select id="technician"><option>Milan Kol√≠n</option><option>Radek Zikmund</option><option>Kol√≠n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum n√°v≈°tƒõvy<span class="en-label">Visit date</span></td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruƒçen√≠<span class="en-label">Delivery date</span></td><td><input id="delivery-date" type="date"></td></tr>
        <tr><td class="label">Datum pod√°n√≠ reklamace<span class="en-label">Complaint date</span></td><td><input id="claim-date" type="date"></td></tr>
        <tr><td class="label">Znaƒçka / Contract<span class="en-label">Brand / Contract</span></td><td><input id="brand"></td></tr>
        <tr><td class="label">Model<span class="en-label">Model</span></td><td><input id="model"></td></tr>
      </table>
    </div>
  </div>

  <div class="section-title">Z√°kazn√≠k reklamuje<span class="en-label">Customer complaint</span></div>
  <div class="split-section">
    <textarea id="description-cz" placeholder="CZ"></textarea>
    <textarea id="description-en" placeholder="EN"></textarea>
  </div>

  <div class="section-title">Probl√©m zji≈°tƒõn√Ω technikem<span class="en-label">Detected problem</span></div>
  <div class="split-section">
    <textarea id="problem-cz" placeholder="CZ"></textarea>
    <textarea id="problem-en" placeholder="EN"></textarea>
  </div>

  <div class="section-title">N√°vrh opravy<span class="en-label">Repair proposal</span></div>
  <div class="split-section">
    <textarea id="repair-cz" placeholder="CZ"></textarea>
    <textarea id="repair-en" placeholder="EN"></textarea>
  </div>

  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">Poƒçet opravovan√Ωch d√≠l≈Ø<span class="en-label">Number of repaired parts</span></td><td><input id="parts"></td></tr>
        <tr><td class="label">Cena za pr√°ci<span class="en-label">Work cost</span></td><td><input id="price-work"></td></tr>
        <tr><td class="label">Cena za materi√°l<span class="en-label">Material cost</span></td><td><input id="price-material"></td></tr>
        <tr><td class="label">Cena za druh√©ho technika<span class="en-label">Second technician cost</span></td><td><input id="price-second"></td></tr>
        <tr><td class="label">Cena za dopravu<span class="en-label">Transport cost</span></td><td><input id="price-transport"></td></tr>
        <tr><td class="label">Cena celkem<span class="en-label">Total cost</span></td><td><input id="price-total"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Reklamace vy≈ôe≈°ena?<span class="en-label">Complaint solved?</span></td><td><select id="solved"><option>ANO</option><option>NE</option></select></td></tr>
        <tr><td class="label">ƒåek√° se na vyj√°d≈ôen√≠ prodejce?<span class="en-label">Waiting for dealer statement?</span></td><td><select id="dealer"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Po≈°kozen√≠ technikem?<span class="en-label">Damage by technician?</span></td><td><select id="damage"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">√öhradu provede z√°kazn√≠k?<span class="en-label">Customer will pay?</span></td><td><select id="payment"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Datum podpisu<span class="en-label">Signature date</span></td><td><input id="sign-date" type="date"></td></tr>
      </table>
    </div>
  </div>

  <div class="section-title">Podpis z√°kazn√≠ka<span class="en-label">Customer signature</span></div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>

  <div class="btns" id="actionButtons">
    <button class="btn-clear" type="button" onclick="signaturePad.clear()">Vymazat podpis</button>
    <button class="btn-back" type="button" onclick="window.location.href='index.html'">Zpƒõt</button>
    <button class="btn-pdf" type="button" onclick="downloadPDF()">Exportovat do PDF</button>
    <button class="btn-email" type="button" onclick="saveAndMail()">Odeslat e-mail z√°kazn√≠kovi</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
const WORKER_URL = "https://wis-drafts-api.72nvwf4pb2.workers.dev/";
let signaturePad, lastPdfName="protokol.pdf";

window.addEventListener("DOMContentLoaded",()=>{
  const canvas=document.getElementById("signature-pad");
  canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight;
  signaturePad=new SignaturePad(canvas,{backgroundColor:"white"});
  const today=new Date().toISOString().split("T")[0];
  document.getElementById("visit-date").value=today;
  document.getElementById("sign-date").value=today;
  loadDraft();
});

function getFormData(){
  const data={};
  document.querySelectorAll("input, textarea, select").forEach(el=>data[el.id]=el.value);
  data["signature"]=signaturePad.isEmpty()?"":signaturePad.toDataURL();
  return data;
}

function setFormData(data){
  Object.keys(data).forEach(k=>{
    const el=document.getElementById(k);
    if(el) el.value=data[k];
  });
  if(data.signature){
    signaturePad.fromDataURL(data.signature);
  }
}

// üß† automatick√© ukl√°d√°n√≠
setInterval(()=>saveDraft(),5000);

async function saveDraft(){
  const data=getFormData();
  localStorage.setItem("draft-protokol",JSON.stringify(data));
  try{
    const res=await fetch(WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
      message:"Ulo≈æen√Ω draft z protokolu",
      content:JSON.stringify([data],null,2)
    })});
  }catch(e){console.warn("Nelze odeslat draft:",e.message);}
}

async function loadDraft(){
  // z localStorage
  const local=localStorage.getItem("draft-protokol");
  if(local){
    setFormData(JSON.parse(local));
    document.getElementById("draftBanner").style.display="block";
  }

  // z Workeru
  try{
    const res=await fetch(WORKER_URL);
    const drafts=await res.json();
    if(Array.isArray(drafts)&&drafts.length>0){
      const last=drafts[drafts.length-1];
      setFormData(last);
      document.getElementById("draftBanner").style.display="block";
    }
  }catch(e){console.warn("Nelze naƒç√≠st vzd√°len√© drafty:",e.message);}
}

// PDF funkce (z≈Øst√°vaj√≠ stejn√©)
function stripDiacritics(str){return (str||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"_").replace(/[<>:\"/\\|?*\u0000-\u001F]/g,"-");}
function buildPdfFileName(){const today=new Date().toISOString().split("T")[0];const customer=stripDiacritics(document.getElementById("customer").value||"neznamy");const claim=stripDiacritics(document.getElementById("claim-number").value||"");const order=stripDiacritics(document.getElementById("order-number").value||"");return `${customer}_${claim}_${order}_${today}.pdf`; }
function generatePdf(callback){const {jsPDF}=window.jspdf;const doc=new jsPDF("p","mm","a4");const wrapper=document.querySelector(".wrapper");wrapper.classList.add("force-desktop");
  html2canvas(wrapper,{scale:2,scrollX:0,scrollY:0,windowWidth:794,windowHeight:wrapper.scrollHeight}).then(canvas=>{const imgData=canvas.toDataURL("image/jpeg",0.95);const pageW=doc.internal.pageSize.getWidth();const pageH=doc.internal.pageSize.getHeight();const imgProps=doc.getImageProperties(imgData);const ratio=imgProps.width/imgProps.height;let pdfW=pageW;let pdfH=pdfW/ratio;if(pdfH>pageH){pdfH=pageH;pdfW=pdfH*ratio;}const x=(pageW-pdfW)/2;const y=(pageH-pdfH)/2;doc.addImage(imgData,"JPEG",x,y,pdfW,pdfH);lastPdfName=buildPdfFileName();doc.save(lastPdfName);wrapper.classList.remove("force-desktop");if(callback)callback();});}
function downloadPDF(){generatePdf();}
function saveAndMail(){openMailClient();generatePdf();}
function openMailClient(){const customer=document.getElementById("customer").value||"";const order=document.getElementById("order-number").value||"";const claim=document.getElementById("claim-number").value||"";const visit=document.getElementById("visit-date").value||"";const email=document.getElementById("email").value||"";const subject=`Reklamace Natuzzi - ${customer} (${order})`;const body=`Dobr√Ω den ${customer},\n\nzas√≠l√°me V√°m protokol z n√°v≈°tƒõvy technika.\n\nƒå√≠slo reklamace: ${claim}\nDatum n√°v≈°tƒõvy: ${visit}\n\nSoubor ${lastPdfName} byl ulo≈æen ‚Äì pros√≠m p≈ôilo≈æte jej do e-mailu jako p≈ô√≠lohu.\n\n=====================\nWHITE GLOVE SERVICE\n=====================\nDo Dubƒçe 364, Bƒõchovice 190 11\n+420 725 965 826\nreklamace-wgs@email.cz`;window.location.href=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;}
</script>
</body>
</html>
