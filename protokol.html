<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protokol - White Glove Service</title>
  <style>
    body {
      font-family: Inter, sans-serif;
      background:#f6f7fb;
      margin:0;
      padding:20px;
      font-size:12px;
      display:flex;
      justify-content:center;
    }
    .wrapper {
      width:100%;
      max-width:900px;
      background:white;
      padding:20px;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
    }
    .header { text-align:center; margin-bottom:20px; }
    .header div:first-child { font-size:28px; font-weight:900; }
    .header div:last-child { font-size:12px; margin-top:4px; font-weight:normal; }

    table { width:100%; border-collapse:collapse; margin:10px 0; }
    td { padding:6px; vertical-align:top; }

    .label { font-weight:600; display:block; }
    .label .en-label {
      display:block;
      font-size:0.85em;
      color:#666;
      font-weight:normal;
      margin:0;
    }

    .section-title {
      font-weight:700;
      margin-top:20px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
    }
    .section-title .en-label {
      font-size:0.9em;
      color:#666;
      font-weight:normal;
      margin-top:2px;
    }

    input, select, textarea {
      width:100%;
      padding:4px 8px;
      font-size:1em;
      border:1px solid #ccc;
      border-radius:4px;
      box-sizing:border-box;
    }
    input, select { height:36px; line-height:36px; background-color:white; }
    textarea { min-height:60px; resize:vertical; }

    .split-section { display:flex; gap:10px; margin:10px 0; }
    .two-col-table { display:flex; gap:30px; flex-wrap:wrap; }
    .two-col-table .col { flex:1; min-width:300px; }

    #signature-pad {
      border:2px dashed #888;
      width:100%;
      height:150px;
      background:white;
    }
    .signature-label { font-size:0.9em; color:#444; margin:4px 0 20px; }

    /* tlaƒç√≠tka */
    .btns {
      margin-top:20px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    .btns button {
      height:42px;
      font-size:0.9em;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      color:white;
      box-shadow:0 2px 5px rgba(0,0,0,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:transform 0.1s ease-in-out, box-shadow 0.2s;
      width:100%;
    }
    .btns button:hover { transform:scale(1.02); box-shadow:0 4px 8px rgba(0,0,0,0.3); }

    /* Metalick√© gradienty */
    .btn-clear { background: linear-gradient(145deg, #7a0f0f, #ff4d4d, #a83232); }
    .btn-back { background: linear-gradient(145deg, #808080, #dcdcdc, #a9a9a9); color:#000; }
    .btn-back svg { width:20px; height:20px; fill:#000; }
    .btn-pdf { background: linear-gradient(145deg, #004080, #1e90ff, #003366); }
    .btn-email { background: linear-gradient(145deg, #006600, #28a745, #004d00); }

    @media (max-width:768px){
      .wrapper{padding:10px;}
      .two-col-table{flex-direction:column;}
      .split-section{flex-direction:column;}
      .btns { grid-template-columns: 1fr; }
    }

    .force-desktop {
      width:794px !important;
      max-width:794px !important;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO: 09769684</div>
  </div>

  <!-- --- Formul√°≈ô z≈Øst√°v√° beze zmƒõny --- -->

  <div class="section-title">Podpis z√°kazn√≠ka<span class="en-label">Customer signature</span></div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>

  <div class="btns">
    <button class="btn-clear" type="button" onclick="signaturePad.clear()">üóëÔ∏è Vymazat podpis</button>
    <button class="btn-back" type="button" onclick="window.location.href='index.html'">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
      ZPƒöT
    </button>
    <button class="btn-pdf" type="button" onclick="downloadPDF()">üìÑ Exportovat do PDF</button>
    <button class="btn-email" type="button" onclick="saveAndMail()">‚úâÔ∏è Odeslat e-mail z√°kazn√≠kovi</button>
  </div>
</div>

<script>
  let signaturePad;
  let lastPdfName = "protokol.pdf";

  window.addEventListener("DOMContentLoaded", () => {
    const canvas = document.getElementById("signature-pad");
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    signaturePad = new SignaturePad(canvas, { backgroundColor: "white" });

    const today = new Date().toISOString().split("T")[0];
    document.getElementById("visit-date").value = today;
    document.getElementById("sign-date").value = today;
  });

  function stripDiacritics(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g,"");
  }

  function buildPdfFileName() {
    const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
    const customer = stripDiacritics(document.getElementById("customer").value || "");
    const claim = document.getElementById("claim-number").value || "";
    const order = document.getElementById("order-number").value || "";

    let parts = [];
    if (customer) parts.push(customer);
    if (claim) parts.push(claim);
    if (order) parts.push(order);
    parts.push(today);

    return parts.join("_") + ".pdf";
  }

  function generatePdf(callback) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");
    const wrapper = document.querySelector(".wrapper");
    wrapper.classList.add("force-desktop");

    html2canvas(wrapper, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const imgProps = doc.getImageProperties(imgData);
      const imgW = imgProps.width;
      const imgH = imgProps.height;
      let drawW = pageW;
      let drawH = (imgH * drawW) / imgW;
      let x = 0, y = 0;
      if (drawH > pageH) {
        const scale = pageH / drawH;
        drawW = drawW * scale;
        drawH = pageH;
        x = (pageW - drawW) / 2;
      }
      doc.addImage(imgData, "PNG", x, y, drawW, drawH);
      if (signaturePad && !signaturePad.isEmpty()) {
        const signData = signaturePad.toDataURL("image/png");
        doc.addImage(signData, "PNG", 15, pageH - 45, 80, 30);
      }
      lastPdfName = buildPdfFileName();
      doc.save(lastPdfName);
      wrapper.classList.remove("force-desktop");
      if (callback) callback();
    });
  }

  function downloadPDF() { generatePdf(); }
  function saveAndMail() { openMailClient(); generatePdf(); }

  function openMailClient() {
    const customer = document.getElementById("customer").value || "";
    const order = document.getElementById("order-number").value || "";
    const claim = document.getElementById("claim-number").value || "";
    const visitDate = document.getElementById("visit-date").value || "";
    const email = document.getElementById("email").value || "";

    const subject = `Reklamace Natuzzi - ${customer} (${order})`;
    const body = `Dobr√Ω den ${customer},

zas√≠l√°me V√°m protokol z n√°v≈°tƒõvy technika.

ƒå√≠slo reklamace: ${claim}
Datum n√°v≈°tƒõvy: ${visitDate}

Soubor ${lastPdfName} byl ulo≈æen ‚Äì pros√≠m p≈ôilo≈æte jej do e-mailu jako p≈ô√≠lohu.

=====================
WHITE GLOVE SERVICE
=====================
Do Dubƒçe 364, Bƒõchovice 190 11
+420 725 965 826
reklamace-wgs@email.cz`;

    window.location.href = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }

  window.addEventListener("message", (event) => {
    if (event.data.type === "openProtocol") {
      const d = event.data.row;
      if (!d) return;
      document.getElementById("order-number").value = d["Order number"] || "";
      document.getElementById("claim-number").value = d["Label"] || "";
      document.getElementById("customer").value = d["Customer"] || "";
      document.getElementById("address").value = d["Address"] || "";
      document.getElementById("phone").value = d["KONTAKT"] || "";
      document.getElementById("email").value = d["EMAIL"] || "";
      document.getElementById("brand").value = d["Contract"] || d["Label"] || "";
      document.getElementById("model").value = d["Model"] || "";
      document.getElementById("description-cz").value = d["POPIS REKLAMACE - OPRAVY"] || "";
      autoTranslate("description-cz", "description-en");
    }
  });

  function autoTranslate(srcId, tgtId) {
    const sourceText = document.getElementById(srcId).value;
    const targetEl = document.getElementById(tgtId);
    if (!sourceText.trim()) return targetEl.value = "";
    fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=cs&tl=en&dt=t&q=${encodeURIComponent(sourceText)}`)
      .then(res => res.json())
      .then(data => {
        if (data && data[0]) targetEl.value = data[0].map(pair => pair[0]).join("");
      });
  }
</script>
</body>
</html>
