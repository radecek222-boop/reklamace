<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protokol - White Glove Service</title>
  <style>
    body {
      font-family: Inter, sans-serif;
      background:#f6f7fb;
      margin:0;
      padding: 20px;
      font-size:12px;
      display: flex;
      justify-content: center;
    }
    .wrapper {
      width: 100%;
      max-width: 900px;
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .header { text-align:center; margin-bottom:20px; }
    .header div:first-child { font-size:28px; font-weight:900; }
    .header div:last-child { font-size:12px; margin-top:4px; font-weight:normal; }
    table { width:100%; border-collapse:collapse; margin:10px 0; }
    td { padding:6px; vertical-align:top; }
    .label { font-weight:600; width:40%; }
    input, select, textarea { width:100%; padding:4px; font-size:1em; }
    .split-section { display:flex; gap:10px; margin:10px 0; }
    .two-col-table { display:flex; gap:30px; flex-wrap:wrap; }
    .two-col-table .col { flex: 1; min-width: 300px; }
    .section-title { font-weight:700; margin-top:20px; }
    .side-label { font-size:11px; font-weight:500; color:#555; margin-bottom:4px; }
    #signature-pad {
      border:2px dashed #888;
      width:100%;
      height:150px;
      background:white;
    }
    .signature-label { font-size:0.9em; color:#444; margin:4px 0 20px; }
    .btns { margin-top:20px; display:flex; gap:10px; flex-wrap:wrap; }
    .btns button { padding:10px 20px; font-size:1em; border:none; background:#333; color:white; border-radius:6px; cursor:pointer; }

    @media (max-width: 768px) {
      .wrapper { padding: 10px; }
      .two-col-table { flex-direction: column; }
      .split-section { flex-direction: column; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let signaturePad;
    window.addEventListener("DOMContentLoaded", () => {
      const canvas = document.getElementById("signature-pad");
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      signaturePad = new SignaturePad(canvas);

      const today = new Date().toISOString().split("T")[0];
      document.getElementById("visit-date").value = today;
      document.getElementById("sign-date").value = today;
    });

    function autoTranslate(srcId, tgtId) {
      const sourceText = document.getElementById(srcId).value;
      const targetEl = document.getElementById(tgtId);
      if (!sourceText.trim()) return targetEl.value = "";
      fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=cs&tl=en&dt=t&q=${encodeURIComponent(sourceText)}`)
        .then(res => res.json())
        .then(data => {
          if (data && data[0]) {
            targetEl.value = data[0].map(pair => pair[0]).join("");
          }
        });
    }

    function calculateTotal() {
      const work = parseFloat(document.getElementById("price-work").value) || 0;
      const material = parseFloat(document.getElementById("price-material").value) || 0;
      const second = parseFloat(document.getElementById("price-second").value) || 0;
      const transport = parseFloat(document.getElementById("price-transport").value) || 0;
      const total = work + material + second + transport;
      document.getElementById("price-total").value = total.toFixed(2);
    }

    // ‚úÖ Export do PDF ‚Äì pevn√© dvousloupcov√© rozlo≈æen√≠
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "mm", "a4");

      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 10;
      let y = 20;

      // HLAVIƒåKA
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("WHITE GLOVE SERVICE", pageWidth/2, y, {align: "center"});
      y += 8;
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text("Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO: 09769684", pageWidth/2, y, {align: "center"});
      y += 15;

      // DVA SLOUPCE ‚Äì z√°kladn√≠ √∫daje
      const col1x = margin;
      const col2x = pageWidth/2 + 5;

      doc.setFontSize(11);
      doc.text("ƒå√≠slo objedn√°vky: " + (document.getElementById("order-number").value || ""), col1x, y);
      doc.text("Technik: " + (document.querySelector("select").value || ""), col2x, y);
      y+=7;
      doc.text("ƒå√≠slo reklamace: " + (document.getElementById("claim-number").value || ""), col1x, y);
      doc.text("Datum n√°v≈°tƒõvy: " + (document.getElementById("visit-date").value || ""), col2x, y);
      y+=7;
      doc.text("Z√°kazn√≠k: " + (document.getElementById("customer").value || ""), col1x, y);
      doc.text("Datum doruƒçen√≠: " + (document.querySelectorAll('input[type=date]')[1].value || ""), col2x, y);
      y+=7;
      doc.text("Adresa z√°kazn√≠ka: " + (document.getElementById("address").value || ""), col1x, y);
      doc.text("Datum pod√°n√≠ reklamace: " + (document.querySelectorAll('input[type=date]')[2].value || ""), col2x, y);
      y+=7;
      doc.text("Znaƒçka / Contract: " + (document.getElementById("brand").value || ""), col1x, y);
      doc.text("Model: " + (document.getElementById("model").value || ""), col2x, y);
      y+=15;

      // BLOKY TEXT≈Æ (CZ / EN)
      function addBlock(title, czId, enId) {
        doc.setFont("helvetica", "bold");
        doc.text(title, margin, y);
        y+=6;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        let cz = document.getElementById(czId).value || "";
        let en = document.getElementById(enId).value || "";
        let splitCZ = doc.splitTextToSize("CZ: " + cz, pageWidth/2 - 15);
        let splitEN = doc.splitTextToSize("EN: " + en, pageWidth/2 - 15);
        let maxLines = Math.max(splitCZ.length, splitEN.length);
        for (let i=0;i<maxLines;i++) {
          if (splitCZ[i]) doc.text(splitCZ[i], col1x, y);
          if (splitEN[i]) doc.text(splitEN[i], col2x, y);
          y+=5;
        }
        y+=5;
      }

      addBlock("Z√°kazn√≠k reklamuje / Customer complaint", "description-cz", "description-en");
      addBlock("Probl√©m zji≈°tƒõn√Ω technikem / Detected problem", "problem-cz", "problem-en");
      addBlock("N√°vrh opravy / Repair proposal", "repair-cz", "repair-en");

      // TABULKA CEN A STAVU
      y+=5;
      doc.setFont("helvetica", "bold");
      doc.text("Finanƒçn√≠ √∫daje", col1x, y);
      doc.text("Stav reklamace", col2x, y);
      y+=7;
      doc.setFont("helvetica", "normal");

      doc.text("Poƒçet d√≠l≈Ø: " + (document.querySelectorAll("input")[6].value || ""), col1x, y);
      doc.text("Vy≈ôe≈°eno: " + (document.querySelectorAll("select")[1].value || ""), col2x, y);
      y+=6;
      doc.text("Pr√°ce: " + (document.getElementById("price-work").value || ""), col1x, y);
      doc.text("Vyj√°d≈ôen√≠ prodejce: " + (document.querySelectorAll("select")[2].value || ""), col2x, y);
      y+=6;
      doc.text("Materi√°l: " + (document.getElementById("price-material").value || ""), col1x, y);
      doc.text("Po≈°kozen√≠ technikem: " + (document.querySelectorAll("select")[3].value || ""), col2x, y);
      y+=6;
      doc.text("2. technik: " + (document.getElementById("price-second").value || ""), col1x, y);
      doc.text("√öhrada z√°kazn√≠k: " + (document.querySelectorAll("select")[4].value || ""), col2x, y);
      y+=6;
      doc.text("Doprava: " + (document.getElementById("price-transport").value || ""), col1x, y);
      doc.text("Datum podpisu: " + (document.getElementById("sign-date").value || ""), col2x, y);
      y+=6;
      doc.text("Celkem: " + (document.getElementById("price-total").value || ""), col1x, y);
      y+=20;

      // PODPIS
      doc.setFont("helvetica", "bold");
      doc.text("Podpis z√°kazn√≠ka:", col1x, y);
      y+=5;
      if (signaturePad && !signaturePad.isEmpty()) {
        const signData = signaturePad.toDataURL();
        doc.addImage(signData, "PNG", col1x, y, 60, 20);
      }

      doc.save("protokol.pdf");
    }
  </script>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO: 09769684</div>
  </div>
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ƒå√≠slo objedn√°vky</td><td><input id="order-number"></td></tr>
        <tr><td class="label">ƒå√≠slo reklamace</td><td><input id="claim-number"></td></tr>
        <tr><td class="label">Z√°kazn√≠k</td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa z√°kazn√≠ka</td><td><input id="address"></td></tr>
        <tr><td class="label">Znaƒçka / Contract</td><td><input id="brand"></td></tr>
        <tr><td class="label">Model</td><td><input id="model"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik</td><td><select><option>Milan Kol√≠n</option><option>Radek Zikmund</option><option>Kol√≠n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum n√°v≈°tƒõvy</td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruƒçen√≠</td><td><input type="date"></td></tr>
        <tr><td class="label">Datum pod√°n√≠ reklamace</td><td><input type="date"></td></tr>
      </table>
    </div>
  </div>

  <div class="section-title">Z√°kazn√≠k reklamuje / Customer complaint</div>
  <div class="split-section">
    <div style="flex:1;"><div class="side-label">CZ</div><textarea id="description-cz" placeholder="Popis v ƒçe≈°tinƒõ" oninput="autoTranslate('description-cz', 'description-en')"></textarea></div>
    <div style="flex:1;"><div class="side-label">EN</div><textarea id="description-en" placeholder="Translation" readonly></textarea></div>
  </div>

  <div class="section-title">Probl√©m zji≈°tƒõn√Ω technikem / Detected problem</div>
  <div class="split-section">
    <div style="flex:1;"><div class="side-label">CZ</div><textarea id="problem-cz" placeholder="Popis v ƒçe≈°tinƒõ" oninput="autoTranslate('problem-cz', 'problem-en')"></textarea></div>
    <div style="flex:1;"><div class="side-label">EN</div><textarea id="problem-en" placeholder="Translation" readonly></textarea></div>
  </div>

  <div class="section-title">N√°vrh opravy / Repair proposal</div>
  <div class="split-section">
    <div style="flex:1;"><div class="side-label">CZ</div><textarea id="repair-cz" placeholder="Popis v ƒçe≈°tinƒõ" oninput="autoTranslate('repair-cz', 'repair-en')"></textarea></div>
    <div style="flex:1;"><div class="side-label">EN</div><textarea id="repair-en" placeholder="Translation" readonly></textarea></div>
  </div>

  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">Poƒçet opravovan√Ωch d√≠l≈Ø</td><td><input></td></tr>
        <tr><td class="label">Cena za pr√°ci</td><td><input id="price-work" oninput="calculateTotal()"></td></tr>
        <tr><td class="label">Cena za materi√°l</td><td><input id="price-material" oninput="calculateTotal()"></td></tr>
        <tr><td class="label">Cena za druh√©ho technika</td><td><input id="price-second" oninput="calculateTotal()"></td></tr>
        <tr><td class="label">Cena za dopravu</td><td><input id="price-transport" oninput="calculateTotal()"></td></tr>
        <tr><td class="label">Cena celkem</td><td><input id="price-total" readonly></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Reklamace vy≈ôe≈°ena?</td><td><select><option>ANO</option><option>NE</option></select></td></tr>
        <tr><td class="label">ƒåek√° se na vyj√°d≈ôen√≠ prodejce?</td><td><select><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Po≈°kozen√≠ technikem?</td><td><select><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">√öhradu provede z√°kazn√≠k?</td><td><select><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Datum podpisu</td><td><input id="sign-date" type="date"></td></tr>
      </table>
    </div>
  </div>
  <div class="section-title">Podpis z√°kazn√≠ka / Customer signature:</div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se pros√≠m prstem nebo my≈°√≠ / Sign using finger or mouse</div>

  <div class="btns">
    <button onclick="signaturePad.clear()">üóëÔ∏è Vymazat podpis</button>
    <button onclick="window.location.href='index.html'">‚¨ÖÔ∏è Zpƒõt na hlavn√≠ str√°nku</button>
    <button onclick="downloadPDF()">üìÑ Exportovat do PDF</button>
  </div>
</div>

<script>
  // P≈ôenos dat ze seznamu
  window.addEventListener("message", (event) => {
    if (event.data.type === "openProtocol") {
      const d = event.data.row;
      if (!d) return;
      document.getElementById("order-number").value = d["Order number"] || "";
      document.getElementById("claim-number").value = d["Label"] || "";
      document.getElementById("customer").value = d["Customer"] || "";
      document.getElementById("address").value = d["Address"] || "";
      document.getElementById("brand").value = d["Label"] || "";
      document.getElementById("model").value = d["Model"] || "";
      document.getElementById("description-cz").value = d["POPIS REKLAMACE - OPRAVY"] || "";
      autoTranslate("description-cz", "description-en");
    }
  });
</script>
</body>
</html>
