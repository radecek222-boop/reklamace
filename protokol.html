<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Servisní protokol – White Glove Service</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f6f7fb; }
    h1 { text-align:center; }
    .grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    label { font-weight:bold; display:block; margin-top:10px; }
    textarea,input { width:100%; padding:8px; margin-top:5px; }
    .prices { text-align:right; }
    canvas { border:1px solid #ccc; margin-top:10px; border-radius:6px; }
    button { margin-top:20px; padding:10px 20px; border:none; border-radius:6px; background:#2196F3; color:#fff; cursor:pointer; }
    .back-btn {
      display:inline-block; margin-top:20px; padding:10px 20px;
      background:#ddd; color:#000; text-decoration:none; border-radius:6px;
    }
  </style>
</head>
<body>
  <h1>Servisní protokol – White Glove Service</h1>

  <form id="protokolForm">
    <div class="grid">
      <div>
        <label>Číslo objednávky / Order number</label>
        <input type="text" name="Objednavka" required>

        <label>Zákazník / Customer</label>
        <input type="text" name="Zakaznik" required>

        <label>Adresa / Address</label>
        <input type="text" name="Adresa" required>

        <label>Model / Model</label>
        <input type="text" name="Model" required>
      </div>

      <div class="prices">
        <label>Cena / Price (EUR)</label>
        <input type="number" name="CENA" required>

        <label>Complaint date</label>
        <input type="date" name="Complaint date">

        <label>Delivery date</label>
        <input type="date" name="Delivery date">
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Problém zjištěný technikem</label>
        <textarea name="Problem" rows="4" required></textarea>
      </div>
      <div>
        <label>Problem detected by technician</label>
        <textarea name="Problem_EN" rows="4" required></textarea>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Návrh opravy</label>
        <textarea name="Navrh" rows="4" required></textarea>
      </div>
      <div>
        <label>Proposed repair</label>
        <textarea name="Navrh_EN" rows="4" required></textarea>
      </div>
    </div>

    <!-- Podpis -->
    <label>Podpis zákazníka:</label>
    <canvas id="signature" width="600" height="200"></canvas>
    <button type="button" onclick="clearSignature()">Smazat podpis</button>

    <div>
      <button type="submit">Uložit protokol</button>
      <button type="button" onclick="exportPDF()">Export do PDF</button>
    </div>
  </form>

  <a href="index.html" class="back-btn">Zpět na hlavní stránku</a>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- Podpis ---
    const canvas = document.getElementById('signature');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
    canvas.addEventListener('mousemove', e => { if (drawing) { ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); } });
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseout', () => drawing = false);

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // --- Uložení do Google Sheets ---
    document.getElementById('protokolForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // aktuální datum podpisu
      const dnes = new Date();
      const datumPodpisu = dnes.toLocaleDateString("cs-CZ");

      // data z formuláře
      const formData = new FormData(this);
      let data = {};
      formData.forEach((value, key) => { data[key] = value; });

      // přidáme datum podpisu
      data["Datum podpisu"] = datumPodpisu;

      // podpis jako obrázek
      const podpisData = canvas.toDataURL();
      data["Podpis"] = podpisData;

      try {
        await fetch("TVŮJ_APPS_SCRIPT_URL", {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });
        alert("Protokol byl uložen (včetně datumu podpisu).");
        this.reset();
        clearSignature();
      } catch (err) {
        alert("Chyba při odesílání: " + err);
      }
    });

    // --- Export do PDF ---
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Servisní protokol – White Glove Service", 20, 20);

      let y = 40;
      const formData = new FormData(document.getElementById('protokolForm'));
      formData.forEach((value, key) => {
        if (key !== "Podpis") {
          doc.setFontSize(11);
          doc.text(`${key}: ${value}`, 20, y);
          y += 8;
        }
      });

      // podpis
      const podpisData = canvas.toDataURL();
      if (podpisData) {
        doc.text("Podpis:", 20, y+10);
        doc.addImage(podpisData, "PNG", 20, y+15, 80, 40);
      }

      doc.save("protokol.pdf");
    }
  </script>
</body>
</html>
