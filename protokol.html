<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protokol – White Glove Service</title>
  <style>
    body { font-family: Inter, sans-serif; background:#f6f7fb; margin:0; padding:20px; display:flex; justify-content:center; }
    .wrapper { width:100%; max-width:900px; background:white; padding:20px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    h1 { text-align:center; font-weight:900; margin-bottom:20px; }
    label { display:block; font-weight:600; margin-top:12px; margin-bottom:5px; }
    input[type="text"], input[type="date"], textarea {
      width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px;
    }
    textarea { resize:vertical; height:80px; }
    .btn { padding:10px 20px; border:none; border-radius:8px; color:#fff; cursor:pointer; font-weight:600; margin:5px; }
    .btn-grey { background:#6c757d; }
    .btn-grey:hover { background:#5a6268; }
    .btn-purple { background:linear-gradient(135deg,#8e44ad,#9b59b6,#c471ed); background-size:200% 200%; animation:shine 3s ease infinite; }
    @keyframes shine { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }
    .actions { text-align:center; margin-top:25px; }
  </style>
</head>
<body>

<div class="wrapper">
  <h1>Servisní protokol – White Glove Service</h1>

  <form id="protokolForm">
    <label>Jméno a příjmení zákazníka:</label>
    <input type="text" name="zakaznik">

    <label>Adresa:</label>
    <input type="text" name="adresa">

    <label>Telefon:</label>
    <input type="text" name="telefon">

    <label>E-mail:</label>
    <input type="text" name="email">

    <label>Model / produkt:</label>
    <input type="text" name="produkt">

    <label>Popis závady:</label>
    <textarea name="popis" id="popisZavady"></textarea>

    <label>Číslo reklamace / Contract:</label>
    <input type="text" name="contract">

    <label>Datum vytvoření:</label>
    <input type="text" name="datum">

    <!-- Tady je místo pro podpis, překlad atd., zůstává beze změn -->
    <div class="actions">
      <button type="button" id="backBtn" class="btn btn-grey">Zpět na seznam</button>
      <button type="button" id="exportBtn" class="btn btn-purple">Exportovat PDF</button>
      <button type="button" id="doneBtn" class="btn" style="background:linear-gradient(135deg,#2ecc71,#58d68d,#27ae60);">Označit jako hotové</button>
    </div>
  </form>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const data = localStorage.getItem("selectedOrder");
  if (data) {
    const order = JSON.parse(data);
    // Automatické předvyplnění polí
    const mapping = {
      zakaznik: "zakaznik",
      adresa: "adresa",
      telefon: "telefon",
      email: "email",
      produkt: "produkt",
      popis: "popis",
      contract: "contract",
      datum_vytvoreni: "datum"
    };
    for (const key in mapping) {
      const el = document.querySelector(`[name="${mapping[key]}"]`);
      if (el) el.value = order[key] || "";
    }
    console.log("✅ Data načtena z localStorage:", order);
  }
});

document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "seznam.html";
});

async function updateGitHubFiles(order) {
  const token = prompt("Zadejte GitHub token pro zápis:");
  if (!token) throw new Error("Nebyl zadán token.");

  const owner = "radecek222-boop";
  const repo = "reklamace";
  const ordersPath = "orders.json";
  const donePath = "hotove.json";

  // Načteme původní data
  const getFile = async (path) => {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      headers: { "Authorization": `token ${token}` }
    });
    if (!res.ok) throw new Error(`Nelze načíst ${path}`);
    const json = await res.json();
    return { content: JSON.parse(atob(json.content.replace(/\n/g, ""))), sha: json.sha };
  };

  const putFile = async (path, content, sha, message) => {
    const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));
    const body = { message, content: newContent, branch: "main" };
    if (sha) body.sha = sha;
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: "PUT",
      headers: {
        "Authorization": `token ${token}`,
        "Accept": "application/vnd.github.v3+json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`Chyba při zápisu ${path}: ${await res.text()}`);
  };

  // načteme oba soubory
  const ordersData = await getFile(ordersPath);
  const doneData = await getFile(donePath);

  // najdeme záznam podle zákazníka + contractu
  const idx = ordersData.content.findIndex(
    i => i.zakaznik === order.zakaznik && i.contract === order.contract
  );

  if (idx !== -1) {
    // Označíme jako hotové
    const finished = { ...ordersData.content[idx], popis: "HOTOVO" };
    doneData.content.push(finished);
    ordersData.content.splice(idx, 1);

    // zapíšeme nové verze obou souborů
    await putFile(ordersPath, ordersData.content, ordersData.sha, `Označeno HOTOVO – ${order.zakaznik}`);
    await putFile(donePath, doneData.content, doneData.sha, `Přesun do hotových – ${order.zakaznik}`);

    alert("✅ Reklamace označena jako hotová a přesunuta.");
    localStorage.removeItem("selectedOrder");
    window.location.href = "seznam.html";
  } else {
    alert("⚠️ Záznam nebyl nalezen v orders.json.");
  }
}

document.getElementById("doneBtn").addEventListener("click", async () => {
  const confirmDone = confirm("Opravdu označit reklamaci jako HOTOVO a přesunout?");
  if (!confirmDone) return;

  const f = document.getElementById("protokolForm");
  const order = {
    zakaznik: f.zakaznik.value,
    adresa: f.adresa.value,
    telefon: f.telefon.value,
    email: f.email.value,
    produkt: f.produkt.value,
    popis: f.popis.value,
    contract: f.contract.value,
    datum_vytvoreni: f.datum.value
  };

  try {
    await updateGitHubFiles(order);
  } catch (err) {
    alert("❌ Chyba při přesunu: " + err.message);
  }
});
</script>
