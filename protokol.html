<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol - White Glove Service</title>
<style>
body { font-family: Inter, sans-serif; background:#f6f7fb; margin:0; padding:20px; display:flex; justify-content:center; }
.wrapper { width:100%; max-width:900px; background:white; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.1); }

.header { text-align:center; margin-bottom:20px; }
.header div:first-child { font-size:28px; font-weight:900; }
.header div:last-child { font-size:12px; margin-top:4px; font-weight:normal; }

.fieldset { border:1px solid #ccc; padding:10px; margin-bottom:15px; border-radius:6px; }
.legend { font-weight:700; font-size:14px; margin-bottom:6px; }
.label { font-weight:600; margin-top:6px; display:block; }
input, select { width:100%; height:36px; font-size:1em; padding:4px 8px; border:1px solid #aaa; border-radius:4px; }
textarea { width:100%; min-height:80px; resize:vertical; padding:4px 8px; font-size:1em; border:1px solid #aaa; border-radius:4px; }

#signature-pad { border:2px dashed #888; width:100%; height:180px; background:white; margin-top:6px; }

.btns { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
.btns button { flex:1 1 45%; height:42px; font-weight:600; color:white; border:none; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; }

.btn-clear { background: linear-gradient(145deg,#7a0f0f,#ff4d4d,#a83232); }
.btn-back { background: linear-gradient(145deg,#808080,#dcdcdc,#a9a9a9); color:#000; }
.btn-pdf { background: linear-gradient(145deg,#004080,#1e90ff,#003366); }
.btn-email { background: linear-gradient(145deg,#006600,#28a745,#004d00); }

/* Mobiln√≠ p≈ôizp≈Øsoben√≠ */
@media screen and (max-width:768px){
  .fieldset { padding:8px; }
  textarea, input, select { font-size:1em; height:36px; }
  .btns { flex-direction:column; }
}
</style>
</head>
<body>
<div class="wrapper">

<div class="header">
  <div>WHITE GLOVE SERVICE</div>
  <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO: 09769684</div>
</div>

<!-- Objedn√°vka a z√°kazn√≠k -->
<div class="fieldset">
  <div class="legend">Objedn√°vka a z√°kazn√≠k</div>
  <label class="label">ƒå√≠slo objedn√°vky</label><input id="order-number">
  <label class="label">ƒå√≠slo reklamace</label><input id="claim-number">
  <label class="label">Z√°kazn√≠k</label><input id="customer">
  <label class="label">Adresa z√°kazn√≠ka</label><input id="address">
  <label class="label">Telefon</label><input id="phone">
  <label class="label">Email</label><input id="email">
</div>

<!-- Technik a data -->
<div class="fieldset">
  <div class="legend">Technik a data</div>
  <label class="label">Technik</label>
  <select id="technician">
    <option>Milan Kol√≠n</option>
    <option>Radek Zikmund</option>
    <option>Kol√≠n/Zikmund</option>
  </select>
  <label class="label">Datum n√°v≈°tƒõvy</label><input id="visit-date" type="date">
  <label class="label">Datum doruƒçen√≠</label><input id="delivery-date" type="date">
  <label class="label">Datum pod√°n√≠ reklamace</label><input id="claim-date" type="date">
  <label class="label">Znaƒçka / Contract</label><input id="brand">
  <label class="label">Model</label><input id="model">
</div>

<!-- Textov√° pole CZ/EN -->
<div class="fieldset">
  <div class="legend">Z√°kazn√≠k reklamuje</div>
  <textarea id="description-cz" placeholder="CZ"></textarea>
  <textarea id="description-en" placeholder="EN"></textarea>
</div>

<div class="fieldset">
  <div class="legend">Probl√©m zji≈°tƒõn√Ω technikem</div>
  <textarea id="problem-cz" placeholder="CZ"></textarea>
  <textarea id="problem-en" placeholder="EN"></textarea>
</div>

<div class="fieldset">
  <div class="legend">N√°vrh opravy</div>
  <textarea id="repair-cz" placeholder="CZ"></textarea>
  <textarea id="repair-en" placeholder="EN"></textarea>
</div>
<!-- Doln√≠ pole: ceny a stav -->
<div class="fieldset">
  <div class="legend">Ceny a stav reklamace</div>
  <label class="label">Poƒçet opravovan√Ωch d√≠l≈Ø</label><input id="parts">
  <label class="label">Cena za pr√°ci</label><input id="price-work">
  <label class="label">Cena za materi√°l</label><input id="price-material">
  <label class="label">Cena za druh√©ho technika</label><input id="price-second">
  <label class="label">Cena za dopravu</label><input id="price-transport">
  <label class="label">Cena celkem</label><input id="price-total">
  <label class="label">Reklamace vy≈ôe≈°ena?</label>
  <select id="solved"><option>ANO</option><option>NE</option></select>
  <label class="label">ƒåek√° se na vyj√°d≈ôen√≠ prodejce?</label>
  <select id="dealer"><option>NE</option><option>ANO</option></select>
  <label class="label">Po≈°kozen√≠ technikem?</label>
  <select id="damage"><option>NE</option><option>ANO</option></select>
  <label class="label">√öhradu provede z√°kazn√≠k?</label>
  <select id="payment"><option>NE</option><option>ANO</option></select>
  <label class="label">Datum podpisu</label><input id="sign-date" type="date">
</div>

<!-- Podpis -->
<div class="fieldset">
  <div class="legend">Podpis z√°kazn√≠ka</div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>
</div>

<!-- Tlaƒç√≠tka -->
<div class="btns">
  <button class="btn-clear" type="button" onclick="signaturePad.clear()">üóëÔ∏è Vymazat podpis</button>
  <button class="btn-back" type="button" onclick="window.location.href='index.html'">‚Æ™ ZPƒöT</button>
  <button class="btn-pdf" type="button" onclick="downloadPDF()">üìÑ Exportovat do PDF</button>
  <button class="btn-email" type="button" onclick="saveAndMail()">‚úâÔ∏è Odeslat e-mail z√°kazn√≠kovi</button>
</div>

</div> <!-- wrapper -->

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let signaturePad;
let lastPdfName = "protokol.pdf";

window.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("signature-pad");
  function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas, { passive: true });
  signaturePad = new SignaturePad(canvas, { backgroundColor: "white" });

  const today = new Date().toISOString().split("T")[0];
  document.getElementById("visit-date").value = today;
  document.getElementById("sign-date").value = today;
});

function stripDiacritics(str){ return (str||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"_").replace(/[<>:"/\\|?*\u0000-\u001F]/g,"-"); }
function buildPdfFileName(){ 
  const today = new Date().toISOString().split("T")[0];
  const customer = stripDiacritics(document.getElementById("customer").value || "neznamy_zakaznik");
  const claim = stripDiacritics(document.getElementById("claim-number").value || "bez_claimu");
  const order = stripDiacritics(document.getElementById("order-number").value || "bez_objednavky");
  return `${customer}_${claim}_${order}_${today}.pdf`;
}

function generatePdf(callback){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");
  let y = 20;
  const lineHeight = 7;

  // Hlaviƒçka
  doc.setFontSize(18); doc.setFont("helvetica","bold");
  doc.text("WHITE GLOVE SERVICE", 105, y, {align:"center"});
  y += lineHeight*2;
  doc.setFontSize(10); doc.setFont("helvetica","normal");
  doc.text("Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO: 09769684", 105, y, {align:"center"});
  y += lineHeight*2;

  doc.setFontSize(12);

  function drawField(label,value){ doc.setFont("helvetica","bold"); doc.text(label+":",10,y); doc.setFont("helvetica","normal"); doc.text(value||"",60,y); y+=lineHeight; }
  function drawTextarea(label,value){ doc.setFont("helvetica","bold"); doc.text(label+":",10,y); doc.setFont("helvetica","normal"); const lines=doc.splitTextToSize(value||"",180); doc.text(lines,10,y+lineHeight); y+=lines.length*lineHeight+lineHeight; }

  // Horn√≠ pole
  drawField("ƒå√≠slo objedn√°vky", document.getElementById("order-number").value);
  drawField("ƒå√≠slo reklamace", document.getElementById("claim-number").value);
  drawField("Z√°kazn√≠k", document.getElementById("customer").value);
  drawField("Adresa z√°kazn√≠ka", document.getElementById("address").value);
  drawField("Telefon", document.getElementById("phone").value);
  drawField("Email", document.getElementById("email").value);
  drawField("Technik", document.getElementById("technician").value);
  drawField("Datum n√°v≈°tƒõvy", document.getElementById("visit-date").value);
  drawField("Datum doruƒçen√≠", document.getElementById("delivery-date").value);
  drawField("Datum pod√°n√≠ reklamace", document.getElementById("claim-date").value);
  drawField("Znaƒçka / Contract", document.getElementById("brand").value);
  drawField("Model", document.getElementById("model").value);

  // Textov√° pole
  drawTextarea("Z√°kazn√≠k reklamuje", document.getElementById("description-cz").value);
  drawTextarea("Probl√©m zji≈°tƒõn√Ω technikem", document.getElementById("problem-cz").value);
  drawTextarea("N√°vrh opravy", document.getElementById("repair-cz").value);

  // Doln√≠ pole
  drawField("Poƒçet opravovan√Ωch d√≠l≈Ø", document.getElementById("parts").value);
  drawField("Cena za pr√°ci", document.getElementById("price-work").value);
  drawField("Cena za materi√°l", document.getElementById("price-material").value);
  drawField("Cena za druh√©ho technika", document.getElementById("price-second").value);
  drawField("Cena za dopravu", document.getElementById("price-transport").value);
  drawField("Cena celkem", document.getElementById("price-total").value);
  drawField("Reklamace vy≈ôe≈°ena?", document.getElementById("solved").value);
  drawField("ƒåek√° se na vyj√°d≈ôen√≠ prodejce?", document.getElementById("dealer").value);
  drawField("Po≈°kozen√≠ technikem?", document.getElementById("damage").value);
  drawField("√öhradu provede z√°kazn√≠k?", document.getElementById("payment").value);
  drawField("Datum podpisu", document.getElementById("sign-date").value);

  // Podpis
  if(signaturePad && !signaturePad.isEmpty()){
    const sigData = signaturePad.toDataURL("image/png");
    doc.addImage(sigData,"PNG",15,y,80,30);
    y+=35;
  }

  lastPdfName = buildPdfFileName();
  doc.save(lastPdfName);
  if(callback) callback();
}

function downloadPDF(){ generatePdf(); }
function saveAndMail(){ openMailClient(); generatePdf(); }
function openMailClient(){
  const customer = document.getElementById("customer").value || "";
  const order = document.getElementById("order-number").value || "";
  const claim = document.getElementById("claim-number").value || "";
  const visitDate = document.getElementById("visit-date").value || "";
  const email = document.getElementById("email").value || "";
  const subject = `Reklamace Natuzzi - ${customer} (${order})`;
  const body = `Dobr√Ω den ${customer},\n\nzas√≠l√°me V√°m protokol z n√°v≈°tƒõvy technika.\n\nƒå√≠slo reklamace: ${claim}\nDatum n√°v≈°tƒõvy: ${visitDate}\n\nSoubor ${lastPdfName} byl ulo≈æen ‚Äì pros√≠m p≈ôilo≈æte jej do e-mailu jako p≈ô√≠lohu.\n\n=====================\nWHITE GLOVE SERVICE\n=====================\nDo Dubƒçe 364, Bƒõchovice 190 11\n+420 725 965 826\nreklamace-wgs@email.cz`;
  window.location.href=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// PROPISOV√ÅN√ç DAT ZE SEZNAMU
window.addEventListener("message",(event)=>{
  if(event.data.type==="openProtocol"){
    const d=event.data.row; if(!d) return;
    document.getElementById("order-number").value = d["Order number"]||"";
    document.getElementById("claim-number").value = d["Label"]||"";
    document.getElementById("customer").value = d["Customer"]||"";
    document.getElementById("address").value = d["Address"]||"";
    document.getElementById("phone").value = d["KONTAKT"]||"";
    document.getElementById("email").value = d["Email"]||d["EMAIL"]||d["E-mail"]||d["MAIL"]||d[15]||"";
    document.getElementById("brand").value = d["Contract"]||d["Label"]||"";
    document.getElementById("model").value = d["Model"]||"";
    document.getElementById("description-cz").value = d["POPIS REKLAMACE - OPRAVY"]||"";
    document.getElementById("problem-cz").value = d["Problem detected"]||"";
    document.getElementById("repair-cz").value = d["Repair proposal"]||"";
    document.getElementById("visit-date").value = d["Visit date"]||"";
    document.getElementById("delivery-date").value = d["Delivery date"]||"";
    document.getElementById("claim-date").value = d["Complaint date"]||"";
    document.getElementById("sign-date").value = d["Signature date"]||"";
    document.getElementById("parts").value = d["Number of repaired parts"]||"";
    document.getElementById("price-work").value = d["Work cost"]||"";
    document.getElementById("price-material").value = d["Material cost"]||"";
    document.getElementById("price-second").value = d["Second technician cost"]||"";
    document.getElementById("price-transport").value = d["Transport cost"]||"";
    document.getElementById("price-total").value = d["Total cost"]||"";
    document.getElementById("solved").value = d["Complaint solved?"]||"";
    document.getElementById("dealer").value = d["Waiting for dealer statement?"]||"";
    document.getElementById("damage").value = d["Damage by technician?"]||"";
    document.getElementById("payment").value = d["Customer will pay?"]||"";
  }
});

// AUTOMATICK√ù P≈òEKLAD
function autoTranslate(srcId, tgtId){
  const sourceText=document.getElementById(srcId).value;
  const targetEl=document.getElementById(tgtId);
  if(!sourceText.trim()) return targetEl.value="";
  fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=cs&tl=en&dt=t&q=${encodeURIComponent(sourceText)}`)
    .then(res=>res.json())
    .then(data=>{ if(data && data[0]) targetEl.value=data[0].map(pair=>pair[0]).join(""); });
}
</script>
</body>
</html>
