<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol - White Glove Service</title>
<style>
body { font-family: Inter, sans-serif; background:#f6f7fb; margin:0; padding:20px; display:flex; justify-content:center; }
.wrapper { width:100%; max-width:900px; background:white; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.1); }

.header { text-align:center; margin-bottom:20px; }
.header div:first-child { font-size:28px; font-weight:900; }
.header div:last-child { font-size:12px; margin-top:4px; font-weight:normal; }

.fieldset { border:1px solid #ccc; padding:10px; margin-bottom:15px; border-radius:6px; }
.legend { font-weight:700; font-size:14px; margin-bottom:6px; }
.label { font-weight:600; margin-top:6px; display:block; }
input, select { width:100%; height:36px; font-size:1em; padding:4px 8px; border:1px solid #aaa; border-radius:4px; }
textarea { width:100%; min-height:80px; resize:vertical; padding:4px 8px; font-size:1em; border:1px solid #aaa; border-radius:4px; }

#signature-pad { border:2px dashed #888; width:100%; height:180px; background:white; margin-top:6px; }

.btns { display:flex; flex-wrap:wrap; gap:10px; margin-top:20px; }
.btns button { flex:1 1 45%; height:42px; font-weight:600; color:white; border:none; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; }

.btn-clear { background: linear-gradient(145deg,#7a0f0f,#ff4d4d,#a83232); }
.btn-back { background: linear-gradient(145deg,#808080,#dcdcdc,#a9a9a9); color:#000; }
.btn-pdf { background: linear-gradient(145deg,#004080,#1e90ff,#003366); }
.btn-email { background: linear-gradient(145deg,#006600,#28a745,#004d00); }

/* MobilnÃ­ pÅ™izpÅ¯sobenÃ­ */
@media screen and (max-width:768px){
  .fieldset { padding:8px; }
  textarea, input, select { font-size:1em; height:36px; }
  .btns { flex-direction:column; }
}
</style>
</head>
<body>
<div class="wrapper">

<div class="header">
  <div>WHITE GLOVE SERVICE</div>
  <div>Do DubÄe 364, BÄ›chovice 190 11 Â· +420 725 965 826 Â· reklamace-wgs@email.cz Â· IÄŒO: 09769684</div>
</div>

<!-- ObjednÃ¡vka a zÃ¡kaznÃ­k -->
<div class="fieldset">
  <div class="legend">ObjednÃ¡vka a zÃ¡kaznÃ­k</div>
  <label class="label">ÄŒÃ­slo objednÃ¡vky</label><input id="order-number">
  <label class="label">ÄŒÃ­slo reklamace</label><input id="claim-number">
  <label class="label">ZÃ¡kaznÃ­k</label><input id="customer">
  <label class="label">Adresa zÃ¡kaznÃ­ka</label><input id="address">
  <label class="label">Telefon</label><input id="phone">
  <label class="label">Email</label><input id="email">
</div>

<!-- Technik a data -->
<div class="fieldset">
  <div class="legend">Technik a data</div>
  <label class="label">Technik</label>
  <select id="technician">
    <option>Milan KolÃ­n</option>
    <option>Radek Zikmund</option>
    <option>KolÃ­n/Zikmund</option>
  </select>
  <label class="label">Datum nÃ¡vÅ¡tÄ›vy</label><input id="visit-date" type="date">
  <label class="label">Datum doruÄenÃ­</label><input id="delivery-date" type="date">
  <label class="label">Datum podÃ¡nÃ­ reklamace</label><input id="claim-date" type="date">
  <label class="label">ZnaÄka / Contract</label><input id="brand">
  <label class="label">Model</label><input id="model">
</div>

<!-- TextovÃ¡ pole CZ/EN -->
<div class="fieldset">
  <div class="legend">ZÃ¡kaznÃ­k reklamuje</div>
  <textarea id="description-cz" placeholder="CZ"></textarea>
  <textarea id="description-en" placeholder="EN"></textarea>
</div>

<div class="fieldset">
  <div class="legend">ProblÃ©m zjiÅ¡tÄ›nÃ½ technikem</div>
  <textarea id="problem-cz" placeholder="CZ"></textarea>
  <textarea id="problem-en" placeholder="EN"></textarea>
</div>

<div class="fieldset">
  <div class="legend">NÃ¡vrh opravy</div>
  <textarea id="repair-cz" placeholder="CZ"></textarea>
  <textarea id="repair-en" placeholder="EN"></textarea>
</div>
<!-- DolnÃ­ pole: ceny a stav -->
<div class="fieldset">
  <div class="legend">Ceny a stav reklamace</div>
  <label class="label">PoÄet opravovanÃ½ch dÃ­lÅ¯</label><input id="parts">
  <label class="label">Cena za prÃ¡ci</label><input id="price-work">
  <label class="label">Cena za materiÃ¡l</label><input id="price-material">
  <label class="label">Cena za druhÃ©ho technika</label><input id="price-second">
  <label class="label">Cena za dopravu</label><input id="price-transport">
  <label class="label">Cena celkem</label><input id="price-total">
  <label class="label">Reklamace vyÅ™eÅ¡ena?</label>
  <select id="solved"><option>ANO</option><option>NE</option></select>
  <label class="label">ÄŒekÃ¡ se na vyjÃ¡dÅ™enÃ­ prodejce?</label>
  <select id="dealer"><option>NE</option><option>ANO</option></select>
  <label class="label">PoÅ¡kozenÃ­ technikem?</label>
  <select id="damage"><option>NE</option><option>ANO</option></select>
  <label class="label">Ãšhradu provede zÃ¡kaznÃ­k?</label>
  <select id="payment"><option>NE</option><option>ANO</option></select>
  <label class="label">Datum podpisu</label><input id="sign-date" type="date">
</div>

<!-- Podpis -->
<div class="fieldset">
  <div class="legend">Podpis zÃ¡kaznÃ­ka</div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">PodepiÅ¡te se prstem nebo myÅ¡Ã­</div>
</div>

<!-- TlaÄÃ­tka -->
<div class="btns">
  <button class="btn-clear" type="button" onclick="signaturePad.clear()">ğŸ—‘ï¸ Vymazat podpis</button>
  <button class="btn-back" type="button" onclick="window.location.href='index.html'">â®ª ZPÄšT</button>
  <button class="btn-pdf" type="button" onclick="downloadPDF()">ğŸ“„ Exportovat do PDF</button>
  <button class="btn-email" type="button" onclick="saveAndMail()">âœ‰ï¸ Odeslat e-mail zÃ¡kaznÃ­kovi</button>
</div>

</div> <!-- wrapper -->

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let signaturePad;
let lastPdfName = "protokol.pdf";

window.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("signature-pad");
  function resizeCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas, { passive: true });
  signaturePad = new SignaturePad(canvas, { backgroundColor: "white" });

  const today = new Date().toISOString().split("T")[0];
  document.getElementById("visit-date").value = today;
  document.getElementById("sign-date").value = today;
});

function stripDiacritics(str){ return (str||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"_").replace(/[<>:"/\\|?*\u0000-\u001F]/g,"-"); }
function buildPdfFileName(){ 
  const today = new Date().toISOString().split("T")[0];
  const customer = stripDiacritics(document.getElementById("customer").value || "neznamy_zakaznik");
  const claim = stripDiacritics(document.getElementById("claim-number").value || "bez_claimu");
  const order = stripDiacritics(document.getElementById("order-number").value || "bez_objednavky");
  return `${customer}_${claim}_${order}_${today}.pdf`;
}

function generatePdf(callback){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");
  let y = 20;
  const lineHeight = 7;

  // HlaviÄka
  doc.setFontSize(18); doc.setFont("helvetica","bold");
  doc.text("WHITE GLOVE SERVICE", 105, y, {align:"center"});
  y += lineHeight*2;
  doc.setFontSize(10); doc.setFont("helvetica","normal");
  doc.text("Do DubÄe 364, BÄ›chovice 190 11 Â· +420 725 965 826 Â· reklamace-wgs@email.cz Â· IÄŒO: 09769684", 105, y, {align:"center"});
  y += lineHeight*2;

  doc.setFontSize(12);

  function drawField(label,value){ doc.setFont("helvetica","bold"); doc.text(label+":",10,y); doc.setFont("helvetica","normal"); doc.text(value||"",60,y); y+=lineHeight; }
  function drawTextarea(label,value){ doc.setFont("helvetica","bold"); doc.text(label+":",10,y); doc.setFont("helvetica","normal"); const lines=doc.splitTextToSize(value||"",180); doc.text(lines,10,y+lineHeight); y+=lines.length*lineHeight+lineHeight; }

  // HornÃ­ pole
  drawField("ÄŒÃ­slo objednÃ¡vky", document.getElementById("order-number").value);
  drawField("ÄŒÃ­slo reklamace", document.getElementById("claim-number").value);
  drawField("ZÃ¡kaznÃ­k", document.getElementById("customer").value);
  drawField("Adresa zÃ¡kaznÃ­ka", document.getElementById("address").value);
  drawField("Telefon", document.getElementById("phone").value);
  drawField("Email", document.getElementById("email").value);
  drawField("Technik", document.getElementById("technician").value);
  drawField("Datum nÃ¡vÅ¡tÄ›vy", document.getElementById("visit-date").value);
  drawField("Datum doruÄenÃ­", document.getElementById("delivery-date").value);
  drawField("Datum podÃ¡nÃ­ reklamace", document.getElementById("claim-date").value);
  drawField("ZnaÄka / Contract", document.getElementById("brand").value);
  drawField("Model", document.getElementById("model").value);

  // TextovÃ¡ pole
  drawTextarea("ZÃ¡kaznÃ­k reklamuje", document.getElementById("description-cz").value);
  drawTextarea("ProblÃ©m zjiÅ¡tÄ›nÃ½ technikem", document.getElementById("problem-cz").value);
  drawTextarea("NÃ¡vrh opravy", document.getElementById("repair-cz").value);

  // DolnÃ­ pole
  drawField("PoÄet opravovanÃ½ch dÃ­lÅ¯", document.getElementById("parts").value);
  drawField("Cena za prÃ¡ci", document.getElementById("price-work").value);
  drawField("Cena za materiÃ¡l", document.getElementById("price-material").value);
  drawField("Cena za druhÃ©ho technika", document.getElementById("price-second").value);
  drawField("Cena za dopravu", document.getElementById("price-transport").value);
  drawField("Cena celkem", document.getElementById("price-total").value);
  drawField("Reklamace vyÅ™eÅ¡ena?", document.getElementById("solved").value);
  drawField("ÄŒekÃ¡ se na vyjÃ¡dÅ™enÃ­ prodejce?", document.getElementById("dealer").value);
  drawField("PoÅ¡kozenÃ­ technikem?", document.getElementById("damage").value);
  drawField("Ãšhradu provede zÃ¡kaznÃ­k?", document.getElementById("payment").value);
  drawField("Datum podpisu", document.getElementById("sign-date").value);

  // Podpis
  if(signaturePad && !signaturePad.isEmpty()){
    const sigData = signaturePad.toDataURL("image/png");
    doc.addImage(sigData,"PNG",15,y,80,30);
    y+=35;
  }

  lastPdfName = buildPdfFileName();
  doc.save(lastPdfName);
  if(callback) callback();
}

function downloadPDF(){ generatePdf(); }
function saveAndMail(){ openMailClient(); generatePdf(); }
function openMailClient(){
  const customer = document.getElementById("customer").value || "";
  const order = document.getElementById("order-number").value || "";
  const claim = document.getElementById("claim-number").value || "";
  const visitDate = document.getElementById("visit-date").value || "";
  const email = document.getElementById("email").value || "";
  const subject = `Reklamace Natuzzi - ${customer} (${order})`;
  const body = `DobrÃ½ den ${customer},\n\nzasÃ­lÃ¡me VÃ¡m protokol z nÃ¡vÅ¡tÄ›vy technika.\n\nÄŒÃ­slo reklamace: ${claim}\nDatum nÃ¡vÅ¡tÄ›vy: ${visitDate}\n\nSoubor ${lastPdfName} byl uloÅ¾en â€“ prosÃ­m pÅ™iloÅ¾te jej do e-mailu jako pÅ™Ã­lohu.\n\n=====================\nWHITE GLOVE SERVICE\n=====================\nDo DubÄe 364, BÄ›chovice 190 11\n+420 725 965 826\nreklamace-wgs@email.cz`;
  window.location.href=`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// PROPISOVÃNÃ DAT ZE SEZNAMU
window.addEventListener("message",(event)=>{
  if(event.data.type==="openProtocol"){
    const d=event.data.row; if(!d) return;
    document.getElementById("order-number").value = d["Order number"]||"";
    document.getElementById("claim-number").value = d["Label"]||"";
    document.getElementById("customer").value = d["Customer"]||"";
    document.getElementById("address").value = d["Address"]||"";
    document.getElementById("phone").value = d["KONTAKT"]||"";
    document.getElementById("email").value = d["Email"]||d["EMAIL"]||d["E-mail"]||d["MAIL"]||d[15]||"";
    document.getElementById("brand").value = d["Contract"]||d["Label"]||"";
    document.getElementById("model").value = d["Model"]||"";
    document.getElementById("description-cz").value = d["POPIS REKLAMACE - OPRAVY"]||"";
    document.getElementById("problem-cz").value = d["Problem detected"]||"";
    document.getElementById("repair-cz").value = d["Repair proposal"]||"";
    document.getElementById("visit-date").value = d["Visit date"]||"";
    document.getElementById("delivery-date").value = d["Delivery date"]||"";
    document.getElementById("claim-date").value = d["Complaint date"]||"";
    document.getElementById("sign-date").value = d["Signature date"]||"";
    document.getElementById("parts").value = d["Number of repaired parts"]||"";
    document.getElementById("price-work").value = d["Work cost"]||"";
    document.getElementById("price-material").value = d["Material cost"]||"";
    document.getElementById("price-second").value = d["Second technician cost"]||"";
    document.getElementById("price-transport").value = d["Transport cost"]||"";
    document.getElementById("price-total").value = d["Total cost"]||"";
    document.getElementById("solved").value = d["Complaint solved?"]||"";
    document.getElementById("dealer").value = d["Waiting for dealer statement?"]||"";
    document.getElementById("damage").value = d["Damage by technician?"]||"";
    document.getElementById("payment").value = d["Customer will pay?"]||"";
  }
});

// AUTOMATICKÃ PÅ˜EKLAD
function autoTranslate(srcId, tgtId){
  const sourceText=document.getElementById(srcId).value;
  const targetEl=document.getElementById(tgtId);
  if(!sourceText.trim()) return targetEl.value="";
  fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=cs&tl=en&dt=t&q=${encodeURIComponent(sourceText)}`)
    .then(res=>res.json())
    .then(data=>{ if(data && data[0]) targetEl.value=data[0].map(pair=>pair[0]).join(""); });
}
</script>
</body>
</html>
