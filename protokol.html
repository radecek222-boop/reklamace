<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protokol - White Glove Service</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 p-4 text-sm font-sans">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <div class="text-center mb-4">
      <h1 class="text-2xl font-bold">WHITE GLOVE SERVICE</h1>
      <p class="text-xs">Do Dubče 364, Běchovice 190 11 · +420 725 965 826 · reklamace-wgs@email.cz · IČO: 09769684</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label>Číslo objednávky<input id="order-number" class="input"/></label></div>
      <div><label>Číslo reklamace<input id="claim-number" class="input"/></label></div>
      <div><label>Zákazník<input id="customer" class="input"/></label></div>
      <div><label>Adresa zákazníka<input id="address" class="input"/></label></div>
      <div><label>Značka / Contract<input id="brand" class="input"/></label></div>
      <div><label>Model<input id="model" class="input"/></label></div>
      <div><label>Technik<select class="input"><option>Milan Kolín</option><option>Radek Zikmund</option></select></label></div>
      <div><label>Datum návštěvy<input id="visit-date" class="input"/></label></div>
    </div>

    <template id="dual-field-template">
      <div class="mt-6">
        <h2 class="font-semibold">{{title}}</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div><label class="text-xs">CZ<textarea id="{{idCZ}}" class="input"></textarea></label></div>
          <div><label class="text-xs">EN<textarea id="{{idEN}}" class="input" readonly></textarea></label></div>
        </div>
      </div>
    </template>

    <div id="translated-fields"></div>

    <script>
      const fields = [
        { title: "Zákazník reklamuje / Customer complaint", idCZ: "description-cz", idEN: "description-en" },
        { title: "Problém zjištěný technikem / Detected problem", idCZ: "problem-cz", idEN: "problem-en" },
        { title: "Návrh opravy / Repair proposal", idCZ: "repair-cz", idEN: "repair-en" }
      ];
      const container = document.getElementById('translated-fields');
      const tmpl = document.getElementById('dual-field-template').innerHTML;
      fields.forEach(f => container.innerHTML += tmpl.replaceAll("{{title}}", f.title).replaceAll("{{idCZ}}", f.idCZ).replaceAll("{{idEN}}", f.idEN));
    </script>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
      <div>
        <label>Počet opravovaných dílů<input class="input"></label>
        <label>Cena za práci<input id="price-work" class="input" oninput="calc()"></label>
        <label>Cena za materiál<input id="price-material" class="input" oninput="calc()"></label>
        <label>Cena za druhého technika<input id="price-second" class="input" oninput="calc()"></label>
        <label>Cena za dopravu<input id="price-transport" class="input" oninput="calc()"></label>
        <label>Cena celkem<input id="price-total" class="input" readonly></label>
      </div>
      <div>
        <label>Reklamace vyřešena?<select class="input"><option>ANO</option><option>NE</option></select></label>
        <label>Čeká se na vyjádření prodejce?<select class="input"><option>NE</option><option>ANO</option></select></label>
        <label>Poškození technikem?<select class="input"><option>NE</option><option>ANO</option></select></label>
        <label>Úhradu provede zákazník?<select class="input"><option>NE</option><option>ANO</option></select></label>
        <label>Datum podpisu<input class="input"></label>
      </div>
    </div>

    <div class="mt-6">
      <h2 class="font-semibold mb-2">Podpis zákazníka / Customer signature:</h2>
      <canvas id="signature-pad" class="border border-dashed w-full h-36"></canvas>
      <p class="text-xs text-gray-500">Podepište se prosím prstem nebo myší</p>
    </div>

    <div class="mt-6 flex gap-4">
      <button onclick="window.close()" class="bg-gray-700 text-white px-4 py-2 rounded">⬅️ Zpět</button>
      <button onclick="downloadPDF()" class="bg-green-600 text-white px-4 py-2 rounded">📄 PDF</button>
    </div>

    <script>
      const calc = () => {
        const g = id => parseFloat(document.getElementById(id).value) || 0;
        document.getElementById("price-total").value = (g("price-work") + g("price-material") + g("price-second") + g("price-transport")).toFixed(2);
      };

      const autoTranslate = (srcId, tgtId) => {
        const t = document.getElementById(srcId).value;
        if (!t.trim()) return document.getElementById(tgtId).value = "";
        fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=cs&tl=en&dt=t&q=${encodeURIComponent(t)}`)
          .then(res => res.json())
          .then(data => document.getElementById(tgtId).value = data[0].map(p => p[0]).join(""));
      };

      window.addEventListener("DOMContentLoaded", () => {
        signaturePad = new SignaturePad(document.getElementById("signature-pad"));
        window.addEventListener("message", e => {
          if (e.data?.type === "openProtocol") {
            const d = e.data.row;
            if (!d) return;
            document.getElementById("order-number").value = d["Order number"] || "";
            document.getElementById("claim-number").value = d["Label"] || "";
            document.getElementById("customer").value = d["Customer"] || "";
            document.getElementById("address").value = d["Address"] || "";
            document.getElementById("brand").value = d["Label"] || "";
            document.getElementById("model").value = d["Model"] || "";
            document.getElementById("description-cz").value = d["POPIS REKLAMACE - OPRAVY"] || "";
            autoTranslate("description-cz", "description-en");
          }
        });

        fields.forEach(f => {
          const input = document.getElementById(f.idCZ);
          input?.addEventListener("input", () => autoTranslate(f.idCZ, f.idEN));
        });
      });

      const downloadPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.html(document.querySelector(".wrapper"), {
          callback: pdf => {
            if (signaturePad && !signaturePad.isEmpty()) {
              const imgData = signaturePad.toDataURL();
              pdf.addImage(imgData, 'PNG', 15, 260, 60, 20);
            }
            pdf.save("protokol.pdf");
          },
          margin: [10, 10, 10, 10], html2canvas: { scale: 0.7 }
        });
      };
    </script>
  </div>
</body>
</html>
