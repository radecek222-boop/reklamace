<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protokol ‚Äì White Glove Service</title>

<style>
/* === üåô WGS Elegantn√≠ tmav√Ω vzhled === */
body {
  font-family: "Inter", sans-serif;
  background: radial-gradient(circle at top left,#030614 0%,#050a1a 80%);
  color:#d9e6ff;
  margin:0;padding:20px;
  display:flex;justify-content:center;
  font-size:13px;
}
.wrapper {
  width:100%;max-width:900px;
  background:rgba(10,15,30,0.9);
  backdrop-filter:blur(6px);
  border-radius:14px;
  box-shadow:0 0 25px rgba(0,150,255,0.25);
  padding:25px 30px;
  box-sizing:border-box;
}
.header{text-align:center;margin-bottom:20px;}
.header div:first-child{
  font-size:26px;font-weight:900;color:#7bc8ff;
  text-shadow:0 0 18px rgba(0,128,255,0.4);
}
.header div:last-child{
  font-size:11px;color:#9fbaff;
  margin-top:4px;
}
.section-title{
  font-weight:700;margin-top:22px;margin-bottom:6px;
  color:#bcd3ff;
  border-left:4px solid #33aaff;
  padding-left:8px;
}
.en-label{font-size:.85em;color:#7f94c2;font-weight:400;display:block;}
table{width:100%;border-collapse:collapse;margin-bottom:10px;}
td{padding:6px;vertical-align:top;}
.label{font-weight:600;color:#bcd3ff;}
input,select,textarea{
  width:100%;padding:6px 8px;
  border:1px solid #ccc;border-radius:5px;
  background:#fff;color:#111;box-sizing:border-box;
}
textarea{min-height:70px;resize:vertical;}
.two-col-table{display:flex;gap:20px;flex-wrap:wrap;}
.col{flex:1;min-width:300px;}
.split-section{display:flex;gap:10px;flex-wrap:wrap;}
#signature-pad{
  border:2px dashed #999;width:100%;height:200px;
  background:#fff;touch-action:none;
}
.signature-label{margin:5px 0 15px;color:#bcd3ff;font-size:.85em;text-align:center;}
.btns{
  margin-top:18px;display:flex;flex-wrap:wrap;justify-content:center;gap:10px;
}
button.btn{
  border:none;border-radius:8px;padding:12px 24px;
  color:#fff;font-weight:600;cursor:pointer;
  box-shadow:0 3px 8px rgba(0,0,0,0.2);
  transition:transform .1s ease,opacity .2s;
}
button.btn:hover{transform:scale(1.03);opacity:.9;}
.btn-yellow{background:linear-gradient(135deg,#ffb200,#ffca40);color:#222;}
.btn-blue{background:linear-gradient(135deg,#0080ff,#33aaff);}
.btn-green{background:linear-gradient(135deg,#00b56a,#00da80);}
.btn-gray{background:linear-gradient(135deg,#777,#aaa);color:#000;}
.btn-clear{
  background:linear-gradient(135deg,#e63946,#ff6b6b);
  color:#fff;border:none;border-radius:6px;
  padding:4px 10px;font-size:0.8em;font-weight:600;
  margin-bottom:6px;cursor:pointer;
}
.btn-clear:hover{opacity:.9;transform:scale(1.05);}
.notif{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:linear-gradient(135deg,#00b56a,#00da80);
  color:#fff;padding:10px 20px;border-radius:8px;
  font-weight:600;font-size:.9em;opacity:0;
  transition:opacity .3s,transform .3s;z-index:3000;
}
.notif.show{opacity:1;transform:translate(-50%,10px);}
.notif.error{background:linear-gradient(135deg,#e63946,#ff6b6b);}
.notif.warning{background:linear-gradient(135deg,#ffb200,#ffca40);color:#222;}
@media(max-width:768px){.two-col-table{flex-direction:column;}.split-section{flex-direction:column;}}
</style>
</head>

<body>
<div class="wrapper">
  <div class="header">
    <div>WHITE GLOVE SERVICE</div>
    <div>Do Dubƒçe 364, Bƒõchovice 190 11 ¬∑ +420 725 965 826 ¬∑ reklamace-wgs@email.cz ¬∑ IƒåO 09769684</div>
  </div>

  <!-- üü® Z√ÅKAZNICK√â √öDAJE -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">ƒå√≠slo objedn√°vky<span class="en-label">Order number</span></td><td><input id="order-number"></td></tr>
        <tr><td class="label">ƒå√≠slo reklamace<span class="en-label">Claim number</span></td><td><input id="claim-number"></td></tr>
        <tr><td class="label">Z√°kazn√≠k<span class="en-label">Customer</span></td><td><input id="customer"></td></tr>
        <tr><td class="label">Adresa<span class="en-label">Address</span></td><td><input id="address"></td></tr>
        <tr><td class="label">Telefon<span class="en-label">Phone</span></td><td><input id="phone"></td></tr>
        <tr><td class="label">Email<span class="en-label">Email</span></td><td><input id="email"></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Technik<span class="en-label">Technician</span></td>
          <td><select id="technician"><option>Milan Kol√≠n</option><option>Radek Zikmund</option><option>Kol√≠n/Zikmund</option></select></td></tr>
        <tr><td class="label">Datum n√°v≈°tƒõvy<span class="en-label">Visit date</span></td><td><input id="visit-date" type="date"></td></tr>
        <tr><td class="label">Datum doruƒçen√≠<span class="en-label">Delivery date</span></td><td><input id="delivery-date" type="date"></td></tr>
        <tr><td class="label">Datum reklamace<span class="en-label">Claim date</span></td><td><input id="claim-date" type="date"></td></tr>
        <tr><td class="label">Znaƒçka/Contract<span class="en-label">Brand</span></td><td><input id="brand"></td></tr>
        <tr><td class="label">Model<span class="en-label">Model</span></td><td><input id="model"></td></tr>
      </table>
    </div>
  </div>

  <!-- üü® POPIS -->
  <div class="section-title">Z√°kazn√≠k reklamuje<span class="en-label">Customer complaint</span></div>
  <div class="split-section"><textarea id="description-cz" placeholder="CZ"></textarea><textarea id="description-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">Probl√©m zji≈°tƒõn√Ω technikem<span class="en-label">Detected problem</span></div>
  <div class="split-section"><textarea id="problem-cz" placeholder="CZ"></textarea><textarea id="problem-en" placeholder="EN" readonly></textarea></div>

  <div class="section-title">N√°vrh opravy<span class="en-label">Repair proposal</span></div>
  <div class="split-section"><textarea id="repair-cz" placeholder="CZ"></textarea><textarea id="repair-en" placeholder="EN" readonly></textarea></div>

  <!-- üü® CENY -->
  <div class="two-col-table">
    <div class="col">
      <table>
        <tr><td class="label">Poƒçet d√≠l≈Ø<span class="en-label">Parts</span></td><td><input id="parts" type="number"></td></tr>
        <tr><td class="label">Pr√°ce<span class="en-label">Work</span></td><td><input id="price-work" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Materi√°l<span class="en-label">Material</span></td><td><input id="price-material" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">2. technik<span class="en-label">Second tech.</span></td><td><input id="price-second" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Doprava<span class="en-label">Transport</span></td><td><input id="price-transport" type="number" step="0.01" oninput="updateTotal()"></td></tr>
        <tr><td class="label">Celkem<span class="en-label">Total</span></td><td><input id="price-total" readonly></td></tr>
      </table>
    </div>
    <div class="col">
      <table>
        <tr><td class="label">Vy≈ôe≈°eno?<span class="en-label">Solved?</span></td><td><select id="solved"><option>ANO</option><option>NE</option></select></td></tr>
        <tr><td class="label">ƒåek√° se na prodejce?<span class="en-label">Waiting dealer?</span></td><td><select id="dealer"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Po≈°kozen√≠ technikem?<span class="en-label">Damage by tech?</span></td><td><select id="damage"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Plat√≠ z√°kazn√≠k?<span class="en-label">Customer pays?</span></td><td><select id="payment"><option>NE</option><option>ANO</option></select></td></tr>
        <tr><td class="label">Datum podpisu<span class="en-label">Signature date</span></td><td><input id="sign-date" type="date"></td></tr>
      </table>
    </div>
  </div>

  <!-- üü® PODPIS + TLAƒå√çTKA -->
  <button class="btn-clear" type="button" onclick="signaturePad.clear()">Vymazat podpis</button>
  <div class="section-title">Podpis z√°kazn√≠ka<span class="en-label">Customer signature</span></div>
  <canvas id="signature-pad"></canvas>
  <div class="signature-label">Podepi≈°te se prstem nebo my≈°√≠</div>

  <div class="btns">
    <button class="btn btn-yellow" type="button" onclick="attachPhotos()">P≈ôidat fotky</button>
    <button class="btn btn-blue" type="button" onclick="exportPDF()">Exportovat PDF</button>
    <button class="btn btn-green" type="button" onclick="mailCustomer()">Odeslat z√°kazn√≠kovi</button>
    <button class="btn btn-gray" type="button" onclick="window.location.href='index.html'">Zpƒõt</button>
  </div>

  <div id="notif" class="notif"></div>
</div>

<!-- === JS ‚Äì v√Ωpoƒçet a PDF === -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
function updateTotal(){
 const a=parseFloat(priceWork.value)||0,b=parseFloat(priceMaterial.value)||0,
       c=parseFloat(priceSecond.value)||0,d=parseFloat(priceTransport.value)||0;
 priceTotal.value=(a+b+c+d).toFixed(2);
}
let signaturePad;
window.addEventListener("load",()=>{
 const c=document.getElementById("signature-pad");
 const resize=()=>{const r=Math.max(window.devicePixelRatio||1,1);c.width=c.offsetWidth*r;c.height=c.offsetHeight*r;c.getContext("2d").scale(r,r);}
 window.addEventListener("resize",resize);resize();
 signaturePad=new SignaturePad(c,{minWidth:1,maxWidth:2,penColor:"black"});
});
function showNotif(t="success",m="Hotovo"){
 const n=document.getElementById("notif");n.className=`notif ${t}`;n.textContent=m;n.classList.add("show");
 clearTimeout(window._t);window._t=setTimeout(()=>n.classList.remove("show"),2500);
}
async function exportPDF(){
 try{
  showNotif("success","Generuji PDF...");
  const {jsPDF}=window.jspdf,doc=new jsPDF("p","mm","a4");
  const wrap=document.querySelector(".wrapper");
  const btns=document.querySelector(".btns");btns.style.display="none";
  const canvas=await html2canvas(wrap,{scale:2,backgroundColor:"#fff",useCORS:true});
  const img=canvas.toDataURL("image/jpeg",0.98);
  const w=210,h=(canvas.height*210)/canvas.width;
  doc.addImage(img,"JPEG",0,0,210,Math.min(h,297));
  // ƒçernob√≠l√Ω efekt + ≈°ed√© boxy simulace
  doc.setDrawColor(150);doc.setFillColor(245);doc.rect(10,10,190,277);
  btns.style.display="flex";
  window.open(doc.output("bloburl"),"_blank");
  showNotif("success","PDF vytvo≈ôeno");
 }catch(e){console.error(e);showNotif("error","Chyba PDF");}
}
function mailCustomer(){showNotif("warning","Otev√≠r√°m mail‚Ä¶");}
function attachPhotos(){showNotif("warning","Zat√≠m neaktivn√≠ demo");}
</script>
 <!-- üü¶ ƒå√ÅST 2/2 ‚Äì FOTODOKUMENTACE + SPOJEN√ç PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<script>
let attachedPhotos = [];

// üì∏ P≈ôid√°n√≠ fotek nebo po≈ô√≠zen√≠ z kamery
async function attachPhotos() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.multiple = true;
  input.capture = "environment";
  input.style.display = "none";
  document.body.appendChild(input);

  input.onchange = async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    showNotif("success", "Zpracov√°v√°m fotky...");
    attachedPhotos = [];
    for (const file of files) {
      const blob = await compressImage(file, 0.6);
      const base64 = await toBase64(blob);
      attachedPhotos.push(base64);
    }
    localStorage.setItem("photoPdfDataLocal", JSON.stringify(attachedPhotos));
    renderPhotoPreview(attachedPhotos);
    showNotif("success", "Fotky p≈ôid√°ny");
    input.remove();
  };
  input.click();
}

// üß© Komprese obr√°zku
async function compressImage(file, maxMB = 0.6) {
  const img = await loadImage(URL.createObjectURL(file));
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const maxW = 1200;
  const s = Math.min(1, maxW / img.width);
  canvas.width = img.width * s;
  canvas.height = img.height * s;
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  let q = 0.85;
  let blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", q));
  while (blob.size > maxMB * 1024 * 1024 && q > 0.4) {
    q -= 0.05;
    blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", q));
  }
  return blob;
}

// üß© Naƒçten√≠ a p≈ôevod
function loadImage(src){return new Promise((r,j)=>{const i=new Image();i.onload=()=>r(i);i.onerror=j;i.src=src;});}
function toBase64(b){return new Promise((r,j)=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.onerror=j;fr.readAsDataURL(b);});}

// üß© N√°hled pod protokolem
function renderPhotoPreview(arr){
  let cont=document.getElementById("photoPreviewContainer");
  if(!cont){
    cont=document.createElement("div");
    cont.id="photoPreviewContainer";
    cont.style.marginTop="25px";
    document.querySelector(".wrapper").appendChild(cont);
  }
  cont.innerHTML="<h3 style='margin-bottom:10px;'>üì∑ P≈ôipojen√© fotky</h3><div id='photoGrid' style='display:flex;flex-wrap:wrap;gap:10px;'></div>";
  const grid=cont.querySelector("#photoGrid");
  arr.forEach(s=>{
    const img=document.createElement("img");
    img.src=s;
    img.style.width="160px";
    img.style.height="110px";
    img.style.objectFit="cover";
    img.style.borderRadius="6px";
    img.style.cursor="pointer";
    img.onclick=()=>window.open(s,"_blank");
    grid.appendChild(img);
  });
}

// üß© Slouƒçen√≠ protokolu + fotky
async function mergePdfWithPhotos(protoDoc, arr){
  const { PDFDocument } = window.PDFLib;
  const protoBytes = await protoDoc.output("arraybuffer");
  const mainPdf = await PDFDocument.load(protoBytes);
  const photosPdf = await createPhotosPdf(arr);
  const copy = await mainPdf.copyPages(photosPdf, photosPdf.getPageIndices());
  copy.forEach(p=>mainPdf.addPage(p));
  return await mainPdf.save();
}

// üß© Vytvo≈ôen√≠ PDF s fotkami
async function createPhotosPdf(arr){
  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF("p","mm","a4");
  const w=pdf.internal.pageSize.getWidth(), h=pdf.internal.pageSize.getHeight();
  let y=20;
  for(const src of arr){
    const imgW=w-40, imgH=(imgW*3)/4;
    if(y+imgH>h-20){pdf.addPage();y=20;}
    pdf.addImage(src,"JPEG",20,y,imgW,imgH);
    y+=imgH+10;
  }
  const bytes=pdf.output("arraybuffer");
  return await PDFLib.PDFDocument.load(bytes);
}

// üß© P≈ôepsan√Ω exportPDF pro spojen√≠
async function exportPDF(){
  try{
    showNotif("success","Generuji PDF...");
    const proto=await generateProtocolPDF();
    const local=JSON.parse(localStorage.getItem("photoPdfDataLocal")||"[]");
    if(local.length){
      const merged=await mergePdfWithPhotos(proto,local);
      const blob=new Blob([merged],{type:"application/pdf"});
      const url=URL.createObjectURL(blob);
      window.open(url,"_blank");
      showNotif("success","PDF vytvo≈ôeno s fotkami");
    }else{
      const blob=proto.output("blob");
      const url=URL.createObjectURL(blob);
      window.open(url,"_blank");
      showNotif("warning","Export bez fotek");
    }

    // ‚úÖ po exportu p≈ôesun do hotov√Ωch
    await moveToHotove();

  }catch(e){console.error(e);showNotif("error","Chyba exportu PDF");}
}

// üü¢ Po exportu nebo odesl√°n√≠ ‚Äì p≈ôesun do hotov√Ωch
async function moveToHotove() {
  try {
    const base = "https://wgs-token.72nvwf4pb2.workers.dev";
    const current = JSON.parse(localStorage.getItem("currentCustomer") || "{}");
    if (!current || !current.cislo) return console.warn("‚ö†Ô∏è ≈Ω√°dn√Ω aktu√°ln√≠ z√°kazn√≠k v localStorage");

    // 1Ô∏è‚É£ Ulo≈æen√≠ do hotov√Ωch
    await fetch(`${base}/hotove`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(current)
    });

    // 2Ô∏è‚É£ Smaz√°n√≠ z temporaryfiles
    await fetch(`${base}/temporaryfiles`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cislo: current.cislo })
    });

    showNotif("success", "Reklamace p≈ôesunuta do hotov√Ωch");
  } catch (e) {
    console.error("‚ùå Chyba p≈ôesunu:", e);
    showNotif("error", "Nepoda≈ôilo se p≈ôesunout do hotov√Ωch");
  }
}

// ‚úâÔ∏è Po odesl√°n√≠ z√°kazn√≠kovi
function mailCustomer(){
  showNotif("warning","Otev√≠r√°m mail‚Ä¶");
  moveToHotove();
}
</script>
<!-- üü¶ KONEC ƒå√ÅSTI 2/2 ‚Äì FOTODOKUMENTACE + SPOJEN√ç PDF -->
