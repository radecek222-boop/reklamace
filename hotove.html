<!-- 
====================================================================
üíé WHITE GLOVE SERVICE ‚Äì HOTOV√â REKLAMACE (BETA)
====================================================================
Verze syst√©mu:       v1.1
Datum sestaven√≠:     2025-10-08
Autor:               Hugo (White Glove Service) & GPT-5
Projekt:             WGS reklamace / servisn√≠ pl√°nov√°n√≠
Soubory:             hotove.html (p≈ôehled dokonƒçen√Ωch reklamac√≠)
Zdroje:              dataAll + stavyReklamaci (localStorage / GitHub)
Repozit√°≈ô:           https://github.com/radecek222-boop/reklamace
Popis:
  P≈ôehled v≈°ech hotov√Ωch reklamac√≠ s mo≈ænost√≠ otev≈ô√≠t protokol PDF.
  Zobrazuje tak√© datum vytvo≈ôen√≠ protokolu.

Struktura souboru:
  A ‚Äì HTML, HEAD, STYL
  B ‚Äì Hlaviƒçka a tlaƒç√≠tka
  C ‚Äì Kontejner tabulky
  D ‚Äì Naƒç√≠t√°n√≠ dat a filtrov√°n√≠
  E ‚Äì Generov√°n√≠ tabulky
  F ‚Äì Zobrazen√≠ PDF protokolu
  G ‚Äì Inicializace
====================================================================
-->

<!-- üü® A ‚Äì Z√ÅKLAD DOKUMENTU -->
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Hotov√© reklamace ‚Äì White Glove Service</title>
<style>
body{
  font-family:"Inter",system-ui,sans-serif;
  background:#f6f7fb;margin:0;padding:0;
  display:flex;justify-content:center;align-items:flex-start;
  min-height:100vh;
}
.wrapper{
  background:#fff;padding:25px;margin:40px 15px;
  border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);
  width:100%;max-width:900px;position:relative;box-sizing:border-box;
}
h1{text-align:center;font-size:2.2em;font-weight:900;color:#111;margin:0 0 8px;}
h2{text-align:center;font-size:1.1em;font-weight:500;color:#666;margin:0 0 25px;}
.actions{
  text-align:center;margin-bottom:20px;
  display:flex;justify-content:center;flex-wrap:wrap;gap:15px;
}
.btn{
  display:inline-block;text-decoration:none;
  padding:10px 24px;border-radius:8px;font-weight:600;
  font-size:1em;border:none;cursor:pointer;
  transition:transform .15s ease-in-out,opacity .2s;
  color:white;box-shadow:0 3px 8px rgba(0,0,0,.15);
  min-width:140px;
}
.btn:hover{transform:scale(1.04);opacity:.9;}
.btn-back{background:linear-gradient(135deg,#6c757d,#a0a4a7);}
.btn-refresh{background:linear-gradient(135deg,#28a745,#5bd85b);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:.95em;}
th{background:#f8f8f8;font-weight:700;}
tr:hover{background:#f1f6ff;}
.loading{text-align:center;padding:30px;color:#666;}
.btn-pdf{
  background:linear-gradient(135deg,#0046ff,#357aff);
  padding:6px 14px;font-size:.85em;border-radius:6px;
  color:#fff;text-decoration:none;
}
.btn-pdf:hover{opacity:.85;}
.protokol-info{
  display:flex;flex-direction:column;gap:4px;
}
.protokol-date{
  font-size:.8em;color:#555;
}
@media(max-width:700px){
  th,td{font-size:.85em;}
  .btn{min-width:120px;padding:8px 18px;font-size:.9em;}
  .protokol-info{align-items:flex-start;}
}
</style>
</head>

<!-- üü© KONEC A -->

<body>
<div class="wrapper">
  <!-- üü® B ‚Äì HLAVIƒåKA A TLAƒå√çTKA -->
  <h1>WHITE GLOVE SERVICE</h1>
  <h2>Hotov√© reklamace</h2>
  <div class="actions">
    <a href="seznam.html" class="btn btn-back">Zpƒõt</a>
    <button id="reloadBtn" class="btn btn-refresh">Naƒç√≠st znovu</button>
  </div>

  <!-- üü® C ‚Äì KONTEJNER TABULKY -->
  <div id="tableContainer" class="loading">Naƒç√≠t√°m data...</div>

<!-- üü® D ‚Äì NAƒå√çT√ÅN√ç DAT A FILTROV√ÅN√ç (s automatick√Ωm obnoven√≠m po 5 s) -->
<script>
async function loadDone(autoRetry = true) {
  const stavy = JSON.parse(localStorage.getItem("stavyReklamaci") || "{}");
  const dataAll = JSON.parse(localStorage.getItem("dataAll") || "[]");

  // ‚è≥ Pokud nejsou data, zkus znovu za 5 s (ƒçek√°me, a≈æ GitHub ulo≈æ√≠ zmƒõny)
  if (!dataAll.length) {
    tableContainer.innerHTML = "<div class='loading'>≈Ω√°dn√© ulo≈æen√© z√°znamy ‚Äì ƒçek√°m na synchronizaci...</div>";
    if (autoRetry) setTimeout(() => loadDone(false), 5000);
    return;
  }

  // üîç Filtrov√°n√≠ hotov√Ωch reklamac√≠
  const hotove = dataAll.filter(r => {
    const id = r.cislo || r.zakaznik;
    return stavy[id] === "hotovo";
  });

   // ‚è≥ Pokud zat√≠m ≈æ√°dn√© hotov√©, zkus znovu po 5 s
  if (!hotove.length) {
    tableContainer.innerHTML = "<div class='loading'>≈Ω√°dn√© hotov√© reklamace ‚Äì kontroluji aktualizaci...</div>";
    if (autoRetry) setTimeout(() => loadDone(false), 5000);
    return;
  }

  // ‚úÖ Hotov√© reklamace vykreslit
  renderTable(hotove);
}
</script>
<!-- üü® KONEC SEKCE D -->

<!-- üü® ZAƒå√ÅTEK SEKCE E ‚Äì GENEROV√ÅN√ç TABULKY (s datem protokolu) -->
<script>
function renderTable(hotove) {
  let html = `
  <table>
    <thead>
      <tr>
        <th>#</th><th>ƒå√≠slo</th><th>Z√°kazn√≠k</th><th>Adresa</th>
        <th>Telefon</th><th>Zadavatel</th><th>Typ</th><th>Protokol</th>
      </tr>
    </thead><tbody>`;
  hotove.forEach((r, i) => {
    const hasProto = r.protokol?.file;
    const protoBtn = hasProto
      ? `<a href="#" class="btn-pdf" onclick="openProtocol('${r.cislo}')">üìé Zobrazit PDF</a>`
      : `<span style='color:#999;'>‚Äî</span>`;
    const protoDate = r.protokol?.date
      ? `<span class='protokol-date'>${r.protokol.date}</span>`
      : "";
    const protoHtml = `<div class='protokol-info'>${protoBtn}${protoDate}</div>`;

    html += `
      <tr>
        <td>${i + 1}</td>
        <td>${r.cislo || ""}</td>
        <td>${r.zakaznik || ""}</td>
        <td>${r.adresa || ""}</td>
        <td><a href="tel:${r.telefon || ""}">${r.telefon || ""}</a></td>
        <td>${r.contract || (r.jinaZadavatel?.jmeno || "")}</td>
        <td>${r.typ || ""}</td>
        <td>${protoHtml}</td>
      </tr>`;
  });
  html += `</tbody></table>`;
  tableContainer.innerHTML = html;
}
</script>
<!-- üü® KONEC SEKCE E -->

<!-- üü® ZAƒå√ÅTEK SEKCE F ‚Äì ZOBRAZEN√ç PDF PROTOKOLU -->
<script>
function openProtocol(cislo){
  try{
    const dataAll = JSON.parse(localStorage.getItem("dataAll") || "[]");
    const item = dataAll.find(r => r.cislo === cislo);
    if(!item || !item.protokol?.file){
      alert("Protokol nen√≠ ulo≈æen.");
      return;
    }
    const pdfUrl = URL.createObjectURL(b64toBlob(item.protokol.file, "application/pdf"));
    window.open(pdfUrl, "_blank");
  }catch(e){
    console.error("‚ùå Chyba p≈ôi otev√≠r√°n√≠ protokolu:", e);
  }
}

// pomocn√° konverze Base64 ‚Üí Blob
function b64toBlob(b64Data, contentType){
  contentType = contentType || "";
  const sliceSize = 512;
  const byteCharacters = atob(b64Data);
  const byteArrays = [];
  for(let offset = 0; offset < byteCharacters.length; offset += sliceSize){
    const slice = byteCharacters.slice(offset, offset + sliceSize);
    const byteNumbers = new Array(slice.length);
    for(let i = 0; i < slice.length; i++){
      byteNumbers[i] = slice.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    byteArrays.push(byteArray);
  }
  return new Blob(byteArrays, { type: contentType });
}

// üü® G ‚Äì INIT
document.getElementById("reloadBtn").addEventListener("click", loadDone);
window.addEventListener("DOMContentLoaded", loadDone);
</script>
<!-- üü® KONEC SEKCE F + G -->

</div>
</body>
</html>
