<!doctype html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WHITE GLOVE SERVICE ‚Äì Hotov√© reklamace</title>
<style>
:root { font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
body { margin:0; padding:20px; background:#f6f7fb; }
h1{text-align:center;font-size:2em;font-weight:900;margin:0 0 10px;}
h2{text-align:center;font-size:1.1em;font-weight:600;margin:0 0 20px;color:#555;}
.btn-gradient{display:inline-block;text-decoration:none;padding:10px 22px;border-radius:8px;font-weight:600;font-size:1em;color:#fff;border:none;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:transform 0.15s ease-in-out,opacity 0.2s;margin:4px;}
.btn-gradient:hover{transform:scale(1.04);opacity:0.9;}
.btn-blue{background:linear-gradient(135deg,#0046ff,#357aff);}
.btn-gray{background:linear-gradient(135deg,#6c757d,#a0a4a7);}
.btn-yellow{background:linear-gradient(135deg,#ffb300,#ffd54f);}
.top-actions{text-align:center;margin-bottom:20px;}
</style>
</head>
<body>
<h1>WHITE GLOVE SERVICE</h1>
<h2>Hotov√© reklamace</h2>

<div class="top-actions">
  <a href="seznam.html" class="btn-gradient btn-blue">Zpƒõt na seznam</a>
  <button onclick="loadOrders()" class="btn-gradient btn-gray">Naƒç√≠st znovu</button>
</div>

<table id="dataTable" style="width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;">
<thead><tr><th>#</th><th>Objedn√°vka</th><th>Z√°kazn√≠k</th><th>Adresa</th><th>Telefon</th><th>Email</th><th>Stav</th></tr></thead>
<tbody id="tableBody"><tr><td colspan="7" style="text-align:center;padding:20px;">Naƒç√≠t√°n√≠...</td></tr></tbody>
</table>

<script>
const GITHUB_USER="radecek222-boop",REPO="reklamace",TOKEN="TV≈ÆJ_TOKEN",HOTOVE_FILE="hotove.json";

async function loadOrders(){
 try{
  const res=await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${REPO}/main/${HOTOVE_FILE}?${Date.now()}`);
  const data=await res.json();
  await autoCleanupOldPhotos(data);
  renderTable(data);
 }catch(e){document.getElementById("tableBody").innerHTML=`<tr><td colspan="7" style="text-align:center;color:red;">Chyba: ${e.message}</td></tr>`;}
}

function renderTable(data){
 const tbody=document.getElementById("tableBody");tbody.innerHTML="";
 if(!data.length){tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;">≈Ω√°dn√© hotov√© reklamace.</td></tr>`;return;}
 data.forEach((item,i)=>{
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${i+1}</td><td>${item["ƒå√≠slo objedn√°vky"]||""}</td><td>${item["Z√°kazn√≠k"]||""}</td><td>${item["Adresa"]||""}</td><td>${item["Telefon"]||""}</td><td>${item["Email"]||""}</td><td>${item["Stav"]||""}</td>`;
  tbody.appendChild(tr);
 });
}

// üßπ Automatick√© maz√°n√≠ fotek po 48 h
async function autoCleanupOldPhotos(data){
 const now=new Date();
 let updated=false;
 for(const item of data){
  if(item["SmazatFotkyPo"] && new Date(item["SmazatFotkyPo"])<now){
    for(const key of ["Foto1","Foto2","Foto3"]){
      if(item[key] && item[key].includes("uploads/")){
        const path=item[key].split("/main/")[1];
        await deleteFile(path);
        item[key]="";
      }
    }
    delete item["SmazatFotkyPo"];
    updated=true;
  }
 }
 if(updated) await updateFile(HOTOVE_FILE,JSON.stringify(data,null,2));
}

async function deleteFile(path){
 try{
  const metaRes=await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${path}`,{headers:{Authorization:`token ${TOKEN}`}});
  const meta=await metaRes.json();
  if(meta.sha){
    await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${path}`,{
      method:"DELETE",
      headers:{Authorization:`token ${TOKEN}`,"Content-Type":"application/json"},
      body:JSON.stringify({message:`Auto-smaz√°n√≠ ${path}`,sha:meta.sha})
    });
  }
 }catch(e){console.warn("Nelze smazat:",path,e);}
}

async function updateFile(filename,content){
 const metaRes=await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${filename}`,{headers:{Authorization:`token ${TOKEN}`}});
 const meta=await metaRes.json();
 await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${filename}`,{
  method:"PUT",headers:{Authorization:`token ${TOKEN}`,"Content-Type":"application/json"},
  body:JSON.stringify({message:`√ödr≈æba ${filename}`,content:btoa(unescape(encodeURIComponent(content))),sha:meta.sha})
 });
}

window.addEventListener("pageshow",loadOrders);
loadOrders();
</script>
</body>
</html>
