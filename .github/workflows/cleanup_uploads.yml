name: üßπ Cleanup old and unused uploads

on:
  schedule:
    - cron: "0 3 * * *"   # ka≈æd√Ω den ve 3:00 r√°no UTC (5:00 na≈°eho ƒçasu)
  workflow_dispatch:       # mo≈ænost ruƒçn√≠ho spu≈°tƒõn√≠

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: üß≠ Checkout repository
        uses: actions/checkout@v4

      - name: üß© Prepare environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: üïí Remove unused or old uploads
        run: |
          echo "üßπ Kontrola nepou≈æit√Ωch soubor≈Ø ve slo≈æce /uploads..."
          if [ ! -f "orders.json" ]; then
            echo "‚ö†Ô∏è Soubor orders.json neexistuje, p≈ôeskakuji kontrolu."
            exit 0
          fi

          # extrahuj v≈°echny URL nebo n√°zvy fotek z orders.json
          jq -r '.. | .fotky? | select(. != null)[]' orders.json > used_files.txt || true

          # log pro kontrolu
          echo "Pou≈æit√© soubory:"
          cat used_files.txt || echo "(≈æ√°dn√©)"

          # projdi v≈°echny soubory v uploads
          for file in $(find uploads -type f); do
            base=$(basename "$file")
            if grep -q "$base" used_files.txt; then
              echo "‚úÖ Soubor $base je st√°le pou≈æ√≠v√°n ‚Äì zachov√°v√°m."
            else
              # zkontroluj st√°≈ô√≠ souboru
              age_hours=$(( ($(date +%s) - $(stat -c %Y "$file")) / 3600 ))
              if [ $age_hours -gt 48 ]; then
                echo "üóëÔ∏è Smaz√°n soubor: $base (st√°≈ô√≠: ${age_hours}h)"
                rm "$file"
              else
                echo "‚è≥ Soubor $base je mlad≈°√≠ ne≈æ 48h ‚Äì ponech√°v√°m."
              fi
            fi
          done

      - name: üì¶ Commit and push cleanup
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "üßπ Removed unused uploads older than 48h" || echo "No changes"
          git push
