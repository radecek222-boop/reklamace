<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>White Glove Service</title>
  <style>
    :root { font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
    body { margin:0; padding:0; background:#f6f7fb; }
    .screen { display:none; min-height:100vh; padding:20px; }
    .active { display:block; }

    /* Úvodní obrazovka */
    .home { display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
    .home h1 { font-size:3.5em; font-weight:900; margin:0 0 15px; }
    .home p { font-size:1.3em; margin:0 0 40px; color:#555; }
    .btn {
      background:#e0e0e0; color:#111; padding:15px 30px; margin:10px;
      border:none; border-radius:10px; cursor:pointer; font-size:1.1em;
      min-width:220px; box-shadow:0 2px 5px rgba(0,0,0,0.15); transition:0.2s;
    }
    .btn:hover { background:#d5d5d5; }

    /* Protokol */
    .form-group { margin-bottom:12px; }
    label { display:block; font-weight:bold; margin-bottom:4px; }
    input, textarea {
      width:100%; padding:8px; border-radius:6px; border:1px solid #ccc; font-size:0.95em;
    }

    /* Modal */
    #signatureModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000;
    }
    #signatureModal .modal-content {
      background:#fff; padding:20px; border-radius:10px; max-width:500px; width:90%; text-align:center;
    }
    #signatureModal h3 { margin-top:0; }
    #signatureCanvas { border:1px solid #ccc; width:100%; height:200px; }
    #signaturePreview {
      border:1px solid #ccc; background:#fff; width:100%; height:150px;
      display:flex; align-items:center; justify-content:center; color:#777;
    }
  </style>
</head>
<body>

<!-- Úvodní obrazovka -->
<div id="home" class="screen home active">
  <h1>WHITE GLOVE SERVIS</h1>
  <p>specializovaný autorizovaný servis Natuzzi</p>
  <button class="btn" onclick="openList()">Seznam reklamací</button>
  <button class="btn" onclick="showScreen('protocol')">Protokol oprav</button>
</div>

<!-- Protokol oprav -->
<div id="protocol" class="screen">
  <h2>Protokol oprav</h2>
  <form id="repairForm">
    <div class="form-group">
      <label>Zákazník</label>
      <input type="text" id="formCustomer" name="customer">
    </div>
    <div class="form-group">
      <label>Adresa</label>
      <input type="text" id="formAddress" name="address">
    </div>
    <div class="form-group">
      <label>Telefon</label>
      <input type="text" id="formPhone" name="phone">
    </div>
    <div class="form-group">
      <label>Číslo objednávky</label>
      <input type="text" id="formOrder" name="order">
    </div>
    <div class="form-group">
      <label>Datum reklamace</label>
      <input type="text" id="formComplaintDate" name="complaint_date">
    </div>
    <div class="form-group">
      <label>Datum dodání</label>
      <input type="text" id="formDeliveryDate" name="delivery_date">
    </div>
    <div class="form-group">
      <label>Popis závady / opravy</label>
      <textarea id="formDescription" name="description"></textarea>
    </div>
    <div class="form-group">
      <label>Podpis zákazníka</label>
      <div id="signaturePreview">(zatím nepodepsáno)</div>
      <button type="button" class="btn" onclick="openSignatureModal()">Podepsat</button>
    </div>
  </form>
  <button class="btn" onclick="exportPDF()">Exportovat do PDF</button>
  <button class="btn" onclick="showScreen('home')">Zpět</button>
</div>

<!-- Modal pro podpis -->
<div id="signatureModal">
  <div class="modal-content">
    <h3>Podpis zákazníka</h3>
    <canvas id="signatureCanvas"></canvas>
    <div style="margin-top:10px;">
      <button class="btn" onclick="saveSignature()">Uložit</button>
      <button class="btn" onclick="clearSignatureCanvas()">Vymazat</button>
      <button class="btn" onclick="closeSignatureModal()">Zrušit</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// otevře seznam v novém okně
function openList(){
  window.open("seznam.html", "_blank", "width=1000,height=700");
}

// Export do PDF
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const element = document.getElementById("repairForm");
  const canvasEl = await html2canvas(element);
  const imgData = canvasEl.toDataURL("image/png");
  pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);
  pdf.save("protokol.pdf");
}

// posloucháme zprávy z seznam.html
window.addEventListener("message", function(event){
  if (event.data && event.data.type === "openProtocol"){
    const row = event.data.row;

    // pevné indexy podle tabulky
    document.getElementById("formCustomer").value     = row[0] || "";  // Customer
    document.getElementById("formAddress").value      = row[1] || "";  // Address
    document.getElementById("formPhone").value        = row[2] || "";  // KONTAKT
    document.getElementById("formOrder").value        = row[4] || "";  // Order number
    document.getElementById("formDescription").value  = row[10]|| "";  // POPIS REKLAMACE - OPRAVY
    document.getElementById("formComplaintDate").value= row[11]|| "";  // Complaint date
    document.getElementById("formDeliveryDate").value = row[12]|| "";  // Delivery date

    showScreen("protocol");
  }
});


// --- Podpis (modal) ---
let sigModal = document.getElementById("signatureModal");
let sigCanvas = document.getElementById("signatureCanvas");
let sigCtx = sigCanvas.getContext("2d");
let drawingSig = false;

function openSignatureModal(){
  sigModal.style.display = "flex";
  resizeSigCanvas();
}
function closeSignatureModal(){
  sigModal.style.display = "none";
}
function resizeSigCanvas(){
  sigCanvas.width = sigCanvas.clientWidth;
  sigCanvas.height = sigCanvas.clientHeight;
}
function clearSignatureCanvas(){
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
}

sigCanvas.addEventListener("mousedown", e => {drawingSig=true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX,e.offsetY);});
sigCanvas.addEventListener("mousemove", e => {if(drawingSig){sigCtx.lineTo(e.offsetX,e.offsetY); sigCtx.stroke();}});
sigCanvas.addEventListener("mouseup", ()=> drawingSig=false);
sigCanvas.addEventListener("mouseleave", ()=> drawingSig=false);

// Dotyk pro mobil
sigCanvas.addEventListener("touchstart", e => {
  e.preventDefault();
  let rect = sigCanvas.getBoundingClientRect();
  let x = e.touches[0].clientX - rect.left;
  let y = e.touches[0].clientY - rect.top;
  drawingSig = true;
  sigCtx.beginPath();
  sigCtx.moveTo(x,y);
});
sigCanvas.addEventListener("touchmove", e => {
  e.preventDefault();
  if (!drawingSig) return;
  let rect = sigCanvas.getBoundingClientRect();
  let x = e.touches[0].clientX - rect.left;
  let y = e.touches[0].clientY - rect.top;
  sigCtx.lineTo(x,y);
  sigCtx.stroke();
});
sigCanvas.addEventListener("touchend", ()=> drawingSig=false);

function saveSignature(){
  let dataURL = sigCanvas.toDataURL("image/png");
  document.getElementById("signaturePreview").innerHTML = `<img src="${dataURL}" style="max-width:100%; max-height:150px;">`;
  closeSignatureModal();
}
</script>

</body>
</html>
