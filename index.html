<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>White Glove Service</title>
  <style>
    :root{
      --bg:#0b0b0c; --card:#121316; --muted:#6b7280; --text:#e5e7eb;
      --accent:#22c55e; --accent-2:#3b82f6; --border:#1f2937;
    }
    body{
      margin:0; font-family:sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{position:sticky;top:0;background:#0b0b0c;z-index:10;}
    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    .title{font-size:2em;font-weight:700;}
    .subtitle{color:var(--muted);font-size:0.9em;}
    .stats{display:grid;gap:8px;grid-template-columns:repeat(4,1fr);margin:12px 0;}
    .stat{background:var(--card);padding:10px;border-radius:12px;}
    .stat .k{font-weight:700;font-size:1.2em;}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
    .input,select{padding:8px;border-radius:8px;border:1px solid var(--border);
      background:var(--card);color:var(--text);}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text);}
    .btn.main{background:var(--accent-2);color:#fff;}
    .list{display:flex;flex-direction:column;gap:10px;}
    .card{background:var(--card);padding:12px;border-radius:12px;}
    .cust{font-weight:700;}
    .muted{color:var(--muted);font-size:0.85em;}
    .badges{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;}
    .pill{background:#1f2937;padding:4px 8px;border-radius:999px;font-size:0.8em;}
    .field{display:flex;flex-direction:column;margin-top:8px;}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .linkbtn{padding:6px 10px;border-radius:8px;background:#0f172a;
      border:1px solid var(--border);color:#cbd5e1;text-decoration:none;font-size:0.9em;}
    .term-input{width:100%;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">White Glove Service</div>
    <div class="subtitle">Reklamace & servis</div>
    <div class="stats">
      <div class="stat"><div class="k" id="s_total">0</div><div class="l">Celkem</div></div>
      <div class="stat"><div class="k" id="s_new">0</div><div class="l">Nová</div></div>
      <div class="stat"><div class="k" id="s_scheduled">0</div><div class="l">Domluven termín</div></div>
      <div class="stat"><div class="k" id="s_silent">0</div><div class="l">Nekomunikuje</div></div>
    </div>
    <div class="toolbar">
      <input id="q" class="input" placeholder="Hledat cokoliv..." />
      <select id="fltStatus" class="input">
        <option value="">Stav: vše</option>
        <option value="nová">Nová</option>
        <option value="domluven termín">Domluven termín</option>
        <option value="zákazník nekomunikuje">Zákazník nekomunikuje</option>
      </select>
      <select id="fltZadavatel" class="input">
        <option value="">Zadavatel: všichni</option>
        <option>Natuzzi Strejček</option>
        <option>Natuzzi Vimrová</option>
        <option>Natuzzi Italia SK</option>
        <option>Phase Klucarova</option>
        <option>Natuzzi Jama</option>
        <option>Natuzzi River</option>
        <option>Natuzzi Soho</option>
        <option>Softaly</option>
        <option>Pozarucni servis</option>
      </select>
      <button id="btnReset" class="btn ghost">Reset</button>
    </div>
  </div>
</header>
<main class="wrap">
  <div class="list" id="list"></div>
</main>

<script>
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1IlBI3Wqh_7J3JbJcxfD9W1Af3jFGbBkKeGXKs92oySU/edit?usp=sharing";

const COLS = {
  customer:"Customer",address:"Address",kontakt:"KONTAKT",
  statusTerm:"STAV - termín návštěvy",orderNo:"Order number",label:"Label",cena:"CENA",
  milan:"MILAN",radek:"RADEK",model:"Model",popis:"POPIS REKLAMACE - OPRAVY",
  complaintDate:"Complaint date",deliveryDate:"Delivery date"
};
const ZadavatelOptions=[
 "Natuzzi Strejček","Natuzzi Vimrová","Natuzzi Italia SK","Phase Klucarova",
 "Natuzzi Jama","Natuzzi River","Natuzzi Soho","Softaly","Pozarucni servis"
];
const StatusOptions=["nová","domluven termín","zákazník nekomunikuje"];

function csvToRows(text){
  const lines=text.replace(/\r/g,"").split("\n").filter(Boolean);
  const header=parseCsvLine(lines[0]);
  const rows=lines.slice(1).map(l=>parseCsvLine(l));
  return {header,rows};
}
function parseCsvLine(line){
  const out=[];let cur="";let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch=='"'){ if(inQ && line[i+1]=='"'){cur+='"';i++;} else {inQ=!inQ;} }
    else if(ch=="," && !inQ){ out.push(cur);cur=""; }
    else { cur+=ch; }
  }
  out.push(cur);return out;
}
function headerIndexMap(header){const map={};header.forEach((h,i)=>{map[h.trim()]=i;});return map;}
function safe(v){return (v??"").toString().trim();}

function telHref(raw){const d=safe(raw).replace(/[^\d+]/g,"");return d?`tel:${d}`:null;}
function wazeHref(a){const q=encodeURIComponent(safe(a));return q?`https://waze.com/ul?q=${q}&navigate=yes`:null;}

let DATA=[],VIEW=[],headerMap={};
const els={list:document.getElementById("list"),q:document.getElementById("q"),
fltStatus:document.getElementById("fltStatus"),fltZ:document.getElementById("fltZadavatel"),
s_total:document.getElementById("s_total"),s_new:document.getElementById("s_new"),
s_scheduled:document.getElementById("s_scheduled"),s_silent:document.getElementById("s_silent"),
btnReset:document.getElementById("btnReset")};

function buildRecord(row){
  function get(c){const i=headerMap[c];return i!=null?row[i]:"";}
  return {
    customer:safe(get(COLS.customer)),address:safe(get(COLS.address)),kontakt:safe(get(COLS.kontakt)),
    orderNo:safe(get(COLS.orderNo)),cena:safe(get(COLS.cena)),
    milan:safe(get(COLS.milan)),radek:safe(get(COLS.radek)),
    model:safe(get(COLS.model)),popis:safe(get(COLS.popis)),
    complaintDate:safe(get(COLS.complaintDate)),deliveryDate:safe(get(COLS.deliveryDate))
  };
}

function matchesFilters(rec){
  const q=els.q.value.trim().toLowerCase();
  const fS=els.fltStatus.value, fZ=els.fltZ.value;
  if(fS && rec.status!==fS) return false;
  if(fZ && rec.zadavatel!==fZ) return false;
  if(q){
    const hay=[rec.customer,rec.address,rec.orderNo,rec.model,rec.popis,
      rec.kontakt,rec.cena,rec.milan,rec.radek,rec.complaintDate,rec.deliveryDate].join(" ").toLowerCase();
    if(!hay.includes(q)) return false;
  }
  return true;
}

function updateStats(){
  els.s_total.textContent=VIEW.length;
  els.s_new.textContent=VIEW.filter(r=>r.status==="nová").length;
  els.s_scheduled.textContent=VIEW.filter(r=>r.status==="domluven termín").length;
  els.s_silent.textContent=VIEW.filter(r=>r.status==="zákazník nekomunikuje").length;
}

function render(){
  VIEW=DATA.filter(matchesFilters);
  updateStats();
  els.list.innerHTML="";
  if(VIEW.length===0){els.list.innerHTML="<div class='muted'>Žádné položky</div>";return;}
  VIEW.forEach(rec=>{
    const card=document.createElement("div");card.className="card";
    card.innerHTML=`<div class="cust">${rec.customer}</div>
    <div class="muted">${rec.address}</div>`;
    const badges=document.createElement("div");badges.className="badges";
    if(rec.orderNo) badges.innerHTML+=`<div class="pill">Obj: ${rec.orderNo}</div>`;
    if(rec.model) badges.innerHTML+=`<div class="pill">Model: ${rec.model}</div>`;
    if(rec.cena) badges.innerHTML+=`<div class="pill">Cena: ${rec.cena}</div>`;
    card.appendChild(badges);
    if(rec.popis){const d=document.createElement("div");d.textContent="Popis: "+rec.popis;card.appendChild(d);}
    const actions=document.createElement("div");actions.className="row-actions";
    if(wazeHref(rec.address)) actions.innerHTML+=`<a class="linkbtn" href="${wazeHref(rec.address)}" target="_blank">Waze</a>`;
    if(telHref(rec.kontakt)) actions.innerHTML+=`<a class="linkbtn" href="${telHref(rec.kontakt)}">Zavolat</a>`;
    card.appendChild(actions);
    const foot=document.createElement("div");foot.className="muted";
    foot.textContent=[rec.complaintDate?`Reklamace: ${rec.complaintDate}`:"",
      rec.deliveryDate?`Dodání: ${rec.deliveryDate}`:"",
      rec.milan?`Milan: ${rec.milan}`:"",
      rec.radek?`Radek: ${rec.radek}`:""].filter(Boolean).join(" • ");
    if(foot.textContent) card.appendChild(foot);
    els.list.appendChild(card);
  });
}

["input","change"].forEach(ev=>{
  els.q.addEventListener(ev,render);els.fltStatus.addEventListener(ev,render);els.fltZ.addEventListener(ev,render);
});
els.btnReset.addEventListener("click",()=>{els.q.value="";els.fltStatus.value="";els.fltZ.value="";render();});

(async function init(){
  try{
    const res=await fetch(https://docs.google.com/spreadsheets/d/1IlBI3Wqh_7J3JbJcxfD9W1Af3jFGbBkKeGXKs92oySU/edit?gid=0#gid=0,{cache:"no-store"});
    const txt=await res.text();const {header,rows}=csvToRows(txt);
    headerMap=headerIndexMap(header);
    DATA=rows.map(buildRecord);
    render();
  }catch(e){
    els.list.innerHTML="<div class='muted'>Chyba načtení CSV</div>";
  }
})();
</script>
</body>
</html>
