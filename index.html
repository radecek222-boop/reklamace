<script>
const API_URL = "SEM_DEJ_TVÅ®J_EXEC_LINK"; 
const claims = [];
const $ = id=>document.getElementById(id);

function updateProtocol(data){
  $("p_customer").textContent = data.customer;
  $("p_address").textContent = data.address;
  $("p_address").href = "https://waze.com/ul?q=" + encodeURIComponent(data.address);
  $("p_phone").textContent = data.phone;
  $("p_email").textContent = data.email;
  $("p_order").textContent = data.order;
  $("p_issuer").textContent = data.issuer;
  $("p_tech").textContent = data.tech;
  $("p_model").textContent = data.model;
  $("p_complaint").textContent = data.complaint;
  $("p_total").textContent = (
    Number(data.price_work)+Number(data.price_mat)+Number(data.price_tech)+Number(data.price_trans)+Number(data.price_pickup)
  ).toFixed(2);
}

async function saveToSheet(obj){
  try {
    let res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(obj)
    });
    let text = await res.text();
    console.log("OdpovÄ›Ä ze serveru:", text);
    return text;
  } catch(err){
    console.error("Chyba pÅ™i uklÃ¡dÃ¡nÃ­:", err);
    return "error: " + err;
  }
}

async function loadFromSheet(){
  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    claims.length = 0;
    data.forEach(r => claims.push(r));
    renderTable();
  } catch(err){
    console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­:", err);
  }
}

$("saveBtn").onclick = async ()=>{
  const obj = {
    customer:$("customer").value,
    address:$("address").value,
    phone:$("phone").value,
    email:$("email").value,
    order:$("order").value,
    status:$("status").value,
    issuer:$("issuer").value,
    tech:$("tech").value,
    model:$("model").value,
    complaint:$("complaint").value,
    price_work:$("price_work").value,
    price_mat:$("price_mat").value,
    price_tech:$("price_tech").value,
    price_trans:$("price_trans").value,
    price_pickup:$("price_pickup").value,
    visit_date:$("visit_date").value
  };

  let result = await saveToSheet(obj);

  if(result.includes("success")){
    alert("âœ… UloÅ¾eno do Google Sheets");
    updateProtocol(obj);

    // ðŸ”„ hned obnovÃ­me tabulku ze SheetÅ¯
    await loadFromSheet();
  } else {
    alert("âš ï¸ UloÅ¾enÃ­ se nepodaÅ™ilo: " + result);
  }

  // ðŸ§¹ vymazÃ¡nÃ­ formulÃ¡Å™e
  ["customer","address","phone","email","status","order","issuer","tech","model","complaint",
   "price_work","price_mat","price_tech","price_trans","price_pickup","visit_date"].forEach(id=>{
    const el = $(id); 
    if(el) el.value = (id.startsWith("price")) ? "0" : "";
  });
};

$("clearBtn").onclick = ()=>{
  ["customer","address","phone","email","status","order","issuer","tech","model","complaint",
   "price_work","price_mat","price_tech","price_trans","price_pickup","visit_date"].forEach(id=>{
    const el = $(id); if(el) el.value = (id.startsWith("price")) ? "0" : "";
  });
};

function renderTable(){
  const tbody=$("claimsTable").querySelector("tbody");
  tbody.innerHTML="";
  claims.forEach(c=>{
    const total=(+c.price_work+ +c.price_mat+ +c.price_tech+ +c.price_trans+ +c.price_pickup).toFixed(2);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${c.customer}</td>
                  <td><a href="https://waze.com/ul?q=${encodeURIComponent(c.address)}" target="_blank">${c.address}</a></td>
                  <td><a href="tel:${c.phone}">${c.phone}</a></td>
                  <td>${c.model}</td>
                  <td>${c.status}</td>
                  <td>${c.tech}</td>
                  <td>${total}</td>`;
    tbody.appendChild(tr);
  });
}

const canvas=$("sigCanvas"),ctx=canvas.getContext("2d");let drawing=false;
canvas.addEventListener("mousedown",()=>drawing=true);
canvas.addEventListener("mouseup",()=>drawing=false);
canvas.addEventListener("mousemove",e=>{if(!drawing)return;ctx.fillStyle="black";ctx.beginPath();ctx.arc(e.offsetX,e.offsetY,2,0,Math.PI*2);ctx.fill();});

// ðŸ“¥ NaÄtenÃ­ dat hned po startu strÃ¡nky
window.onload = ()=>{
  loadFromSheet();
};
</script>
