<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Servisní protokol - White Glove Service</title>
  <style>
    :root{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111}
    body{margin:0;padding:20px;background:#f6f7fb}
    h1{font-size:20px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 20px rgba(30,40,60,0.06)}
    label{display:block;font-size:12px;margin-top:8px;color:#333}
    input[type=text], textarea, select{width:100%;padding:8px;border:1px solid #e3e6ee;border-radius:6px;margin-top:6px;font-size:14px;box-sizing:border-box}
    textarea{min-height:72px;resize:vertical}
    button{background:#0b69ff;color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.secondary{background:#f1f4fb;color:#0b69ff;border:1px solid #dbe6ff}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    tr.selected{background:#eef6ff}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
    .right{display:flex;flex-direction:column;gap:8px}
    .protocol{width:100%;max-width:100%;padding:18px;background:#fff;border-radius:8px;box-sizing:border-box}
    .protocol h2{margin:0 0 6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:140px}
    .sig-canvas{border:1px dashed #ccc;border-radius:6px;background:#fff;width:100%;height:120px;max-width:100%}
    .small{font-size:12px;color:#666}
    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    @media(max-width:980px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <h1>Servisní protokol — WGS</h1>
  <div class="grid">
    <div>
      <div class="card">
        <h3>Nová reklamace</h3>
        <div>
          <label>Zákazník<input id="customer" type="text"></label>
          <label>Adresa<input id="address" type="text"></label>
          <label>Kontakt (tel/email)<input id="contact" type="text"></label>
          <label>Stav
            <select id="status">
              <option>Nová</option>
              <option>Domluven termín</option>
              <option>Zákazník nekomunikuje</option>
              <option>Hotovo</option>
            </select>
          </label>
          <label>Číslo objednávky<input id="order" type="text"></label>
          <label>Zadavatel
            <select id="issuer">
              <option></option>
              <option>Natuzzi Strejček</option>
              <option>Natuzzi Vimrová</option>
              <option>Natuzzi Italia SK</option>
              <option>Phase Klucarova</option>
              <option>Natuzzi Jama</option>
              <option>Natuzzi River</option>
              <option>Natuzzi Soho</option>
              <option>Softaly</option>
              <option>Pozarucni servis</option>
            </select>
          </label>
          <label>Model<input id="model" type="text"></label>
          <label>Popis reklamace<textarea id="complaint"></textarea></label>
          <div class="controls">
            <button id="addBtn">Přidat / Uložit</button>
            <button id="clearBtn" class="secondary">Vymazat formulář</button>
            <button id="loadSheets" class="secondary">Načíst z Google Sheets</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Seznam reklamací</h3>
        <div style="max-height:360px;overflow:auto;margin-top:8px">
          <table id="claimsTable">
            <thead><tr><th>Obj.</th><th>Zákazník</th><th>Model</th><th>Stav</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="actions">
          <button id="openProtocol" class="secondary">Otevřít protokol</button>
          <button id="deleteBtn" class="secondary">Smazat záznam</button>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card protocol" id="protocolPreview">
        <h2>CLAIM PROTOCOL</h2>
        <div class="row"><div class="col"><strong>Číslo objednávky:</strong> <span id="p_order">-</span></div><div class="col"><strong>Zadavatel:</strong> <span id="p_claim">-</span></div></div>
        <div class="row"><div class="col"><strong>Technik:</strong> <span id="p_tech">Milan</span></div><div class="col"><strong>Datum návštěvy:</strong> <span id="p_visit">-</span></div></div>
        <hr>
        <div><strong>Zákazník:</strong> <span id="p_customer">-</span></div>
        <div><strong>Adresa:</strong> <span id="p_address">-</span></div>
        <div><strong>Model:</strong> <span id="p_model">-</span></div>
        <div style="margin-top:8px"><strong>Popis reklamace:</strong>
          <div id="p_complaint" style="white-space:pre-wrap;background:#fbfbfb;padding:8px;border-radius:6px;margin-top:6px"></div>
        </div>
        <div style="margin-top:12px">
          <div class="small">Podpis zákazníka:</div>
          <canvas id="sigCanvas" class="sig-canvas"></canvas>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="clearSig" class="secondary">Vymazat podpis</button>
            <button id="generatePdf">Generovat PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- knihovny -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // ===== KONFIGURACE =====
    const SHEET_ID = "1IlBI3Wqh_7J3JbJcxfD9W1Af3jFGbBkKeGXKs92oySU"
    const SHEET_GID = "0"
    const GVIZ_CSV = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SHEET_GID}`
    const APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbwCL5s2dLRygGE3OzOJm50IaSSLGOeCr0fwi70UKBI-73D-WvA0brcrNFXSCaObDVM-SA/exec"

    const storageKey = 'wgs_claims_v1'
    let claims = JSON.parse(localStorage.getItem(storageKey) || '[]')
    let selectedIndex = null

    // DOM prvky
    const elems = {
      customer: document.getElementById('customer'),
      address: document.getElementById('address'),
      contact: document.getElementById('contact'),
      status: document.getElementById('status'),
      order: document.getElementById('order'),
      issuer: document.getElementById('issuer'),
      model: document.getElementById('model'),
      complaint: document.getElementById('complaint'),
      addBtn: document.getElementById('addBtn'),
      clearBtn: document.getElementById('clearBtn'),
      claimsTable: document.querySelector('#claimsTable tbody'),
      openProtocol: document.getElementById('openProtocol'),
      deleteBtn: document.getElementById('deleteBtn'),
      loadSheets: document.getElementById('loadSheets'),
      p_order: document.getElementById('p_order'),
      p_claim: document.getElementById('p_claim'),
      p_tech: document.getElementById('p_tech'),
      p_visit: document.getElementById('p_visit'),
      p_customer: document.getElementById('p_customer'),
      p_address: document.getElementById('p_address'),
      p_model: document.getElementById('p_model'),
      p_complaint: document.getElementById('p_complaint'),
      sigCanvas: document.getElementById('sigCanvas'),
      clearSig: document.getElementById('clearSig'),
      generatePdf: document.getElementById('generatePdf')
    }

    // pomocné
    function escapeHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')}
    function save(){localStorage.setItem(storageKey, JSON.stringify(claims))}
    function renderTable(){
      elems.claimsTable.innerHTML=''
      claims.forEach((c,i)=>{
        const tr=document.createElement('tr')
        if(i===selectedIndex) tr.classList.add('selected')
        tr.innerHTML=`<td>${escapeHtml(c.order||'')}</td><td>${escapeHtml(c.customer||'')}</td><td>${escapeHtml(c.model||'')}</td><td>${escapeHtml(c.status||'')}</td>`
        tr.addEventListener('click',()=>{selectedIndex=i;renderTable()})
        elems.claimsTable.appendChild(tr)
      })
    }

    // přidat/uložit
    elems.addBtn.addEventListener('click',()=>{
      const newItem={
        customer: elems.customer.value.trim(),
        address: elems.address.value.trim(),
        contact: elems.contact.value.trim(),
        status: elems.status.value,
        order: elems.order.value.trim(),
        issuer: elems.issuer.value,
        model: elems.model.value.trim(),
        complaint: elems.complaint.value.trim(),
        visit_date: new Date().toLocaleDateString('cs-CZ')
      }
      if(selectedIndex===null){claims.unshift(newItem);selectedIndex=0}else{claims[selectedIndex]=newItem}
      save();renderTable()
    })

    // vymazat formulář
    elems.clearBtn.addEventListener('click',()=>{selectedIndex=null;elems.customer.value=elems.address.value=elems.contact.value=elems.order.value=elems.model.value=elems.complaint.value='';elems.status.value='Nová';elems.issuer.value='';renderTable()})

    // otevřít protokol
    elems.openProtocol.addEventListener('click',()=>{
      if(selectedIndex===null){alert('Vyberte záznam.');return}
      const c=claims[selectedIndex]
      elems.p_order.textContent=c.order||'-'
      elems.p_claim.textContent=c.issuer||'-'
      elems.p_customer.textContent=c.customer||'-'
      elems.p_address.textContent=c.address||'-'
      elems.p_model.textContent=c.model||'-'
      elems.p_complaint.textContent=c.complaint||'-'
      elems.p_visit.textContent=c.visit_date||'-'
    })

    // mazání
    elems.deleteBtn.addEventListener('click',()=>{if(selectedIndex===null)return;claims.splice(selectedIndex,1);selectedIndex=null;save();renderTable()})

    // Signature pad
    class SignaturePadSimple{
      constructor(c){
        this.c=c;this.ctx=c.getContext('2d');this.ctx.lineWidth=2.2;this.drawing=false;
        this.resize();window.addEventListener('resize',()=>this.resize());this._init()
      }
      resize(){this.c.width=this.c.offsetWidth;this.c.height=this.c.offsetHeight;this.clear()}
      _init(){this.c.addEventListener('pointerdown',e=>{this.drawing=true;this.last=[e.offsetX,e.offsetY]});this.c.addEventListener('pointermove',e=>{if(!this.drawing)return;this.ctx.beginPath();this.ctx.moveTo(this.last[0],this.last[1]);this.ctx.lineTo(e.offsetX,e.offsetY);this.ctx.stroke();this.last=[e.offsetX,e.offsetY]});window.addEventListener('pointerup',()=>this.drawing=false)}
      clear(){this.ctx.fillStyle='#fff';this.ctx.fillRect(0,0,this.c.width,this.c.height)}
      toDataURL(){return this.c.toDataURL('image/png')}
    }
    const sigPad=new SignaturePadSimple(elems.sigCanvas);elems.clearSig.addEventListener('click',()=>sigPad.clear())

    // PDF export
    elems.generatePdf.addEventListener('click',async()=>{
      const proto=document.getElementById('protocolPreview')
      const canvas=await html2canvas(proto,{scale:2,backgroundColor:'#fff'})
      const imgData=canvas.toDataURL('image/png')
      const {jsPDF}=window.jspdf
      const pdf=new jsPDF({unit:'pt',format:[canvas.width,canvas.height]})
      pdf.addImage(imgData,'PNG',0,0,canvas.width,canvas.height)
      pdf.save('protokol.pdf')
    })

    // načtení z Google Sheets
    async function loadFromSheets(){
      try{
        const res=await fetch(GVIZ_CSV);const txt=await res.text()
        const lines=txt.split('\n').filter(l=>l.trim().length>0)
        const headers=lines[0].split(',')
        const rows=lines.slice(1).map(l=>l.split(','))
        claims=rows.map(r=>({
          order:r[headers.indexOf('Order number')],
          customer:r[headers.indexOf('Customer')],
          address:r[headers.indexOf('Address')],
          contact:r[headers.indexOf('KONTAKT')],
          status:r[headers.indexOf('STAV - termín návštěvy')],
          issuer:r[headers.indexOf('Label')],
          model:r[headers.indexOf('Model')],
          complaint:r[headers.indexOf('POPIS REKLAMACE - OPRAVY')],
          visit_date:r[headers.indexOf('Complaint date')]
        }))
        renderTable()
      }catch(e){
        const res=await fetch(APPS_SCRIPT);const json=await res.json()
        claims=json;renderTable()
      }
    }
    elems.loadSheets.addEventListener('click',loadFromSheets)

    renderTable()
  </script>
</body>
</html>
