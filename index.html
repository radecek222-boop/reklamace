<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Claim Protocol - White Glove Service</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; background: #f9f9f9; padding: 20px; border-radius: 10px; }
    h2 { text-align: center; margin-bottom: 20px; }
    .logo { text-align: center; margin-bottom: 20px; }
    .logo img { max-width: 220px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
    textarea { height: 70px; }
    #signature { border: 1px solid #ccc; width: 100%; height: 150px; background: white; }
    .btn { margin-top: 15px; padding: 12px; cursor: pointer; border: none; border-radius: 6px; background: #333; color: white; font-weight: bold; }
    .btn:hover { background: #555; }
    .section { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .checkbox-group { margin: 5px 0; }
  </style>
</head>
<body>
  <div class="logo">
    <img src="https://dummyimage.com/200x50/000/fff&text=White+Glove+Service" alt="Logo firmy">
  </div>
  
  <h2>CLAIM PROTOCOL</h2>

  <div class="section">
    <label>ƒå√≠slo objedn√°vky / Order number</label>
    <input id="cislo_objednavky">
    <button type="button" class="btn" onclick="fetchData()">Naƒç√≠st z Google Sheets</button>

    <label>ƒå√≠slo reklamace / Claim number</label>
    <input id="cislo_reklamace">

    <label>Technik / Worker</label>
    <input id="technik">

    <label>Datum n√°v≈°tƒõvy / Date of visit</label>
    <input id="datum_navstevy" type="date">
  </div>

  <div class="section">
    <label>Z√°kazn√≠k / Customer</label>
    <input id="zakaznik">

    <label>Adresa z√°kazn√≠ka / Address customer</label>
    <input id="adresa">
  </div>

  <div class="section">
    <label>Znaƒçka / Label</label>
    <input id="znacka">

    <label>Model</label>
    <input id="model">

    <label>Potah / Upholstery</label>
    <input id="potah">
  </div>

  <div class="section">
    <label>Datum doruƒçen√≠ / Delivery date (customer)</label>
    <input id="datum_doruceni" type="date">

    <label>Datum pod√°n√≠ reklamace / Complaint date (customer)</label>
    <input id="datum_reklamace" type="date">
  </div>

  <div class="section">
    <label>Z√°kazn√≠k reklamuje / The customer complains</label>
    <textarea id="zakaznik_reklamace"></textarea>

    <label>Probl√©m zji≈°tƒõn√Ω na m√≠stƒõ technikem / Problem detected on site by technician</label>
    <textarea id="problem"></textarea>

    <label>N√°vrh opravy / Repair proposal</label>
    <textarea id="oprava"></textarea>
  </div>

  <div class="section">
    <h3>Stav reklamace / Claim status</h3>
    <div class="checkbox-group">
      <input type="checkbox" id="vyreseno">
      <label for="vyreseno">Reklamace vy≈ôe≈°ena</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="cekani">
      <label for="cekani">ƒåek√° se na vyj√°d≈ôen√≠ prodejce</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="poskozeni">
      <label for="poskozeni">Po≈°kozen√≠ technikem</label>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="uhrada">
      <label for="uhrada">√öhradu provede z√°kazn√≠k</label>
    </div>
  </div>

  <div class="section">
    <h3>Ceny / Prices</h3>
    <label>Poƒçet opravovan√Ωch d√≠l≈Ø / Number of repaired parts</label>
    <input id="dily" type="number">

    <label>Cena za pr√°ci / Price for work</label>
    <input id="prace" type="number">

    <label>Cena za materi√°l / Price for material</label>
    <input id="material" type="number">

    <label>Cena za druh√©ho technika / Price for second technician</label>
    <input id="druhy_technik" type="number">

    <label>Cena za dopravu / Price for transport</label>
    <input id="doprava" type="number">

    <label>Cena celkem EUR / Total price EUR</label>
    <input id="celkem" type="number">
  </div>

  <div class="section">
    <label>Podpis z√°kazn√≠ka / Customer signature:</label>
    <canvas id="signature"></canvas>
    <button class="btn" onclick="clearSig()">Smazat podpis</button>
  </div>

  <button class="btn" onclick="generatePDF()">Ulo≈æit PDF</button>

  <script>
    const { jsPDF } = window.jspdf;
    const canvas = document.getElementById('signature');
    const signaturePad = new SignaturePad(canvas);

    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function clearSig() {
      signaturePad.clear();
    }

    // üëá vlo≈æ sem svou Apps Script URL
    const API_URL = "https://script.google.com/macros/s/AKfycby5ff53i4bIkHm8jn2Yb3muR9hV3MkgAfnJP688GP4HmNhjI-7y5i6DcVICgK8gJqW72w/exec";

    async function fetchData() {
      const order = document.getElementById("cislo_objednavky").value;
      if (!order) {
        alert("Zadej ƒç√≠slo objedn√°vky!");
        return;
      }
      try {
        const response = await fetch(API_URL + "?order=" + encodeURIComponent(order));
        const data = await response.json();
        if (data.length > 0) {
          const row = data[0];
          document.getElementById("cislo_reklamace").value = row["Claim number"] || "";
          document.getElementById("zakaznik").value = row["Customer"] || "";
          document.getElementById("adresa").value = row["Address"] || "";
          document.getElementById("znacka").value = row["Label"] || "";
          document.getElementById("model").value = row["Model"] || "";
          document.getElementById("potah").value = row["Upholstery"] || "";
          if (row["Delivery date"]) {
            document.getElementById("datum_doruceni").value = new Date(row["Delivery date"]).toISOString().split("T")[0];
          }
          if (row["Complaint date"]) {
            document.getElementById("datum_reklamace").value = new Date(row["Complaint date"]).toISOString().split("T")[0];
          }
        } else {
          alert("Objedn√°vka nenalezena v Google Sheets");
        }
      } catch (err) {
        alert("Chyba p≈ôi naƒç√≠t√°n√≠: " + err);
      }
    }

    function generatePDF() {
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      // HLAVIƒåKA
      doc.setFontSize(16);
      doc.text("WHITE GLOVE SERVICE s.r.o.", 105, 15, { align: "center" });
      doc.setFontSize(10);
      doc.text("Do Dubƒçe 364, Bƒõchovice 190 11 | +420 725 965 826 | reklamace-wgs@email.cz | IƒåO: 09769684", 105, 20, { align: "center" });
      doc.setFontSize(14);
      doc.text("CLAIM PROTOCOL", 105, 30, { align: "center" });

      // TABULKY
      doc.autoTable({ startY: 40, head: [['Order number','Claim number','Worker','Date of visit']], body: [[
        document.getElementById("cislo_objednavky").value,
        document.getElementById("cislo_reklamace").value,
        document.getElementById("technik").value,
        document.getElementById("datum_navstevy").value
      ]]});

      doc.autoTable({ startY: doc.lastAutoTable.finalY+5, head: [['Customer','Address']], body: [[
        document.getElementById("zakaznik").value,
        document.getElementById("adresa").value
      ]]});

      doc.autoTable({ startY: doc.lastAutoTable.finalY+5, head: [['Label','Model','Upholstery']], body: [[
        document.getElementById("znacka").value,
        document.getElementById("model").value,
        document.getElementById("potah").value
      ]]});

      doc.autoTable({ startY: doc.lastAutoTable.finalY+5, head: [['Delivery date','Complaint date']], body: [[
        document.getElementById("datum_doruceni").value,
        document.getElementById("datum_reklamace").value
      ]]});

      doc.autoTable({ startY: doc.lastAutoTable.finalY+5, head: [['The customer complains']], body: [[
        document.getElementById("zakaznik_reklamace").value
      ]]});
      doc.autoTable({ startY: doc.lastAutoTable.finalY+2, head: [['Problem detected on site']], body: [[
        document.getElementById("problem").value
      ]]});
      doc.autoTable({ startY: doc.lastAutoTable.finalY+2, head: [['Repair proposal']], body: [[
        document.getElementById("oprava").value
      ]]});

      doc.autoTable({ startY: doc.lastAutoTable.finalY+5, head: [['Claim status']], body: [[
        (document.getElementById('vyreseno').checked ? "‚úî" : "‚úñ") + " Complaint resolved"
      ],[
        (document.getElementById('cekani').checked ? "‚úî" : "‚úñ") + " Waiting for dealer response"
      ],[
        (document.getElementById('poskozeni').checked ? "‚úî" : "‚úñ") + " Damage caused by technician"
      ],[
        (document.getElementById('uhrada').checked ? "‚úî" : "‚úñ") + " Paid by customer"
      ]]});

      doc.autoTable({ startY: doc.lastAutoTable.finalY+5, head: [['Parts','Work','Material','2nd worker','Transport','Total EUR']], body: [[
        document.getElementById("dily").value,
        document.getElementById("prace").value,
        document.getElementById("material").value,
        document.getElementById("druhy_technik").value,
        document.getElementById("doprava").value,
        document.getElementById("celkem").value
      ]]});

      let y = doc.lastAutoTable.finalY + 15;
      if (!signaturePad.isEmpty()) {
        const imgData = signaturePad.toDataURL();
        doc.addImage(imgData, "PNG", 20, y, 80, 30);
        doc.text("Customer signature", 20, y+40);
      } else {
        doc.text("Customer signature: [not provided]", 20, y);
      }

      doc.save("claim_protocol.pdf");
    }
  </script>
</body>
</html>
