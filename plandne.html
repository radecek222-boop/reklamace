<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pl√°n dne ‚Äì White Glove Service</title>

<!-- üü© ZAƒå√ÅTEK SEKCE 1/10 ‚Äì Z√ÅKLADN√ç STYL A STRUKTURA -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
body {
  font-family:"Inter",system-ui,sans-serif;
  margin:0;padding:0;
  background:radial-gradient(circle at top left,#081a1b 0%,#0a0d0f 80%);
  color:#e6f5f2;
  display:flex;flex-direction:column;
  height:100vh;
}
header {
  text-align:center;
  padding:16px;
  font-weight:900;
  font-size:22px;
  background:#0f1818;
  color:#00ffb3;
  box-shadow:0 2px 6px rgba(0,255,160,0.15);
}

/* üíª Desktop */
.main {
  flex:1;
  display:grid;
  grid-template-columns:340px 1fr;
  gap:12px;
  padding:12px;
  box-sizing:border-box;
}

/* üì± Mobiln√≠ verze ‚Äì vertik√°ln√≠ layout */
@media (max-width:800px){
  .main {
    display:flex;
    flex-direction:column;
  }
  #calendar {order:1;}
  #dayList {order:2;}
  #map {
    order:3;
    height:300px;
    margin-top:10px;
  }
}

#calendar {
  background:#101b1b;
  border-radius:10px;
  padding:16px;
  box-shadow:0 0 15px rgba(0,255,150,0.08);
  overflow:auto;
}
#map {
  width:100%;
  height:100%;
  border-radius:10px;
  box-shadow:0 0 20px rgba(0,255,150,0.1);
}
.btns {
  display:flex;
  justify-content:center;
  gap:10px;
  padding:12px;
  background:#0f1818;
  box-shadow:0 -2px 6px rgba(0,0,0,0.2);
}
button {
  background:linear-gradient(135deg,#00b894,#00ffb3);
  color:#fff;border:none;border-radius:8px;
  padding:10px 20px;
  font-weight:600;
  cursor:pointer;
  transition:transform .1s ease,opacity .2s;
}
button:hover{transform:scale(1.03);opacity:.9;}

/* üóìÔ∏è Kalend√°≈ô */
table.calendar-table {
  border-collapse:collapse;width:100%;
  text-align:center;font-size:14px;color:#dff8f2;
}
table.calendar-table th {
  background:#0c2422;
  padding:6px;
  font-weight:700;
  color:#00ffb3;
}
table.calendar-table td {
  padding:8px;
  border:1px solid rgba(0,255,150,0.15);
  cursor:pointer;
  position:relative;
  height:42px;
  vertical-align:middle;
  transition:background .2s;
}
table.calendar-table td:hover{background:rgba(0,255,180,0.08);}
.today {
  border:2px solid #00ffb3!important;
  border-radius:4px;
  font-weight:700;
}
.square {
  width:8px;height:8px;
  background:#ff5252;
  border-radius:2px;
  position:absolute;
  bottom:5px;left:50%;
  transform:translateX(-50%);
}
.empty-day{color:#666;}

/* üßæ Zpr√°va pod kalend√°≈ôem */
#noDataMsg {
  text-align:center;
  font-size:14px;
  color:#aaa;
  margin-top:10px;
  font-weight:500;
}

/* üîπ Tlaƒç√≠tko zpƒõt */
.btn-back {
  width:100%;
  background:linear-gradient(135deg,#444,#888);
  color:#fff;
  border:none;border-radius:8px;
  padding:10px 0;
  font-weight:600;
  cursor:pointer;
  transition:transform .1s ease,opacity .2s;
  font-size:15px;
  margin-bottom:8px;
}
.btn-back:hover{transform:scale(1.02);opacity:.9;}
</style>
<!-- üü© KONEC SEKCE 1/10 ‚Äì Z√ÅKLADN√ç STYL A STRUKTURA -->

</head>

<body>

<!-- üü© ZAƒå√ÅTEK SEKCE 2/10 ‚Äì HLAVIƒåKA -->
<header>Pl√°n dne ‚Äì WGS</header>
<!-- üü© KONEC SEKCE 2/10 ‚Äì HLAVIƒåKA -->

<!-- üü© ZAƒå√ÅTEK SEKCE 3/10 ‚Äì HLAVN√ç OBSAH -->
<div class="main">
  <!-- üü® Kalend√°≈ô -->
  <div id="calendar">
    <button class="btn-back" onclick="window.location.href='seznam.html'">Zpƒõt na seznam</button>

    <div style="display:flex;justify-content:space-between;align-items:center;margin:10px 0 8px;">
      <button onclick="changeMonth(-1)" style="background:none;border:none;font-size:18px;color:#00ffb3;cursor:pointer;">‚óÄ</button>
      <h3 id="monthLabel" style="margin:0;color:#00ffb3;">≈ò√≠jen 2025</h3>
      <button onclick="changeMonth(1)" style="background:none;border:none;font-size:18px;color:#00ffb3;cursor:pointer;">‚ñ∂</button>
    </div>

    <table class="calendar-table">
      <thead>
        <tr><th>Po</th><th>√öt</th><th>St</th><th>ƒåt</th><th>P√°</th><th>So</th><th>Ne</th></tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
    <div id="noDataMsg">Vyberte datum v kalend√°≈ôi.</div>
  </div>

  <!-- üü® Mapa -->
  <div id="map"></div>
</div>
<!-- üü© KONEC SEKCE 3/10 ‚Äì HLAVN√ç OBSAH -->

<!-- üü© ZAƒå√ÅTEK SEKCE 4/10 ‚Äì LEAFLET MAPA -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const WGS_CENTER=[50.08031890414999,14.59812450867171];
let map,markers=[];
let dataAll=[];

function initMap(){
  map=L.map("map").setView(WGS_CENTER,10);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);
  L.marker(WGS_CENTER).addTo(map)
    .bindPopup("<b>White Glove Service s.r.o.</b><br>Do Dubƒçe 364, Bƒõchovice")
    .openPopup();
}
</script>
<!-- üü© KONEC SEKCE 4/10 ‚Äì LEAFLET MAPA -->

<!-- üü© ZAƒå√ÅTEK SEKCE 5/10 ‚Äì KALEND√Å≈ò -->
<script>
let currentYear,currentMonth;

function buildCalendar(plannedDates=[]){
  const today=new Date();
  if(currentYear===undefined)currentYear=today.getFullYear();
  if(currentMonth===undefined)currentMonth=today.getMonth();

  const first=new Date(currentYear,currentMonth,1);
  const last=new Date(currentYear,currentMonth+1,0);
  const startDay=(first.getDay()+6)%7;
  const totalDays=last.getDate();
  const body=document.getElementById("calendarBody");
  body.innerHTML="";

  const header=document.getElementById("monthLabel");
  const monthNames=["Leden","√önor","B≈ôezen","Duben","Kvƒõten","ƒåerven","ƒåervenec","Srpen","Z√°≈ô√≠","≈ò√≠jen","Listopad","Prosinec"];
  header.textContent=`${monthNames[currentMonth]} ${currentYear}`;

  let row=document.createElement("tr");
  for(let i=0;i<startDay;i++)row.appendChild(document.createElement("td"));

  for(let d=1;d<=totalDays;d++){
    if(row.children.length===7){body.appendChild(row);row=document.createElement("tr");}
    const td=document.createElement("td");
    td.textContent=d;
    const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    if(plannedDates.includes(dateStr)){
      const square=document.createElement("div");square.className="square";td.appendChild(square);
    }
    if(d===today.getDate()&&currentMonth===today.getMonth()&&currentYear===today.getFullYear())
      td.classList.add("today");
    td.addEventListener("click",()=>showDayOnMap(dateStr));
    row.appendChild(td);
  }
  while(row.children.length<7)row.appendChild(document.createElement("td"));
  body.appendChild(row);
}

function changeMonth(offset){
  currentMonth+=offset;
  if(currentMonth<0){currentMonth=11;currentYear--;}
  else if(currentMonth>11){currentMonth=0;currentYear++;}
  buildCalendar([...new Set(dataAll.map(d=>d.datum))]);
}
</script>
<!-- üü© KONEC SEKCE 5/10 ‚Äì KALEND√Å≈ò -->

<!-- üü© ZAƒå√ÅTEK SEKCE 6/10 ‚Äì MAPA ZOBRAZEN√ç DNƒö -->
<script>
async function showDayOnMap(dateStr){
  const infoBox=document.getElementById("noDataMsg");
  const listContainer=document.getElementById("dayList");

  if(!dataAll.length){infoBox.textContent="≈Ω√°dn√© z√°znamy.";return;}
  markers.forEach(m=>map.removeLayer(m));markers=[];
  listContainer.innerHTML="";

  const dayOrders=dataAll.filter(o=>o.datum===dateStr);
  if(!dayOrders.length){
    infoBox.textContent="≈Ω√°dn√© z√°znamy pro tento den.";
    map.setView(WGS_CENTER,10);
    return;
  }
  infoBox.textContent="";
  const coords=[{lat:WGS_CENTER[0],lon:WGS_CENTER[1],name:"WGS"}];

  for(const o of dayOrders){
    if(!o.adresa)continue;
    try{
      const r=await fetch(`https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(o.adresa)}&apiKey=cd5c4b6f36f84e66b3b2f5adf3d19fd8`);
      const j=await r.json();
      const loc=j.features?.[0]?.geometry?.coordinates;
      if(loc)coords.push({lat:loc[1],lon:loc[0],adresa:o.adresa,zakaznik:o.zakaznik,cas:o.cas});
    }catch(e){console.warn("‚ö†Ô∏è Nelze geok√≥dovat:",o.adresa);}
  }

  let counter=0;
  for(let i=1;i<coords.length;i++){
    const cur=coords[i],prev=coords[i-1];
    const distKm=getDistanceFromLatLon(prev.lat,prev.lon,cur.lat,cur.lon).toFixed(1);
    const marker=L.marker([cur.lat,cur.lon]).addTo(map);
    marker.bindPopup(`<b>${cur.zakaznik||"Z√°kazn√≠k"}</b><br>${cur.adresa}<br><small>${cur.cas||""}</small>`);
    markers.push(marker);
    counter++;
    const row=document.createElement("div");
    row.className="dayRow";
    row.innerHTML=`
      <div class="num">${counter}.</div>
      <div class="info">
        <div class="addr"><b>${cur.adresa}</b></div>
        <div class="time"><b>${cur.cas||"-"}</b> ‚Ä¢ ${distKm} km</div>
      </div>`;
    listContainer.appendChild(row);
  }

  if(coords.length>1){
    const line=L.polyline(coords.map(c=>[c.lat,c.lon]),{color:"#00ffb3",weight:3}).addTo(map);
    map.fitBounds(line.getBounds().pad(0.2));
  }else map.setView(WGS_CENTER,10);
}

function getDistanceFromLatLon(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
           Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
           Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}
</script>
<!-- üü© KONEC SEKCE 6/10 ‚Äì MAPA ZOBRAZEN√ç DNƒö -->

<!-- üü© ZAƒå√ÅTEK SEKCE 7/10 ‚Äì STYL SEZNAMU POD MAPOU -->
<style>
#dayList {
  margin-top:8px;
  background:#101b1b;
  border-radius:8px;
  padding:10px;
  box-shadow:0 0 8px rgba(0,255,150,0.1);
  font-size:13px;line-height:1.4;
}
.dayRow {
  display:flex;align-items:center;gap:10px;
  border-bottom:1px solid rgba(0,255,150,0.1);
  padding:4px 0;
}
.dayRow:last-child{border-bottom:none;}
.dayRow .num{font-weight:700;color:#00ffb3;}
.dayRow .info{flex:1;}
.dayRow .addr{font-weight:600;}
.dayRow .time{font-size:12px;color:#aaf7df;}
</style>
<!-- üü© KONEC SEKCE 7/10 ‚Äì STYL SEZNAMU POD MAPOU -->

<!-- üü© ZAƒå√ÅTEK SEKCE 8/10 ‚Äì NAƒå√çT√ÅN√ç DAT -->
<script>
async function loadTemporaryFiles(){
  try{
    const res=await fetch("https://wgs-token.72nvwf4pb2.workers.dev/temporaryfiles?"+Date.now(),{cache:"no-store"});
    const json=await res.json();
    const data=Array.isArray(json)?json.map(r=>r.data||r):(json.data||[]);
    dataAll=data.filter(d=>d.datum);
    const dates=[...new Set(dataAll.map(d=>d.datum))];
    buildCalendar(dates);
  }catch(e){
    console.error("‚ùå Nelze naƒç√≠st temporaryfiles:",e);
    buildCalendar();
  }
}
</script>
<!-- üü© KONEC SEKCE 8/10 ‚Äì NAƒå√çT√ÅN√ç DAT -->

<!-- üü© ZAƒå√ÅTEK SEKCE 9/10 ‚Äì INICIALIZACE -->
<script>
document.addEventListener("DOMContentLoaded",()=>{
  initMap();
  loadTemporaryFiles();
  const mapParent=document.getElementById("map").parentElement;
  const listDiv=document.createElement("div");
  listDiv.id="dayList";
  mapParent.appendChild(listDiv);
});
</script>
<!-- üü© KONEC SEKCE 9/10 ‚Äì INICIALIZACE -->
</body>
</html>
