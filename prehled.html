<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>P≈ôehled ‚Äì White Glove Service</title>

<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0; padding: 0;
  display: flex; justify-content: center; align-items: flex-start;
  min-height: 100vh;
}
.wrapper {
  background: #fff;
  padding: 30px; margin: 40px 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  width: 100%; max-width: 960px;
  position: relative; box-sizing: border-box;
}
h1 { text-align: center; font-size: 2.1em; font-weight: 900; color: #111; margin: 0 0 8px; }
.sub { text-align: center; color: #111; margin-bottom: 30px; font-size: 1.05em; font-weight: 500; }

#logoutBtn {
  position: absolute; top: 15px; right: 20px;
  background: linear-gradient(135deg,#b8b8b8,#d3d3d3);
  border: none; color: #333; font-weight: 600;
  border-radius: 8px; padding: 6px 14px; cursor: pointer;
  transition: opacity .25s;
  font-size: 0.9em;
}
#logoutBtn:hover { opacity: .85; }

.obrat-box {
  text-align: center;
  background: linear-gradient(135deg,#e0e0e0,#f0f0f0);
  border-radius: 12px;
  padding: 25px 20px;
  margin-bottom: 25px;
  font-size: 1.5em;
  font-weight: 700;
  color: #111;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
  position: relative;
}
#currencyToggle {
  position: absolute;
  top: 12px;
  right: 16px;
  background: linear-gradient(135deg,#b5b5b5,#e0e0e0);
  border: none;
  border-radius: 8px;
  padding: 5px 10px;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
  color: #222;
  transition: background .25s;
}
#currencyToggle:hover { background: linear-gradient(135deg,#999,#c9c9c9); }

.btn {
  border: none; border-radius: 8px; padding: 12px 28px;
  font-size: 1em; font-weight: 600; cursor: pointer;
  color: #fff; background: linear-gradient(135deg,#444,#707070);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  display: block; margin: 0 auto 25px; transition: transform .15s, opacity .25s;
}
.btn:hover { transform: scale(1.05); opacity: .9; }

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 10px 8px; border-bottom: 1px solid #ddd; text-align: left; }
th { background: #f0f0f0; }
tr:hover { background: #fafafa; }

/* modal + tick */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 4000; backdrop-filter: blur(4px); }
.modal-overlay.active { display: flex; }
.modal-box { background: rgba(40,40,40,.95); color: #fff; padding: 30px; border-radius: 14px; max-width: 680px; width: 90%; display: flex; flex-direction: row; gap: 20px; flex-wrap: wrap; justify-content: space-between; position: relative; }
.modal-column { flex: 1 1 45%; display: flex; flex-direction: column; gap: 10px; }
.modal-column h3 { margin-bottom: 8px; border-bottom: 1px solid #666; padding-bottom: 4px; }
.client-list { max-height: 280px; overflow-y: auto; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; }
.client-list label { display:block; padding:4px; cursor:pointer; }
.modal-actions { width: 100%; display: flex; justify-content: center; gap: 12px; margin-top: 20px; }
.modal-actions button { border: none; border-radius: 8px; padding: 10px 20px; font-size: .95em; cursor: pointer; }
.btn-dark { background: linear-gradient(135deg,#444,#707070); color:#fff; }
.btn-light { background: linear-gradient(135deg,#888,#b5b5b5); color:#fff; }
.confirm-tick { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.1); opacity: 0; font-size: 90px; color: #00ff88; text-shadow: 0 0 25px rgba(0,255,150,0.6); transition: transform .5s ease, opacity .5s ease; }
.confirm-tick.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
</style>
</head>

<body>
<div class="wrapper">
  <button id="logoutBtn">Odej√≠t</button>
  <h1>P≈ôehled WGS</h1>
  <div class="sub">Statistick√Ω p≈ôehled zak√°zek</div>

  <div class="obrat-box" id="infoObrat">
    Obrat: ‚Äì
    <button id="currencyToggle">CZK</button>
  </div>

  <button id="filterBtn" class="btn">Vyber mo≈ænosti</button>

  <table id="resultsTable">
    <thead>
      <tr><th>Z√°kazn√≠k</th><th>ƒå√≠slo objedn√°vky</th><th>Zadavatel</th><th>ƒå√°stka</th></tr>
    </thead>
    <tbody><tr><td colspan="4" style="text-align:center;color:#888;padding:20px;">Zat√≠m ≈æ√°dn√° data</td></tr></tbody>
  </table>

  <div id="cnbInfo" style="text-align:center;font-size:0.85em;color:#666;margin-top:12px;"></div>
</div>

<!-- üßæ MOD√ÅLN√ç OKNO -->
<div id="filterModal" class="modal-overlay">
  <div class="modal-box">
    <span id="tick" class="confirm-tick">‚úÖ</span>

    <div class="modal-column">
      <h3>Zadavatel</h3>
      <div id="clientList" class="client-list"></div>
    </div>

    <div class="modal-column">
      <h3>Obdob√≠</h3>
      <label>Od:</label><input type="date" id="dateFrom">
      <label>Do:</label><input type="date" id="dateTo">
      <label>Mƒõs√≠c:</label>
      <select id="monthSelect">
        <option value="">‚Äì Nevybr√°no ‚Äì</option>
        <option value="01">Leden</option><option value="02">√önor</option>
        <option value="03">B≈ôezen</option><option value="04">Duben</option>
        <option value="05">Kvƒõten</option><option value="06">ƒåerven</option>
        <option value="07">ƒåervenec</option><option value="08">Srpen</option>
        <option value="09">Z√°≈ô√≠</option><option value="10">≈ò√≠jen</option>
        <option value="11">Listopad</option><option value="12">Prosinec</option>
      </select>
    </div>

    <div class="modal-actions">
      <button id="confirmFilter" class="btn-dark">Potvrdit</button>
      <button id="closeFilter" class="btn-light">Zav≈ô√≠t</button>
    </div>
  </div>
</div>

<script>
let allOrders=[], cnbRate=25.5, cnbDate="", currency="CZK";
const infoObrat=document.getElementById("infoObrat"),
currencyToggle=document.getElementById("currencyToggle"),
logoutBtn=document.getElementById("logoutBtn"),
filterBtn=document.getElementById("filterBtn"),
filterModal=document.getElementById("filterModal"),
confirmFilter=document.getElementById("confirmFilter"),
closeFilter=document.getElementById("closeFilter"),
clientList=document.getElementById("clientList"),
cnbInfo=document.getElementById("cnbInfo"),
resultsTableBody=document.querySelector("#resultsTable tbody"),
tick=document.getElementById("tick");

// üí∂ kurz
async function loadCNB(){
 try{
  const r=await fetch("https://api.frankfurter.app/latest?from=EUR&to=CZK");
  const d=await r.json(); cnbRate=d.rates.CZK; cnbDate=d.date;
 }catch{cnbRate=25.5;cnbDate="‚Äì";}
 cnbInfo.textContent=`Kurz ECB: 1 ‚Ç¨ = ${cnbRate.toFixed(3)} Kƒç (k ${cnbDate})`;
}

// üìã Zadavatel√©
async function loadClients(){
 const known=[
  "Natuzzi Editions - Strejcek","Natuzzi Editions - Vimrova",
  "Natuzzi Italia - Bratislava","Natuzzi Italia - Jama","Natuzzi Italia - River",
  "Softaly - Soho","Phase - Klucarova","Phase - Jancova",
  "WGS poz√°ruƒçn√≠ servis","Milan Kol√≠n","Radek Zikmund","Jin√©"
 ];
 try{
  const r=await fetch("https://radecek222-boop.github.io/reklamace/hotove.json?t="+Date.now());
  const d=await r.json(); allOrders=d;
  const newC=[...new Set(d.map(x=>x.contract||"").filter(Boolean))];
  const all=[...new Set([...known,...newC])].sort();
  const sel=JSON.parse(localStorage.getItem("selClients")||"[]");
  clientList.innerHTML=all.map(c=>`<label><input type="checkbox" value="${c}" ${sel.includes(c)?"checked":""}> ${c}</label>`).join("");
 }catch{clientList.innerHTML="<p>‚ùå Chyba naƒçten√≠.</p>";}
}

// üá®üáøüá∏üá∞ Rozdƒõlen√≠ zak√°zek podle zkratky
function isCzechOrder(order){
 const cz=["NCE","NBU","NBR"];
 return cz.some(p=>String(order.cislo||"").startsWith(p));
}
function isSlovakOrder(order){
 const sk=["NZA","NBA","NKE"];
 return sk.some(p=>String(order.cislo||"").startsWith(p));
}

// v√Ωpoƒçet
function convertToEUR(v){
 if(typeof v==="string"&&v.includes("‚Ç¨"))return parseFloat(v.replace(/[^\d,.-]/g,"").replace(",","."));
 if(typeof v==="string"&&v.includes("K"))return parseFloat(v.replace(/[^\d,.-]/g,"").replace(",",".")/cnbRate);
 return Number(v)||0;
}
function fmtEUR(x){return x.toLocaleString("cs-CZ",{style:"currency",currency:"EUR"});}
function fmtCZK(x){return x.toLocaleString("cs-CZ",{style:"currency",currency:"CZK"});}

function render(){
 const clients=JSON.parse(localStorage.getItem("selClients")||"[]");
 const period=JSON.parse(localStorage.getItem("selPeriod")||"{}");
 const from=period.from?new Date(period.from):null;
 const to=period.to?new Date(period.to):null;
 let f=allOrders.slice();
 if(clients.length){
   f=f.filter(x=>{
     const contract=x.contract||""; const tech=(x.technik||"").toLowerCase();
     let match=false;
     for(const c of clients){
       if(contract.includes(c))match=true;
       if(c==="Milan Kol√≠n" && (tech.includes("kol√≠n")||tech.includes("oba")))match=true;
       if(c==="Radek Zikmund" && (tech.includes("zikmund")||tech.includes("oba")))match=true;
     }
     return match;
   });
 }
 if(from&&to)f=f.filter(x=>{const d=new Date(x.datumProtokolu||x.datum_reklamace||x.datum);return d>=from&&d<=to;});

 // üá®üáøüá∏üá∞ rozdƒõlen√≠
 const czOrders=f.filter(isCzechOrder);
 const skOrders=f.filter(isSlovakOrder);

 let totalEUR=f.reduce((a,x)=>a+convertToEUR(x.cenaCelkem||x.cena||x.total),0);
 const totalCZK=totalEUR*cnbRate;
 const display=currency==="CZK"?fmtCZK(totalCZK):fmtEUR(totalEUR);
 infoObrat.firstChild.textContent=`Obrat: ${display}`;

 function rowHTML(arr){
  return arr.map(x=>`<tr>
    <td>${x.zakaznik||"‚Äì"}</td>
    <td>${x.cislo||x.typ==="poz√°ruƒçn√≠"?"Poz√°ruƒçn√≠":"‚Äì"}</td>
    <td>${x.contract||"‚Äì"}</td>
    <td>${currency==="CZK"?fmtCZK(convertToEUR(x.cenaCelkem||x.cena||x.total)*cnbRate):fmtEUR(convertToEUR(x.cenaCelkem||x.cena||x.total))}</td>
  </tr>`).join("");
 }

 resultsTableBody.innerHTML=
  (czOrders.length?`<tr><th colspan="4">üá®üáø ƒåesk√© zak√°zky</th></tr>${rowHTML(czOrders)}`:"")+
  (skOrders.length?`<tr><th colspan="4">üá∏üá∞ Slovensk√© zak√°zky</th></tr>${rowHTML(skOrders)}`:"")+
  ((!czOrders.length&&!skOrders.length)?`<tr><td colspan="4" style="text-align:center;color:#888;padding:20px;">≈Ω√°dn√© v√Ωsledky</td></tr>`:"");
}

// ovl√°d√°n√≠
filterBtn.onclick=()=>{filterModal.classList.add("active");loadClients();};
closeFilter.onclick=()=>filterModal.classList.remove("active");
confirmFilter.onclick=()=>{
 const c=[...clientList.querySelectorAll("input:checked")].map(i=>i.value);
 const from=document.getElementById("dateFrom").value,to=document.getElementById("dateTo").value;
 localStorage.setItem("selClients",JSON.stringify(c));
 localStorage.setItem("selPeriod",JSON.stringify({from,to}));
 tick.classList.add("show");
 setTimeout(()=>{tick.classList.remove("show");filterModal.classList.remove("active");render();},1500);
};

// p≈ôep√≠n√°n√≠ mƒõny
currencyToggle.onclick=()=>{
 currency = currency==="CZK"?"EUR":"CZK";
 currencyToggle.textContent = currency;
 render();
};

// mƒõs√≠c ‚Üí od/do
const monthSelect=document.getElementById("monthSelect"),df=document.getElementById("dateFrom"),dt=document.getElementById("dateTo");
if(monthSelect)monthSelect.onchange=()=>{
 const y=new Date().getFullYear(),m=monthSelect.value;if(!m){df.value=dt.value="";return;}
 const f=new Date(y,m-1,1),l=new Date(y,m,0);
 const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
 df.value=fmt(f);dt.value=fmt(l);
};

// tlaƒç√≠tko odej√≠t
logoutBtn.onclick=()=>{window.location.href="index.html";};

// start
window.addEventListener("DOMContentLoaded",async()=>{
 await loadCNB();
 await loadClients();
 render();
});
</script>
</body>
</html>
