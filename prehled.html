<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>P≈ôehled ‚Äì White Glove Service</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.css">
<style>
body{
  font-family:"Inter",system-ui,sans-serif;
  background:#f6f7fb;
  margin:0;padding:0;
  display:flex;justify-content:center;align-items:flex-start;
  min-height:100vh;
}
.wrapper{
  background:#fff;
  padding:25px;
  margin:40px 15px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  width:100%;
  max-width:950px;
  box-sizing:border-box;
  position:relative;
}
h1{text-align:center;font-size:1.9em;font-weight:900;margin:0;color:#111;}
.sub{text-align:center;color:#777;margin-bottom:20px;}
.btn{
  border:none;border-radius:8px;padding:8px 18px;
  font-size:0.9em;font-weight:600;cursor:pointer;
  transition:transform .15s,opacity .25s;
  color:white;box-shadow:0 3px 8px rgba(0,0,0,0.15);
}
.btn:hover{transform:scale(1.05);opacity:.9;}
.btn-back{background:linear-gradient(135deg,#a0a4a7,#6c757d);}
.btn-stats{background:linear-gradient(135deg,#0046ff,#357aff);}
.stats-boxes{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;margin-bottom:20px;
}
.box{
  background:#f7f8fa;border-radius:10px;padding:15px;text-align:center;
  box-shadow:inset 0 1px 4px rgba(0,0,0,0.05);
}
.box .num{font-size:1.6em;font-weight:800;color:#0046ff;}
.box .label{font-size:0.9em;color:#666;}
.filter-bar{
  display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:25px;
}
select,input[type="date"]{
  padding:6px 10px;font-size:0.9em;border:1px solid #ccc;border-radius:6px;
}
.chart-container{
  background:#f9f9f9;border-radius:10px;padding:15px;
  box-shadow:inset 0 1px 4px rgba(0,0,0,0.05);margin-bottom:25px;
}
h3{text-align:center;font-size:1em;color:#333;margin-bottom:10px;}
.loading{text-align:center;padding:30px;color:#666;}
.hidden{display:none;}
/* üîê Login modal */
#loginOverlay{
  position:fixed;inset:0;background:rgba(255,255,255,0.95);
  display:flex;justify-content:center;align-items:center;
  flex-direction:column;z-index:9999;
  font-size:1em;color:#333;
}
.login-box{
  background:#fff;padding:30px 40px;border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
  text-align:center;
}
.login-box h2{margin-top:0;font-weight:800;margin-bottom:15px;}
.login-box input{
  padding:10px;border:1px solid #ccc;border-radius:8px;
  width:200px;font-size:1em;margin-bottom:15px;
}
.login-box button{
  background:linear-gradient(135deg,#6c757d,#a0a4a7);
  color:white;border:none;border-radius:8px;padding:10px 24px;
  font-weight:600;cursor:pointer;
  transition:transform .15s ease,opacity .25s ease;
}
.login-box button:hover{transform:scale(1.05);opacity:.9;}

/* üïí Odpoƒçet vpravo naho≈ôe */
#adminBar{
  position:absolute;
  top:10px;right:15px;
  display:flex;align-items:center;
  gap:10px;
  font-size:0.9em;
  color:#333;
}
#countdown{
  font-weight:700;
  color:#0046ff;
}
</style>
</head>
<body>
<div id="loginOverlay">
  <div class="login-box">
    <h2>Admin p≈ô√≠stup</h2>
    <p>Zadejte p≈ô√≠stupov√© heslo:</p>
    <input type="password" id="adminPass" placeholder="Heslo">
    <br>
    <button onclick="checkPass()">P≈ôihl√°sit</button>
  </div>
</div>

<div class="wrapper hidden" id="content">
  <div id="adminBar">
    üîì P≈ôihl√°≈°en√Ω administr√°tor
    <span>| Odhl√°≈°en√≠ za <span id="countdown">10:00</span></span>
    <button class="btn btn-back" style="padding:6px 12px;font-size:0.8em;" onclick="logout()">Odhl√°sit</button>
  </div>

  <h1>P≈ôehled WGS</h1>
  <div class="sub">Statistiky reklamac√≠, v√Ωdƒõlk≈Ø a obratu</div>

  <div class="filter-bar">
    <select id="periodSelect">
      <option value="week">Posledn√≠ t√Ωden</option>
      <option value="month">Posledn√≠ mƒõs√≠c</option>
      <option value="year">Posledn√≠ rok</option>
      <option value="all" selected>V≈°e</option>
    </select>
    <label>Od: <input type="date" id="dateFrom"></label>
    <label>Do: <input type="date" id="dateTo"></label>
    <select id="typeSelect">
      <option value="all" selected>V≈°echny typy</option>
      <option value="reklamace">Reklamace</option>
      <option value="poz√°ruƒçn√≠">Poz√°ruƒçn√≠ servis</option>
    </select>
    <button class="btn btn-stats" id="applyFilter">Zobrazit</button>
  </div>

  <div class="stats-boxes">
    <div class="box"><div class="num" id="sumRevenue">0 Kƒç</div><div class="label">Celkov√Ω obrat</div></div>
    <div class="box"><div class="num" id="sumOrders">0</div><div class="label">Poƒçet zak√°zek</div></div>
    <div class="box"><div class="num" id="sumTechs">0 Kƒç</div><div class="label">V√Ωdƒõlek technik≈Ø</div></div>
  </div>

  <div class="chart-container">
    <h3>üí∞ Obrat podle zadavatel≈Ø</h3>
    <canvas id="clientChart" height="200"></canvas>
  </div>

  <div class="chart-container">
    <h3>üë®‚Äçüîß V√Ωdƒõlky technik≈Ø</h3>
    <canvas id="techChart" height="200"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let allData=[];let logoutTimer;let countdownInterval;let remaining=600; // 10 min = 600 s

// üîí P≈ôihl√°≈°en√≠
function checkPass(){
  const pass=document.getElementById("adminPass").value.trim();
  if(pass==="Mikes332018"){
    sessionStorage.setItem("wgsAdminLogin",Date.now().toString());
    document.getElementById("loginOverlay").classList.add("hidden");
    document.getElementById("content").classList.remove("hidden");
    startLogoutTimer();
    loadStats();
  }else alert("Nespr√°vn√© heslo!");
}

// üïí Spu≈°tƒõn√≠ odpoƒçtu a automatick√©ho odhl√°≈°en√≠
function startLogoutTimer(){
  clearTimeout(logoutTimer);
  clearInterval(countdownInterval);
  remaining=600; // znovu 10 minut
  updateCountdown();
  countdownInterval=setInterval(()=>{
    remaining--;
    updateCountdown();
    if(remaining<=0){
      clearInterval(countdownInterval);
      alert("Byl jste automaticky odhl√°≈°en po 10 minut√°ch neaktivity.");
      logout();
    }
  },1000);
}
function updateCountdown(){
  const min=Math.floor(remaining/60).toString().padStart(2,"0");
  const sec=(remaining%60).toString().padStart(2,"0");
  document.getElementById("countdown").textContent=`${min}:${sec}`;
}

// üñ±Ô∏è Aktivita = restart odpoƒçtu
["click","keydown","mousemove","touchstart"].forEach(ev=>document.addEventListener(ev,startLogoutTimer));

async function loadStats(){
  try{
    const res=await fetch("prehled.json?t="+Date.now());
    allData=await res.json();
    renderStats();
  }catch(e){console.error(e);}
}
document.getElementById("applyFilter").onclick=renderStats;

function renderStats(){
  if(!allData.length)return;
  const period=document.getElementById("periodSelect").value;
  const type=document.getElementById("typeSelect").value;
  let from,to;
  const now=new Date();
  switch(period){
    case"week":from=new Date(now);from.setDate(now.getDate()-7);break;
    case"month":from=new Date(now);from.setMonth(now.getMonth()-1);break;
    case"year":from=new Date(now);from.setFullYear(now.getFullYear()-1);break;
    default:from=new Date("2000-01-01");
  }
  to=now;
  const fromInput=document.getElementById("dateFrom").value;
  const toInput=document.getElementById("dateTo").value;
  if(fromInput)from=new Date(fromInput);
  if(toInput)to=new Date(toInput);

  const filtered=allData.filter(r=>{
    const d=new Date(r.datum||r.date||r.visit||"2000-01-01");
    const inDate=d>=from && d<=to;
    const inType=(type==="all"||(r.typ||"").toLowerCase().includes(type));
    return inDate&&inType;
  });

  const byClient={},byTech={};let total=0;
  filtered.forEach(r=>{
    const c=r.contract||"Nezn√°m√Ω";
    const t=r.technician||r.technik||"Neuvedeno";
    const p=parseFloat(r.total||r.cenaCelkem||0);
    byClient[c]=(byClient[c]||0)+p;
    byTech[t]=(byTech[t]||0)+p;
    total+=p;
  });

  document.getElementById("sumRevenue").textContent=total.toLocaleString("cs-CZ")+" Kƒç";
  document.getElementById("sumOrders").textContent=filtered.length;
  const totalTech=Object.values(byTech).reduce((a,b)=>a+b,0);
  document.getElementById("sumTechs").textContent=totalTech.toLocaleString("cs-CZ")+" Kƒç";

  drawChart("clientChart",Object.keys(byClient),Object.values(byClient),"#0046ff");
  drawChart("techChart",Object.keys(byTech),Object.values(byTech),"#00b36b");
}

let chart1,chart2;
function drawChart(id,labels,values,color){
  const ctx=document.getElementById(id);
  const data={labels,datasets:[{data:values,backgroundColor:color+"aa",borderColor:color,borderWidth:1.5}]};
  const config={type:"bar",data,options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}};
  if(id==="clientChart"){if(chart1)chart1.destroy();chart1=new Chart(ctx,config);}
  else{if(chart2)chart2.destroy();chart2=new Chart(ctx,config);}
}

// üîö Ruƒçn√≠ odhl√°≈°en√≠
function logout(){
  sessionStorage.removeItem("wgsAdminLogin");
  location.href="index.html";
}
</script>
</body>
</html>
