<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>P≈ôehled ‚Äì White Glove Service</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0; padding: 0;
  display: flex; justify-content: center; align-items: flex-start;
  min-height: 100vh;
}
.wrapper {
  background: #fff;
  padding: 30px; margin: 40px 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  width: 100%; max-width: 960px;
  position: relative; box-sizing: border-box;
}
h1 { text-align:center;font-size:2.1em;font-weight:900;color:#111;margin:0 0 8px;}
.sub {text-align:center;color:#666;margin-bottom:35px;font-size:1em;}
.top-bar{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin-bottom:30px;}
.btn{border:none;border-radius:8px;padding:10px 24px;font-size:.95em;font-weight:600;cursor:pointer;transition:transform .15s,opacity .25s;color:#fff;box-shadow:0 3px 8px rgba(0,0,0,0.15);min-width:160px;}
.btn:hover{transform:scale(1.05);opacity:.9;}
.btn-light{background:linear-gradient(135deg,#888,#b5b5b5);}
.btn-dark{background:linear-gradient(135deg,#444,#707070);}
.btn-gray{background:linear-gradient(135deg,#666,#999);}
.info-box{display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#e0e0e0,#f0f0f0);color:#111;font-weight:700;border-radius:8px;padding:10px 20px;font-size:.95em;min-width:160px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.1);}
#resultsTable{width:100%;border-collapse:collapse;margin-top:15px;}
#resultsTable th,#resultsTable td{padding:10px 8px;border-bottom:1px solid #eee;text-align:left;font-size:.9em;}
#resultsTable th{background:#f8f8f8;font-weight:700;color:#333;}
.summary{text-align:center;margin-top:25px;font-weight:600;color:#333;}
#logoutBtn{position:absolute;top:15px;right:20px;background:linear-gradient(135deg,#b8b8b8,#d3d3d3);border:none;color:#333;font-weight:600;border-radius:8px;padding:8px 16px;cursor:pointer;transition:opacity .25s;}
#logoutBtn:hover{opacity:.85;}
#techChart{max-height:220px;max-width:400px;margin:auto;display:block;}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:4000;backdrop-filter:blur(4px);opacity:0;transition:opacity .25s ease;}
.modal-overlay.active{display:flex;opacity:1;}
.modal-box{background:rgba(40,40,40,.95);color:#fff;padding:40px 30px;border-radius:14px;box-shadow:0 4px 25px rgba(0,0,0,.45);text-align:center;max-width:380px;width:90%;}
.modal-actions{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
.client-list{text-align:left;margin-bottom:25px;max-height:240px;overflow-y:auto;border-radius:8px;background:rgba(255,255,255,0.08);padding:10px;}
.client-list label{display:block;padding:5px;cursor:pointer;}
.client-list input{margin-right:6px;}
.period-fields{display:flex;flex-direction:column;gap:12px;background:rgba(255,255,255,0.08);border-radius:10px;padding:15px 12px;margin-bottom:20px;}
.period-fields select,.period-fields input{width:100%;background:#222;color:#fff;border:1px solid #555;border-radius:8px;padding:10px;font-size:1em;outline:none;}
.period-fields select:focus,.period-fields input:focus{border-color:#00c851;box-shadow:0 0 6px rgba(0,200,81,0.4);}
</style>
</head>
<body>
<div class="wrapper">
  <button id="logoutBtn">Odej√≠t</button>
  <h1>P≈ôehled WGS</h1>
  <div class="sub">Statistiky reklamac√≠ a servisn√≠ch zak√°zek</div>

  <div class="top-bar">
    <button id="selectClientBtn" class="btn btn-light">Vyber zadavatele</button>
    <button id="selectTechBtn" class="btn btn-light">Vyber technika</button>
    <button id="selectPeriodBtn" class="btn btn-gray">Obdob√≠</button>
    <div id="infoObrat" class="info-box">Obrat: 0 ‚Ç¨</div>
  </div>

  <table id="resultsTable">
    <thead>
      <tr>
        <th>Z√°kazn√≠k</th>
        <th>ƒå√≠slo</th>
        <th>Zadavatel</th>
        <th>Technik</th>
        <th>ƒå√°stka (EUR)</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5" style="text-align:center;color:#888;padding:20px;">Zat√≠m nejsou vybran√° ≈æ√°dn√° data</td></tr>
    </tbody>
  </table>

  <div id="summary" class="summary"></div>
  <canvas id="techChart"></canvas>
  <div style="text-align:center;font-size:0.8em;color:#666;margin-top:12px;" id="cnbInfo"></div>
</div>






<!-- üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 2 ‚Äì Mod√°ln√≠ okna -->
<div id="clientModal" class="modal-overlay">
  <div class="modal-box">
    <h2>Vyber zadavatele</h2>
    <div id="loadingClients" class="loading">Naƒç√≠t√°m‚Ä¶</div>
    <div id="clientList" class="client-list" style="display:none;"></div>
    <div class="modal-actions">
      <button id="confirmClients" class="btn btn-dark">Potvrdit</button>
      <button id="closeClients" class="btn btn-light">Zav≈ô√≠t</button>
    </div>
  </div>
</div>

<div id="techModal" class="modal-overlay"></div>

<div id="periodModal" class="modal-overlay">
  <div class="modal-box">
    <h2>Vyber obdob√≠</h2>
    <div class="period-fields">
      <label>Od:</label><input type="date" id="dateFrom">
      <label>Do:</label><input type="date" id="dateTo">
      <label>Mƒõs√≠c:</label>
      <select id="monthSelect">
        <option value="">‚Äì Nevybr√°no ‚Äì</option>
        <option value="01">Leden</option><option value="02">√önor</option><option value="03">B≈ôezen</option>
        <option value="04">Duben</option><option value="05">Kvƒõten</option><option value="06">ƒåerven</option>
        <option value="07">ƒåervenec</option><option value="08">Srpen</option><option value="09">Z√°≈ô√≠</option>
        <option value="10">≈ò√≠jen</option><option value="11">Listopad</option><option value="12">Prosinec</option>
      </select>
    </div>
    <div class="modal-actions">
      <button id="confirmPeriod" class="btn btn-dark">Potvrdit</button>
      <button id="closePeriod" class="btn btn-light">Zav≈ô√≠t</button>
    </div>
  </div>
</div>










<!-- üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 3 ‚Äì Glob√°ln√≠ promƒõnn√© a kurz ƒåNB -->
<script>
let allOrders = [];
let cnbRate = null;
let cnbRateDate = null;

const clientModal = document.getElementById("clientModal");
const techModal   = document.getElementById("techModal");
const periodModal = document.getElementById("periodModal");
const clientList  = document.getElementById("clientList");
const loadingClients = document.getElementById("loadingClients");
const selectClientBtn = document.getElementById("selectClientBtn");
const selectTechBtn   = document.getElementById("selectTechBtn");
const selectPeriodBtn = document.getElementById("selectPeriodBtn");
const confirmClients  = document.getElementById("confirmClients");
const closeClients    = document.getElementById("closeClients");
const confirmPeriod   = document.getElementById("confirmPeriod");
const closePeriod     = document.getElementById("closePeriod");
const infoObrat       = document.getElementById("infoObrat");
const summaryBox      = document.getElementById("summary");
const resultsTableBody = document.querySelector("#resultsTable tbody");



// üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 4 ‚Äì Naƒçten√≠ kurzu ƒåNB (TXT feed)
async function loadCNBrate() {
  try {
    const resp = await fetch("https://www.cnb.cz/en/financial-markets/foreign-exchange-market/exchange-rate-fixing/daily.txt", { cache: "no-cache" });
    const text = await resp.text();
    const lines = text.trim().split("\n");
    for (const line of lines) {
      if (line.includes("|EUR|")) {
        const parts = line.split("|");
        const amount = parseFloat(parts[2]);
        const rate = parseFloat(parts[4].replace(",", "."));
        if (!isNaN(rate) && amount > 0) {
          cnbRate = rate / amount;
          const dateLine = lines[0].split("#")[0].trim();
          cnbRateDate = dateLine;
          console.log(`üìà Kurz ƒåNB: 1 ‚Ç¨ = ${cnbRate.toFixed(4)} Kƒç (${cnbRateDate})`);
        }
        break;
      }
    }
  } catch (err) {
    console.error("‚ùå Chyba naƒç√≠t√°n√≠ kurzu ƒåNB:", err);
    const stored = JSON.parse(localStorage.getItem("lastCnbRate") || "{}");
    if (stored.value) {
      cnbRate = stored.value;
      cnbRateDate = stored.date;
      console.warn("Pou≈æit ulo≈æen√Ω kurz:", cnbRate);
    }
  }
  if (cnbRate && cnbRateDate) {
    localStorage.setItem("lastCnbRate", JSON.stringify({ value: cnbRate, date: cnbRateDate, time: Date.now() }));
  }
}



// üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 5 ‚Äì Pomocn√© funkce
const parseMoney = v => {
  if (!v) return 0;
  const s = String(v).replace(/[^\d.,-]/g, "");
  const n = Number(s.replace(",", "."));
  return isNaN(n) ? 0 : n;
};
const fmtEUR = n => `${n.toLocaleString("cs-CZ",{minimumFractionDigits:2,maximumFractionDigits:2})} ‚Ç¨`;
const getDate = r => {
  const raw = r.datum_protokolu || r.datum_reklamace || r.datum_prodeje || "";
  const d = new Date(raw);
  return isNaN(d) ? new Date("2000-01-01") : d;
};










// üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 6 ‚Äì Zadavatel√©
async function loadClients() {
  loadingClients.style.display="block";
  clientList.style.display="none";
  clientList.innerHTML="";
  try {
    const res = await fetch("https://radecek222-boop.github.io/reklamace/hotove.json?t="+Date.now());
    const data = await res.json();
    const known=["Natuzzi Editions","Natuzzi Italia","Softaly","Phase","WGS (Poz√°ruƒçn√≠ servis)"];
    const fromData=[...new Set(data.map(r=>r.contract).filter(Boolean))];
    const allClients=[...new Set([...known,...fromData])].sort();
    const saved=JSON.parse(localStorage.getItem("selectedClients")||"[]");
    clientList.innerHTML=allClients.map(c=>`
      <label><input type="checkbox" value="${c}" ${saved.includes(c)?"checked":""}>${c}</label>`).join("");
    loadingClients.style.display="none";
    clientList.style.display="block";
  } catch (err) {
    loadingClients.textContent="‚ùå Chyba naƒç√≠t√°n√≠ zadavatel≈Ø";
  }
}

confirmClients.onclick=()=>{
  const checked=[...clientList.querySelectorAll("input:checked")].map(i=>i.value);
  localStorage.setItem("selectedClients",JSON.stringify(checked));
  clientModal.classList.remove("active");
  renderResults();
};










// üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 7 ‚Äì V√Ωbƒõr obdob√≠
document.getElementById("monthSelect").addEventListener("change",e=>{
  const month=parseInt(e.target.value,10);
  if(!month)return;
  const year=new Date().getFullYear();
  const start=new Date(year,month-1,1);
  const end=new Date(year,month,0);
  const yyyy=year.toString().padStart(4,"0");
  const mm=month.toString().padStart(2,"0");
  const fromStr=`${yyyy}-${mm}-01`;
  const toStr=`${yyyy}-${mm}-${String(end.getDate()).padStart(2,"0")}`;
  document.getElementById("dateFrom").value=fromStr;
  document.getElementById("dateTo").value=toStr;
});

confirmPeriod.onclick=()=>{
  const from=document.getElementById("dateFrom").value;
  const to=document.getElementById("dateTo").value;
  if(!from||!to){alert("Zadej platn√© obdob√≠.");return;}
  localStorage.setItem("selectedPeriod",JSON.stringify({from,to}));
  periodModal.classList.remove("active");
  renderResults();
};




















// üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 8 ‚Äì V√Ωbƒõr technika
const techList = [
  { name: "Milan Kol√≠n", key: "kolin" },
  { name: "Radek Zikmund", key: "zikmund" }
];

techModal.innerHTML = `
  <div class="modal-box">
    <h2>Vyber technika</h2>
    <div style="margin-bottom:20px;text-align:left;">
      ${techList.map(t => `
        <label style="display:block;margin:5px 0;">
          <input type="radio" name="techSelect" value="${t.key}">${t.name}
        </label>`).join("")}
    </div>
    <div class="modal-actions">
      <button id="confirmTech" class="btn btn-dark">Potvrdit</button>
      <button id="closeTech" class="btn btn-light">Zav≈ô√≠t</button>
    </div>
  </div>
`;

document.addEventListener("click", e => {
  if (e.target.id === "confirmTech") {
    const sel = document.querySelector("input[name='techSelect']:checked");
    if (!sel) return;
    localStorage.setItem("selectedTech", sel.value);
    techModal.classList.remove("active");
    renderResults();
  }
  if (e.target.id === "closeTech") {
    techModal.classList.remove("active");
  }
}); // ‚úÖ spr√°vnƒõ uzav≈ôen√Ω addEventListener




















// üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 9 ‚Äì Naƒçten√≠ zak√°zek + vykreslen√≠
async function loadOrders() {
  await loadCNBrate();
  try {
    const res = await fetch("https://radecek222-boop.github.io/reklamace/hotove.json?t=" + Date.now());
    allOrders = await res.json();
    renderResults();
  } catch (err) {
    console.error("‚ùå Chyba naƒç√≠t√°n√≠ dat:", err);
  }
}










function renderResults() {
  if (!allOrders.length) return;

  const selClients = JSON.parse(localStorage.getItem("selectedClients") || "[]");
  const selPeriod  = JSON.parse(localStorage.getItem("selectedPeriod") || "{}");
  const selTech    = localStorage.getItem("selectedTech") || "";
  const from = selPeriod.from ? new Date(selPeriod.from) : null;
  const to   = selPeriod.to ? new Date(selPeriod.to) : null;

  let filtered = allOrders.slice();

  // üìã Filtry
  if (selClients.length)
    filtered = filtered.filter(r => selClients.includes(r.contract));
  if (from && to)
    filtered = filtered.filter(r => { const d = getDate(r); return d >= from && d <= to; });
  if (selTech)
    filtered = filtered.filter(r => (r.technik || "").toLowerCase().includes(selTech));

  // üìÖ Se≈ôazen√≠ podle data (nejnovƒõj≈°√≠ naho≈ôe)
  filtered.sort((a, b) => getDate(b) - getDate(a));

  // üí∂ V√Ωpoƒçty ‚Äì fixn√≠ 30 % pro ka≈æd√©ho technika
  const techTotals = { "Radek Zikmund": 0, "Milan Kol√≠n": 0 };
  let totalEUR = 0;

  filtered.forEach(r => {
    let val = parseMoney(r.cenaCelkem || r.total || r.cena);
    const str = String(r.cenaCelkem || r.total || r.cena);
    if (cnbRate && !str.includes("‚Ç¨")) val = val / cnbRate;
    totalEUR += val;

    const t = (r.technik || "").toLowerCase();
    const hasRadek = t.includes("zikmund");
    const hasMilan = t.includes("kolin");
    if (hasRadek) techTotals["Radek Zikmund"] += val * 0.30;
    if (hasMilan) techTotals["Milan Kol√≠n"] += val * 0.30;
  });

  // üßæ Tabulka v√Ωsledk≈Ø
  resultsTableBody.innerHTML = filtered.map(r => {
    let val = parseMoney(r.cenaCelkem || r.total || r.cena);
    const str = String(r.cenaCelkem || r.total || r.cena);
    if (cnbRate && !str.includes("‚Ç¨")) val = val / cnbRate;
    return `
      <tr>
        <td>${r.zakaznik || "‚Äì"}</td>
        <td>${r.cislo || "‚Äì"}</td>
        <td>${r.contract || "‚Äì"}</td>
        <td>${r.technik || "‚Äì"}</td>
        <td>${fmtEUR(val)}</td>
      </tr>
    `;
  }).join("") || `
    <tr><td colspan="5" style="text-align:center;color:#888;padding:20px;">≈Ω√°dn√© v√Ωsledky</td></tr>
  `;

  // üìä Shrnut√≠ a pod√≠ly
  let shareText = "";
  Object.entries(techTotals).forEach(([name, v]) => {
    const pct = totalEUR > 0 ? ((v / totalEUR) * 100).toFixed(1) : "0.0";
    shareText += `${name}: ${fmtEUR(v)} (${pct} %)  |  `;
  });
  infoObrat.textContent = `Celkov√Ω obrat: ${fmtEUR(totalEUR)}`;
  summaryBox.textContent = `Zak√°zek: ${filtered.length}  |  ${shareText.slice(0, -3)}`;

  // üìâ Mini graf Chart.js
  const ctx = document.getElementById("techChart");
  if (ctx) {
    const chartData = {
      labels: Object.keys(techTotals),
      datasets: [{
        label: "Pod√≠l technik≈Ø v EUR",
        data: Object.values(techTotals).map(v => v.toFixed(2)),
        backgroundColor: ["#4A90E2", "#7ED321"],
        borderRadius: 8
      }]
    };

    if (window.techChartInstance) {
      window.techChartInstance.data = chartData;
      window.techChartInstance.update();
    } else {
      window.techChartInstance = new Chart(ctx, {
        type: "bar",
        data: chartData,
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.y.toLocaleString("cs-CZ",{minimumFractionDigits:2})} ‚Ç¨`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback:(val)=>val.toLocaleString("cs-CZ") },
              title: { display:true, text:"‚Ç¨" }
            }
          }
        }
      });
    }
  }

  // üßÆ Kurz ƒåNB ‚Äì zobrazen√≠ dole
  const foot = document.getElementById("cnbInfo");
  if (foot) {
    if (cnbRate && cnbRateDate) {
      foot.textContent = `kurz ƒåNB: 1 ‚Ç¨ = ${cnbRate.toLocaleString("cs-CZ",{minimumFractionDigits:4,maximumFractionDigits:4})} Kƒç (platn√Ω k ${cnbRateDate})`;
    } else {
      foot.textContent = "";
    }
  }
}









// üîπüîπüîπüîπüîπüîπüîπüîπüîπüîπ Sekce 10 ‚Äì Inicializace
window.addEventListener("DOMContentLoaded", () => {
  loadOrders();
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });
  }
});
</script>
</body>
</html>
