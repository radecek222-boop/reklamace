<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>White Glove Service – Servisní protokol</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --ink:#0e1116; --muted:#6b7280; --line:#e5e7eb; --brand:#0b69ff; --ok:#0ea5e9; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    h1{font-size:18px;margin:16px 16px 0}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.06);padding:14px}
    label{display:block;font-size:12px;color:#374151;margin-top:6px}
    input,select,textarea{width:100%;margin-top:6px;border:1px solid var(--line);border-radius:8px;padding:9px 10px;font-size:14px;background:#fff}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .controls{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .primary{background:var(--brand);color:#fff}
    .ghost{background:#eef2ff;color:#1d4ed8;border:1px solid #dbeafe}
    .danger{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted);font-weight:600;position:sticky;top:0;background:#fafafa}
    tr.selected{background:#eef6ff}
    .small{font-size:12px;color:var(--muted)}
    .protocol{padding:16px;border:1px solid var(--line);border-radius:10px}
    .protocol h2{margin:0 0 6px}
    .sig{border:1px dashed #cbd5e1;border-radius:8px;background:#fff}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:12px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px}
    a.inline{color:#0b69ff;text-decoration:none}
    a.inline:hover{text-decoration:underline}
    .scroll{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .nowrap{white-space:nowrap}
    .hidden{display:none !important}

    /* Responsivita */
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .scroll{max-height:280px}
      .row{flex-direction:column}
    }

    /* Co se nemá objevit v PDF snímku */
    .no-print{ /* skryju dočasně před snímkováním */ }
  </style>
</head>
<body>
  <h1>White Glove Service – Servisní protokol</h1>
  <div class="grid">
    <!-- LEVÁ STRANA: FORM + SEZNAM -->
    <div>
      <div class="card">
        <h3>Nová / Upravit reklamaci</h3>
        <div class="row">
          <div class="col">
            <label>Zákazník
              <input id="customer" list="customersList" placeholder="Ing. Jan Novák" required />
              <datalist id="customersList"></datalist>
            </label>
          </div>
          <div class="col">
            <label>Číslo objednávky
              <input id="order" placeholder="8100653023" required />
            </label>
          </div>
        </div>

        <label>Adresa
          <input id="address" placeholder="Ulice 123, Město" required />
        </label>

        <div class="row">
          <div class="col">
            <label>Telefon
              <input id="phone" placeholder="+420 777 000 000" required />
            </label>
          </div>
          <div class="col">
            <label>E-mail
              <input id="email" type="email" placeholder="jmeno@domena.cz" required />
            </label>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Stav reklamace
              <select id="status" required>
                <option value="">— vyberte —</option>
                <option>Nová</option>
                <option>Čekáme na díly</option>
                <option>Nemůžeme se dovolat zákazníkovi</option>
                <option>Čekáme na informace od zadavatele</option>
                <option>Zákazník nezvedá</option>
              </select>
            </label>
          </div>
          <div class="col">
            <label>Zadavatel
              <select id="issuer" required>
                <option value="">— vyberte —</option>
                <option>Natuzzi Česká republika</option>
                <option>Natuzzi Slovensko</option>
                <option>Natuzzi Italia JAMA</option>
                <option>Natuzzi Italia RIVER</option>
                <option>Natuzzi Italia SOHO</option>
                <option>SOFTALY</option>
                <option>Natuzzi Italia FASE</option>
                <option>Pozáruční servis</option>
              </select>
            </label>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Technik
              <select id="tech" required>
                <option value="">— vyberte —</option>
                <option>Milan Kolín</option>
                <option>Radek Zikmund</option>
                <option>Oba</option>
              </select>
            </label>
          </div>
          <div class="col">
            <label>Model
              <input id="model" placeholder="U144-480-A0BH" required />
            </label>
          </div>
        </div>

        <label>Popis reklamace
          <textarea id="complaint" placeholder="Stručně popište problém…" required></textarea>
        </label>

        <div class="row">
          <div class="col"><label>Cena práce (EUR)<input id="price_work" type="number" step="0.01" value="0" required /></label></div>
          <div class="col"><label>Cena materiál (EUR)<input id="price_mat" type="number" step="0.01" value="0" required /></label></div>
        </div>
        <div class="row">
          <div class="col"><label>Cena druhého technika (EUR)<input id="price_tech" type="number" step="0.01" value="0" required /></label></div>
          <div class="col"><label>Cena doprava (EUR)<input id="price_trans" type="number" step="0.01" value="0" required /></label></div>
        </div>
        <div class="row">
          <div class="col"><label>Cena vyzvednutí dílu (EUR)<input id="price_pickup" type="number" step="0.01" value="0" required /></label></div>
          <div class="col"><label>Datum návštěvy<input id="visit_date" type="date" /></label></div>
        </div>

        <div class="controls">
          <button class="primary" id="saveBtn">Přidat</button>
          <button class="ghost" id="updateBtn" disabled>Uložit změny</button>
          <button class="ghost" id="clearBtn">Vymazat formulář</button>
          <span class="small" style="margin-left:auto">Ukládá se do <strong>localStorage</strong> a „Zákazníci“ pro auto-doplňování.</span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Seznam reklamací</h3>
        <div class="scroll">
          <table id="claimsTable">
            <thead>
              <tr>
                <th>Obj.</th>
                <th>Zákazník</th>
                <th>Adresa</th>
                <th>Telefon</th>
                <th>Model</th>
                <th>Stav</th>
                <th>Technik</th>
                <th class="nowrap">Cena celkem (EUR)</th>
                <th>Akce</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="small" style="margin-top:6px">Tip: klikni na telefon v tabulce → volání; klikni na adresu → Waze navigace.</p>
      </div>
    </div>

    <!-- PRAVÁ STRANA: PROTOKOL -->
    <div>
      <div class="card protocol" id="protocol">
        <h2>CLAIM PROTOCOL</h2>
        <div class="chips">
          <span class="chip">White Glove Service s.r.o.</span>
          <span class="chip">Do Dubče 364 / Běchovice, 190 11</span>
          <span class="chip">+420 725 965 826</span>
          <span class="chip">reklamace-wgs@email.cz</span>
          <span class="chip">IČO: 09769684</span>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col"><strong>Číslo objednávky:</strong> <span id="p_order">—</span></div>
          <div class="col"><strong>Číslo reklamace (zadavatel):</strong> <span id="p_issuer">—</span></div>
        </div>
        <div class="row">
          <div class="col"><strong>Technik:</strong> <span id="p_tech">—</span></div>
          <div class="col"><strong>Datum návštěvy:</strong> <span id="p_visit">—</span></div>
        </div>
        <hr>
        <div><strong>Zákazník:</strong> <span id="p_customer">—</span></div>
        <div><strong>Adresa:</strong> <span id="p_address">—</span></div>
        <div><strong>Kontakt:</strong> <span id="p_phone">—</span> • <span id="p_email">—</span></div>
        <div><strong>Model:</strong> <span id="p_model">—</span></div>

        <div style="margin-top:8px"><strong>Popis reklamace:</strong>
          <div id="p_complaint" style="white-space:pre-wrap;background:#fbfbfb;padding:8px;border-radius:6px;margin-top:6px"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col"><strong>Cena práce:</strong> <span id="p_price_work">0.00</span> EUR</div>
          <div class="col"><strong>Cena materiál:</strong> <span id="p_price_mat">0.00</span> EUR</div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col"><strong>Cena druhého technika:</strong> <span id="p_price_tech">0.00</span> EUR</div>
          <div class="col"><strong>Cena doprava:</strong> <span id="p_price_trans">0.00</span> EUR</div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col"><strong>Cena vyzvednutí dílu:</strong> <span id="p_price_pickup">0.00</span> EUR</div>
          <div class="col"><strong>Cena celkem EUR:</strong> <span id="p_total">0.00</span></div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Podpis zákazníka:</div>
          <canvas id="sigCanvas" class="sig" width="680" height="120"></canvas>
          <div class="actions no-print" style="margin-top:8px">
            <button class="ghost" id="clearSig">Vymazat podpis</button>
            <button class="primary" id="genPdf">Generovat PDF (CZ + EN)</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Nápověda</h3>
        <ul>
          <li>Auto-doplňování zákazníků si pamatuje poslední údaje (adresa, tel., e-mail).</li>
          <li>Povinná pole musí být vyplněna, jinak se záznam neuloží ani nevygeneruje PDF.</li>
          <li>Adresu v seznamu můžeš klepnutím otevřít ve Waze.</li>
          <li>V seznamu najdeš tlačítka <em>Otevřít</em> a <em>Upravit</em> pro práci s protokolem.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Knihovny pro export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ====== ULOŽIŠTĚ ======
    const STORAGE_KEY = 'wgs_claims_v2';
    const CUSTOMERS_KEY = 'wgs_customers_v1';
    let claims = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let customers = JSON.parse(localStorage.getItem(CUSTOMERS_KEY) || '{}'); // {name: {address, phone, email}}
    let selectedIndex = null; // index v claims pro "edit/otevřít"

    // ====== ELEMENTY ======
    const el = (id)=>document.getElementById(id);
    const $ = {
      customer: el('customer'),
      address: el('address'),
      phone: el('phone'),
      email: el('email'),
      status: el('status'),
      order: el('order'),
      issuer: el('issuer'),
      tech: el('tech'),
      model: el('model'),
      complaint: el('complaint'),
      price_work: el('price_work'),
      price_mat: el('price_mat'),
      price_tech: el('price_tech'),
      price_trans: el('price_trans'),
      price_pickup: el('price_pickup'),
      visit_date: el('visit_date'),
      saveBtn: el('saveBtn'),
      updateBtn: el('updateBtn'),
      clearBtn: el('clearBtn'),
      claimsTable: document.querySelector('#claimsTable tbody'),
      customersList: el('customersList'),
      // protokol náhled
      p_order: el('p_order'),
      p_issuer: el('p_issuer'),
      p_tech: el('p_tech'),
      p_visit: el('p_visit'),
      p_customer: el('p_customer'),
      p_address: el('p_address'),
      p_phone: el('p_phone'),
      p_email: el('p_email'),
      p_model: el('p_model'),
      p_complaint: el('p_complaint'),
      p_price_work: el('p_price_work'),
      p_price_mat: el('p_price_mat'),
      p_price_tech: el('p_price_tech'),
      p_price_trans: el('p_price_trans'),
      p_price_pickup: el('p_price_pickup'),
      p_total: el('p_total'),
      sigCanvas: el('sigCanvas'),
      clearSig: el('clearSig'),
      genPdf: el('genPdf'),
      protocol: el('protocol'),
    };

    // ====== POMOCNÉ ======
    const fmtMoney = (n)=> (Number(n)||0).toFixed(2);
    const saveAll = ()=>{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(claims));
      localStorage.setItem(CUSTOMERS_KEY, JSON.stringify(customers));
    };
    const escapeHtml = s => String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;');

    // Auto-doplňování zákazníků (datalist)
    function refreshCustomersList(){
      $.customersList.innerHTML = '';
      Object.keys(customers).sort().forEach(name=>{
        const o = document.createElement('option');
        o.value = name;
        $.customersList.appendChild(o);
      });
    }
    refreshCustomersList();

    // Při výběru zákazníka doplníme poslední známé údaje
    $.customer.addEventListener('change', ()=>{
      const name = $.customer.value.trim();
      if(customers[name]){
        const c = customers[name];
        if(!$.address.value) $.address.value = c.address||'';
        if(!$.phone.value) $.phone.value = c.phone||'';
        if(!$.email.value) $.email.value = c.email||'';
      }
    });

    // Validace povinných polí
    function validateForm(showAlerts=true){
      const required = [
        ['customer','Zákazník'],
        ['order','Číslo objednávky'],
        ['address','Adresa'],
        ['phone','Telefon'],
        ['email','E-mail'],
        ['status','Stav reklamace'],
        ['issuer','Zadavatel'],
        ['tech','Technik'],
        ['model','Model'],
        ['complaint','Popis reklamace'],
        ['price_work','Cena práce'],
        ['price_mat','Cena materiál'],
        ['price_tech','Cena druhého technika'],
        ['price_trans','Cena doprava'],
        ['price_pickup','Cena vyzvednutí dílu'],
      ];
      const missing = required.filter(([id])=>{
        const v = $[id].value;
        return v===null || v===undefined || String(v).trim()==='' || (id.startsWith('price_') && isNaN(Number(v)));
      });
      if(missing.length && showAlerts){
        alert('Doplňte povinná pole: ' + missing.map(([,label])=>label).join(', '));
      }
      return !missing.length;
    }

    function collectForm(){
      return {
        customer: $.customer.value.trim(),
        address: $.address.value.trim(),
        phone: $.phone.value.trim(),
        email: $.email.value.trim(),
        status: $.status.value,
        order: $.order.value.trim(),
        issuer: $.issuer.value,
        tech: $.tech.value,
        model: $.model.value.trim(),
        complaint: $.complaint.value.trim(),
        price_work: Number($.price_work.value||0),
        price_mat: Number($.price_mat.value||0),
        price_tech: Number($.price_tech.value||0),
        price_trans: Number($.price_trans.value||0),
        price_pickup: Number($.price_pickup.value||0),
        visit_date: $.visit_date.value || new Date().toISOString().slice(0,10),
        // metriky pro podíly techniků:
        shares: computeShares($.tech.value, Number($.price_work.value||0)+Number($.price_mat.value||0)+Number($.price_tech.value||0)+Number($.price_trans.value||0)+Number($.price_pickup.value||0))
      };
    }

    function computeShares(tech, total){
      // pravidlo: 1 technik = 45%; 2 technici (Oba) = 33% + 33%
      const t = Number(total)||0;
      if(tech==='Oba') return { 'Milan Kolín': t*0.33, 'Radek Zikmund': t*0.33, 'Firma': t*0.34 };
      if(tech==='Milan Kolín') return { 'Milan Kolín': t*0.45, 'Firma': t*0.55 };
      if(tech==='Radek Zikmund') return { 'Radek Zikmund': t*0.45, 'Firma': t*0.55 };
      return { 'Firma': t }; // fallback
    }

    function clearForm(){
      ['customer','address','phone','email','status','order','issuer','tech','model','complaint','price_work','price_mat','price_tech','price_trans','price_pickup','visit_date'].forEach(id=>{
        if(id==='status'||id==='issuer'||id==='tech') $[id].value='';
        else if(id.startsWith('price_')) $[id].value='0';
        else $[id].value='';
      });
      selectedIndex = null;
      $.updateBtn.disabled = true;
      $.saveBtn.disabled = false;
      renderTable();
      updateProtocolPreview(null);
    }

    function renderTable(){
      $.claimsTable.innerHTML = '';
      claims.forEach((c,i)=>{
        const tr = document.createElement('tr');
        if(i===selectedIndex) tr.classList.add('selected');
        const total = (c.price_work||0)+(c.price_mat||0)+(c.price_tech||0)+(c.price_trans||0)+(c.price_pickup||0);

        // tel link
        const tel = c.phone ? `<a class="inline" href="tel:${encodeURIComponent(c.phone)}">${escapeHtml(c.phone)}</a>` : '';

        // waze link (deep link + fallback)
        const q = encodeURIComponent(c.address||'');
        const waze = c.address ? `<a class="inline" href="waze://?q=${q}" onclick="if(!navigator.userAgent.match(/Android|iPhone/i)){ this.href='https://waze.com/ul?q=${q}'; }" target="_blank">${escapeHtml(c.address)}</a>` : '';

        tr.innerHTML = `
          <td class="nowrap">${escapeHtml(c.order||'')}</td>
          <td>${escapeHtml(c.customer||'')}</td>
          <td>${waze||'—'}</td>
          <td>${tel||'—'}</td>
          <td>${escapeHtml(c.model||'')}</td>
          <td>${escapeHtml(c.status||'')}</td>
          <td>${escapeHtml(c.tech||'')}</td>
          <td class="nowrap">${fmtMoney(total)}</td>
          <td class="nowrap">
            <button class="ghost" data-open="${i}">Otevřít</button>
            <button class="ghost" data-edit="${i}">Upravit</button>
            <button class="danger" data-del="${i}">Smazat</button>
          </td>
        `;
        $.claimsTable.appendChild(tr);
      });

      // Delegace akcí
      $.claimsTable.querySelectorAll('button[data-open]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          selectedIndex = Number(btn.getAttribute('data-open'));
          renderTable();
          updateProtocolPreview(claims[selectedIndex]);
          window.scrollTo({top:0,behavior:'smooth'});
        });
      });
      $.claimsTable.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          selectedIndex = Number(btn.getAttribute('data-edit'));
          const c = claims[selectedIndex];
          fillForm(c);
          $.updateBtn.disabled = false;
          $.saveBtn.disabled = true;
          renderTable();
          window.scrollTo({top:0,behavior:'smooth'});
        });
      });
      $.claimsTable.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.getAttribute('data-del'));
          if(confirm('Smazat vybraný záznam?')){
            claims.splice(idx,1);
            saveAll();
            if(selectedIndex===idx) selectedIndex = null;
            renderTable();
            updateProtocolPreview(null);
          }
        });
      });
    }

    function fillForm(c){
      if(!c) return;
      $.customer.value = c.customer||'';
      $.address.value = c.address||'';
      $.phone.value = c.phone||'';
      $.email.value = c.email||'';
      $.status.value = c.status||'';
      $.order.value = c.order||'';
      $.issuer.value = c.issuer||'';
      $.tech.value = c.tech||'';
      $.model.value = c.model||'';
      $.complaint.value = c.complaint||'';
      $.price_work.value = (c.price_work||0);
      $.price_mat.value = (c.price_mat||0);
      $.price_tech.value = (c.price_tech||0);
      $.price_trans.value = (c.price_trans||0);
      $.price_pickup.value = (c.price_pickup||0);
      $.visit_date.value = (c.visit_date||'');
      updateProtocolPreview(c);
    }

    function updateProtocolPreview(c){
      const src = c || collectForm();
      $.p_order.textContent = src.order||'—';
      $.p_issuer.textContent = src.issuer||'—';
      $.p_tech.textContent = src.tech||'—';
      $.p_visit.textContent = src.visit_date ? new Date(src.visit_date).toLocaleDateString('cs-CZ') : '—';
      $.p_customer.textContent = src.customer||'—';
      $.p_address.textContent = src.address||'—';
      $.p_phone.textContent = src.phone||'—';
      $.p_email.textContent = src.email||'—';
      $.p_model.textContent = src.model||'—';
      $.p_complaint.textContent = src.complaint||'';
      $.p_price_work.textContent = fmtMoney(src.price_work);
      $.p_price_mat.textContent = fmtMoney(src.price_mat);
      $.p_price_tech.textContent = fmtMoney(src.price_tech);
      $.p_price_trans.textContent = fmtMoney(src.price_trans);
      $.p_price_pickup.textContent = fmtMoney(src.price_pickup);
      const total = (src.price_work||0)+(src.price_mat||0)+(src.price_tech||0)+(src.price_trans||0)+(src.price_pickup||0);
      $.p_total.textContent = fmtMoney(total);
    }

    // Uložení nového záznamu
    $.saveBtn.addEventListener('click', ()=>{
      if(!validateForm()) return;
      const obj = collectForm();

      // uložit zákazníka do "adresáře" pro auto-doplňování
      customers[obj.customer] = { address: obj.address, phone: obj.phone, email: obj.email };
      // vložit na začátek (nejnovější nahoře)
      claims.unshift(obj);
      saveAll();
      refreshCustomersList();
      renderTable();
      updateProtocolPreview(obj);
      clearForm(); // vyčistit, nechť se nic nepřepisuje
      alert('Záznam uložen.');
    });

    // Uložit změny do existujícího záznamu
    $.updateBtn.addEventListener('click', ()=>{
      if(selectedIndex===null){ alert('Nejprve vyberte záznam k úpravě.'); return; }
      if(!validateForm()) return;
      const obj = collectForm();
      customers[obj.customer] = { address: obj.address, phone: obj.phone, email: obj.email };
      claims[selectedIndex] = obj;
      saveAll();
      refreshCustomersList();
      renderTable();
      updateProtocolPreview(obj);
      alert('Změny uloženy.');
    });

    $.clearBtn.addEventListener('click', clearForm);

    // ====== PODPIS ======
    class Sig {
      constructor(canvas){
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.lineWidth = 2.2;
        this.down=false; this.last=[0,0];
        canvas.addEventListener('pointerdown', e=>{ this.down=true; this.last=[e.offsetX,e.offsetY] });
        window.addEventListener('pointerup', ()=> this.down=false);
        canvas.addEventListener('pointermove', e=>{
          if(!this.down) return;
          const [lx,ly]=this.last;
          this.ctx.beginPath(); this.ctx.moveTo(lx,ly); this.ctx.lineTo(e.offsetX,e.offsetY); this.ctx.stroke();
          this.last=[e.offsetX,e.offsetY];
        });
        this.clear();
      }
      clear(){ this.ctx.fillStyle='#fff'; this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height); this.ctx.fillStyle='#000'; }
      dataURL(){ return this.canvas.toDataURL('image/png'); }
    }
    const sig = new Sig($.sigCanvas);
    $.clearSig.addEventListener('click', ()=>sig.clear());

    // ====== PDF GENEROVÁNÍ (CZ + EN) ======
    async function renderProtocolToPDF(lang /* 'cs' | 'en' */){
      // Dočasně změň nadpisy dle jazyka
      const h2 = document.querySelector('#protocol h2');
      const labels = {
        cs: {
          h2:'CLAIM PROTOCOL',
          co:'Číslo objednávky:', ci:'Číslo reklamace (zadavatel):', te:'Technik:', dv:'Datum návštěvy:',
          z:'Zákazník:', a:'Adresa:', k:'Kontakt:', m:'Model:',
          pr:'Popis reklamace:', cp:'Cena práce:', cm:'Cena materiál:', ct:'Cena druhého technika:', cd:'Cena doprava:',
          cx:'Cena vyzvednutí dílu:', tt:'Cena celkem EUR:', ps:'Podpis zákazníka:'
        },
        en: {
          h2:'CLAIM PROTOCOL',
          co:'Order number:', ci:'Claim number (issuer):', te:'Worker:', dv:'Date of visit:',
          z:'Customer:', a:'Address:', k:'Contact:', m:'Model:',
          pr:'Complaint description:', cp:'Price for work:', cm:'Price for material:', ct:'Price for second technician:', cd:'Price for transport:',
          cx:'Price for parts pickup:', tt:'Total price EUR:', ps:'Signature customer:'
        }
      }[lang];

      // přepneme texty v DOM (jen labely – hodnoty zůstávají)
      const swapText = (selector, text)=>{ const n = document.querySelector(selector); if(n) n.firstChild && (n.childNodes[0].nodeValue=text+' '); };
      h2.textContent = labels.h2;
      swapText("div.row:nth-of-type(1) .col:nth-of-type(1) strong", labels.co);
      swapText("div.row:nth-of-type(1) .col:nth-of-type(2) strong", labels.ci);
      swapText("div.row:nth-of-type(2) .col:nth-of-type(1) strong", labels.te);
      swapText("div.row:nth-of-type(2) .col:nth-of-type(2) strong", labels.dv);
      swapText("div strong:nth-of-type(1)", labels.z);
      swapText("div strong:nth-of-type(2)", labels.a);
      // kontakt je třetí „strong“ po hracce:
      const allStrong = document.querySelectorAll('#protocol strong');
      if(allStrong[6]) allStrong[6].textContent = labels.k+' ';
      if(allStrong[7]) allStrong[7].textContent = labels.m+' ';
      // popis
      const blocks = document.querySelectorAll('#protocol > div');
      // (už je připraveno pořadí – necháváme)
      // ceny
      // (přímé strongy níže)
      const pricesStrong = document.querySelectorAll('#protocol .row strong');
      // Bezpečně podle aktuální struktury:
      // Řádek práce/materiál
      pricesStrong.forEach(s=>{
        if(s.textContent.includes('Cena práce')||s.textContent.includes('Price for work')) s.textContent = labels.cp+' ';
        if(s.textContent.includes('Cena materiál')||s.textContent.includes('Price for material')) s.textContent = labels.cm+' ';
        if(s.textContent.includes('Cena druhého technika')||s.textContent.includes('Price for second technician')) s.textContent = labels.ct+' ';
        if(s.textContent.includes('Cena doprava')||s.textContent.includes('Price for transport')) s.textContent = labels.cd+' ';
        if(s.textContent.includes('Cena vyzvednutí dílu')||s.textContent.includes('Price for parts pickup')) s.textContent = labels.cx+' ';
        if(s.textContent.includes('Cena celkem EUR')||s.textContent.includes('Total price EUR')) s.textContent = labels.tt+' ';
      });
      // Popis reklamace label:
      const prLabel = document.querySelector('#p_complaint')?.previousElementSibling;
      if(prLabel && prLabel.tagName==='STRONG') prLabel.textContent = labels.pr;

      // Schovat ovládací prvky (no-print) pro snímkování
      const toHide = document.querySelectorAll('.no-print');
      toHide.forEach(n=>n.classList.add('hidden'));

      // Přidat podpis bitmapu do preview (aby byl součástí snímku)
      // (plátno už je součástí, html2canvas ho zachytí)

      const canvas = await html2canvas($.protocol, {scale:2, useCORS:true, backgroundColor:'#ffffff'});
      const img = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:'portrait',unit:'pt',format:[canvas.width, canvas.height]});
      pdf.addImage(img,'PNG',0,0,canvas.width,canvas.height);

      // Vrátit UI
      toHide.forEach(n=>n.classList.remove('hidden'));

      // Název souboru
      const c = (selectedIndex!=null)? claims[selectedIndex] : collectForm();
      const safe = s => (s||'').toString().replace(/[^a-zA-Z0-9_\-]/g,'_');
      const filename = `${safe(c.order)}_${safe(c.issuer)}_${safe(c.model)}_${lang.toUpperCase()}.pdf`;
      pdf.save(filename);
    }

    // Tlačítko: generovat PDF (obě verze)
    $.genPdf.addEventListener('click', async ()=>{
      if(selectedIndex===null && !validateForm(true)){
        return; // není vybrán záznam ani validní rozpracovaný formulář
      }
      // Ujisti se, že preview odpovídá zdroji
      const src = (selectedIndex!=null)? claims[selectedIndex] : collectForm();
      updateProtocolPreview(src);
      try{
        await renderProtocolToPDF('cs');
        await renderProtocolToPDF('en');
      }catch(err){
        alert('Chyba při generování PDF: '+ err.message);
      }
    });

    // Načti existující data
    renderTable();
    updateProtocolPreview(null);
  </script>
</body>
</html>
