<!-- 
====================================================================
üíé WHITE GLOVE SERVICE ‚Äì SEZNAM REKLAMAC√ç
====================================================================
Verze syst√©mu:       v1.0
Datum sestaven√≠:     2025-10-08
Autor:               Hugo (White Glove Service) & GPT-5
Projekt:             WGS reklamace / servisn√≠ pl√°nov√°n√≠
Soubory:             seznam.html (hlavn√≠ p≈ôehled), orders.json (data)
Worker:              https://wgs-token.72nvwf4pb2.workers.dev/orders
Repozit√°≈ô:           https://github.com/radecek222-boop/reklamace
Popis:
  Kompletn√≠ rozhran√≠ pro zobrazen√≠ a spr√°vu reklamac√≠.
  - P≈ô√≠m√© naƒç√≠t√°n√≠ dat z GitHub JSON p≈ôes Cloudflare Worker
  - Mapa, kalend√°≈ô, pl√°n dne a ukl√°d√°n√≠ term√≠n≈Ø
  - Kompatibiln√≠ s iPhone Safari a desktop prohl√≠≈æeƒçi

Struktura souboru:
  A ‚Äì Struktura str√°nky a tlaƒç√≠tka
  B ‚Äì Naƒç√≠t√°n√≠ dat a tabulka + debug
  C ‚Äì Detail z√°kazn√≠ka
  D ‚Äì Ulo≈æen√≠ term√≠nu (GitHub + toast)
  E ‚Äì Pl√°n dne (mapa + trasa)
  F ‚Äì Pomocn√© funkce a utilitky
  G ‚Äì Extern√≠ knihovny a glob√°ln√≠ inicializace

Posledn√≠ √∫prava:     2025-10-08 / 14:00  
====================================================================
-->



<!-- üü® SEKCE A ‚Äì Z√ÅKLAD (struktura str√°nky, styly, tlaƒç√≠tka, vyhled√°v√°n√≠) -->
<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seznam reklamac√≠ ‚Äì White Glove Service</title>

<!-- üåç Leaflet mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- üìÑ PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ============================= */
/* üß± Z√ÅKLADN√ç VZHLED STR√ÅNKY     */
/* ============================= */
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}
.wrapper {
  background: #fff;
  padding: 25px;
  margin: 40px 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 1200px;
  box-sizing: border-box;
}

/* ============================= */
/* üè∑Ô∏è NADPISY                    */
/* ============================= */
h1 {
  text-align: center;
  font-size: 2.2em;
  font-weight: 900;
  color: #111;
  margin: 0 0 8px;
}
h2 {
  text-align: center;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  margin: 0 0 25px;
}

/* ============================= */
/* üîò HLAVN√ç TLAƒå√çTKA (akce)     */
/* ============================= */
.actions {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 25px;
}
.btn {
  display: inline-block;
  text-decoration: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1em;
  border: none;
  cursor: pointer;
  transition: transform 0.15s ease-in-out, opacity 0.2s;
  color: white;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  min-width: 160px;
}
.btn:hover { transform: scale(1.04); opacity: 0.9; }

/* üé® Barvy tlaƒç√≠tek */
.btn-back    { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
.btn-refresh { background: linear-gradient(135deg, #b80000, #ff3838); }
.btn-green   { background: linear-gradient(135deg, #28a745, #60d06a); text-align:center; }
.btn-plan    { background: linear-gradient(135deg, #0046ff, #357aff); }

/* ============================= */
/* üîç VYHLED√ÅV√ÅN√ç                */
/* ============================= */
#search {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
}

/* ============================= */
/* üìã TABULKA Z√ÅZNAM≈Æ            */
/* ============================= */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  padding: 10px 8px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 0.95em;
  white-space: normal;
  line-height: 1.4em;
  color: #000;
  font-weight: 400;
}
th {
  background: #f8f8f8;
  font-weight: 700;
  color: #000;
}
td.adresa,
td.telefon { font-weight: 600; }
tr:hover { background: #f1f6ff; cursor: pointer; }

/* ============================= */
/* üü¢ STAVY REKLAMAC√ç            */
/* ============================= */
.stav-novy      { background: #fff9b1 !important; }
.stav-domluveno { background: #99b3ff !important; }
.stav-zruseno   { background: #ff6666 !important; }
.stav-nezveda   { background: #ffad33 !important; }

/* ============================= */
/* üì± MOBILN√ç ZOBRAZEN√ç          */
/* ============================= */
@media (max-width:700px){
  table { display:none; }
  .btn {
    width:100%;
    min-width:unset;
    text-align:center;
  }
}
</style>
</head>

<body>
  <div class="wrapper">
    <!-- üßæ HLAVIƒåKA STR√ÅNKY -->
    <h1>WHITE GLOVE SERVICE</h1>
    <h2>Seznam reklamac√≠ a servisn√≠ch po≈æadavk≈Ø</h2>

    <!-- üß≠ OVL√ÅDAC√ç TLAƒå√çTKA -->
    <div class="actions">
      <a href="index.html" class="btn btn-back">Zpƒõt</a>
      <button id="reloadBtn" class="btn btn-refresh">Naƒç√≠st znovu</button>
      <a href="hotove.html" class="btn btn-green">Hotov√© reklamace</a>
      <button id="planBtn" class="btn btn-plan">Pl√°n dne</button>
    </div>

    <!-- üîç VYHLED√ÅV√ÅN√ç -->
    <input type="text" id="search" placeholder="üîç Hledat podle jm√©na, adresy nebo zadavatele...">

    <!-- üì¶ M√çSTO PRO TABULKU -->
    <div id="tableContainer" class="loading">Naƒç√≠t√°m data...</div>
  </div>

  <!-- üîù Automatick√Ω posun p≈ôi otev≈ôen√≠ kalend√°≈ôe -->
  <script>
  document.addEventListener("click", e => {
    if (e.target && e.target.id === "termBtn") {
      setTimeout(() => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }, 150);
    }
  });
  </script>
</body>
</html>
<!-- üü® KONEC SEKCE A -->




<!-- üü¶ SEKCE B ‚Äì NAƒå√çT√ÅN√ç DAT + TABULKA + DEBUG -->
<script>
/* ============================= */
/* ‚öôÔ∏è KONSTANTY A PROMƒöNN√â       */
/* ============================= */
const API_URL = "https://wgs-token.72nvwf4pb2.workers.dev/orders";
const tableContainer = document.getElementById("tableContainer");
const searchInput = document.getElementById("search");
const reloadBtn = document.getElementById("reloadBtn");

let dataAll = [];
let stavy = JSON.parse(localStorage.getItem("stavyReklamaci") || "{}");

/* ============================= */
/* üîÑ AUTOMATICK√â NAƒå√çT√ÅN√ç DAT   */
/* ============================= */
setInterval(loadData, 120000); // ka≈æd√© 2 minuty

/* ============================= */
/* üß≠ NAƒå√çT√ÅN√ç DAT Z API          */
/* ============================= */
async function loadData() {
  console.log("üì• Naƒç√≠t√°m data z Workeru‚Ä¶");
  tableContainer.innerHTML = "<div class='loading'>Naƒç√≠t√°m data...</div>";

  try {
    const res = await fetch(API_URL, { mode: "cors", cache: "no-store" });
    if (!res.ok) throw new Error(`Chyba HTTP ${res.status}`);
    let data = await res.json();

    // üß† Normalizace ‚Äì zajist√≠, ≈æe v≈ædy pracujeme s polem
    if (!Array.isArray(data)) {
      if (typeof data === "object" && Object.keys(data).length > 0) {
        data = Object.values(data);
      } else {
        throw new Error("Worker nevrac√≠ platn√© z√°znamy");
      }
    }

    console.log("üì¶ Worker data:", data);
    updateDebug(data.length); // aktualizace panelu debug

    if (data.length === 0) {
      tableContainer.innerHTML = "<div>≈Ω√°dn√© z√°znamy</div>";
      return;
    }

    // üíæ P≈ôid√°n√≠ ulo≈æen√Ωch term√≠n≈Ø z localStorage
    const ulozeneTerminy = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]");
    data.forEach(z => {
      const ulozeny = ulozeneTerminy.find(u => u.cislo === z.cislo);
      if (ulozeny) { z.datum = ulozeny.datum; z.cas = ulozeny.cas; }
    });

    dataAll = data.reverse();
    renderTable(dataAll);

  } catch (err) {
    console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠:", err);
    tableContainer.innerHTML =
      `<div style='color:red;font-weight:600;'>Chyba naƒç√≠t√°n√≠ dat: ${err.message}</div>`;
    updateDebug(0);
  }
}

/* ============================= */
/* üìã VYKRESLEN√ç TABULKY          */
/* ============================= */
function renderTable(arr) {
  if (!arr || !arr.length) {
    tableContainer.innerHTML = "<div>≈Ω√°dn√© z√°znamy</div>";
    return;
  }

  let html = `
  <table>
    <thead>
      <tr>
        <th>Z√°kazn√≠k</th>
        <th>Adresa</th>
        <th>Telefon</th>
        <th>Stav</th>
      </tr>
    </thead>
    <tbody>`;

  arr.forEach((r, i) => {
    const id = r.cislo || `radek-${i}`;
    const stav = stavy[id] || "novy";

    const adresa = r.adresa
      ? `<a href="https://waze.com/ul?q=${encodeURIComponent(r.adresa)}"
           target="_blank"
           style="color:#000;font-weight:600;">${r.adresa}</a>`
      : "‚Äì";

    const telefon = r.telefon
      ? `<a href="tel:${r.telefon.replace('+420','').trim()}"
           style="color:#000;font-weight:600;">${r.telefon.replace('+420','').trim()}</a>`
      : "‚Äì";

    let stavText = stav;
    if (stav === "domluveno" && r.datum && r.cas) {
      const d = new Date(r.datum);
      const den = d.toLocaleDateString("cs-CZ",
        { weekday: "short", day: "numeric", month: "numeric" });
      stavText = `${den} ${r.cas}`;
    }

    html += `
      <tr class="stav-${stav}" data-index="${i}" data-id="${id}">
        <td>${r.zakaznik || "‚Äì"}</td>
        <td>${adresa}</td>
        <td>${telefon}</td>
        <td style="font-weight:400;">${stavText}</td>
      </tr>`;
  });

  html += "</tbody></table>";
  tableContainer.innerHTML = html;

  document.querySelectorAll("tbody tr").forEach(row => {
    row.addEventListener("click", () => openDetail(row.dataset.index));
  });
}

/* ============================= */
/* üîç VYHLED√ÅV√ÅN√ç                 */
/* ============================= */
searchInput.addEventListener("input", () => {
  const q = searchInput.value.trim().toLowerCase();
  if (!q) return renderTable(dataAll);
  renderTable(dataAll.filter(r =>
    (r.zakaznik || "").toLowerCase().includes(q) ||
    (r.adresa || "").toLowerCase().includes(q)
  ));
});

/* ============================= */
/* üîÅ RUƒåN√ç NAƒåTEN√ç DAT           */
/* ============================= */
reloadBtn.addEventListener("click", loadData);

/* ============================= */
/* üß© DEBUG PANEL AKTUALIZACE     */
/* ============================= */
function updateDebug(count) {
  const c = document.getElementById("debugCount");
  const t = document.getElementById("debugTime");
  if (!c || !t) return;
  c.textContent = count;
  t.textContent = new Date().toLocaleTimeString("cs-CZ",
    { hour: "2-digit", minute: "2-digit", second: "2-digit" });
}
</script>

<!-- üß© DEBUG PANEL (VIZU√ÅLN√ç INFO) -->
<div id="debugBox"
     style="font-family:Inter,sans-serif;
            font-size:12px;
            color:#333;
            position:fixed;
            bottom:10px;
            right:12px;
            background:#f7f7f7;
            border:1px solid #ccc;
            border-radius:8px;
            padding:8px 12px;
            box-shadow:0 2px 6px rgba(0,0,0,0.1);
            z-index:9999;">
  Naƒçteno: <span id="debugCount">0</span> z√°znam≈Ø<br>
  <small>Aktualizace: <span id="debugTime">‚Äì</span></small>
</div>
<!-- üü¶ KONEC SEKCE B -->

‚Ä®



<!-- üü© SEKCE C ‚Äì DETAIL Z√ÅKAZN√çKA (rozdƒõlen√° verze) -->
<!-- ================================================= -->
<!-- üü© C-1: OPRAVEN√â OTEV≈òEN√ç DETAILU (s mo≈ænost√≠ upravit popis z√°vady) -->
<script>
function openDetail(index) {
  const item = dataAll[index];
  if (!item) return;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  const adresaUpravena = normalizePrahaAddress(item.adresa || "");

  overlay.innerHTML = `
    <div class="detail-modal">
      <div class="grid-layout">

        <!-- üß≠ LEV√ù PANEL -->
        <div class="left-panel">
          <div>
            <div id="miniCalendar"></div>
            <div class="custom-time-picker">
              <select id="hours"></select><span>:</span><select id="minutes"></select>
            </div>
            <div class="term-info-box" id="termInfoBox">Vyberte datum a ƒças</div>
          </div>

          <div class="left-buttons">
            <button id="saveTermBtn" class="btn-action btn-green">Ulo≈æit / Zmƒõnit</button>
            <button id="noAnswerBtn" class="btn-action btn-orange">Nezved√° (SMS)</button>
            <button id="cancelBtn" class="btn-action btn-red">Z√°kazn√≠k zru≈°il</button>
            <button id="closeBtn" class="btn-action btn-gray">Zav≈ô√≠t</button>

            <div class="extra-buttons">
              <button id="createProtocolBtn" class="btn-action btn-blue">Vytvo≈ôit protokol</button>
              <button id="exportPdfBtn" class="btn-action btn-gray">Exportovat do PDF</button>
            </div>
          </div>
        </div>

        <!-- üßæ PRAV√ù PANEL -->
        <div class="right-panel">
          <div class="customer-info">
            <h2>${item.zakaznik || "Z√°kazn√≠k"}</h2>
            <p><strong>Adresa:</strong>
              <a href="https://waze.com/ul?q=${encodeURIComponent(adresaUpravena)}" target="_blank">${adresaUpravena}</a>
            </p>
            <p><strong>Telefon:</strong>
              <a href="tel:${(item.telefon||"").replace("+420","").trim()}">
                ${(item.telefon||"").replace("+420","").trim()}</a>
            </p>
            <p><strong>Email:</strong> ${item.email||"‚Äì"}</p>
            <p><strong>Produkt / model:</strong> ${item.produkt||"‚Äì"}</p>

            <!-- ‚úèÔ∏è Popis z√°vady + tlaƒç√≠tko Upravit -->
            <div class="popis-box">
              <p><strong>Popis z√°vady:</strong></p>
              <div id="popisText">${item.popis || "‚Äì"}</div>
              <button id="editPopisBtn" class="btn-small">Upravit popis</button>
            </div>
          </div>

          <div class="distance-banner" id="mapDistance">üìç Poƒç√≠t√°m vzd√°lenost‚Ä¶</div>
          <div id="mapDetail"></div>
        </div>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  setTimeout(() => overlay.classList.add("active"), 20);

  // üß≠ Inicializace standardn√≠ch ƒç√°st√≠
  initCalendarAndTime(overlay, item, index);
  initMapForDetail(overlay, item);
  initDetailButtons(overlay, item, index);

  // ‚úèÔ∏è Otev≈ôen√≠ editoru popisu
  overlay.querySelector("#editPopisBtn").onclick = () => openEditPopisModal(item, overlay);
}

/* üìù Editor popisu z√°vady (mal√Ω modal s textareou) */
function openEditPopisModal(item, parentOverlay) {
  const modal = document.createElement("div");
  modal.className = "edit-popis-overlay";
  modal.innerHTML = `
    <div class="edit-popis-modal">
      <h3>Upravit popis z√°vady</h3>
      <textarea id="newPopis">${item.popis || ""}</textarea>
      <div class="popis-buttons">
        <button id="savePopisBtn" class="btn-green">Ulo≈æit</button>
        <button id="closePopisBtn" class="btn-gray">Zav≈ô√≠t</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  setTimeout(()=>modal.classList.add("active"),20);

  modal.querySelector("#closePopisBtn").onclick = ()=>modal.remove();
  modal.querySelector("#savePopisBtn").onclick = ()=>{
    const newText = modal.querySelector("#newPopis").value.trim();
    item.popis = newText;
    localStorage.setItem("upravenyPopisy", JSON.stringify({
      ...(JSON.parse(localStorage.getItem("upravenyPopisy")||"{}")),
      [item.cislo]: newText
    }));
    const textBox = parentOverlay.querySelector("#popisText");
    if (textBox) textBox.textContent = newText || "‚Äì";
    modal.remove();
    showToast("Popis z√°vady upraven", "success");
  };
}
</script>

<!-- üíÖ CSS ‚Äì zarovn√°n√≠ mapy + editor popisu -->
<style>
.detail-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999; opacity: 0; transition: opacity .25s ease;
}
.detail-overlay.active { opacity: 1; }

.detail-modal {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
  max-width: 900px; width: 95%;
  max-height: 90vh; overflow-y: auto;
}
.grid-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px; align-items: stretch;
}
.left-panel, .right-panel {
  display: flex; flex-direction: column; justify-content: space-between;
}

/* Zarovn√°n√≠ spodku mapy s tlaƒç√≠tky */
#mapDetail {
  flex-grow: 1;
  border-radius: 10px; border: 1px solid #ddd;
  margin-top: 10px; min-height: 260px;
}

/* ‚úèÔ∏è Popis z√°vady */
.popis-box {
  margin-top: 10px;
  background: #f9f9f9;
  border-radius: 8px;
  padding: 8px 10px;
}
#popisText {
  white-space: pre-wrap;
  font-size: 0.95em;
  color: #111;
  margin-bottom: 8px;
}
.btn-small {
  background: linear-gradient(135deg,#0046ff,#357aff);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 0.85em;
  font-weight: 600;
  cursor: pointer;
}

/* ‚úèÔ∏è Modal pro √∫pravu popisu */
.edit-popis-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex; justify-content: center; align-items: center;
  z-index: 10000; opacity: 0; transition: opacity .25s ease;
}
.edit-popis-overlay.active { opacity: 1; }
.edit-popis-modal {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
}
.edit-popis-modal h3 {
  margin-top: 0;
  text-align: center;
}
.edit-popis-modal textarea {
  width: 100%;
  height: 150px;
  font-size: 0.95em;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  resize: vertical;
  box-sizing: border-box;
}
.popis-buttons {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  margin-top: 12px;
}
.popis-buttons button {
  flex: 1;
  height: 40px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: #fff;
}
.btn-green { background: linear-gradient(135deg,#28a745,#6fdd72); }
.btn-gray { background: linear-gradient(135deg,#6c757d,#a0a4a7); }

@media (max-width:700px){
  .grid-layout { grid-template-columns:1fr; }
  #mapDetail { height:auto; }
}
</style>
<!-- üü© KONEC OPRAVY C-1 -->





<!-- üü© C-2: MAPA A VZD√ÅLENOST -->
<script>
function initMapForDetail(overlay, item) {
  if (!item.adresa) return;
  const wgs = [50.049, 14.523];
  const map = L.map(overlay.querySelector("#mapDetail")).setView(wgs, 9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { attribution: "¬© OpenStreetMap" }).addTo(map);
  const wgsM = L.marker(wgs, { title: "WGS" }).addTo(map);

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.adresa)}`)
    .then(r => r.json())
    .then(d => {
      if (d[0]) {
        const c = [+d[0].lat, +d[0].lon];
        const cust = L.marker(c, { title: "Z√°kazn√≠k" }).addTo(map);
        L.polyline([wgs, c], { color: "#0046ff", weight: 3 }).addTo(map);
        const dist = calcDistanceCoords(wgs[0], wgs[1], c[0], c[1]);
        overlay.querySelector("#mapDistance").innerHTML =
          `Vzd√°lenost od WGS: ${dist.toFixed(1)} km`;
        map.fitBounds(L.featureGroup([wgsM, cust]).getBounds().pad(0.3));
      }
    });
}
</script>
<!-- üü© KONEC C-2 -->


<!-- üü© C-3: KALEND√Å≈ò A ƒåAS -->
<script>
function initCalendarAndTime(overlay, item, index) {
  const infoBox = overlay.querySelector("#termInfoBox");
  const miniCal = new VanillaCalendar("#miniCalendar", {
    settings: { lang: "cs", selection: { day: "single" }, visibility: { theme: "light" } },
    actions: { clickDay: e => {
      const chosen = e.target.dataset.calendarDay;
      if (chosen) {
        overlay.dataset.datum = chosen;
        updateTermInfoBox(infoBox, chosen, null);
        flashBox(infoBox, "gray");
      }
    } }
  });
  miniCal.init();

  // hodiny
  const hSel = overlay.querySelector("#hours"), mSel = overlay.querySelector("#minutes");
  for (let h = 7; h < 20; h++) hSel.innerHTML += `<option>${String(h).padStart(2,"0")}</option>`;
  for (let m = 0; m < 60; m += 5) mSel.innerHTML += `<option>${String(m).padStart(2,"0")}</option>`;
  hSel.addEventListener("change", () => updateTime(infoBox, overlay));
  mSel.addEventListener("change", () => updateTime(infoBox, overlay));
}
</script>
<!-- üü© KONEC C-3 -->




<!-- üü© C-4: TLAƒå√çTKA AKC√ç ‚Äì kompletn√≠, ovƒõ≈ôen√° verze -->
<script>
function initDetailButtons(overlay, item, index) {
  const id = item.cislo || `radek-${index}`;
  const infoBox = overlay.querySelector("#termInfoBox");

  /* üíæ ULO≈ΩIT / ZMƒöNIT TERM√çN */
  overlay.querySelector("#saveTermBtn").onclick = () => {
    const datum = overlay.dataset.datum;
    const cas = `${overlay.querySelector("#hours").value}:${overlay.querySelector("#minutes").value}`;
    if (!datum || !cas) return alert("Vyberte datum a ƒças!");
    ulozitTerminNaGitHub(item, id, datum, cas, overlay, overlay.querySelector("#saveTermBtn"), infoBox);
  };

  /* üì© NEZVED√Å (SMS) */
  overlay.querySelector("#noAnswerBtn").onclick = () => {
    stavy[id] = "nezveda"; item.stav = "nezveda";
    setNextToast("üì© SMS o nezvednut√≠ byla p≈ôipravena", "warning");
    if (item.telefon) {
      const tel = item.telefon.replace(/\+?420|\s+/g, "");
      const sms = "Dobr√Ω den, volali jsme ohlednƒõ Va≈°√≠ reklamace. Pros√≠m ozvƒõte se zpƒõt. WGS";
      window.location.href = `sms:+420${tel}?body=${encodeURIComponent(sms)}`;
    }
    overlay.remove(); renderTable(dataAll);
  };

  /* ‚ùå Z√ÅKAZN√çK ZRU≈†IL */
  overlay.querySelector("#cancelBtn").onclick = () => {
    stavy[id] = "zruseno"; item.stav = "zruseno";
    setNextToast("‚ùå Term√≠n zru≈°en", "error");
    if (item.telefon) {
      const tel = item.telefon.replace(/\+?420|\s+/g, "");
      const sms = "Dobr√Ω den, V√°≈° term√≠n servisu byl zru≈°en na z√°kladƒõ Va≈°eho po≈æadavku. WGS";
      window.location.href = `sms:+420${tel}?body=${encodeURIComponent(sms)}`;
    }
    overlay.remove(); renderTable(dataAll);
  };

  /* üîô ZPƒöT */
  overlay.querySelector("#closeBtn").onclick = () => overlay.remove();

  /* üßæ VYTVORIT PROTOKOL */
  overlay.querySelector("#createProtocolBtn").onclick = () => {
    try {
      localStorage.setItem("protokolData", JSON.stringify(item));
      window.location.href = "protokol.html";
    } catch (e) {
      alert("‚ùå Nepoda≈ôilo se ulo≈æit data pro protokol: " + e.message);
    }
  };

  /* üìÑ EXPORTOVAT DO PDF */
  overlay.querySelector("#exportPdfBtn").onclick = async () => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.text("White Glove Service ‚Äì Protokol", 10, 15);
      doc.setFontSize(11);
      let y = 30;
      const lines = [
        `Z√°kazn√≠k: ${item.zakaznik || "-"}`,
        `Adresa: ${item.adresa || "-"}`,
        `Telefon: ${item.telefon || "-"}`,
        `Email: ${item.email || "-"}`,
        `Produkt / model: ${item.produkt || "-"}`,
        `Popis z√°vady: ${item.popis || "-"}`,
        `Datum servisu: ${item.datum || "-"} ${item.cas || ""}`,
      ];
      lines.forEach(line => { doc.text(line, 10, y); y += 8; });
      const filename = `Protokol_${(item.cislo || "bez_cisla").replace(/\s+/g, "_")}.pdf`;
      doc.save(filename);
    } catch (err) {
      alert("‚ùå Chyba p≈ôi exportu PDF: " + err.message);
    }
  };
}
</script>

<!-- üü© DOPL≈áKOV√ù STYL (pro vizu√°ln√≠ rozestup) -->
<style>
.extra-buttons {
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin-top:14px; /* mezera mezi Zpƒõt a protokol/PDF */
}
.extra-buttons .btn-action {
  flex:1;
  font-size:0.95em;
  padding:10px;
}
.btn-blue {
  background:linear-gradient(135deg,#0046ff,#357aff);
  color:#fff;
}
@media(max-width:700px){
  .extra-buttons { flex-direction:column; }
}
</style>
<!-- üü© KONEC C-4 -->







<!-- üü© C-5: POMOCN√â FUNKCE -->
<script>
function updateTermInfoBox(b, d, c) {
  const date = new Date(d);
  const den = date.toLocaleDateString("cs-CZ", { weekday: "long", day: "numeric", month: "long" });
  b.textContent = c ? `${den} ‚Äì ${c}` : `${den}`;
}
function updateTime(b, o) {
  const d = o.dataset.datum; if (!d) return;
  const c = `${o.querySelector("#hours").value}:${o.querySelector("#minutes").value}`;
  updateTermInfoBox(b, d, c); flashBox(b, "green");
}
function flashBox(b, color) {
  b.classList.remove("flash-gray", "flash-green"); void b.offsetWidth;
  b.classList.add(color === "green" ? "flash-green" : "flash-gray");
}
function calcDistanceCoords(a, b, c, d) {
  const R = 6371, dL = (c - a) * Math.PI / 180, dO = (d - b) * Math.PI / 180;
  const x = Math.sin(dL/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
}
</script>
<!-- üü© KONEC C-5 -->


<!-- üü© C-STYLE: CSS DETAILU -->
<style>
.grid-layout { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.left-panel, .right-panel { background:#fff; border-radius:10px; padding:10px; }
#miniCalendar { margin-bottom:12px; }
.custom-time-picker { display:flex; justify-content:center; align-items:center; gap:6px; margin-bottom:10px; }
.custom-time-picker select { font-size:1.1em; font-weight:600; border:1px solid #ccc; border-radius:8px; padding:5px 10px; }
.term-info-box { background:#f0f0f0; padding:10px; text-align:center; font-weight:600; border-radius:8px; margin-top:8px; transition:background .3s; }
.flash-gray{animation:flashGray .4s;} .flash-green{animation:flashGreen .5s 2;}
@keyframes flashGray{0%{background:#d6d6d6;}100%{background:#f0f0f0;}}
@keyframes flashGreen{0%,100%{background:#b6f7a8;}50%{background:#d8ffd2;}}
.customer-info h2{text-align:center;margin:0 0 8px;}
.customer-info p{margin:4px 0;font-size:.95em;color:#000;}
.distance-banner{background:#f6f6f6;border-radius:8px;padding:8px;text-align:center;font-weight:600;margin:10px 0;}
#mapDetail{height:260px;border-radius:10px;border:1px solid #ddd;}
.left-buttons{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
.btn-action{padding:10px;border:none;border-radius:8px;font-weight:600;color:#fff;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.15);}
.btn-green{background:linear-gradient(135deg,#28a745,#6fdd72);}
.btn-orange{background:linear-gradient(135deg,#ff9800,#ffc270);color:#222;}
.btn-red{background:linear-gradient(135deg,#dc3545,#f87171);}
.btn-gray{background:linear-gradient(135deg,#6c757d,#a0a4a7);}
@media(max-width:700px){.grid-layout{grid-template-columns:1fr;}.left-buttons{flex-direction:column;}}
</style>
<!-- üü© KONEC C-STYLE -->






<!-- üüß SEKCE D ‚Äì ULO≈ΩEN√ç TERM√çNU NA GITHUB + TOAST + LOADER -->
<script>
/* ========================================================= */
/* üíæ ULO≈ΩEN√ç TERM√çNU P≈òES WORKER (GITHUB)                   */
/* ========================================================= */
async function ulozitTerminNaGitHub(item, id, datum, cas, overlay, btn, infoBox) {
  stavy[id] = "domluveno";
  item.datum = datum;
  item.cas = cas;

  // ‚è≥ Loader ‚Äûƒåekejte‚Äú
  const loader = document.createElement("div");
  loader.className = "loader-overlay";
  loader.innerHTML = `
    <div class="loader-inner">
      <div class="hourglass"></div>
      <div>‚è≥ ƒåekejte, ukl√°d√°m term√≠n‚Ä¶</div>
    </div>`;
  document.body.appendChild(loader);

  try {
    // üíæ Ulo≈æen√≠ p≈ôes Worker na GitHub
    const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "update", record: item })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    // ‚úÖ Potvrzen√≠
    setTimeout(() => {
      loader.remove();
      showSuccessOverlay("‚úÖ Term√≠n √∫spƒõ≈°nƒõ ulo≈æen",
        "Data byla odesl√°na a potvrzena v GitHub repozit√°≈ôi.");
      ulozTermin(item);
      localStorage.setItem("stavyReklamaci", JSON.stringify(stavy));
      flashBox(infoBox, "green");
      setNextToast("‚úÖ Term√≠n √∫spƒõ≈°nƒõ ulo≈æen", "success");

      setTimeout(() => {
        overlay.remove();
        renderTable(dataAll);
      }, 1400);
    }, 800);

  } catch (err) {
    loader.remove();
    alert("‚ùå Chyba p≈ôi ukl√°d√°n√≠ term√≠nu: " + err.message);
    showToast("Chyba p≈ôi ukl√°d√°n√≠!", "error");
  }
}

/* ========================================================= */
/* üåü TOAST A SUCCESS OVERLAY                                */
/* ========================================================= */
function showToast(msg, type = "success") {
  const toast = document.createElement("div");
  toast.className = `wgs-toast ${type}`;
  toast.innerHTML = `<span>${msg}</span>`;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("active"), 50);
  setTimeout(() => {
    toast.classList.remove("active");
    setTimeout(() => toast.remove(), 400);
  }, 3500);
}

// pro p≈ôenos zpr√°vy do dal≈°√≠ho naƒçten√≠
function setNextToast(msg, type = "success") {
  sessionStorage.setItem("wgsToastMsg", msg);
  sessionStorage.setItem("wgsToastType", type);
}

// po reloadu zobraz toast z p≈ôedchoz√≠ akce
window.addEventListener("DOMContentLoaded", () => {
  const toastMsg = sessionStorage.getItem("wgsToastMsg");
  const toastType = sessionStorage.getItem("wgsToastType");
  if (toastMsg) {
    showToast(toastMsg, toastType);
    sessionStorage.removeItem("wgsToastMsg");
    sessionStorage.removeItem("wgsToastType");
  }
});

/* ========================================================= */
/* üéâ SUCCESS OVERLAY (velk√° b√≠l√° hl√°≈°ka uprost≈ôed)          */
/* ========================================================= */
function showSuccessOverlay(title, text) {
  const ok = document.createElement("div");
  ok.className = "successOverlay";
  ok.innerHTML = `
    <div class="successInner">
      <div class="icon">‚úÖ</div>
      <div class="title">${title}</div>
      <div class="text">${text}</div>
    </div>`;
  document.body.appendChild(ok);
  setTimeout(() => ok.classList.add("active"), 50);
  setTimeout(() => {
    ok.classList.remove("active");
    setTimeout(() => ok.remove(), 400);
  }, 1800);
}
</script>

<!-- üüß D-STYLE: LOADER + TOAST + SUCCESS OVERLAY -->
<style>
.loader-overlay {
  position: fixed; inset: 0;
  background: rgba(255,255,255,0.88);
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  font-family: "Inter", sans-serif;
  color: #0046ff; font-weight: 700;
  font-size: 1.2em; z-index: 99999;
}
.hourglass {
  width: 44px; height: 44px;
  border: 4px solid #0046ff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1.1s linear infinite;
  margin-bottom: 12px;
}
@keyframes spin { from {transform:rotate(0)} to {transform:rotate(360deg)} }

.successOverlay {
  position: fixed; inset: 0;
  background: rgba(255,255,255,0.9);
  display: flex; justify-content: center; align-items: center;
  opacity: 0; transition: opacity 0.3s ease; z-index: 100000;
}
.successOverlay.active { opacity: 1; }
.successInner {
  background: #fff;
  border-left: 6px solid #28a745;
  border-radius: 12px;
  padding: 25px 30px;
  text-align: center;
  font-family: "Inter", sans-serif;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  max-width: 360px;
}
.successInner .icon { font-size: 2em; margin-bottom: 10px; }
.successInner .title { font-size: 1.3em; font-weight: 800; color: #28a745; margin-bottom: 6px; }
.successInner .text { font-size: 0.95em; color: #333; }

/* Toast vpravo naho≈ôe */
.wgs-toast {
  position: fixed; top: 20px; right: 20px;
  background: #fff;
  padding: 14px 22px;
  border-radius: 8px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.15);
  font-family: "Inter", sans-serif;
  font-size: 0.95em;
  font-weight: 600;
  color: #111;
  opacity: 0; transform: translateY(-10px);
  transition: all 0.35s ease; z-index: 100001;
}
.wgs-toast.active { opacity: 1; transform: translateY(0); }
.wgs-toast.success { border-left: 5px solid #28a745; }
.wgs-toast.error { border-left: 5px solid #dc3545; }
.wgs-toast.warning { border-left: 5px solid #ff9800; }
</style>
<!-- üüß KONEC SEKCE D -->






<!-- üü¶ SEKCE E ‚Äì PL√ÅN DNE (kalend√°≈ô, mapa, trasa, legenda) -->
<!-- ====================================================== -->

<!-- üü¶ E-1: OTEV≈òEN√ç OKNA PL√ÅNU DNE -->
<script>
function openPlanModal() {
  const overlay = document.createElement("div");
  overlay.id = "planModal";
  overlay.innerHTML = `
    <div class="planContent">
      <div class="planLeft">
        <div id="planCalendar"></div>
        <div id="planLegend"></div>
        <button id="planCloseBtn" class="btn-close">Zpƒõt</button>
      </div>
      <div class="planRight">
        <div id="planMap"></div>
        <div id="planList"></div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  setTimeout(()=>overlay.classList.add("active"),20);

  initPlanCalendar(overlay);
  overlay.querySelector("#planCloseBtn").onclick = ()=>overlay.remove();
}
</script>
<!-- üü¶ KONEC E-1 -->


<!-- üü¶ E-2: KALEND√Å≈ò A NAƒåTEN√ç DN√ç -->
<script>
function initPlanCalendar(overlay){
  const cal = new VanillaCalendar("#planCalendar",{
    settings:{ lang:"cs", selection:{ day:"single" }, visibility:{ theme:"light" }},
    actions:{ clickDay:e=>{
      const d = e.target.dataset.calendarDay;
      if(!d)return;
      loadPlanForDay(d,overlay);
    }}
  });
  cal.init();

  // vyznaƒçit dny s term√≠nem modr√Ωm punt√≠kem
  const data = dataAll.filter(x=>x.datum);
  data.forEach(r=>{
    const el=document.querySelector(`[data-calendar-day="${r.datum}"]`);
    if(el) el.classList.add("vanilla-calendar-day__btn_selected");
  });
}
</script>
<!-- üü¶ KONEC E-2 -->


<!-- üü¶ E-3: NAƒåTEN√ç A ZOBRAZEN√ç DNƒö -->
<script>
async function loadPlanForDay(date,overlay){
  const list=dataAll.filter(r=>r.datum===date && r.stav!=="zruseno");
  const planList=overlay.querySelector("#planList");
  const planLegend=overlay.querySelector("#planLegend");
  const planMap=overlay.querySelector("#planMap");

  if(!list.length){
    planList.innerHTML="<div class='empty'>≈Ω√°dn√© zak√°zky pro tento den</div>";
    planLegend.innerHTML="";
    planMap.innerHTML="";
    return;
  }

  // se≈ôadit podle ƒçasu
  list.sort((a,b)=>(a.cas||"").localeCompare(b.cas||""));
  planList.innerHTML="";
  planLegend.innerHTML="";

  let legendHTML="<table class='legendTable'><tr><th>#</th><th>ƒåas</th><th>Z√°kazn√≠k</th></tr>";
  list.forEach((r,i)=>{
    legendHTML+=`<tr><td>${i+1}</td><td>${r.cas||"-"}</td><td>${r.zakaznik}</td></tr>`;
  });
  legendHTML+="</table>";
  planLegend.innerHTML=legendHTML;

  planList.innerHTML=list.map((r,i)=>`
    <div class="planItem">
      <div class="planNum">${i+1}</div>
      <div class="planName">${r.zakaznik}</div>
      <div class="planAddr">${r.adresa}</div>
      <div class="planTime">${r.cas}</div>
    </div>`).join("");

  await showPlanMap(list,planMap);
}
</script>
<!-- üü¶ KONEC E-3 -->


<!-- üü¶ E-4: MAPA A TRASA -->
<script>
async function showPlanMap(list,container){
  const wgs=[50.049,14.523];
  const map=L.map(container).setView(wgs,9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);
  const points=[wgs];
  const markers=[L.marker(wgs,{title:"WGS"})];
  const geos=[];

  for(const r of list){
    if(!r.adresa)continue;
    const geo=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(r.adresa)}`).then(x=>x.json());
    if(geo[0]){
      const p=[+geo[0].lat,+geo[0].lon];
      geos.push(p);
      points.push(p);
      markers.push(L.marker(p,{title:r.zakaznik}).addTo(map).bindPopup(`${r.zakaznik}<br>${r.adresa}<br>${r.cas}`));
    }
  }

  if(points.length>1){
    L.polyline(points,{color:"#0046ff",weight:3}).addTo(map);
    map.fitBounds(L.featureGroup(markers).getBounds().pad(0.3));
  }
}
</script>
<!-- üü¶ KONEC E-4 -->


<!-- üü¶ E-STYLE: MAPA + LEGENDA + ROZLO≈ΩEN√ç -->
<style>
#planModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);
  justify-content:center;align-items:center;z-index:9999;opacity:0;transition:opacity .25s ease;}
#planModal.active{display:flex;opacity:1;}
.planContent{background:#fff;border-radius:14px;display:grid;
  grid-template-columns:340px 1fr;gap:15px;padding:20px;max-width:90vw;max-height:90vh;overflow:auto;}
.planLeft{display:flex;flex-direction:column;align-items:center;}
#planCalendar{width:100%;}
.legendTable{border-collapse:collapse;width:100%;margin-top:10px;font-size:.9em;}
.legendTable th,.legendTable td{border-bottom:1px solid #ddd;padding:4px;text-align:left;}
.legendTable th{background:#f2f2f2;font-weight:700;}
.btn-close{margin-top:10px;background:linear-gradient(135deg,#dc3545,#f87171);color:#fff;
  border:none;border-radius:8px;padding:8px 16px;font-weight:600;cursor:pointer;}
.planRight{display:flex;flex-direction:column;gap:10px;}
#planMap{height:360px;border-radius:10px;border:1px solid #ccc;}
.planItem{background:#f8f9fa;padding:8px 10px;border-radius:8px;margin-bottom:6px;
  display:grid;grid-template-columns:30px 1fr 1fr 60px;align-items:center;gap:8px;}
.planNum{font-weight:800;color:#0046ff;}
.planName{font-weight:600;}
.planAddr{font-size:.9em;color:#333;}
.planTime{text-align:right;font-weight:600;}
.empty{text-align:center;color:#555;margin-top:30px;}
@media(max-width:900px){.planContent{grid-template-columns:1fr;max-width:100vw;}}
</style>
<!-- üü¶ KONEC SEKCE E -->










<!-- üü® SEKCE F ‚Äì POMOCN√â FUNKCE A UTILITIES -->
<!-- ======================================= -->

<!-- 
====================================================================
üß≠ F-1: POMOCN√â FUNKCE ‚Äì NORMALIZACE ADRES
====================================================================
√öƒçel:
  - sjednocuje z√°pisy adres z r≈Øzn√Ωch zdroj≈Ø
  - dopl≈àuje chybƒõj√≠c√≠ mƒõstsk√© ƒç√°sti Prahy pro p≈ôesnou geolokaci
  - zaji≈°≈•uje spr√°vn√© v√Ωsledky pro OpenStreetMap (Nominatim)
  - pou≈æ√≠v√° se p≈ôi zobrazov√°n√≠ adres ve Waze, mapƒõ i detailu z√°kazn√≠ka

Posledn√≠ √∫prava: 2025-10-08
====================================================================
-->
<script>
function normalizePrahaAddress(a) {
  if (!a) return "";
  let t = a.trim();

  // üí° odstranƒõn√≠ duplicitn√≠ch oznaƒçen√≠ a sjednocen√≠ mezery
  t = t.replace(/\bHlavn√≠ mƒõsto Praha\b/gi, "Praha");
  t = t.replace(/\bPraha\s*\d*\b/gi, "Praha");
  t = t.replace(/\s+/g, " ");

  // üß© speci√°ln√≠ pra≈æsk√© ƒçtvrti, kter√© Nominatim ƒçasto zamƒõ≈àuje:
  const doplnky = [
    { match: /do dubƒçe/i, add: "Praha 9 - Bƒõchovice" },
    { match: /bƒõchovic/i, add: "Praha 9 - Bƒõchovice" },
    { match: /horn√≠ poƒçernic/i, add: "Praha 9 - Horn√≠ Poƒçernice" },
    { match: /doln√≠ mƒõcholup/i, add: "Praha 10 - Doln√≠ Mƒõcholupy" },
    { match: /uh≈ô√≠nƒõves/i, add: "Praha 22 - Uh≈ô√≠nƒõves" },
    { match: /≈ôepy/i, add: "Praha 17 - ≈òepy" },
    { match: /zliƒç√≠n/i, add: "Praha 5 - Zliƒç√≠n" },
    { match: /kolodƒõj/i, add: "Praha 9 - Kolodƒõje" },
    { match: /kyje/i, add: "Praha 14 - Kyje" },
    { match: /dubeƒç/i, add: "Praha 10 - Dubeƒç" }
  ];

  // üß† kontrola a doplnƒõn√≠ mƒõstsk√© ƒç√°sti, pokud v adrese chyb√≠
  for (const d of doplnky) {
    if (d.match.test(t) && !t.toLowerCase().includes(d.add.toLowerCase())) {
      if (!/praha\s*\d/i.test(t)) t += ", " + d.add;
    }
  }

  // üß≠ doplnƒõn√≠ defaultn√≠ ƒç√°sti pro Prahu, pokud nen√≠ uvedena
  if (/praha/i.test(t) && !/praha\s*\d/i.test(t)) {
    t += ", Praha 1";
  }

  return t.trim();
}
</script>
<!-- üü© KONEC SEKCE F-1 -->


<!-- üü® F-2: LOK√ÅLN√ç UKL√ÅD√ÅN√ç TERM√çN≈Æ -->
<script>
function ulozTermin(item) {
  const ulozene = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]");
  const exist = ulozene.find(x => x.cislo === item.cislo);
  if (exist) {
    exist.datum = item.datum;
    exist.cas = item.cas;
  } else {
    ulozene.push({ cislo: item.cislo, datum: item.datum, cas: item.cas });
  }
  localStorage.setItem("stavyReklamaciData", JSON.stringify(ulozene));
}
</script>
<!-- üü® KONEC F-2 -->


<!-- üü® F-3: V√ùPOƒåET HASH A KONTROLA DUPLIK√ÅT≈Æ -->
<script>
function computeDataHash(arr) {
  try {
    const s = JSON.stringify(arr);
    let hash = 0;
    for (let i = 0; i < s.length; i++) {
      hash = (hash << 5) - hash + s.charCodeAt(i);
      hash |= 0;
    }
    return hash;
  } catch (e) { return 0; }
}
</script>
<!-- üü® KONEC F-3 -->


<!-- üü® F-4: KONTROLA RELOADU A P≈òENOS TOASTU -->
<script>
window.addEventListener("DOMContentLoaded", () => {
  const msg = sessionStorage.getItem("wgsToastMsg");
  const type = sessionStorage.getItem("wgsToastType");
  if (msg) {
    showToast(msg, type);
    sessionStorage.removeItem("wgsToastMsg");
    sessionStorage.removeItem("wgsToastType");
  }

  // voliteln√©: zobraz info o poƒçtu z√°znam≈Ø
  if (typeof dataAll !== "undefined" && dataAll.length) {
    console.log(`‚ÑπÔ∏è Naƒçteno ${dataAll.length} z√°znam≈Ø z Workera.`);
  }
});
</script>
<!-- üü® KONEC F-4 -->


<!-- üü® F-5: GENERICK√â FUNKCE ‚Äì BARVY, FORM√ÅTY -->
<script>
function formatDateCzech(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("cs-CZ", { day: "2-digit", month: "2-digit", year: "numeric" });
}
function formatTimeShort(h, m) {
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}
</script>
<!-- üü® KONEC F-5 -->


<!-- üü® F-STYLE: DOPL≈áKOV√â STYLY -->
<style>
.flash-green {animation:flashGreen .6s;}
@keyframes flashGreen {
  0% {background:#c0f9b8;} 50% {background:#e8ffe3;} 100% {background:#f0f0f0;}
}
.loading {text-align:center;padding:20px;color:#555;font-family:Inter,sans-serif;}
</style>
<!-- üü® KONEC F-STYLE -->






<!-- üü™ SEKCE G ‚Äì EXTERN√ç KNIHOVNY + GLOB√ÅLN√ç INICIALIZACE -->
<!-- ===================================================== -->

<!-- üü™ G-1: IMPORTY KNIHOVEN -->
<!-- üó∫Ô∏è Leaflet (mapa) -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin=""></script>

<!-- üìÖ Vanilla Calendar (tv√° verze z GitHubu) -->
<link rel="stylesheet"
      href="https://radecek222-boop.github.io/reklamace/vanilla-calendar.min.css">
<script src="https://radecek222-boop.github.io/reklamace/vanilla-calendar.min.js"></script>

<!-- üìÑ jsPDF (pro export PDF ‚Äì voliteln√©) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- üü™ KONEC G-1 -->


<!-- üü™ G-2: GLOB√ÅLN√ç INICIALIZACE A OCHRANA -->
<script>
window.addEventListener("DOMContentLoaded", () => {
  console.log("‚úÖ White Glove Service ‚Äì syst√©m spu≈°tƒõn");
  console.log("üåç Worker API:", API_URL);
  console.log("üì¶ P≈ôipojen√≠ k GitHub repozit√°≈ôi aktivn√≠.");

  // 1Ô∏è‚É£ Naƒçten√≠ dat z Workera
  loadData();

  // 2Ô∏è‚É£ Zobrazen√≠ toastu z minul√© akce (po reloadu)
  const toastMsg = sessionStorage.getItem("wgsToastMsg");
  const toastType = sessionStorage.getItem("wgsToastType");
  if (toastMsg) {
    showToast(toastMsg, toastType);
    sessionStorage.removeItem("wgsToastMsg");
    sessionStorage.removeItem("wgsToastType");
  }

  // 3Ô∏è‚É£ Kontrola knihoven + log
  if (typeof L === "undefined") {
    console.error("‚ùå Leaflet se nonaƒçetl ‚Äì zkontroluj CDN.");
  } else {
    console.log("üó∫Ô∏è Leaflet OK");
  }

  if (typeof VanillaCalendar === "undefined") {
    console.error("‚ùå Vanilla Calendar se nonaƒçetl ‚Äì zkontroluj link v sekci G-1.");
  } else {
    console.log("üìÖ Vanilla Calendar inicializov√°n (v2.8.1 ‚Äì GitHub lok√°ln√≠ verze)");
  }

  console.log("üß≠ Naƒçteny v≈°echny sekce A‚ÄìG (verze v1.0 ‚Äì 10/2025)");
});

window.addEventListener("error", e => {
  console.error("‚ö†Ô∏è Chyba:", e.message, "‚Üí", e.filename, ":", e.lineno);
});
window.addEventListener("unhandledrejection", e => {
  console.error("‚ö†Ô∏è Nezpracovan√© Promise:", e.reason);
});
</script>
<!-- üü™ KONEC G-2 -->


<!-- üü™ G-3: Z√ÅVƒöREƒåN√â STYLY A INFO -->
<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  color: #111;
  margin: 0;
  padding: 0;
}

/* P≈ôechody pro mod√°ln√≠ vrstvy a p≈ôekryvy */
.detail-overlay,
#planModal,
.loader-overlay,
.successOverlay {
  transition: opacity 0.3s ease;
}

/* Mobiln√≠ optimalizace */
@media (max-width:600px) {
  .detail-modal, .planContent { max-width: 95vw; }
  #planMap { height: 260px; }
}

/* V√Ωbƒõr textu */
::selection { background:#0046ff; color:#fff; }
</style>
<!-- üü™ KONEC G-3 -->







<!-- 
============================================================
üß≠ WHITE GLOVE SERVICE ‚Äì SEZNAM REKLAMAC√ç (mapa sekc√≠ A‚ÄìG)
Verze: 1.0 (≈ô√≠jen 2025)
Autor: Hugo & GPT-5
============================================================

üî∏ SEKCE A ‚Äì STRUKTURA STR√ÅNKY
  - HTML rozlo≈æen√≠ (hlaviƒçka, tlaƒç√≠tka, vyhled√°v√°n√≠, tabulka)
  - z√°kladn√≠ CSS vzhled
  - v≈°echny viditeln√© prvky u≈æivatelsk√©ho rozhran√≠

üîπ SEKCE B ‚Äì NAƒå√çT√ÅN√ç DAT
  - Fetch z Cloudflare Workera (https://wgs-token.72nvwf4pb2.workers.dev/orders)
  - funkce loadData() + renderTable()
  - vyhled√°v√°n√≠ z√°kazn√≠k≈Ø, filtrov√°n√≠
  - debug panel (B-DEBUG) ‚Äì poƒçet z√°znam≈Ø + ƒças naƒçten√≠

üîπ SEKCE C ‚Äì DETAIL Z√ÅKAZN√çKA
  - openDetail(index) ‚Äì zobrazen√≠ detailu z tabulky
  - lev√Ω panel: kalend√°≈ô, ƒças, tlaƒç√≠tka (Ulo≈æit / Nezved√° / Zru≈°il / Zpƒõt)
  - prav√Ω panel: √∫daje z√°kazn√≠ka, mapa (Leaflet), vzd√°lenost od WGS
  - rozdƒõleno do C-1 a≈æ C-5 + styly

üîπ SEKCE D ‚Äì ULO≈ΩEN√ç TERM√çNU
  - ulo≈æit p≈ôes Worker (GitHub update)
  - loader ‚è≥ + toast üîî + success overlay ‚úÖ
  - funkce showToast(), showSuccessOverlay(), setNextToast()
  - ukl√°d√°n√≠ do localStorage + p≈ôenos mezi relacemi

üîπ SEKCE E ‚Äì PL√ÅN DNE
  - openPlanModal() ‚Äì mƒõs√≠ƒçn√≠ kalend√°≈ô + mapa dne
  - zobrazen√≠ z√°kazn√≠k≈Ø podle ƒçasu
  - vykreslen√≠ trasy WGS ‚Üí z√°kazn√≠ci (Leaflet)
  - legenda (ƒças, po≈ôad√≠, jm√©no)
  - responzivn√≠ pro mobil i desktop

üîπ SEKCE F ‚Äì POMOCN√â FUNKCE
  - normalizePrahaAddress() ‚Äì √∫prava adres
  - ulozTermin() ‚Äì ulo≈æen√≠ term√≠nu do localStorage
  - computeDataHash() ‚Äì kontroln√≠ hash pro zmƒõny
  - form√°tov√°n√≠ ƒçasu, datumu, animace flash
  - p≈ôenos toastu po reloadu

üîπ SEKCE G ‚Äì EXTERN√ç KNIHOVNY + GLOB√ÅLN√ç INIT
  - import Leaflet + Vanilla Calendar + jsPDF
  - kontrola naƒçten√≠ knihoven (konzolov√© logy)
  - glob√°ln√≠ styly, ochrana proti chyb√°m (error / rejection)

============================================================
üìÇ Celkov√° struktura:
A  ‚Äì HTML UI
B  ‚Äì Data & Tabulka
C  ‚Äì Detail z√°kazn√≠ka
D  ‚Äì Ulo≈æen√≠ term√≠nu
E  ‚Äì Pl√°n dne
F  ‚Äì Pomocn√© funkce
G  ‚Äì Extern√≠ knihovny & Init
============================================================

üß† Pozn√°mka:
Tento blok je pouze dokumentaƒçn√≠ (HTML koment√°≈ô).
Nem√° ≈æ√°dn√Ω vliv na funkci k√≥du a m≈Ø≈æe b√Ωt volnƒõ p≈ôesouv√°n
nebo dopl≈àov√°n podle pot≈ôeby v√Ωvoje.

============================================================
-->


<!-- 
============================================================
‚öôÔ∏è WHITE GLOVE SERVICE ‚Äì TECHNICK√ù INDEX FUNKC√ç
============================================================

üì¶ SEKCE A ‚Äì STRUKTURA A OVL√ÅD√ÅN√ç
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ window.scrollTo()                  ‚Üí posun p≈ôi otev≈ôen√≠ kalend√°≈ôe
‚Ä¢ (DOM event listener)               ‚Üí kliknut√≠ na tlaƒç√≠tko term√≠nu

üì° SEKCE B ‚Äì NAƒå√çT√ÅN√ç DAT + DEBUG
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ loadData()                         ‚Üí naƒçten√≠ dat z Workera (JSON)
‚Ä¢ renderTable(arr)                   ‚Üí vykreslen√≠ tabulky z√°znam≈Ø
‚Ä¢ normalizePrahaAddress(addr)        ‚Üí √∫prava adres Praha bez PSƒå
‚Ä¢ sortSmart(data)                    ‚Üí chytr√© ≈ôazen√≠ dat
‚Ä¢ hashData(arr)                      ‚Üí hash pro detekci zmƒõn
‚Ä¢ playNotification()                 ‚Üí zvuk p≈ôi nov√Ωch z√°znamech
‚Ä¢ searchInput.oninput                ‚Üí filtrov√°n√≠ v√Ωsledk≈Ø
‚Ä¢ reloadBtn.onclick                  ‚Üí ruƒçn√≠ obnoven√≠ dat

üë§ SEKCE C ‚Äì DETAIL Z√ÅKAZN√çKA
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ openDetail(index)                  ‚Üí otev≈ôe detail z√°kazn√≠ka (modal)
‚Ä¢ updateTermInfoBox()                ‚Üí aktualizace textu s datem/ƒçasem
‚Ä¢ updateTime()                       ‚Üí p≈ôepoƒçet ƒçasu p≈ôi zmƒõnƒõ hodin/minut
‚Ä¢ flashBox()                         ‚Üí kr√°tk√° animace p≈ôi potvrzen√≠
‚Ä¢ calcDistanceCoords()               ‚Üí v√Ωpoƒçet vzd√°lenosti mezi body
‚Ä¢ (Leaflet map init)                 ‚Üí zobrazen√≠ mapy z√°kazn√≠ka
‚Ä¢ (VanillaCalendar init)             ‚Üí mal√Ω kalend√°≈ô v detailu
‚Ä¢ (Event listeners)                  ‚Üí tlaƒç√≠tka Ulo≈æit / Nezved√° / Zru≈°it / Zpƒõt

üíæ SEKCE D ‚Äì ULO≈ΩEN√ç TERM√çNU
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ ulozitTerminNaGitHub()             ‚Üí ukl√°d√° zmƒõny p≈ôes Worker ‚Üí GitHub
‚Ä¢ ulozTermin()                       ‚Üí zapisuje term√≠n do localStorage
‚Ä¢ showToast(msg, type)               ‚Üí kr√°tk√° zpr√°va v rohu
‚Ä¢ setNextToast(msg, type)            ‚Üí ulo≈æ√≠ toast pro p≈ô√≠≈°t√≠ zobrazen√≠
‚Ä¢ (Loader overlay)                   ‚Üí vizu√°ln√≠ animace ‚è≥ bƒõhem ukl√°d√°n√≠

üóìÔ∏è SEKCE E ‚Äì PL√ÅN DNE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ initCalendar()                     ‚Üí zobrazen√≠ Vanilla Calendaru
‚Ä¢ addBlueDots()                      ‚Üí oznaƒçen√≠ dn≈Ø s ulo≈æen√Ωmi term√≠ny
‚Ä¢ showPlanForDay(date)               ‚Üí vykresl√≠ mapu a legendu pro vybran√Ω den
‚Ä¢ recalcDeparture()                  ‚Üí p≈ôepoƒç√≠t√° ƒças odjezdu
‚Ä¢ highlightTodayRows()               ‚Üí zv√Ωrazn√≠ dne≈°n√≠ term√≠ny (blik√°n√≠)
‚Ä¢ exportPlanToPDF()                  ‚Üí export pl√°nu dne do PDF

üß© SEKCE F ‚Äì POMOCN√â FUNKCE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ normalizePrahaAddress()            ‚Üí (z√°kladn√≠ verze) zkr√°cen√≠ adres
‚Ä¢ ulozTermin(item)                   ‚Üí ukl√°d√°n√≠ lok√°ln√≠ch term√≠n≈Ø
‚Ä¢ computeDataHash()                  ‚Üí hash kontrola
‚Ä¢ formatDateCzech()                  ‚Üí p≈ôevod ISO data do ƒçesk√©ho form√°tu
‚Ä¢ formatTimeShort(h, m)              ‚Üí form√°tov√°n√≠ ƒçasu HH:MM
‚Ä¢ (flashGreen animace)               ‚Üí potvrzen√≠ ulo≈æen√Ωch dat

üåç SEKCE G ‚Äì EXTERN√ç KNIHOVNY + INIT
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Leaflet (L.*)                      ‚Üí mapy, trasy, znaƒçky
‚Ä¢ VanillaCalendar()                  ‚Üí kalend√°≈ô (verze 2.8.1)
‚Ä¢ jsPDF()                            ‚Üí export PDF
‚Ä¢ window.addEventListener("DOMContentLoaded")  ‚Üí glob√°ln√≠ start log≈Ø
‚Ä¢ window.addEventListener("error")   ‚Üí zachyt√≠ JS chyby
‚Ä¢ window.addEventListener("unhandledrejection") ‚Üí zachyt√≠ chyby Promise

============================================================
üß† DOPORUƒåEN√ç PRO LADƒöN√ç
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Pokud se data nenaƒç√≠taj√≠ ‚Üí zkontroluj Worker (sekce B)
‚Ä¢ Pokud mapa nefunguje ‚Üí zkontroluj Leaflet import (sekce G)
‚Ä¢ Pokud kalend√°≈ô nefunguje ‚Üí Vanilla Calendar (sekce G)
‚Ä¢ Pokud toast miz√≠ ‚Üí kontrola sessionStorage (sekce D/F)
‚Ä¢ Pokud detail zamrz√° ‚Üí zkontroluj funkce openDetail() a ulozitTerminNaGitHub()

============================================================
üìò VERZE: 1.0 ‚Äì ≈ô√≠jen 2025
============================================================
-->

