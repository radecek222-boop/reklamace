<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seznam reklamac√≠ ‚Äì White Glove Service</title>

<!-- Leaflet mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Vanilla Calendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.8.1/build/vanilla-calendar.min.css">
<script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.8.1/build/vanilla-calendar.min.js"></script>

<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}
.wrapper {
  width: 95%;
  max-width: 1300px;
  background: #fff;
  margin: 20px 0 60px;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  margin: 0 0 15px;
  font-size: 1.6rem;
  font-weight: 800;
}
.buttons {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}
button {
  font-family: inherit;
  font-size: 15px;
  font-weight: 600;
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: #fff;
  transition: transform 0.2s ease, opacity 0.2s ease;
}
button:hover { transform: scale(1.04); }
#backBtn { background: linear-gradient(135deg, #444, #222); }
#reloadBtn { background: linear-gradient(135deg, #b30000, #800000); }
#hotoveBtn { background: linear-gradient(135deg, #444, #222); }
#planBtn { background: linear-gradient(135deg, #004a99, #002f6c); }
table {
  border-collapse: collapse;
  width: 100%;
  border-radius: 10px;
  overflow: hidden;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #eee;
  text-align: left;
  font-size: 14px;
}
th {
  background: #f1f1f1;
  font-weight: 700;
}
tr:hover { background: #fafafa; cursor: pointer; }
.status-novy { background: rgba(255, 255, 0, 0.3); animation: blink 1s infinite alternate; }
.status-zruseno { background: rgba(255, 0, 0, 0.1); }
.status-domluveno { background: rgba(0, 0, 0, 0.05); }
@keyframes blink { from { background: rgba(255,255,0,0.4); } to { background: rgba(255,255,0,0.1); } }
.phone, .address { color: #000; text-decoration: underline; cursor: pointer; }
.phone:hover, .address:hover { text-decoration: none; }
.modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 10000;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 95%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}
.close-btn {
  position: absolute;
  top: 10px; right: 10px;
  background: #b30000;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
}
.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}
@media (max-width: 800px) {
  .detail-grid { grid-template-columns: 1fr; }
  .wrapper { padding: 15px; }
}
.map-box {
  height: 300px;
  border-radius: 10px;
  margin-top: 10px;
}
</style>
</head>

<body>
<div class="wrapper">
  <h1>WHITE GLOVE SERVICE ‚Äì Seznam reklamac√≠</h1>

  <div class="buttons">
    <button id="backBtn">Zpƒõt</button>
    <button id="reloadBtn">Naƒç√≠st znovu</button>
    <button id="hotoveBtn">Hotov√© reklamace</button>
    <button id="planBtn">Pl√°n dne</button>
  </div>

  <input type="text" id="searchInput" placeholder="üîç Hledat jm√©no nebo adresu..." 
    style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; font-family:inherit;">

  <div style="overflow-x:auto;">
    <table id="reklamaceTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Jm√©no</th>
          <th>Adresa</th>
          <th>Telefon</th>
          <th>Popis</th>
          <th>Stav</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- dynamicky doplnƒõno -->
      </tbody>
    </table>
  </div>
</div>

<!-- üîç Detailn√≠ modal -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeDetail()">Zav≈ô√≠t</button>
    <h2 id="detailName" style="margin-bottom:10px;"></h2>
    <div class="detail-grid">
      <div>
        <p><b>Adresa:</b> <span id="detailAddress"></span></p>
        <p><b>Telefon:</b> <a id="detailPhone" class="phone"></a></p>
        <p><b>E-mail:</b> <span id="detailEmail"></span></p>
        <p><b>Popis:</b> <span id="detailPopis"></span></p>
        <p><b>Typ:</b> <span id="detailTyp"></span></p>
        <p><b>Stav:</b> <span id="detailStav"></span></p>
        <p><b>Term√≠n:</b> <span id="detailTermin"></span></p>
      </div>
      <div>
        <div id="mapDetail" class="map-box"></div>
      </div>
    </div>
  </div>
</div>
<script>
/* ============================================= */
/* üîÑ   NAƒå√çT√ÅN√ç A ZOBRAZEN√ç DAT Z CLOUDFLARE    */
/* ============================================= */

const WORKER_URL = "https://dark-darkness-d89a.72nvwf4pb2.workers.dev/";
let reklamacniData = [];
let mapDetail = null;

/* üì•  Naƒçten√≠ dat */
async function loadData() {
  try {
    const response = await fetch(WORKER_URL);
    const csv = await response.text();
    reklamacniData = parseCSV(csv);
    renderTable(reklamacniData);
  } catch (err) {
    console.error("‚ùå Chyba p≈ôi naƒçten√≠ dat:", err);
    showBanner("Chyba p≈ôi naƒçten√≠ dat", "#b30000");
  }
}

/* üß©  Parsov√°n√≠ CSV */
function parseCSV(csv) {
  const lines = csv.split("\n").filter(x => x.trim() !== "");
  const headers = lines[0].split(",");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    const item = {};
    headers.forEach((h, i) => item[h.trim()] = cols[i] ? cols[i].trim() : "");
    return item;
  });
}

/* ============================================= */
/* üìã  ZOBRAZEN√ç TABULKY SE Z√ÅKAZN√çKY            */
/* ============================================= */
function renderTable(data) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">≈Ω√°dn√© z√°znamy</td></tr>`;
    return;
  }

  data.forEach((item, index) => {
    const tr = document.createElement("tr");

    // üîç logika stavu
    let stavClass = "";
    let stavText = item.stav?.toLowerCase() || "";
    if (stavText.includes("nov√Ω")) stavClass = "status-novy";
    else if (stavText.includes("zru≈°eno")) stavClass = "status-zruseno";
    else if (stavText.includes("domluveno")) stavClass = "status-domluveno";

    tr.classList.add(stavClass);

    // üìÖ pokud m√° term√≠n, zobraz jen datum bez roku a ƒças
    let stavDisplay = "";
    if (item.termin && item.termin.trim() !== "") {
      try {
        const d = new Date(item.termin);
        const den = String(d.getDate()).padStart(2, "0");
        const mes = String(d.getMonth()+1).padStart(2, "0");
        const hod = String(d.getHours()).padStart(2, "0");
        const min = String(d.getMinutes()).padStart(2, "0");
        stavDisplay = `${den}.${mes}. ${hod}:${min}`;
      } catch {
        stavDisplay = item.termin;
      }
    } else if (stavText.includes("zru≈°eno")) {
      stavDisplay = "Zru≈°eno";
    } else if (stavText.includes("nezved√°")) {
      stavDisplay = "Nezved√°";
    } else if (stavText.includes("nov√Ω")) {
      stavDisplay = "Nov√Ω";
    } else {
      stavDisplay = "";
    }

    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.jmeno || ""}</td>
      <td><a class="address" href="https://waze.com/ul?ll=${encodeURIComponent(item.adresa || "")}" target="_blank">${item.adresa || ""}</a></td>
      <td><a class="phone" href="tel:${item.telefon || ""}">${item.telefon || ""}</a></td>
      <td>${item.popis || ""}</td>
      <td>${stavDisplay}</td>
    `;

    tr.addEventListener("click", () => openDetail(item));
    tbody.appendChild(tr);
  });
}

/* üîç Vyhled√°v√°n√≠ */
document.getElementById("searchInput").addEventListener("input", e => {
  const val = e.target.value.toLowerCase();
  const filtered = reklamacniData.filter(item =>
    (item.jmeno && item.jmeno.toLowerCase().includes(val)) ||
    (item.adresa && item.adresa.toLowerCase().includes(val))
  );
  renderTable(filtered);
});
/* ============================================= */
/* üîç   DETAIL Z√ÅKAZN√çKA + MAPA + INTERAKCE      */
/* ============================================= */

function openDetail(item) {
  const modal = document.getElementById("detailModal");
  modal.style.display = "flex";

  // üßæ Vyplnit √∫daje
  document.getElementById("detailName").textContent = item.jmeno || "";
  document.getElementById("detailAddress").innerHTML =
    `<a class="address" href="https://waze.com/ul?q=${encodeURIComponent(item.adresa || "")}" target="_blank">${item.adresa || ""}</a>`;
  document.getElementById("detailPhone").href = `tel:${item.telefon || ""}`;
  document.getElementById("detailPhone").textContent = item.telefon || "";
  document.getElementById("detailEmail").textContent = item.email || "";
  document.getElementById("detailPopis").textContent = item.popis || "";
  document.getElementById("detailTyp").textContent = item.typ || "";
  document.getElementById("detailStav").textContent = item.stav || "";

  // üìÖ Zobraz term√≠n pokud je
  let terminText = "";
  if (item.termin && item.termin.trim() !== "") {
    try {
      const d = new Date(item.termin);
      const den = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth()+1).padStart(2, "0");
      const hod = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      terminText = `${den}.${mes}. ${hod}:${min}`;
    } catch {
      terminText = item.termin;
    }
  }
  document.getElementById("detailTermin").textContent = terminText;

  // üó∫Ô∏è Inicializace mapy
  const mapContainer = document.getElementById("mapDetail");
  mapContainer.innerHTML = ""; // vyƒçisti

  if (item.adresa) {
    // Z√≠sk√°n√≠ polohy p≈ôes Nominatim (OpenStreetMap API)
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.adresa)}`)
      .then(res => res.json())
      .then(data => {
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          mapDetail = L.map("mapDetail").setView([lat, lon], 13);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution: "&copy; OpenStreetMap"
          }).addTo(mapDetail);
          L.marker([lat, lon]).addTo(mapDetail).bindPopup(item.jmeno || "Z√°kazn√≠k").openPopup();
          setTimeout(() => mapDetail.invalidateSize(), 400);
        } else {
          mapContainer.innerHTML = "<p style='text-align:center;color:#666;'>Nepoda≈ôilo se naj√≠t adresu</p>";
        }
      })
      .catch(err => {
        console.warn("‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠ mapy:", err);
        mapContainer.innerHTML = "<p style='text-align:center;color:#666;'>Mapa nedostupn√°</p>";
      });
  } else {
    mapContainer.innerHTML = "<p style='text-align:center;color:#666;'>Bez adresy</p>";
  }

  // üö´ Zamez p≈ôekryv≈Øm klik√°n√≠
  mapContainer.style.pointerEvents = "auto";
}

/* ‚ùå Zav≈ôen√≠ detailu */
function closeDetail() {
  const modal = document.getElementById("detailModal");
  modal.style.display = "none";

  if (mapDetail) {
    mapDetail.remove(); // uvolni mapu z pamƒõti
    mapDetail = null;
  }
}

/* ============================================= */
/* üîî   BANNEROV√Å NOTIFIKACE                     */
/* ============================================= */
function showBanner(text, color = "#28a745") {
  const banner = document.createElement("div");
  banner.textContent = text;
  Object.assign(banner.style, {
    position: "fixed",
    top: "12px",
    left: "50%",
    transform: "translateX(-50%)",
    background: color,
    color: "#fff",
    padding: "10px 22px",
    borderRadius: "10px",
    boxShadow: "0 4px 8px rgba(0,0,0,0.2)",
    zIndex: "99999",
    fontWeight: "600",
    letterSpacing: "0.3px"
  });
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
}
/* ============================================= */
/* üìÖ   PL√ÅN DNE ‚Äì MAPA + KALEND√Å≈ò               */
/* ============================================= */

let planMap = null;
let planCalendar = null;
let planModal = null;

/* HTML modalu pro pl√°n dne */
const planModalHTML = `
<div id="planModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:1000px;">
    <button class="close-btn" onclick="closePlan()">Zav≈ô√≠t</button>
    <h2 style="margin-bottom:15px;">üìÖ Pl√°n dne</h2>
    <div id="calendarContainer" style="margin-bottom:20px;"></div>
    <div id="planMap" style="height:400px; border-radius:10px;"></div>
    <div id="planList" style="margin-top:15px;"></div>
  </div>
</div>
`;
document.body.insertAdjacentHTML("beforeend", planModalHTML);

/* Otev≈ôen√≠ pl√°nu dne */
document.getElementById("planBtn").addEventListener("click", openPlan);

function openPlan() {
  planModal = document.getElementById("planModal");
  planModal.style.display = "flex";

  // üó∫Ô∏è Inicializace mapy
  if (!planMap) {
    planMap = L.map("planMap").setView([49.8, 15.4], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(planMap);
  }

  setTimeout(() => planMap.invalidateSize(), 400);

  // üóìÔ∏è Inicializace kalend√°≈ôe
  const container = document.getElementById("calendarContainer");
  container.innerHTML = "";

  planCalendar = new VanillaCalendar(container, {
    type: "default",
    settings: {
      range: {
        disablePast: true
      },
      selection: {
        day: 'multiple'
      }
    },
    actions: {
      clickDay(event, self) {
        const date = self.selectedDates[0];
        if (date) showPlanForDay(date);
      }
    }
  });
  planCalendar.init();
  markPlannedDays();
}

/* Zav≈ôen√≠ pl√°nu dne */
function closePlan() {
  const modal = document.getElementById("planModal");
  modal.style.display = "none";
  if (planMap) planMap.invalidateSize();
}

/* Zobrazen√≠ seznamu a mapy pro konkr√©tn√≠ den */
function showPlanForDay(dateStr) {
  if (!reklamacniData.length) return;
  const chosen = reklamacniData.filter(r => (r.termin || "").startsWith(dateStr));

  const listDiv = document.getElementById("planList");
  listDiv.innerHTML = "";

  if (!chosen.length) {
    listDiv.innerHTML = `<p style="text-align:center;color:#666;">≈Ω√°dn√© reklamace pro tento den</p>`;
    return;
  }

  listDiv.innerHTML = chosen.map(r =>
    `<p><b>${r.jmeno}</b> ‚Äì ${r.adresa || ""} (${r.telefon || ""})</p>`
  ).join("");

  // üó∫Ô∏è vykreslen√≠ trasy a marker≈Ø
  planMap.eachLayer(l => { if (l instanceof L.Marker || l instanceof L.Polyline) planMap.removeLayer(l); });

  const coords = [];
  const requests = chosen.map(r =>
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(r.adresa || "")}`)
      .then(res => res.json())
      .then(data => {
        if (data[0]) {
          const lat = parseFloat(data[0].lat);
          const lon = parseFloat(data[0].lon);
          coords.push([lat, lon]);
          L.marker([lat, lon]).addTo(planMap).bindPopup(`${r.jmeno}<br>${r.adresa}`);
        }
      })
  );

  Promise.all(requests).then(() => {
    if (coords.length > 1) {
      const route = coords.map(c => c.join(",")).join(";");
      fetch(`https://router.project-osrm.org/route/v1/driving/${route}?overview=full&geometries=geojson`)
        .then(res => res.json())
        .then(json => {
          const routeCoords = json.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
          L.polyline(routeCoords, { color: "#007bff", weight: 4 }).addTo(planMap);
          planMap.fitBounds(L.polyline(routeCoords).getBounds());
        })
        .catch(() => planMap.fitBounds(L.latLngBounds(coords)));
    } else if (coords.length === 1) {
      planMap.setView(coords[0], 13);
    }
  });
}

/* Vyznaƒçit dny, kde jsou pl√°novan√© term√≠ny */
function markPlannedDays() {
  if (!planCalendar || !reklamacniData.length) return;

  const dates = reklamacniData
    .filter(r => r.termin)
    .map(r => r.termin.split("T")[0]);

  planCalendar.update({
    dates: {
      highlights: dates.map(d => ({ date: d, background: "#004a99", color: "#fff" }))
    }
  });
}
/* ============================================= */
/* üïê  ZV√ùRAZNƒöN√ç DNE≈†N√çCH Z√ÅZNAM≈Æ              */
/* ============================================= */

function highlightTodayRows() {
  const today = new Date().toISOString().split("T")[0];
  const rows = document.querySelectorAll("#tableBody tr");
  rows.forEach(row => {
    const item = reklamacniData[row.rowIndex - 1];
    if (!item) return;
    if (item.termin && item.termin.startsWith(today)) {
      row.style.background = "rgba(255, 223, 0, 0.3)";
      row.style.animation = "blink 1.5s infinite alternate";
    }
  });
}

/* ============================================= */
/* ‚öôÔ∏è  NAƒå√çT√ÅN√ç A OBNOVA DAT                    */
/* ============================================= */

let fetchInProgress = false;

async function loadDataSafe() {
  if (fetchInProgress) return;
  fetchInProgress = true;
  try {
    await loadData();
    highlightTodayRows();
  } finally {
    fetchInProgress = false;
  }
}

/* Automatick√© obnoven√≠ ka≈æd√© 2 minuty */
setInterval(loadDataSafe, 120000);

/* Obnoven√≠ p≈ôi n√°vratu do okna */
window.addEventListener("focus", () => setTimeout(loadDataSafe, 600));

/* ============================================= */
/* üîâ  ZVUKOV√â POTVRZEN√ç NAƒåTEN√ç                */
/* ============================================= */
function playNotification() {
  try {
    const audio = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
    audio.volume = 0.2;
    audio.play().catch(() => {});
  } catch(e) { console.warn("Zvuk nelze p≈ôehr√°t:", e); }
}

/* ============================================= */
/* üß≠  HLAVN√ç TLAƒå√çTKA                          */
/* ============================================= */

// üîô Zpƒõt na index
document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "index.html";
});

// üîÅ Naƒç√≠st znovu
document.getElementById("reloadBtn").addEventListener("click", () => {
  showBanner("Aktualizuji seznam‚Ä¶", "#b30000");
  loadDataSafe();
  playNotification();
});

// ‚úÖ Hotov√© reklamace
document.getElementById("hotoveBtn").addEventListener("click", () => {
  window.location.href = "hotove.html";
});
/* ============================================= */
/* üöÄ  INITIALIZACE P≈òI NAƒåTEN√ç STR√ÅNKY         */
/* ============================================= */

window.addEventListener("DOMContentLoaded", () => {
  console.log("‚úÖ Seznam reklamac√≠ inicializov√°n");

  // üßæ Naƒçten√≠ dat z Cloudflare Worker
  loadDataSafe().then(() => showBanner("Data naƒçtena", "#004a99"));

  // Zvukov√© potvrzen√≠
  setTimeout(playNotification, 500);

  // Oprava mapy po otev≈ôen√≠ modalu (detail / pl√°n)
  document.addEventListener("click", e => {
    if (e.target.closest("#planBtn")) {
      setTimeout(() => {
        if (planMap) planMap.invalidateSize();
      }, 700);
    }
  });

  // Detekce zmƒõny mezi z√°lo≈ækami
  window.addEventListener("storage", e => {
    if (["stavyReklamaci", "stavyReklamaciData"].includes(e.key)) {
      console.log("üîÅ Detekov√°na zmƒõna v jin√© z√°lo≈æce ‚Äì aktualizuji data");
      setTimeout(loadDataSafe, 800);
    }
  });
});

/* ============================================= */
/* üíæ  UKL√ÅD√ÅN√ç POSLEDN√çHO Z√ÅKAZN√çKA            */
/* ============================================= */

function rememberLastCustomer(item) {
  try {
    localStorage.setItem("lastCustomer", JSON.stringify(item));
  } catch(e) { console.warn("Nelze ulo≈æit posledn√≠ho z√°kazn√≠ka:", e); }
}

function getLastCustomer() {
  try {
    return JSON.parse(localStorage.getItem("lastCustomer") || "null");
  } catch {
    return null;
  }
}
/* ============================================= */
/* ‚ö°Ô∏è  RYCHL√â VYHLED√ÅV√ÅN√ç (DEBOUNCE)           */
/* ============================================= */

let searchTimeout;
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input", e => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    const val = e.target.value.toLowerCase();
    const filtered = reklamacniData.filter(item =>
      (item.jmeno && item.jmeno.toLowerCase().includes(val)) ||
      (item.adresa && item.adresa.toLowerCase().includes(val)) ||
      (item.telefon && item.telefon.toLowerCase().includes(val))
    );
    renderTable(filtered);
  }, 200);
});

/* ============================================= */
/* üí°  TOOLTIPY PRO OZNAƒåEN√â DNY                */
/* ============================================= */

function addTooltipToCalendar() {
  const days = document.querySelectorAll(".vanilla-calendar-day__btn");
  if (!planCalendar || !reklamacniData.length) return;

  const grouped = {};
  reklamacniData.forEach(r => {
    if (r.termin) {
      const d = r.termin.split("T")[0];
      if (!grouped[d]) grouped[d] = [];
      grouped[d].push(r.jmeno);
    }
  });

  days.forEach(btn => {
    const date = btn.getAttribute("data-calendar-day");
    if (grouped[date]) {
      btn.title = "Napl√°nov√°no: " + grouped[date].join(", ");
    }
  });
}

/* Spou≈°tƒõt po zobrazen√≠ kalend√°≈ôe */
document.addEventListener("click", e => {
  if (e.target.closest("#planBtn")) {
    setTimeout(addTooltipToCalendar, 1500);
  }
});

/* ============================================= */
/* üì±  MOBILN√ç OPTIMALIZACE MODAL≈Æ A MAP        */
/* ============================================= */

function adjustLayoutForMobile() {
  const isMobile = window.innerWidth < 768;
  const modals = document.querySelectorAll(".modal-content");
  modals.forEach(m => {
    m.style.maxHeight = isMobile ? "88vh" : "90vh";
    m.style.width = isMobile ? "94%" : "900px";
    m.style.padding = isMobile ? "15px" : "20px";
  });
  const mapBoxes = document.querySelectorAll(".map-box, #planMap");
  mapBoxes.forEach(box => {
    box.style.height = isMobile ? "250px" : "400px";
  });
}

/* Spou≈°tƒõt p≈ôi zmƒõnƒõ velikosti */
window.addEventListener("resize", adjustLayoutForMobile);
window.addEventListener("orientationchange", adjustLayoutForMobile);
window.addEventListener("load", adjustLayoutForMobile);

/* ============================================= */
/* üé®  DODATEƒåN√â UX DETAILY                     */
/* ============================================= */

document.addEventListener("mouseover", e => {
  if (e.target.tagName === "TR" && e.target.closest("#tableBody")) {
    e.target.style.background = "#f3f4f8";
  }
});
document.addEventListener("mouseout", e => {
  if (e.target.tagName === "TR" && e.target.closest("#tableBody")) {
    e.target.style.background = "";
  }
});
/* ============================================= */
/* üéØ  AUTO-SCROLL NA AKTIVN√ç ≈ò√ÅDEK             */
/* ============================================= */

function scrollToSelected(item) {
  const rows = document.querySelectorAll("#tableBody tr");
  for (const row of rows) {
    if (row.cells[1]?.textContent === item.jmeno) {
      row.scrollIntoView({ behavior: "smooth", block: "center" });
      row.style.outline = "2px solid #004a99";
      setTimeout(() => row.style.outline = "none", 2500);
      break;
    }
  }
}

/* ============================================= */
/* üïì  KONTROLA P≈òEKRYV≈Æ TERM√çN≈Æ                */
/* ============================================= */

function checkTermConflicts() {
  const conflicts = {};
  reklamacniData.forEach(r => {
    if (r.termin) {
      const t = r.termin.split("T")[0];
      if (!conflicts[t]) conflicts[t] = 0;
      conflicts[t]++;
    }
  });
  const tooMany = Object.entries(conflicts).filter(([_, count]) => count > 5);
  if (tooMany.length > 0) {
    console.warn("‚ö†Ô∏è Dny s vysok√Ωm poƒçtem term√≠n≈Ø:", tooMany);
  }
}

/* ============================================= */
/* üß≠  TOOLTIP PRO PL√ÅN DNE                     */
/* ============================================= */

function showPlanSummaryTooltip(date, coords) {
  if (!coords || coords.length === 0) return;
  if (coords.length < 2) {
    L.popup()
      .setLatLng(coords[0])
      .setContent("Pouze jedna adresa tento den")
      .openOn(planMap);
    return;
  }

  fetch(`https://router.project-osrm.org/route/v1/driving/${coords.map(c => c.join(",")).join(";")}?overview=false&steps=false`)
    .then(r => r.json())
    .then(d => {
      const km = (d.routes[0].distance / 1000).toFixed(1);
      const time = (d.routes[0].duration / 60).toFixed(0);
      const text = `üöó ${km} km ‚Ä¢ ‚è±Ô∏è ${time} min`;
      L.popup()
        .setLatLng(coords[Math.floor(coords.length / 2)])
        .setContent(text)
        .openOn(planMap);
    })
    .catch(() => {});
}

/* ============================================= */
/* üó∫Ô∏è  VYU≈ΩIT√ç SHRNUUT√ç PO NAPL√ÅNOV√ÅN√ç          */
/* ============================================= */

function addSummaryAfterRouting(coords) {
  if (coords.length > 1) {
    showPlanSummaryTooltip("", coords);
  }
}

/* √öprava funkce showPlanForDay (hook pro summary) */
const _origShowPlanForDay = showPlanForDay;
showPlanForDay = function(dateStr) {
  _origShowPlanForDay(dateStr);
  setTimeout(() => {
    const markers = [];
    planMap.eachLayer(l => {
      if (l instanceof L.Marker) {
        markers.push([l.getLatLng().lat, l.getLatLng().lng]);
      }
    });
    addSummaryAfterRouting(markers);
  }, 2500);
};

/* ============================================= */
/* üîê  O≈†ET≈òEN√ç NEKOMPLETN√çCH DAT               */
/* ============================================= */

function sanitizeData() {
  reklamacniData = reklamacniData.map(r => ({
    jmeno: r.jmeno || "Nezn√°m√Ω z√°kazn√≠k",
    adresa: r.adresa || "Nezad√°no",
    telefon: r.telefon || "",
    email: r.email || "",
    popis: r.popis || "",
    typ: r.typ || "",
    stav: r.stav || "",
    termin: r.termin || ""
  }));
}
/* ============================================= */
/* üåê  OFFLINE / CACHE KONTROLA                  */
/* ============================================= */

function saveCache(data) {
  try {
    localStorage.setItem("reklamaceCache", JSON.stringify(data));
  } catch(e) { console.warn("Cache nelze ulo≈æit:", e); }
}

function loadCache() {
  try {
    const d = localStorage.getItem("reklamaceCache");
    return d ? JSON.parse(d) : [];
  } catch {
    return [];
  }
}

/* P≈ôi selh√°n√≠ naƒçten√≠ pou≈æ√≠t cache */
async function loadData() {
  try {
    const response = await fetch(WORKER_URL);
    if (!response.ok) throw new Error("Nepoda≈ôilo se naƒç√≠st data");
    const csv = await response.text();
    reklamacniData = parseCSV(csv);
    sanitizeData();
    saveCache(reklamacniData);
    renderTable(reklamacniData);
  } catch (err) {
    console.warn("‚ö†Ô∏è Chyba p≈ôi naƒçten√≠ z internetu:", err);
    reklamacniData = loadCache();
    if (reklamacniData.length > 0) {
      renderTable(reklamacniData);
      showBanner("Naƒçteno z cache", "#666");
    } else {
      document.getElementById("tableBody").innerHTML = "<tr><td colspan='6' style='text-align:center;color:#777;'>Bez p≈ôipojen√≠ a bez ulo≈æen√Ωch dat</td></tr>";
    }
  }
}

/* ============================================= */
/* üß≠  KONTROLA DOSTUPNOSTI MAPY                */
/* ============================================= */

function checkMapAvailability() {
  const img = new Image();
  img.src = "https://tile.openstreetmap.org/0/0/0.png";
  img.onload = () => console.log("üó∫Ô∏è Mapa dostupn√°");
  img.onerror = () => showBanner("Mapov√© podklady jsou moment√°lnƒõ nedostupn√©", "#b30000");
}
window.addEventListener("load", checkMapAvailability);

/* ============================================= */
/* ‚è≥  VIZU√ÅLN√ç LOADER                          */
/* ============================================= */

const loader = document.createElement("div");
Object.assign(loader.style, {
  display: "none",
  position: "fixed",
  top: "0", left: "0",
  width: "100%", height: "100%",
  background: "rgba(255,255,255,0.85)",
  zIndex: "99999",
  justifyContent: "center",
  alignItems: "center",
  fontSize: "20px",
  color: "#333",
  fontWeight: "600"
});
loader.textContent = "Naƒç√≠t√°m data‚Ä¶";
document.body.appendChild(loader);

function showLoader() { loader.style.display = "flex"; }
function hideLoader() { loader.style.display = "none"; }

/* Oprava pro loadDataSafe */
const _origLoadDataSafe = loadDataSafe;
loadDataSafe = async function() {
  showLoader();
  try {
    await _origLoadDataSafe();
  } finally {
    hideLoader();
  }
};
/* ============================================= */
/* üß†  WATCHDOG PRO FETCH                       */
/* ============================================= */

setInterval(() => {
  if (fetchInProgress) {
    console.warn("‚è≥ Kontrola: fetch st√°le prob√≠h√° ‚Äì mo≈æn√© zpomalen√≠ s√≠tƒõ");
  }
}, 15000);

/* ============================================= */
/* üß©  FIN√ÅLN√ç ZAJI≈†TƒöN√ç STABILITY              */
/* ============================================= */

function initPage() {
  console.log("üß† Inicializuji kompletn√≠ syst√©m seznamu...");
  try {
    loadDataSafe();
    highlightTodayRows();
    adjustLayoutForMobile();
    checkTermConflicts();
    playNotification();
  } catch (e) {
    console.error("‚ùå Chyba p≈ôi inicializaci:", e);
    showBanner("Chyba p≈ôi inicializaci str√°nky", "#b30000");
  }
}

window.addEventListener("load", initPage);

/* ============================================= */
/* ‚úÖ  √öSPƒö≈†N√â UKONƒåEN√ç                         */
/* ============================================= */

console.log("‚úÖ White Glove Service ‚Äì Seznam reklamac√≠ plnƒõ naƒçten.");

/* ============================================= */
/* üîö  KONEC SCRIPTU                             */
/* ============================================= */
</script>
</body>
</html>
