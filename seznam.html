<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seznam reklamac√≠ ‚Äì White Glove Service</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Vanilla Calendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.8.1/build/vanilla-calendar.min.css">
<script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.8.1/build/vanilla-calendar.min.js"></script>

<!-- PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family:"Inter",system-ui,sans-serif;
  background:#f6f7fb;
  margin:0;
  padding:0;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
}
.wrapper{
  background:#fff;
  padding:25px;
  margin:40px 15px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  width:100%;
  max-width:1200px;
  box-sizing:border-box;
}
h1{text-align:center;font-size:2.2em;font-weight:900;color:#111;margin:0 0 8px;}
h2{text-align:center;font-size:1.1em;font-weight:500;color:#666;margin:0 0 25px;}
.actions{
  display:flex;justify-content:center;flex-wrap:wrap;gap:15px;margin-bottom:25px;
}
.btn{
  text-decoration:none;padding:10px 24px;border-radius:8px;font-weight:600;font-size:1em;
  border:none;cursor:pointer;transition:transform .15s ease,opacity .2s;
  color:#fff;box-shadow:0 3px 8px rgba(0,0,0,.15);min-width:160px;
}
.btn:hover{transform:scale(1.04);opacity:.9;}
.btn-back{background:linear-gradient(135deg,#6c757d,#a0a4a7);}
.btn-refresh{background:linear-gradient(135deg,#b80000,#ff3838);}
.btn-green{background:linear-gradient(135deg,#28a745,#60d06a);}
.btn-plan{background:linear-gradient(135deg,#0046ff,#357aff);}
#search{
  width:100%;padding:10px;margin-bottom:15px;border-radius:6px;border:1px solid #ccc;
  font-size:1em;box-sizing:border-box;
}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{
  padding:10px 8px;border-bottom:1px solid #eee;text-align:center;font-size:.95em;
  white-space:normal;line-height:1.4em;
}
th{background:#f8f8f8;font-weight:700;}
tr:hover{background:#f1f6ff;cursor:pointer;}
/* üîπ Stavy tmav≈°√≠ barvy */
.stav-novy{animation:blikani 1s infinite alternate;background:#ffd600!important;}
.stav-domluveno{background:#3b5bff!important;color:#fff!important;}
.stav-zruseno{background:#d93025!important;color:#fff!important;}
.stav-nezveda{background:#ff9100!important;color:#000!important;}
@keyframes blikani{from{background:#fff176;}to{background:#ffeb3b;}}
@media(max-width:700px){
  table{display:none;}
  .btn{width:100%;min-width:unset;text-align:center;}
}
</style>
</head>
<body>
<div class="wrapper">
  <h1>WHITE GLOVE SERVICE</h1>
  <h2>Seznam reklamac√≠ a servisn√≠ch po≈æadavk≈Ø</h2>

  <div class="actions">
    <a href="index.html" class="btn btn-back">Zpƒõt</a>
    <button id="reloadBtn" class="btn btn-refresh">Naƒç√≠st znovu</button>
    <a href="hotove.html" class="btn btn-green">Hotov√© reklamace</a>
    <button id="planBtn" class="btn btn-plan">Pl√°n dne</button>
  </div>

  <input id="search" placeholder="üîç Hledat podle jm√©na nebo adresy‚Ä¶">
  <div id="tableContainer" class="loading">Naƒç√≠t√°m data‚Ä¶</div>

<script>
const API_URL="https://wgs-token.72nvwf4pb2.workers.dev/orders";
const tableContainer=document.getElementById("tableContainer");
const searchInput=document.getElementById("search");
const reloadBtn=document.getElementById("reloadBtn");
let dataAll=[],lastDataHash="";
let stavy=JSON.parse(localStorage.getItem("stavyReklamaci")||"{}");

/* ‚ö° Naƒçten√≠ s cache a pozad√≠m */
async function loadData(force=false){
  const now=Date.now();
  const cache=JSON.parse(localStorage.getItem("cacheData")||"{}");
  if(!force&&cache.data&&(now-cache.time<60000)){
    dataAll=sortSmart(cache.data);
    renderTable(dataAll);
    refreshDataInBackground();
    return;
  }
  await refreshDataInBackground();
}
async function refreshDataInBackground(){
  try{
    const res=await fetch(API_URL,{mode:"cors",cache:"reload"});
    if(!res.ok)throw new Error("Chyba p≈ôi naƒç√≠t√°n√≠ dat");
    const data=await res.json();
    if(!Array.isArray(data))throw new Error("Neplatn√Ω form√°t dat");
    dataAll=sortSmart(data.reverse());
    localStorage.setItem("cacheData",JSON.stringify({data,time:Date.now()}));
    renderTable(dataAll);
  }catch(err){
    tableContainer.innerHTML=`<div style='color:red'>Chyba: ${err.message}</div>`;
  }
}
setInterval(loadData,120000);
reloadBtn.onclick=()=>loadData(true);
window.addEventListener("DOMContentLoaded",()=>loadData());
<script>
/* üß© Pomocn√© funkce (dostupn√© pro v≈°echny dal≈°√≠ ƒç√°sti) */
function sortSmart(data){
  const today=new Date().toISOString().split("T")[0];
  return data.sort((a,b)=>{
    const sa=(JSON.parse(localStorage.getItem("stavyReklamaci")||"{}")[a.cislo]||"novy");
    const sb=(JSON.parse(localStorage.getItem("stavyReklamaci")||"{}")[b.cislo]||"novy");
    const da=a.datum===today?0:(sa==="zruseno"?2:1);
    const db=b.datum===today?0:(sb==="zruseno"?2:1);
    return da-db;
  });
}
function simplifyAddress(addr){
  if(!addr)return "";
  const prahaMatch=addr.match(/Praha\s*\d+/i);
  if(prahaMatch)return prahaMatch[0];
  if(addr.toLowerCase().includes("bƒõchovice"))return "Praha 9";
  return addr.replace(/\d{3}\s?\d{2}$/,"").trim();
}
function formatNoYear(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(isNaN(d)) return iso; // fallback kdy≈æ p≈ôijde u≈æ form√°tovan√Ω string
  return `${String(d.getDate()).padStart(2,"0")}.${String(d.getMonth()+1).padStart(2,"0")}.`;
}

/* üìã Vykreslen√≠ tabulky ‚Äì stav + datum bez roku pod stavem */
function renderTable(arr){
  if(!arr.length){
    tableContainer.innerHTML="<div class='loading'>≈Ω√°dn√© z√°znamy</div>";
    return;
  }
  let html=`
    <table>
      <thead>
        <tr>
          <th>Z√°kazn√≠k</th>
          <th>Adresa</th>
          <th>Telefon</th>
          <th>Stav</th>
        </tr>
      </thead>
      <tbody>
  `;
  arr.forEach((r,i)=>{
    const id=r.cislo||`radek-${i}`;
    const stav=stavy[id]||"novy";
    const adresa=r.adresa
      ? `<a href="https://waze.com/ul?q=${encodeURIComponent(r.adresa)}" target="_blank">${simplifyAddress(r.adresa)}</a>`
      : "‚Äì";
    const telefon=r.telefon
      ? `<a href="tel:${r.telefon.replace('+420','').trim()}">${r.telefon.replace('+420','').trim()}</a>`
      : "‚Äì";

    // datum+ƒças pod stavem ‚Äì bez roku
    const stavDetail = (stav==="domluveno" && (r.datum||r.cas))
      ? `<div style="font-size:.85em;color:#111;margin-top:2px;">
           ${r.datum?formatNoYear(r.datum):""} ${r.cas||""}
         </div>` : "";

    html+=`
      <tr class="stav-${stav}" data-index="${i}" data-id="${id}">
        <td>${r.zakaznik||"‚Äì"}</td>
        <td>${adresa}</td>
        <td>${telefon}</td>
        <td style="font-weight:600;text-transform:capitalize;">
          ${stav}${stavDetail}
        </td>
      </tr>
    `;
  });
  html+="</tbody></table>";
  tableContainer.innerHTML=html;

  // otev≈ôen√≠ detailu
  document.querySelectorAll("tbody tr").forEach(row=>{
    row.addEventListener("click",()=>openDetail(row.getAttribute("data-index")));
  });
}

/* üîç Vyhled√°v√°n√≠ */
searchInput.addEventListener("input",()=>{
  const q=searchInput.value.trim().toLowerCase();
  if(!q) return renderTable(dataAll);
  const filtered=dataAll.filter(r=>
    (r.zakaznik||"").toLowerCase().includes(q)||
    (r.adresa||"").toLowerCase().includes(q)
  );
  renderTable(filtered);
});
</script>
<script>
/* ============================= */
/* üí¨ DETAIL MODAL SE Z√ÅKAZN√çKEM */
/* ============================= */
const geoCache = JSON.parse(localStorage.getItem("geoCache") || "{}");

function openDetail(index){
  const item=dataAll[index];
  if(!item)return;

  const overlay=document.createElement("div");
  overlay.className="detail-overlay";
  overlay.innerHTML=`
    <div class="detail-modal">
      <div class="detail-content">
        <div class="detail-info">
          <h2>${item.zakaznik||"Z√°kazn√≠k"}</h2>
          <p><strong>Adresa:</strong>
            <a href="https://waze.com/ul?q=${encodeURIComponent(item.adresa||"")}" target="_blank">
              ${item.adresa||"Neuvedeno"}
            </a>
          </p>
          <p><strong>Telefon:</strong>
            <a href="tel:${(item.telefon||"").replace("+420","").trim()}">
              ${(item.telefon||"").replace("+420","").trim()}
            </a>
          </p>
          <p><strong>Email:</strong> ${item.email||"‚Äì"}</p>
          <p><strong>Produkt / model:</strong> ${item.produkt||"‚Äì"}</p>
          <p><strong>Popis z√°vady:</strong> ${item.popis||"‚Äì"}</p>
          <p><strong>Typ:</strong> ${item.typ||"‚Äì"}</p>

          ${item.typ && item.typ.toLowerCase().includes("poz√°ruƒçn√≠") ? "" :
            `<p><strong>Datum prodeje:</strong> ${item.datum_prodeje||"‚Äì"} |
             <strong>Datum reklamace:</strong> ${item.datum_reklamace||"‚Äì"}</p>`}

          ${
            item.fotky&&item.fotky.length?
              `<div class="foto-container">
                ${item.fotky.map(f=>`<img src="foto/${f}" alt="${f}" onclick="showPhoto(this.src)">`).join("")}
              </div>`:
              `<p style="color:#777;">üì∑ ≈Ω√°dn√© p≈ôilo≈æen√© fotografie</p>`
          }

          <div class="btn-row">
            <button id="termBtn" class="btn-action btn-blue">Domluvit term√≠n</button>
            <button id="protoBtn" class="btn-action btn-green">P≈ôej√≠t na protokol</button>
            <button id="closeBtn" class="btn-action btn-red">Zav≈ô√≠t</button>
          </div>

          <div id="termSection" class="term-section">
            <h3>Domluvit / Zmƒõnit term√≠n</h3>
            <div class="term-center">
              <input type="date" id="datumTerminu" class="term-date">
              <div class="custom-time-picker">
                <select id="hours"></select><span>:</span><select id="minutes"></select>
              </div>
            </div>
            <div class="btn-row">
              <button id="saveTermBtn" class="btn-action btn-green">Ulo≈æit term√≠n</button>
              <button id="noAnswerBtn" class="btn-action btn-orange">Nezved√° to</button>
              <button id="cancelBtn" class="btn-action btn-gray">Z√°kazn√≠k zru≈°il</button>
              <button id="backBtn" class="btn-action btn-red">Zpƒõt</button>
            </div>
          </div>
        </div>
        <div class="detail-map">
          <div id="mapDetail"></div>
          <div id="mapDistance" class="map-distance"></div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  setTimeout(()=>overlay.classList.add("active"),10);

  const id=item.cislo||`radek-${index}`;
  const dateInput=overlay.querySelector("#datumTerminu");
  const hoursSel=overlay.querySelector("#hours");
  const minsSel=overlay.querySelector("#minutes");
  for(let h=7;h<20;h++){hoursSel.innerHTML+=`<option value="${String(h).padStart(2,"0")}">${String(h).padStart(2,"0")}</option>`;}
  for(let m=0;m<60;m+=5){minsSel.innerHTML+=`<option value="${String(m).padStart(2,"0")}">${String(m).padStart(2,"0")}</option>`;}

  /* üó∫Ô∏è Mapa z√°kazn√≠ka */
  if(item.adresa){
    const map=L.map(overlay.querySelector("#mapDetail"),{zoomControl:false}).setView([50.05,14.52],9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);
    const wgsMarker=L.marker([50.05,14.52]).addTo(map).bindPopup("<b>WGS Praha 9</b>");

    async function loadCoords(addr){
      if(geoCache[addr]) return geoCache[addr];
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
      const data=await res.json();
      if(data[0]){
        const c=[parseFloat(data[0].lat),parseFloat(data[0].lon)];
        geoCache[addr]=c;
        localStorage.setItem("geoCache",JSON.stringify(geoCache));
        return c;
      }
      return null;
    }
    loadCoords(item.adresa).then(coords=>{
      if(!coords)return;
      const custMarker=L.marker(coords,{title:item.zakaznik||"Z√°kazn√≠k"}).addTo(map)
        .bindPopup(`<b>${item.zakaznik||"Z√°kazn√≠k"}</b><br>${item.adresa}`);
      const g=L.featureGroup([wgsMarker,custMarker]);
      map.fitBounds(g.getBounds().pad(0.3));
      const dist=calcDistanceCoords(50.05,14.52,coords[0],coords[1]);
      overlay.querySelector("#mapDistance").innerHTML=`üìç Vzd√°lenost: <b>${dist.toFixed(1)} km</b>`;
    });
  }

  /* üíæ Offline-first ulo≈æit term√≠n */
  overlay.querySelector("#saveTermBtn").onclick=()=>{
    const datum=dateInput.value;
    const cas=`${hoursSel.value}:${minsSel.value}`;
    if(!datum||!cas)return alert("Vypl≈àte datum i ƒças!");

    stavy[id]="domluveno";
    item.datum=datum; item.cas=cas;
    ulozTermin(item);
    localStorage.setItem("stavyReklamaci",JSON.stringify(stavy));
    closeDetail(); renderTable(dataAll);
  };

  overlay.querySelector("#termBtn").onclick=()=>overlay.querySelector("#termSection").style.display="block";
  overlay.querySelector("#backBtn").onclick=()=>overlay.querySelector("#termSection").style.display="none";
  overlay.querySelector("#protoBtn").onclick=()=>{
    localStorage.setItem("selectedRecord",JSON.stringify(item));
    window.location.href="protokol.html";
  };
  overlay.querySelector("#closeBtn").onclick=closeDetail;

  function closeDetail(){
    overlay.classList.remove("active");
    setTimeout(()=>overlay.remove(),200);
  }
}

/* üìè V√Ωpoƒçet vzd√°lenosti */
function calcDistanceCoords(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* üíæ Offline-first ulozTermin + synchronizace */
async function ulozTermin(item){
  try{
    const res=await fetch("https://dark-darkness-d89a.72nvwf4pb2.workers.dev/sync",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(item)
    });
    if(!res.ok)throw new Error("Offline");
    console.log("‚úÖ Data odesl√°na online");
  }catch(e){
    const pending=JSON.parse(localStorage.getItem("pendingChanges")||"[]");
    pending.push(item);
    localStorage.setItem("pendingChanges",JSON.stringify(pending));
    console.warn("‚ö†Ô∏è Offline, ulo≈æeno lok√°lnƒõ");
  }
}

/* üåê Synchronizace po n√°vratu online */
window.addEventListener("online",syncPendingChanges);
window.addEventListener("DOMContentLoaded",syncPendingChanges);
async function syncPendingChanges(){
  const pending=JSON.parse(localStorage.getItem("pendingChanges")||"[]");
  if(!pending.length)return;
  console.log(`üîÅ Synchronizuji ${pending.length} z√°znam≈Ø`);
  for(const item of pending){
    try{
      const res=await fetch("https://dark-darkness-d89a.72nvwf4pb2.workers.dev/sync",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(item)
      });
      if(res.ok){console.log("‚úÖ Sync:",item.zakaznik||item.cislo);}
      else throw new Error("Chyba");
    }catch(err){
      console.warn("‚ùå Sync fail:",err.message);
      return;
    }
  }
  localStorage.removeItem("pendingChanges");
}
</script>
<style>
/* ============================= */
/* üí¨ DETAIL MODAL STYL          */
/* ============================= */
.detail-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);
  display:flex;justify-content:center;align-items:center;
  opacity:0;transition:opacity .25s ease;z-index:9999;
}
.detail-overlay.active{opacity:1;}
.detail-modal{
  background:#fff;border-radius:16px;width:90%;max-width:950px;
  padding:25px 30px;box-shadow:0 10px 25px rgba(0,0,0,0.3);
  overflow-y:auto;max-height:90vh;animation:fadeIn .3s ease;
}
@keyframes fadeIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.detail-content{display:flex;flex-direction:row;gap:20px;}
.detail-info{flex:1.2;}
.detail-map{flex:1;display:flex;flex-direction:column;gap:10px;}
#mapDetail{
  height:280px;width:100%;border-radius:10px;border:1px solid #ddd;
}
.map-distance{font-size:.95em;text-align:center;color:#333;padding-top:5px;}
.detail-modal h2{text-align:center;font-size:1.6em;font-weight:800;margin:0 0 10px;}
.detail-modal p{font-size:.95em;margin:6px 0;color:#333;}
.detail-modal a{color:#0066ff;text-decoration:none;}
.detail-modal a:hover{text-decoration:underline;}
/* üñºÔ∏è Fotky */
.foto-container{
  display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0;
}
.foto-container img{
  width:120px;height:120px;object-fit:cover;border-radius:8px;cursor:pointer;
  transition:transform .2s ease;box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.foto-container img:hover{transform:scale(1.06);}
/* üéõÔ∏è Sekce term√≠nu */
.term-section{
  display:none;margin-top:25px;padding-top:15px;border-top:1px solid #ddd;
}
.term-section h3{text-align:center;font-size:1.2em;margin-bottom:18px;}
.term-center{
  display:flex;flex-direction:column;align-items:center;gap:18px;
}
.term-date{
  font-size:1.5em;padding:12px 16px;border-radius:10px;border:1px solid #ccc;
  text-align:center;font-weight:600;outline:none;
  transition:border-color .2s,box-shadow .2s;
}
.term-date:focus{
  border-color:#0046ff;box-shadow:0 0 0 2px rgba(0,70,255,.25);
}
.custom-time-picker{
  display:flex;justify-content:center;align-items:center;gap:8px;
}
.custom-time-picker select{
  font-size:1.3em;font-weight:600;border-radius:10px;
  padding:6px 12px;border:1px solid #ccc;outline:none;
}
.custom-time-picker select:focus{
  border-color:#0046ff;box-shadow:0 0 0 2px rgba(0,70,255,.25);
}
/* üß≠ Tlaƒç√≠tka v modalu */
.btn-row{
  display:flex;justify-content:center;align-items:center;
  gap:10px;flex-wrap:wrap;margin-top:20px;
}
.btn-action{
  flex:1;min-width:150px;text-align:center;padding:10px;border:none;
  border-radius:8px;font-weight:600;color:white;cursor:pointer;
  transition:transform .15s ease,opacity .2s ease;
  box-shadow:0 3px 8px rgba(0,0,0,.15);
}
.btn-action:hover{transform:scale(1.05);opacity:.9;}
.btn-blue{background:linear-gradient(135deg,#007bff,#399bff);}
.btn-green{background:linear-gradient(135deg,#28a745,#6fdd72);}
.btn-gray{background:linear-gradient(135deg,#6c757d,#9ca3af);}
.btn-orange{background:linear-gradient(135deg,#ff9800,#ffc270);color:#222;}
.btn-red{background:linear-gradient(135deg,#dc3545,#f87171);}
/* üì± Mobiln√≠ zobrazen√≠ */
@media(max-width:750px){
  .detail-content{flex-direction:column;}
  .detail-modal{width:94%;padding:20px;}
  .btn-row{flex-direction:column;}
  .btn-action{width:100%;font-size:.95em;}
  #mapDetail{height:300px;}
}
/* üß≠ Fix pro Safari / iPhone */
@supports(-webkit-touch-callout:none){
  .detail-overlay{
    top:0;left:0;width:100vw;height:100dvh;
    overflow-y:auto;-webkit-overflow-scrolling:touch;
  }
  .detail-modal{max-height:100dvh;overflow-y:auto;}
  body.modal-open{position:fixed;width:100%;overflow:hidden;}
}
</style>
<style>
/* ‚ú® Pl√°n dne ‚Äì modal */
#planModal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);
  justify-content:center;align-items:center;z-index:99999;
  opacity:0;transition:opacity .25s ease;
}
#planModal.active{display:flex;opacity:1;}
#planModal .modal-inner{
  background:white;border-radius:14px;padding:20px;
  width:95%;max-width:1100px;
  box-shadow:0 10px 25px rgba(0,0,0,.3);
  display:flex;flex-direction:column;gap:20px;
}
#planModal h2{
  text-align:center;font-size:1.4em;font-weight:700;
  margin:5px 0 15px;
}
.plan-content{
  display:grid;grid-template-columns:1fr 1fr;gap:20px;
}
#calendar{
  border:1px solid #ddd;border-radius:10px;overflow:hidden;
}
.vanilla-calendar-day__btn[data-has-plan="true"]{
  background:#357aff!important;color:#fff!important;
  border-radius:6px!important;
}
#map{
  height:450px;border-radius:10px;border:1px solid #ddd;
}
.plan-list{
  max-height:220px;overflow-y:auto;font-size:.95em;
  padding:10px;border:1px solid #ddd;border-radius:10px;
}
.plan-list div{
  margin-bottom:5px;padding:4px 6px;border-bottom:1px solid #eee;
}
.plan-actions{
  display:flex;justify-content:center;gap:15px;
}
.btn-red{
  background:linear-gradient(135deg,#dc3545,#f87171);
  color:#fff;border:none;padding:10px 20px;
  border-radius:8px;cursor:pointer;font-weight:600;
  transition:.2s;
}
.btn-red:hover{opacity:.9;transform:scale(1.05);}

/* üì± Mobiln√≠ rozlo≈æen√≠ */
@media(max-width:750px){
  .plan-content{display:flex;flex-direction:column;align-items:center;}
  #calendar{width:100%;max-width:360px;margin:0 auto;}
  #map{height:320px;width:100%;}
  .plan-list{width:100%;}
}
</style>

<script>
document.getElementById("planBtn").addEventListener("click",showPlanModal);

function showPlanModal(){
  let modal=document.getElementById("planModal");
  if(!modal){
    modal=document.createElement("div");
    modal.id="planModal";
    modal.innerHTML=`
      <div class="modal-inner">
        <h2>üìÖ Pl√°n dne</h2>
        <div class="plan-content">
          <div>
            <div id="calendar"></div>
            <div class="plan-list" id="planList">Vyberte den v kalend√°≈ôi‚Ä¶</div>
          </div>
          <div id="map"></div>
        </div>
        <div class="plan-actions">
          <button class="btn-red" onclick="closePlanModal()">Zav≈ô√≠t</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
  modal.classList.add("active");
  disableBodyScroll();

  const calendarElem=document.getElementById("calendar");
  const planList=document.getElementById("planList");
  const terminy=JSON.parse(localStorage.getItem("terminyReklamaci")||"[]");

  // üîµ Zv√Ωrazni dny, kter√© maj√≠ pl√°n
  const daysWithPlan=new Set(terminy.map(t=>t.datum));

  const calendar=new VanillaCalendar(calendarElem,{
    settings:{lang:"cs"},
    actions:{
      clickDay(e,day){
        const datum=day.date;
        const vybrane=terminy.filter(t=>t.datum===datum);
        if(!vybrane.length){
          planList.innerHTML="üì≠ ≈Ω√°dn√© n√°v≈°tƒõvy pro tento den.";
          showPlanMap([]);
          return;
        }
        planList.innerHTML=vybrane.map(t=>
          `<div><b>${t.cas}</b> ‚Äì ${t.zakaznik||""}, ${t.adresa||""}</div>`
        ).join("");
        showPlanMap(vybrane);
      }
    }
  });

  // po inicializaci oznaƒçit dny
  calendar.init();
  setTimeout(()=>{
    document.querySelectorAll(".vanilla-calendar-day__btn").forEach(btn=>{
      const d=btn.dataset.calendarDay;
      if(daysWithPlan.has(d)) btn.setAttribute("data-has-plan","true");
    });
  },300);
}

/* üó∫Ô∏è Mapa pro pl√°n dne */
function showPlanMap(zaznamy){
  const mapElem=document.getElementById("map");
  mapElem.innerHTML=""; // reset mapy
  const map=L.map(mapElem,{zoomControl:true}).setView([49.8,15.4],7);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(map);

  if(!zaznamy.length) return;

  zaznamy.forEach(z=>{
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(z.adresa)}`)
      .then(res=>res.json())
      .then(data=>{
        if(data[0]){
          const coords=[parseFloat(data[0].lat),parseFloat(data[0].lon)];
          L.marker(coords).addTo(map)
            .bindPopup(`<b>${z.zakaznik||""}</b><br>${z.adresa||""}<br>${z.cas||""}`);
        }
      });
  });
}

function closePlanModal(){
  const modal=document.getElementById("planModal");
  if(modal){
    modal.classList.remove("active");
    setTimeout(()=>modal.remove(),300);
    enableBodyScroll();
  }
}
</script>
<script>
/* üöÄ Rychl√© naƒç√≠t√°n√≠ s fallbackem na localStorage */
async function loadDataFast(){
  const cached=localStorage.getItem("cachedOrders");
  if(cached){
    try{
      const parsed=JSON.parse(cached);
      if(Array.isArray(parsed)&&parsed.length>0){
        console.log("‚ö° Naƒçteno z cache");
        dataAll=sortSmart(parsed);
        renderTable(dataAll);
      }
    }catch(e){}
  }
  try{
    const res=await fetch(API_URL,{mode:"cors",cache:"no-store"});
    if(!res.ok)throw new Error("Chyba p≈ôi naƒç√≠t√°n√≠ dat");
    const fresh=await res.json();
    if(Array.isArray(fresh)){
      localStorage.setItem("cachedOrders",JSON.stringify(fresh));
      dataAll=sortSmart(fresh.reverse());
      renderTable(dataAll);
      console.log("‚úÖ Naƒçteno online");
    }
  }catch(err){
    console.warn("‚ö†Ô∏è Offline re≈æim ‚Äì pou≈æ√≠v√°m cache",err.message);
    if(!cached)tableContainer.innerHTML="<div style='color:red;'>≈Ω√°dn√© ulo≈æen√© z√°znamy</div>";
  }
}

/* üåç P≈ôednaƒçten√≠ mapov√Ωch dla≈ædic pro rychlej≈°√≠ start */
(function preloadTiles(){
  const imgs=[];
  for(let i=0;i<3;i++){
    const img=new Image();
    img.src=`https://a.tile.openstreetmap.org/8/${134+i}/${84+i}.png`;
    imgs.push(img);
  }
})();

/* üß† Automatick√° synchronizace term√≠n≈Ø */
window.addEventListener("online",()=>{
  console.log("üîÅ Online ‚Äì obnovuji data");
  loadDataFast();
  syncPendingChanges();
});
window.addEventListener("DOMContentLoaded",()=>{
  loadDataFast();
  syncPendingChanges();
});

/* üéß Zvuk p≈ôi nov√Ωch z√°znamech */
function playNotification(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type="sine";osc.frequency.value=880;
    gain.gain.value=0.08;
    osc.start();osc.stop(ctx.currentTime+0.3);
  }catch(e){}
}

/* ‚è≥ Intervalov√© obnoven√≠ */
setInterval(loadDataFast,120000);
</script>
