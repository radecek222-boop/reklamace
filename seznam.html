<!-- üü® ZAƒå√ÅTEK ƒå√ÅSTI 3/10 (Detail z√°kazn√≠ka ‚Äì stabiln√≠ verze se vzd√°lenost√≠ a p≈ôechodem na ƒças) -->
<script>
function openDetail(index) {
  const item = dataAll[index];
  if (!item) return;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  const adresaUpravena = normalizePrahaAddress(item.adresa || "");

  overlay.innerHTML = `
    <div class="detail-modal">
      <div class="grid-layout">
        <!-- üß© Lev√Ω horn√≠ blok ‚Äì detail z√°kazn√≠ka -->
        <div class="left-top">
          <h2>${item.zakaznik || "Z√°kazn√≠k"}</h2>
          <p><strong>Adresa:</strong>
            <a href="https://waze.com/ul?q=${encodeURIComponent(adresaUpravena)}" target="_blank">${adresaUpravena || "Neuvedeno"}</a>
          </p>
          <p><strong>Telefon:</strong>
            <a href="tel:${(item.telefon || "").replace("+420","").trim()}">${(item.telefon || "").replace("+420","").trim()}</a>
          </p>
          <p><strong>Email:</strong> ${item.email || "‚Äì"}</p>
          <p><strong>Produkt / model:</strong> ${item.produkt || "‚Äì"}</p>
          <p><strong>Popis z√°vady:</strong> ${item.popis || "‚Äì"}</p>
          <p><strong>Typ:</strong> ${item.typ || "‚Äì"}</p>

          ${
            item.typ && item.typ.toLowerCase().includes("poz√°ruƒçn√≠")
              ? ""
              : `<p><strong>Datum prodeje:</strong> ${item.datum_prodeje || "‚Äì"} | <strong>Datum reklamace:</strong> ${item.datum_reklamace || "‚Äì"}</p>`
          }

          ${
            item.fotky && item.fotky.length
              ? `<div class="foto-container">
                  ${item.fotky.map(f => `<img src="foto/${f}" alt="${f}" onclick="showPhoto(this.src)" />`).join("")}
                 </div>`
              : `<p style="color:#777;">üì∑ ≈Ω√°dn√© p≈ôilo≈æen√© fotografie</p>`
          }

          <div class="btn-row">
            <button id="termBtn" class="btn-action btn-blue">Domluvit term√≠n</button>
            <button id="protoBtn" class="btn-action btn-green">P≈ôej√≠t na protokol</button>
            <button id="closeBtn" class="btn-action btn-red">Zav≈ô√≠t</button>
          </div>
        </div>

        <!-- üó∫Ô∏è Prav√Ω horn√≠ blok ‚Äì mapa -->
        <div class="right-top">
          <div id="mapDetail"></div>
          <div id="mapDistance" class="map-distance">üìç Naƒç√≠t√°m trasu...</div>
        </div>

        <!-- üìÖ Lev√Ω doln√≠ blok ‚Äì kalend√°≈ô -->
        <div class="left-bottom" id="calendarBox">
          <div id="miniCalendar"></div>
        </div>

        <!-- ‚è∞ Prav√Ω doln√≠ blok ‚Äì ƒças + tlaƒç√≠tka -->
        <div class="right-bottom">
          <div class="time-box">
            <div class="custom-time-picker">
              <select id="hours"></select><span>:</span><select id="minutes"></select>
            </div>
            <div class="btn-row time-btns">
              <button id="saveTermBtn" class="btn-action btn-green">Ulo≈æit / Zmƒõnit</button>
              <button id="noAnswerBtn" class="btn-action btn-orange">Nezved√° (SMS)</button>
              <button id="cancelBtn" class="btn-action btn-gray">Z√°kazn√≠k zru≈°il</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(overlay);
  setTimeout(() => overlay.classList.add("active"), 10);

  const id = item.cislo || `radek-${index}`;
  const hoursSel = overlay.querySelector("#hours");
  const minsSel  = overlay.querySelector("#minutes");
  for (let h = 7; h < 20; h++) hoursSel.innerHTML += `<option>${String(h).padStart(2,"0")}</option>`;
  for (let m = 0; m < 60; m += 5) minsSel.innerHTML += `<option>${String(m).padStart(2,"0")}</option>`;

  // üóìÔ∏è Mini kalend√°≈ô (po kliknut√≠ zobraz√≠ ƒças)
  const miniCal = new VanillaCalendar("#miniCalendar", {
    settings: { lang: "cs", selection: { day: "single" }, visibility: { theme: "light" } },
    actions: {
      clickDay(event) {
        const chosen = event.target.dataset.calendarDay;
        if (chosen) {
          overlay.dataset.datum = chosen;
          // automaticky odhal√≠ v√Ωbƒõr ƒçasu
          overlay.querySelector(".right-bottom").style.display = "block";
        }
      }
    }
  });
  miniCal.init();

  // üó∫Ô∏è Mapa s trasou WGS ‚ûú z√°kazn√≠k + v√Ωpoƒçet km
  if (item.adresa) {
    const wgsCoords = [50.049, 14.523];
    const map = L.map(overlay.querySelector("#mapDetail")).setView(wgsCoords, 9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OpenStreetMap" }).addTo(map);
    const wgsMarker = L.marker(wgsCoords, { title: "WGS ‚Äì Do Dubƒçe" }).addTo(map);

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.adresa)}`)
      .then(res => res.json())
      .then(data => {
        if (data[0]) {
          const custCoords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
          const custMarker = L.marker(custCoords, { title: "Z√°kazn√≠k" }).addTo(map);
          const group = L.featureGroup([wgsMarker, custMarker]);
          map.fitBounds(group.getBounds().pad(0.3));
          L.polyline([wgsCoords, custCoords], { color: "#0046ff", weight: 3, opacity: 0.8 }).addTo(map);

          const distanceKm = calcDistanceCoords(
            wgsCoords[0], wgsCoords[1],
            custCoords[0], custCoords[1]
          );
          overlay.querySelector("#mapDistance").innerHTML =
            `üìç Trasa: WGS ‚Üí ${item.zakaznik || "Z√°kazn√≠k"} ‚Äì ${distanceKm.toFixed(1)} km`;
        }
      });
  }

  // üìè V√Ωpoƒçet vzd√°lenosti mezi sou≈ôadnicemi
  function calcDistanceCoords(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  // üß≠ Zobrazen√≠ kalend√°≈ôe + hodin a≈æ po kliknut√≠
  overlay.querySelector("#termBtn").onclick = () => {
    overlay.querySelector(".left-bottom").style.display = "block";
    overlay.querySelector("#termBtn").disabled = true;
  };

  // üßæ P≈ôechod na protokol
  overlay.querySelector("#protoBtn").onclick = () => {
    localStorage.setItem("selectedRecord", JSON.stringify(item));
    window.location.href = "protokol.html";
  };

  // üîö Zav≈ô√≠t
  overlay.querySelector("#closeBtn").onclick = () => {
    overlay.classList.remove("active");
    setTimeout(() => overlay.remove(), 200);
  };
}
</script>
<!-- üü® KONEC ƒå√ÅSTI 3/10 -->
