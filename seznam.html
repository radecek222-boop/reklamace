<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Seznam reklamac√≠ ‚Äì White Glove Service</title>
<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}
.wrapper {
  background: #fff;
  padding: 25px;
  margin: 40px 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 1000px;
  box-sizing: border-box;
}
h1 {
  text-align: center;
  font-size: 2.2em;
  font-weight: 900;
  color: #111;
  margin: 0 0 8px;
}
h2 {
  text-align: center;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  margin: 0 0 25px;
}

.actions {
  text-align: center;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
}
.btn {
  display: inline-block;
  text-decoration: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1em;
  border: none;
  cursor: pointer;
  transition: transform 0.15s ease-in-out, opacity 0.2s;
  color: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  min-width: 140px;
  text-align: center;
}
.btn:hover { transform: scale(1.04); opacity: 0.9; }
.btn-back { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
.btn-refresh { background: linear-gradient(135deg, #0046ff, #357aff); }
.btn-green { background: linear-gradient(135deg, #28a745, #5bd85b); }
.btn-gray { background: linear-gradient(135deg, #6c757d, #9ca3af); }
.btn-blue { background: linear-gradient(135deg, #007bff, #4da3ff); }
.btn-orange { background: linear-gradient(135deg, #ff9800, #ffb74d); color: #222; }
.btn-red { background: linear-gradient(135deg, #dc3545, #f87171); }

#search {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
}

/* Tabulka 4 sloupce */
table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
th { background: #f8f8f8; font-weight: 700; }
tr:hover { background: #f1f6ff; cursor: pointer; }

/* Modal */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.55);
  display: none; justify-content: center; align-items: center; z-index: 9999;
}
.modal {
  background: #fff; border-radius: 12px; padding: 25px;
  width: 90%; max-width: 850px; max-height: 85vh;
  overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  animation: fadeIn 0.25s ease;
}
@keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }

/* Rolovac√≠ ƒças */
.custom-time { display: flex; align-items: center; gap: 10px; justify-content: center; margin-top: 8px; }
.custom-time select {
  font-size: 1.6em; font-weight: 700;
  border: 1px solid #ccc; border-radius: 10px;
  padding: 8px 14px; background: #fff;
  appearance: none; -webkit-appearance: none;
  text-align: center;
}
.custom-time span { font-size: 1.6em; font-weight: 600; }

/* Fotky */
.thumbs { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.thumb-img {
  width: 90px; height: 90px; object-fit: cover;
  border-radius: 8px; cursor: pointer; transition: transform 0.15s;
}
.thumb-img:hover { transform: scale(1.05); }

.fullscreen {
  position: fixed; inset: 0; background: rgba(0,0,0,0.9);
  display: flex; justify-content: center; align-items: center;
  z-index: 10000;
}
.fullscreen img { max-width: 92%; max-height: 88%; border-radius: 10px; }
.nav-btn {
  position: absolute; top: 50%; transform: translateY(-50%);
  font-size: 2.2em; color: #fff; background: transparent; border: none; cursor: pointer;
}
.nav-btn.left { left: 30px; } .nav-btn.right { right: 30px; }
.close-full { position: absolute; top: 14px; right: 20px; font-size: 2em; color: #fff; background: none; border: none; cursor: pointer; }

/* Blik√°n√≠ dne≈°n√≠ch term√≠n≈Ø */
@keyframes blinkRed { 0%{background:#ffe0e0;} 50%{background:#ffb3b3;} 100%{background:#ffe0e0;} }
.blink-today { animation: blinkRed 1.2s infinite; }

/* Mobil: zobraz√≠ jen 4 sloupce */
@media (max-width: 700px) {
  table, thead, tbody, th, td, tr { display: block; }
  thead { display: none; }
  tr {
    background: #fff; margin-bottom: 12px; border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08); padding: 10px;
  }
  td {
    display: flex; justify-content: space-between;
    border: none; padding: 5px 0; font-size: 0.9em;
  }
  td::before { content: attr(data-label); font-weight: 600; color: #444; }
}
</style>
</head>

<body>
  <div class="wrapper">
    <h1>WHITE GLOVE SERVICE</h1>
    <h2>Seznam reklamac√≠ a servisn√≠ch po≈æadavk≈Ø</h2>

    <div class="actions">
      <a href="index.html" class="btn btn-back">Zpƒõt</a>
      <button id="reloadBtn" class="btn btn-refresh">Naƒç√≠st znovu</button>
    </div>

    <input id="search" type="text" placeholder="üîç Hledat z√°kazn√≠ka, adresu nebo telefon...">
    <div id="tableContainer" class="loading">Naƒç√≠t√°m data...</div>
  </div>

<script>
const API_URL = "https://wgs-token.72nvwf4pb2.workers.dev/orders";
let dataAll = [];
let stavy = JSON.parse(localStorage.getItem("stavyReklamaci") || "{}");

const tableContainer = document.getElementById("tableContainer");
const searchInput = document.getElementById("search");
const reloadBtn = document.getElementById("reloadBtn");

const todayStr = () => new Date().toISOString().split("T")[0];
const pad = n => String(n).padStart(2,"0");

function buildStatusText(s) {
  if (!s || !s.stav) return "Nov√Ω";
  switch (s.stav) {
    case "domluveno": return `Domluveno${s.datum ? " ‚Äì " + s.datum : ""}`;
    case "nezveda": return "Nezved√°";
    case "zruseno": return "Zru≈°eno";
    default: return "Nov√Ω";
  }
}
function saveStavy() {
  localStorage.setItem("stavyReklamaci", JSON.stringify(stavy));
}

async function loadData() {
  tableContainer.innerHTML = "<div class='loading'>Naƒç√≠t√°m data‚Ä¶</div>";
  try {
    const r = await fetch(API_URL);
    if (!r.ok) throw new Error("Chyba p≈ôi naƒç√≠t√°n√≠");
    const data = await r.json();
    dataAll = Array.isArray(data) ? data.reverse() : [];
    renderTable(dataAll);
  } catch (e) {
    tableContainer.innerHTML = `<div class='loading' style="color:red;">${e.message}</div>`;
  }
}

function renderTable(arr) {
  if (!arr.length) {
    tableContainer.innerHTML = "<div class='loading'>≈Ω√°dn√© z√°znamy</div>";
    return;
  }
  let html = `
    <table><thead><tr><th>#</th><th>Z√°kazn√≠k</th><th>Adresa</th><th>Telefon</th><th>Stav</th></tr></thead><tbody>
  `;
  arr.forEach((r,i)=>{
    const id = r.cislo || `radek-${i}`;
    const state = stavy[id] || { stav:"novy" };
    const isToday = state.stav==="domluveno" && state.datum===todayStr();
    html += `
      <tr data-index="${i}" class="${isToday?"blink-today":""}">
        <td data-label="#">${i+1}</td>
        <td data-label="Z√°kazn√≠k">${r.zakaznik||""}</td>
        <td data-label="Adresa">${r.adresa||""}</td>
        <td data-label="Telefon"><a href="tel:${r.telefon||""}">${r.telefon||""}</a></td>
        <td data-label="Stav">${buildStatusText(state)}</td>
      </tr>
    `;
  });
  html += "</tbody></table>";
  tableContainer.innerHTML = html;

  document.querySelectorAll("tbody tr").forEach(tr=>{
    tr.addEventListener("click",()=>openDetail(tr.dataset.index));
  });
}

function openDetail(index){
  const r = dataAll[index];
  const id = r.cislo || `radek-${index}`;
  const state = stavy[id] || { stav:"novy" };

  const overlay = document.createElement("div");
  overlay.className="modal-overlay"; overlay.style.display="flex";

  let thumbs = "";
  if(Array.isArray(r.foto)&&r.foto.length){
    thumbs = `<div class="thumbs">`+r.foto.map((src,i)=>`<img src="${src}" class="thumb-img" onclick="openFullscreen(${index},${i})">`).join("")+`</div>`;
  } else thumbs="<div style='color:#777'>(bez fotek)</div>";

  overlay.innerHTML=`
  <div class="modal">
    <h2 style="text-align:center;margin-top:0">${r.zakaznik||"Z√°znam"}</h2>
    <p><strong>Adresa:</strong> ${r.adresa||"-"}</p>
    <p><strong>Telefon:</strong> <a href="tel:${r.telefon||""}">${r.telefon||"-"}</a></p>
    <p><strong>Popis:</strong> ${r.popis||"-"}</p>
    <p><strong>Typ:</strong> ${r.typ||"-"}</p>
    <p><strong>Zadavatel:</strong> ${r.contract||(r.jinaZadavatel?.jmeno||"-")}</p>
    <p><strong>Stav:</strong> ${buildStatusText(state)}</p>
    <strong>Fotky:</strong>${thumbs}

    <div class="btn-row">
      <button id="termBtn" class="btn btn-blue">üîµ Domluvit term√≠n</button>
      <button id="protoBtn" class="btn btn-green">üü¢ P≈ôej√≠t na protokol</button>
      <button id="closeBtn" class="btn btn-gray">‚úñ Zav≈ô√≠t</button>
    </div>

    <div id="termSection" style="display:none;margin-top:20px;">
      <p style="text-align:center;font-weight:600;">Zadej term√≠n n√°v≈°tƒõvy:</p>
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
        <input type="date" id="datumInput" value="${state.datum||""}" style="font-size:1.3em;padding:6px 10px;border-radius:8px;border:1px solid #ccc;">
        <div class="custom-time" id="timePicker"></div>
      </div>
      <div class="btn-row" style="margin-top:15px;">
        <button id="saveBtn" class="btn btn-green">üü¢ Ulo≈æit term√≠n</button>
        <button id="noBtn" class="btn btn-orange">üü† Z√°kazn√≠k nezved√°</button>
        <button id="cancelBtn" class="btn btn-red">üî¥ Z√°kazn√≠k zru≈°il</button>
        <button id="backBtn" class="btn btn-gray">‚Ü© Zpƒõt</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(overlay);

  // po kliknut√≠ na datum - zav≈ôe kalend√°≈ô
  const dateInput = overlay.querySelector("#datumInput");
  dateInput.addEventListener("change",()=>dateInput.blur());

  // rolovac√≠ hodiny
  const tp = overlay.querySelector("#timePicker");
  const selH=document.createElement("select"), selM=document.createElement("select");
  for(let h=0;h<24;h++) selH.innerHTML+=`<option value="${pad(h)}">${pad(h)}</option>`;
  for(let m=0;m<60;m+=5) selM.innerHTML+=`<option value="${pad(m)}">${pad(m)}</option>`;
  tp.appendChild(selH); tp.appendChild(document.createElement("span")).textContent=":"; tp.appendChild(selM);
  if(state.cas){const [hh,mm]=state.cas.split(":");selH.value=hh;selM.value=mm;}

  overlay.querySelector("#termBtn").onclick=()=>overlay.querySelector("#termSection").style.display="block";
  overlay.querySelector("#backBtn").onclick=()=>overlay.querySelector("#termSection").style.display="none";
  overlay.querySelector("#closeBtn").onclick=()=>overlay.remove();
  overlay.querySelector("#protoBtn").onclick=()=>{localStorage.setItem("selectedRecord",JSON.stringify(r));window.location.href="protokol.html";};

  overlay.querySelector("#saveBtn").onclick=()=>{
    const d=dateInput.value,t=`${selH.value}:${selM.value}`;
    if(!d){alert("Vyber datum");return;}
    stavy[id]={stav:"domluveno",datum:d,cas:t};saveStavy();overlay.remove();renderTable(dataAll);
  };
  overlay.querySelector("#noBtn").onclick=()=>{stavy[id]={stav:"nezveda"};saveStavy();overlay.remove();renderTable(dataAll);};
  overlay.querySelector("#cancelBtn").onclick=()=>{stavy[id]={stav:"zruseno"};saveStavy();overlay.remove();renderTable(dataAll);};
}

function openFullscreen(index,i=0){
  const r=dataAll[index];if(!r?.foto?.length)return;
  let current=i;
  const fs=document.createElement("div");
  fs.className="fullscreen";
  fs.innerHTML=`
    <button class="close-full">‚úñ</button>
    <button class="nav-btn left">‚ùÆ</button>
    <img src="${r.foto[current]}" alt="foto">
    <button class="nav-btn right">‚ùØ</button>`;
  document.body.appendChild(fs);
  const img=fs.querySelector("img");
  const show=(n)=>{current=(n+r.foto.length)%r.foto.length;img.src=r.foto[current];};
  fs.querySelector(".left").onclick=(e)=>{e.stopPropagation();show(current-1);};
  fs.querySelector(".right").onclick=(e)=>{e.stopPropagation();show(current+1);};
  fs.querySelector(".close-full").onclick=()=>fs.remove();
  fs.onclick=(e)=>{if(e.target===fs)fs.remove();};
}

searchInput.addEventListener("input",()=>{
  const q=searchInput.value.trim().toLowerCase();
  if(!q)return renderTable(dataAll);
  const f=dataAll.filter(r=>
    (r.zakaznik||"").toLowerCase().includes(q)||
    (r.adresa||"").toLowerCase().includes(q)||
    (r.telefon||"").toLowerCase().includes(q));
  renderTable(f);
});
reloadBtn.addEventListener("click",loadData);
window.addEventListener("DOMContentLoaded",loadData);
</script>
</body>
</html>
