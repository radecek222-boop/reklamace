<!doctype html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WHITE GLOVE SERVICE ‚Äì Seznam reklamac√≠</title>
<style>
:root {
  font-family: "Inter", system-ui, Segoe UI, Roboto, Arial, sans-serif;
  color: #111;
}

body {
  margin: 0;
  padding: 20px;
  background: #f6f7fb;
}

h1 {
  text-align: center;
  font-size: 2em;
  font-weight: 900;
  margin: 0 0 10px;
}
h2 {
  text-align: center;
  font-size: 1.1em;
  font-weight: 600;
  color: #555;
  margin: 0 0 25px;
}

.btn-gradient {
  display: inline-block;
  text-decoration: none;
  padding: 10px 22px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1em;
  color: #fff;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  transition: transform 0.15s ease-in-out, opacity 0.2s;
  margin: 4px;
}
.btn-gradient:hover { transform: scale(1.04); opacity: 0.9; }
.btn-green { background: linear-gradient(135deg,#00b36b,#3cd67a); }
.btn-gray { background: linear-gradient(135deg,#6c757d,#a0a4a7); }
.btn-blue { background: linear-gradient(135deg,#0046ff,#357aff); }

.top-actions {
  text-align: center;
  margin-bottom: 20px;
}
.searchbox {
  width: 100%;
  max-width: 400px;
  margin: 0 auto 20px;
  display: block;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 1em;
  background: #fff;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 8px;
  overflow: hidden;
}
th, td {
  padding: 10px 12px;
  text-align: left;
  border-bottom: 1px solid #ddd;
  font-size: 0.95em;
}
th { background: #eee; font-weight: 700; }
tr:hover { background: #f1f3f5; cursor: pointer; }

@media (max-width: 768px){
  th:nth-child(n+5), td:nth-child(n+5){display:none;}
}

/* --- stavov√© barvy ≈ô√°dk≈Ø --- */
tr.new { animation: blinkYellow 1.2s infinite; }
@keyframes blinkYellow {
  0%, 100% { background: #fff7c2; }
  50% { background: #ffe86b; }
}
tr.calling { background: linear-gradient(90deg,#ffb347,#ffcc33); color:#000; }
tr.waiting { background: linear-gradient(90deg,#88b5ff,#c8e3ff); color:#000; }
tr.done { background: linear-gradient(90deg,#00b36b,#3cd67a); color:#fff; }

/* --- Detailn√≠ modal --- */
#detailModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  padding: 15px;
  z-index: 1000;
}
#detailContent {
  background: white;
  border-radius: 12px;
  padding: 20px;
  width: 100%;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
#detailButtons {
  text-align: center;
  margin-top: 15px;
}
#detailButtons button {
  margin: 5px;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: #fff;
  font-weight: 600;
  transition: transform 0.15s ease, opacity 0.2s;
}
#detailButtons button:hover { transform: scale(1.05); opacity: 0.9; }
.btn-close { background: linear-gradient(135deg,#6c757d,#a0a4a7); }
.btn-done { background: linear-gradient(135deg,#00b36b,#3cd67a); }
.btn-wait { background: linear-gradient(135deg,#0046ff,#357aff); }
.btn-call { background: linear-gradient(135deg,#ff9800,#ffb347); }

.photo-gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 10px;
}
.photo-gallery img {
  max-width: 100px;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.photo-gallery img:hover { transform: scale(1.1); }

/* --- fullscreen zobrazen√≠ fotky --- */
#photoView {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 1100;
}
#photoView img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
}
</style>
</head>

<body>
  <h1>WHITE GLOVE SERVICE</h1>
  <h2>Seznam reklamac√≠ a servisn√≠ch po≈æadavk≈Ø</h2>

  <div class="top-actions">
    <a href="index.html" class="btn-gradient btn-gray">Zpƒõt na hlavn√≠ str√°nku</a>
    <a href="hotove.html" class="btn-gradient btn-green">Hotov√© reklamace</a>
    <button onclick="loadData()" class="btn-gradient btn-blue">Naƒç√≠st znovu</button>
  </div>

  <input type="text" id="searchInput" class="searchbox" placeholder="Hledat podle jm√©na, adresy nebo telefonu...">

  <table id="dataTable">
    <thead>
      <tr>
        <th>Jm√©no</th>
        <th>Adresa</th>
        <th>Telefon</th>
        <th>Stav</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="4" style="text-align:center;padding:20px;">Naƒç√≠t√°n√≠ dat...</td></tr>
    </tbody>
  </table>

  <!-- detail -->
  <div id="detailModal">
    <div id="detailContent">
      <h3 id="detailName" style="margin-top:0;"></h3>
      <div id="detailInfo"></div>
      <div class="photo-gallery" id="photoGallery"></div>
      <div id="detailButtons">
        <button id="callBtn" class="btn-call">üìû Zavolat</button>
        <button id="wazeBtn" class="btn-wait">üó∫Ô∏è Otev≈ô√≠t ve Waze</button>
        <button id="protoBtn" class="btn-done">üìÑ Vytvo≈ôit protokol</button>
        <button id="closeDetail" class="btn-close">Zav≈ô√≠t</button>
      </div>
    </div>
  </div>

  <div id="photoView"><img id="photoLarge" src=""></div>
<script>
const API = "https://wis-drafts-api.72nvwf4pb2.workers.dev";
const tableBody = document.getElementById("tableBody");
const searchInput = document.getElementById("searchInput");

async function loadData() {
  tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;">Naƒç√≠t√°n√≠ dat...</td></tr>`;
  try {
    const [ordersRes, afterRes] = await Promise.all([
      fetch(`${API}/orders?${Date.now()}`),
      fetch(`${API}/aftersales?${Date.now()}`)
    ]);

    const orders = await ordersRes.json().catch(()=>[]);
    const aftersales = await afterRes.json().catch(()=>[]);

    // oznaƒç√≠me poz√°ruƒçn√≠ servis
    aftersales.forEach(r => { r.isAfter = true; });

    const all = [...orders, ...aftersales];
    renderTable(all);
  } catch(e) {
    tableBody.innerHTML = `<tr><td colspan="4" style="color:red;text-align:center;">Chyba naƒç√≠t√°n√≠: ${e.message}</td></tr>`;
  }
}

function renderTable(data) {
  tableBody.innerHTML = "";
  const query = searchInput.value.trim().toLowerCase();

  data
    .filter(item => {
      if (!query) return true;
      return (
        (item["Z√°kazn√≠k"] || "").toLowerCase().includes(query) ||
        (item["Adresa"] || "").toLowerCase().includes(query) ||
        (item["Telefon"] || "").toLowerCase().includes(query)
      );
    })
    .forEach(item => {
      const tr = document.createElement("tr");

      // jm√©no s prefixem POZ ‚Äì
      const name = item.isAfter ? `POZ ‚Äì ${item["Z√°kazn√≠k"] || ""}` : (item["Z√°kazn√≠k"] || "");

      // stav barvou
      const stav = item["Stav"] || "Nov√° reklamace";
      if (stav.toLowerCase().includes("hotovo")) tr.classList.add("done");
      else if (stav.toLowerCase().includes("nezved")) tr.classList.add("calling");
      else if (stav.toLowerCase().includes("term√≠n")) tr.classList.add("waiting");
      else tr.classList.add("new");

      // obsah ≈ô√°dku
      tr.innerHTML = `
        <td>${name}</td>
        <td>${item["Adresa"] || ""}</td>
        <td><a href="tel:${item["Telefon"] || ""}" onclick="event.stopPropagation()">${item["Telefon"] || ""}</a></td>
        <td>${stav}</td>
      `;

      tr.addEventListener("click", () => openDetail(item));
      tableBody.appendChild(tr);
    });

  if (!tableBody.innerHTML) {
    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:20px;">≈Ω√°dn√© z√°znamy</td></tr>`;
  }
}

searchInput.addEventListener("input", () => loadData());

// naƒçteme po otev≈ôen√≠
window.addEventListener("DOMContentLoaded", loadData);
</script>
<script>
let currentItem = null;

const modal = document.getElementById("detailModal");
const photoView = document.getElementById("photoView");
const photoLarge = document.getElementById("photoLarge");
const detailName = document.getElementById("detailName");
const detailInfo = document.getElementById("detailInfo");
const photoGallery = document.getElementById("photoGallery");
const closeDetail = document.getElementById("closeDetail");
const callBtn = document.getElementById("callBtn");
const wazeBtn = document.getElementById("wazeBtn");
const protoBtn = document.getElementById("protoBtn");
const markDoneBtn = document.getElementById("markDone");

// otev≈ôen√≠ detailu reklamace
function openDetail(item) {
  currentItem = item;
  modal.style.display = "flex";
  document.body.style.overflow = "hidden";

  const isAfter = item.isAfter ? "POZ ‚Äì " : "";
  detailName.textContent = `${isAfter}${item["Z√°kazn√≠k"] || "Nezn√°m√Ω z√°kazn√≠k"}`;
  
  detailInfo.innerHTML = `
    <p><b>Adresa:</b> ${item["Adresa"] || ""}</p>
    <p><b>Telefon:</b> ${item["Telefon"] || ""}</p>
    <p><b>E-mail:</b> ${item["Email"] || ""}</p>
    <p><b>Popis:</b> ${item["Popis CZ"] || item["Popis"] || ""}</p>
    <p><b>Typ:</b> ${item["Typ"] || (item.isAfter ? "Poz√°ruƒçn√≠ servis" : "Reklamace")}</p>
  `;

  // Fotky
  photoGallery.innerHTML = "";
  Object.keys(item).forEach(k => {
    if (k.startsWith("Foto") && item[k]) {
      const img = document.createElement("img");
      img.src = item[k];
      img.onclick = () => openPhoto(img.src);
      photoGallery.appendChild(img);
    }
  });

  // Akce tlaƒç√≠tek
  callBtn.onclick = () => {
    if (item["Telefon"]) window.location.href = `tel:${item["Telefon"]}`;
  };

  wazeBtn.onclick = () => {
    const adr = encodeURIComponent(item["Adresa"] || "");
    window.open(`https://waze.com/ul?q=${adr}`, "_blank");
  };

  protoBtn.onclick = () => {
    localStorage.setItem("selectedRecord", JSON.stringify(item));
    window.location.href = "protokol.html";
  };

  markDoneBtn.onclick = () => markAsDone(item);
}

closeDetail.onclick = () => closeModal();
modal.addEventListener("click", (e) => {
  if (e.target === modal) closeModal();
});
function closeModal() {
  modal.style.display = "none";
  document.body.style.overflow = "";
}

// fullscreen fotky
function openPhoto(src) {
  photoLarge.src = src;
  photoView.style.display = "flex";
}
photoView.onclick = () => {
  photoView.style.display = "none";
  photoLarge.src = "";
};

// ‚úÖ oznaƒçit jako hotov√©
async function markAsDone(item) {
  if (!confirm("Oznaƒçit tuto reklamaci jako hotovou?")) return;

  try {
    const type = item.isAfter ? "aftersales" : "orders";

    const [dataRes, doneRes] = await Promise.all([
      fetch(`${API}/${type}?${Date.now()}`),
      fetch(`${API}/hotove?${Date.now()}`)
    ]);

    const [data, hotove] = await Promise.all([
      dataRes.json().catch(() => []),
      doneRes.json().catch(() => [])
    ]);

    // Nastaven√≠ stavu a 48h lh≈Øta pro smaz√°n√≠ fotek
    const deleteTime = new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString();
    item["Stav"] = "Hotovo";
    item["Vy≈ôe≈°eno"] = "ANO";
    item["SmazatFotkyPo"] = deleteTime;

    // Odstran√≠me z p≈Øvodn√≠ho souboru a p≈ôid√°me do hotov√Ωch
    const updated = data.filter(r => r["ƒå√≠slo reklamace"] !== item["ƒå√≠slo reklamace"]);
    hotove.push(item);

    // Ulo≈æ√≠me obƒõ zmƒõny
    await Promise.all([
      fetch(`${API}/${type}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated)
      }),
      fetch(`${API}/hotove`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(hotove)
      })
    ]);

    alert("Reklamace oznaƒçena jako hotov√° ‚úÖ\nFotky budou smaz√°ny po 48 hodin√°ch.");
    closeModal();

    // vizu√°ln√≠ potvrzen√≠ v tabulce
    [...document.querySelectorAll("tr")].forEach(tr => {
      if (tr.innerText.includes(item["Z√°kazn√≠k"])) {
        tr.style.background = "linear-gradient(90deg, #c9f7c3, #e1ffe1)";
        setTimeout(() => loadData(), 1500);
      }
    });
  } catch (e) {
    alert("Chyba p≈ôi oznaƒçen√≠ jako hotov√©: " + e.message);
  }
}
</script>
</body>
</html>
