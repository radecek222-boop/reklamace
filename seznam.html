<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seznam reklamacÃ­ â€“ White Glove Service</title>

<!-- Leaflet mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}

.wrapper {
  background: #fff;
  padding: 25px;
  margin: 40px 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 1250px;
  position: relative;
  box-sizing: border-box;
}

h1 {
  text-align: center;
  font-size: 2.2em;
  font-weight: 900;
  color: #111;
  margin: 0 0 8px;
}
h2 {
  text-align: center;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  margin: 0 0 25px;
}

.actions {
  text-align: center;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
}

.btn {
  display: inline-block;
  text-decoration: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1em;
  border: none;
  cursor: pointer;
  transition: transform 0.15s ease-in-out, opacity 0.2s;
  color: white;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  min-width: 160px;
}
.btn:hover { transform: scale(1.04); opacity: 0.9; }

.btn-back { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
.btn-refresh { background: linear-gradient(135deg, #0046ff, #357aff); }
.btn-green { background: linear-gradient(135deg, #28a745, #60d06a); }
.btn-purple { background: linear-gradient(135deg, #6f42c1, #b085f5); }

#search {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
}

/* Tabulka */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  padding: 10px 8px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 0.95em;
  white-space: normal;
  word-break: break-word;
}
th {
  background: #f8f8f8;
  font-weight: 700;
}
tr:hover {
  background: #f1f6ff;
  cursor: pointer;
}

/* Stavy */
.stav-novy { animation: blikani 1s infinite alternate; background: #fffbe6 !important; }
.stav-domluveno { background: #e7f0ff !important; }
.stav-zruseno { background: #ffeaea !important; }
.stav-nezveda { background: #fff4e1 !important; }

@keyframes blikani {
  from { background-color: #fff3c4; }
  to { background-color: #fffbe6; }
}

/* Responsivita */
@media (max-width: 700px) {
  th, td { font-size: 0.8em; padding: 8px 5px; }
  .btn { width: 100%; min-width: unset; }
}
</style>
</head>

<body>
  <div class="wrapper">
    <h1>WHITE GLOVE SERVICE</h1>
    <h2>Seznam reklamacÃ­ a servisnÃ­ch poÅ¾adavkÅ¯</h2>

    <div class="actions">
      <a href="index.html" class="btn btn-back">ZpÄ›t</a>
      <button id="reloadBtn" class="btn btn-refresh">NaÄÃ­st znovu</button>
      <a href="hotove.html" class="btn btn-green">HotovÃ© reklamace</a>
      <button id="planBtn" class="btn btn-purple">ğŸŸ£ PlÃ¡n dne</button>
    </div>

    <input type="text" id="search" placeholder="ğŸ” Hledat podle jmÃ©na, adresy nebo zadavatele...">
    <div id="tableContainer" class="loading">NaÄÃ­tÃ¡m data...</div>
  </div>










<script>
const API_URL = "https://wgs-token.72nvwf4pb2.workers.dev/orders";
const tableContainer = document.getElementById("tableContainer");
const searchInput = document.getElementById("search");
const reloadBtn = document.getElementById("reloadBtn");
const planBtn = document.getElementById("planBtn");
let dataAll = [];
let stavy = JSON.parse(localStorage.getItem("stavyReklamaci") || "{}");

/* ğŸ”¹ PÅ™evod PSÄŒ na Prahu 1â€“10 */
function simplifyAddress(addr) {
  if (!addr) return "";
  let upravena = addr.trim();

  const pscPraha = {
    "1": [11000, 11800, 11900],
    "2": [12000, 12800, 12900],
    "3": [13000, 13900],
    "4": [14000, 14900],
    "5": [15000, 15900],
    "6": [16000, 16900],
    "7": [17000, 17900],
    "8": [18000, 18200, 18300],
    "9": [19000, 19300, 19800],
    "10": [10000, 10900]
  };

  if (addr.toLowerCase().includes("hlavnÃ­ mÄ›sto praha")) {
    const match = addr.match(/\d{3}\s?\d{2}/);
    if (match) {
      const psc = parseInt(match[0].replace(/\s/g, ""));
      for (const [praha, rozsah] of Object.entries(pscPraha)) {
        if (rozsah.some(c => Math.abs(psc - c) < 500)) {
          return "Praha " + praha;
        }
      }
    }
    return "Praha";
  }

  // OdstranÄ›nÃ­ PSÄŒ z ostatnÃ­ch adres
  return addr.replace(/\d{3}\s?\d{2}/, "").trim();
}

/* ğŸ§­ NaÄtenÃ­ dat */
async function loadData() {
  tableContainer.innerHTML = "<div class='loading'>NaÄÃ­tÃ¡m data...</div>";
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ dat");
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("NeplatnÃ½ formÃ¡t dat");
    dataAll = data.reverse();
    renderTable(dataAll);
  } catch (err) {
    console.error(err);
    tableContainer.innerHTML = `<div class='loading' style='color:red;'>âŒ ${err.message}</div>`;
  }
}

/* ğŸª„ VykreslenÃ­ tabulky */
function renderTable(arr) {
  if (!arr.length) {
    tableContainer.innerHTML = "<div class='loading'>Å½Ã¡dnÃ© zÃ¡znamy</div>";
    return;
  }

  let html = `
    <table>
      <thead>
        <tr>
          <th>ZÃ¡kaznÃ­k</th>
          <th>Adresa</th>
          <th>Telefon</th>
          <th>Stav</th>
        </tr>
      </thead>
      <tbody>
  `;

  arr.forEach((r, i) => {
    const id = r.cislo || `radek-${i}`;
    const stav = stavy[id] || "novy";
    const trClass = `stav-${stav}`;

    const adresaZkracena = simplifyAddress(r.adresa);
    const adresa = r.adresa
      ? `<a href="https://waze.com/ul?q=${encodeURIComponent(r.adresa)}" target="_blank">${adresaZkracena}</a>`
      : "";
    const telefon = r.telefon
      ? `<a href="tel:${r.telefon.replace('+420','').trim()}">${r.telefon.replace('+420','').trim()}</a>`
      : "";

    html += `
      <tr class="${trClass}" data-index="${i}" data-id="${id}">
        <td>${r.zakaznik || r["JmÃ©no a pÅ™Ã­jmenÃ­ zÃ¡kaznÃ­ka"] || ""}</td>
        <td>${adresa}</td>
        <td>${telefon}</td>
        <td style="font-weight:600;text-transform:capitalize;">${stav}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  tableContainer.innerHTML = html;

  // ğŸ“² KliknutÃ­ â†’ otevÅ™enÃ­ detailu
  document.querySelectorAll("tbody tr").forEach(row => {
    row.addEventListener("click", () => {
      const index = row.getAttribute("data-index");
      openDetail(index);
    });
  });
}

/* ğŸ” VyhledÃ¡vÃ¡nÃ­ */
searchInput.addEventListener("input", () => {
  const q = searchInput.value.trim().toLowerCase();
  if (!q) return renderTable(dataAll);
  const filtered = dataAll.filter(r =>
    (r.zakaznik || r["JmÃ©no a pÅ™Ã­jmenÃ­ zÃ¡kaznÃ­ka"] || "").toLowerCase().includes(q) ||
    (r.adresa || "").toLowerCase().includes(q) ||
    (r.contract || "").toLowerCase().includes(q)
  );
  renderTable(filtered);
});

/* ğŸ” NaÄtenÃ­ znovu */
reloadBtn.addEventListener("click", loadData);

/* ğŸš€ Po startu */
window.addEventListener("DOMContentLoaded", loadData);
</script>










  <script>
/* ğŸŸ¦ OtevÅ™enÃ­ detailu po kliknutÃ­ na Å™Ã¡dek */
function openDetail(index) {
  const item = dataAll[index];
  if (!item) return;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  overlay.innerHTML = `
    <div class="detail-modal">
      <h2>${item.zakaznik || item["JmÃ©no a pÅ™Ã­jmenÃ­ zÃ¡kaznÃ­ka"] || "ZÃ¡kaznÃ­k"}</h2>

      <p><strong>Adresa:</strong> 
        <a href="https://waze.com/ul?q=${encodeURIComponent(item.adresa || "")}" target="_blank">
          ${item.adresa || "Neuvedeno"}
        </a>
      </p>
      <p><strong>Telefon:</strong> 
        <a href="tel:${(item.telefon || "").replace("+420","").trim()}">
          ${(item.telefon || "").replace("+420","").trim()}
        </a>
      </p>
      <p><strong>Email:</strong> ${item.email || "â€“"}</p>
      <p><strong>Produkt:</strong> ${item.produkt || "â€“"}</p>
      <p><strong>Popis zÃ¡vady:</strong> ${item.popis || "â€“"}</p>
      <p><strong>Typ:</strong> ${item.typ || "â€“"}</p>
      <p><strong>Datum prodeje:</strong> ${item.datum_prodeje || "â€“"} 
        | <strong>Datum reklamace:</strong> ${item.datum_reklamace || "â€“"}
      </p>

      ${
        item.fotky && item.fotky.length
          ? `<div class="foto-container">
              ${item.fotky.map(f => `<img src="foto/${f}" alt="${f}" onclick="showPhoto(this.src)" />`).join("")}
             </div>`
          : `<p style="color:#777;">ğŸ“· Å½Ã¡dnÃ© pÅ™iloÅ¾enÃ© fotografie</p>`
      }

      <div class="btn-row">
        <button id="termBtn" class="btn-action btn-blue">ğŸ”µ Domluvit termÃ­n</button>
        <button id="protoBtn" class="btn-action btn-green">ğŸŸ¢ PÅ™ejÃ­t na protokol</button>
        <button id="closeBtn" class="btn-action btn-gray">âŒ ZavÅ™Ã­t</button>
      </div>

      <div id="termSection" class="term-section">
        <h3>Domluvit / ZmÄ›nit termÃ­n</h3>
        <div class="term-center">
          <input type="date" id="datumTerminu" class="term-date" />
          <div class="custom-time-picker">
            <select id="hours"></select>
            <span>:</span>
            <select id="minutes"></select>
          </div>
        </div>

        <div class="btn-row">
          <button id="saveTermBtn" class="btn-action btn-green">ğŸŸ¢ UloÅ¾it termÃ­n</button>
          <button id="noAnswerBtn" class="btn-action btn-orange">ğŸŸ  NezvedÃ¡ to</button>
          <button id="cancelBtn" class="btn-action btn-red">ğŸ”´ ZÃ¡kaznÃ­k zruÅ¡il</button>
          <button id="backBtn" class="btn-action btn-gray">â†©ï¸ ZpÄ›t</button>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(overlay);
  setTimeout(() => overlay.classList.add("active"), 10);

  const id = item.cislo || `radek-${index}`;
  const dateInput = overlay.querySelector("#datumTerminu");
  const hoursSel = overlay.querySelector("#hours");
  const minsSel = overlay.querySelector("#minutes");

  // ğŸ•“ RolovacÃ­ Äas
  for (let h = 0; h < 24; h++) {
    const opt = document.createElement("option");
    opt.value = String(h).padStart(2, "0");
    opt.textContent = opt.value;
    hoursSel.appendChild(opt);
  }
  for (let m = 0; m < 60; m += 5) {
    const opt = document.createElement("option");
    opt.value = String(m).padStart(2, "0");
    opt.textContent = opt.value;
    minsSel.appendChild(opt);
  }

  // ğŸ“… KalendÃ¡Å™ â€“ po vÃ½bÄ›ru se zavÅ™e
  dateInput.addEventListener("change", () => dateInput.blur());

  /* âœ… UloÅ¾it termÃ­n + kontrola pÅ™ekryvu */
  overlay.querySelector("#saveTermBtn").onclick = () => {
    const datum = dateInput.value;
    const cas = `${hoursSel.value}:${minsSel.value}`;
    if (!datum || !cas) return alert("VyplÅˆte datum i Äas!");

    // ğŸ” Kontrola kolizÃ­ Â±2h
    const sameDay = Object.entries(stavy)
      .map(([idKey, st]) => {
        const itemData = dataAll.find(x => (x.cislo || `radek-${dataAll.indexOf(x)}`) === idKey);
        return itemData && itemData.datum === datum && st === "domluveno"
          ? { adresa: itemData.adresa, cas: itemData.cas || "" }
          : null;
      })
      .filter(Boolean);

    if (sameDay.length > 0) {
      const konflikt = sameDay.some(k => {
        if (!k.cas) return false;
        const [h, m] = k.cas.split(":").map(Number);
        const [nh, nm] = cas.split(":").map(Number);
        const diff = Math.abs(h * 60 + m - (nh * 60 + nm));
        return diff <= 120; // Â±2h
      });

      if (konflikt) {
        let seznam = sameDay
          .map(k => `ğŸ•“ ${k.cas || "?"} â€” ${simplifyAddress(k.adresa)}`)
          .join("<br>");
        if (!confirm(`âš ï¸ V ten den uÅ¾ jsou naplÃ¡novanÃ© tyto reklamace:\n\n${seznam}\n\nOpravdu potvrdit termÃ­n?`)) {
          return;
        }
      }
    }

    stavy[id] = "domluveno";
    item.datum = datum;
    item.cas = cas;
    localStorage.setItem("stavyReklamaci", JSON.stringify(stavy));
    closeDetail();
    renderTable(dataAll);
  };

  /* ğŸŸ§ NezvedÃ¡ to */
  overlay.querySelector("#noAnswerBtn").onclick = () => {
    stavy[id] = "nezveda";
    localStorage.setItem("stavyReklamaci", JSON.stringify(stavy));
    closeDetail();
    renderTable(dataAll);
  };

  /* ğŸŸ¥ ZÃ¡kaznÃ­k zruÅ¡il */
  overlay.querySelector("#cancelBtn").onclick = () => {
    stavy[id] = "zruseno";
    localStorage.setItem("stavyReklamaci", JSON.stringify(stavy));
    closeDetail();
    renderTable(dataAll);
  };

  /* ğŸ”µ Domluvit termÃ­n */
  overlay.querySelector("#termBtn").onclick = () => {
    overlay.querySelector("#termSection").style.display = "block";
  };

  /* â†©ï¸ ZpÄ›t */
  overlay.querySelector("#backBtn").onclick = () => {
    overlay.querySelector("#termSection").style.display = "none";
  };

  /* ğŸŸ¢ PÅ™ejÃ­t na protokol */
  overlay.querySelector("#protoBtn").onclick = () => {
    localStorage.setItem("selectedRecord", JSON.stringify(item));
    window.location.href = "protokol.html";
  };

  /* âŒ ZavÅ™Ã­t */
  overlay.querySelector("#closeBtn").onclick = closeDetail;

  function closeDetail() {
    overlay.classList.remove("active");
    setTimeout(() => overlay.remove(), 250);
  }
}

/* ğŸ–¼ï¸ ZvÄ›tÅ¡enÃ­ fotky */
function showPhoto(src) {
  const viewer = document.createElement("div");
  viewer.className = "photo-viewer";
  viewer.innerHTML = `
    <div class="photo-viewer-inner">
      <img src="${src}" alt="photo"/>
      <button class="close-viewer">âœ–</button>
    </div>`;
  document.body.appendChild(viewer);
  viewer.querySelector(".close-viewer").onclick = () => viewer.remove();
}
</script>






<style>
/* ============================= */
/* ğŸ’¬ DETAIL MODAL STYL          */
/* ============================= */
.detail-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity 0.25s ease;
  z-index: 9999;
}
.detail-overlay.active { opacity: 1; }

.detail-modal {
  background: #fff;
  border-radius: 16px;
  width: 80%;
  max-width: 780px;
  padding: 25px 30px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  overflow-y: auto;
  max-height: 90vh;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.detail-modal h2 {
  text-align: center;
  font-size: 1.6em;
  font-weight: 800;
  margin: 0 0 10px;
}
.detail-modal p {
  font-size: 0.95em;
  margin: 6px 0;
  color: #333;
}
.detail-modal a {
  color: #0066ff;
  text-decoration: none;
}
.detail-modal a:hover { text-decoration: underline; }

/* ğŸ–¼ï¸ Fotky */
.foto-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin: 15px 0;
}
.foto-container img {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.foto-container img:hover { transform: scale(1.06); }

/* ğŸ” ZvÄ›tÅ¡enÃ­ fotky */
.photo-viewer {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}
.photo-viewer-inner {
  position: relative;
  max-width: 90vw;
  max-height: 85vh;
}
.photo-viewer-inner img {
  width: 100%;
  height: auto;
  border-radius: 10px;
}
.close-viewer {
  position: absolute;
  top: -15px;
  right: -15px;
  background: #ff3b30;
  color: white;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 1.2em;
  font-weight: bold;
}

/* ğŸ›ï¸ Sekce termÃ­nu */
.term-section {
  display: none;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid #ddd;
}
.term-section h3 {
  text-align: center;
  font-size: 1.15em;
  margin-bottom: 14px;
}

/* ğŸ’  VÄ›tÅ¡Ã­ vstupy pro datum i Äas */
.term-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}
.term-date {
  font-size: 1.3em;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid #ccc;
  text-align: center;
  font-weight: 600;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.term-date:focus {
  border-color: #0046ff;
  box-shadow: 0 0 0 2px rgba(0,70,255,0.25);
}

/* ğŸ•“ RolovacÃ­ Äas */
.custom-time-picker {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}
.custom-time-picker select {
  appearance: none;
  -webkit-appearance: none;
  font-size: 1.3em;
  font-weight: 600;
  border-radius: 10px;
  padding: 6px 12px;
  background: #fff;
  border: 1px solid #ccc;
  text-align: center;
  outline: none;
  transition: box-shadow 0.2s, border-color 0.2s;
}
.custom-time-picker select:focus {
  border-color: #0046ff;
  box-shadow: 0 0 0 2px rgba(0,70,255,0.25);
}

/* ğŸ§­ TlaÄÃ­tka */
.btn-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 20px;
}
.btn-action {
  flex: 1;
  min-width: 150px;
  text-align: center;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: transform 0.15s ease-in-out, opacity 0.2s ease;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}
.btn-action:hover { transform: scale(1.05); opacity: 0.9; }
.btn-blue   { background: linear-gradient(135deg, #007bff, #399bff); }
.btn-green  { background: linear-gradient(135deg, #28a745, #6fdd72); }
.btn-gray   { background: linear-gradient(135deg, #6c757d, #9ca3af); }
.btn-orange { background: linear-gradient(135deg, #ff9800, #ffc270); color: #222; }
.btn-red    { background: linear-gradient(135deg, #dc3545, #f87171); }
.btn-purple { background: linear-gradient(135deg, #6f42c1, #b07bff); }

/* ğŸ“± MobilnÃ­ zobrazenÃ­ */
@media (max-width: 700px) {
  .detail-modal { width: 94%; padding: 20px; }
  .btn-row { flex-direction: column; }
  .btn-action { width: 100%; font-size: 0.95em; }
  .foto-container img { width: 90px; height: 90px; }
}

/* ğŸ©¸ BlikÃ¡nÃ­ dneÅ¡nÃ­ch termÃ­nÅ¯ */
@keyframes blinkRed {
  0% { background-color: #ffe0e0; }
  50% { background-color: #ffb3b3; }
  100% { background-color: #ffe0e0; }
}
.blink-today { animation: blinkRed 1.5s infinite; }

/* ğŸ—ºï¸ Mapa plÃ¡novÃ¡nÃ­ */
.map-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity 0.25s ease;
  z-index: 10000;
}
.map-overlay.active { opacity: 1; }
.map-modal {
  background: #fff;
  border-radius: 16px;
  width: 90%;
  max-width: 850px;
  padding: 25px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  animation: fadeIn 0.3s ease;
}
</style>

<script>
// ğŸ©¸ AutomatickÃ© blikÃ¡nÃ­ dneÅ¡nÃ­ch termÃ­nÅ¯
function highlightTodayRows() {
  const today = new Date().toISOString().split("T")[0];
  document.querySelectorAll("tbody tr").forEach(row => {
    const index = row.dataset.index;
    if (!index) return;
    const item = dataAll[index];
    if (!item) return;

    if (item.datum === today && stavy[item.cislo || `radek-${index}`] === "domluveno") {
      row.classList.add("blink-today");
    } else {
      row.classList.remove("blink-today");
    }
  });
}
const originalRenderTableBlink = renderTable;
renderTable = function(arr) {
  originalRenderTableBlink(arr);
  setTimeout(highlightTodayRows, 100);
};
window.addEventListener("storage", e => {
  if (e.key === "stavyReklamaci") setTimeout(highlightTodayRows, 300);
});
setInterval(highlightTodayRows, 30000);

// ğŸŸ£ OtevÅ™enÃ­ plÃ¡nu dne
function openDayPlan() {
  const overlay = document.createElement("div");
  overlay.className = "map-overlay";
  overlay.innerHTML = `
    <div class="map-modal">
      <h2>ğŸŸ£ Vyber datum pro plÃ¡n dne</h2>
      <input type="date" id="datumPlanu" class="term-date" style="margin:15px auto;display:block;">
      <div id="dayHint" style="text-align:center;font-size:0.9em;color:#555;margin-bottom:10px;"></div>
      <div class="btn-row">
        <button id="showPlanBtn" class="btn-action btn-blue">ğŸ“… Zobrazit plÃ¡n</button>
        <button id="closeMap" class="btn-action btn-gray">âŒ ZavÅ™Ã­t</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  setTimeout(() => overlay.classList.add("active"), 10);

  const close = () => overlay.remove();
  overlay.querySelector("#closeMap").onclick = close;

  // ğŸ“… ZvÃ½raznÄ›nÃ­ dnÅ¯, kde uÅ¾ je plÃ¡n
  const daysWithPlan = new Set();
  dataAll.forEach((r, i) => {
    const id = r.cislo || `radek-${i}`;
    if (stavy[id] === "domluveno" && r.datum) daysWithPlan.add(r.datum);
  });

  const dateInput = overlay.querySelector("#datumPlanu");
  dateInput.addEventListener("input", () => {
    const val = dateInput.value;
    const hint = overlay.querySelector("#dayHint");
    if (daysWithPlan.has(val)) {
      hint.innerHTML = "âœ… Na tento den jiÅ¾ existujÃ­ naplÃ¡novanÃ© zakÃ¡zky.";
      hint.style.color = "#28a745";
    } else {
      hint.innerHTML = "â„¹ï¸ Pro tento den zatÃ­m nenÃ­ nic naplÃ¡novÃ¡no.";
      hint.style.color = "#555";
    }
  });

  overlay.querySelector("#showPlanBtn").onclick = () => {
    const dnes = dateInput.value;
    if (!dnes) return alert("Vyberte datum pro zobrazenÃ­ plÃ¡nu.");

    const stops = [];
    dataAll.forEach((r, i) => {
      const id = r.cislo || `radek-${i}`;
      if (stavy[id] === "domluveno" && r.datum === dnes && r.adresa)
        stops.push({
          adresa: simplifyAddress(r.adresa),
          full: r.adresa,
          zakaznik: r.zakaznik || "",
          cas: r.cas || ""
        });
    });

    if (!stops.length) {
      alert("âŒ Pro tento den nejsou naplÃ¡novÃ¡ny Å¾Ã¡dnÃ© zakÃ¡zky.");
      close();
      return;
    }

    close();
    const start = "Do DubÄe 364, Praha 9 - BÄ›chovice";
    const allAddresses = [start, ...stops.map(s => s.full), start];

    const mapOverlay = document.createElement("div");
    mapOverlay.className = "map-overlay";
    mapOverlay.innerHTML = `
      <div class="map-modal">
        <h2>ğŸ—ºï¸ PlÃ¡n dne â€“ ${dnes}</h2>
        <div id="map" style="width:100%;height:65vh;border-radius:12px;margin-bottom:10px;"></div>
        <div id="route-info" style="font-size:0.9em;color:#333;margin-bottom:15px;text-align:center;">NaÄÃ­tÃ¡m trasu...</div>
        <button id="closeMap" class="btn-action btn-gray" style="width:200px;">ZavÅ™Ã­t</button>
      </div>`;
    document.body.appendChild(mapOverlay);
    setTimeout(() => mapOverlay.classList.add("active"), 10);
    mapOverlay.querySelector("#closeMap").onclick = () => mapOverlay.remove();

    const map = L.map("map").setView([50.08,14.45], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:"Â© OpenStreetMap" }).addTo(map);

    Promise.all(allAddresses.map(a =>
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(a)}&limit=1`)
        .then(r => r.json()).then(j => j[0] ? [parseFloat(j[0].lat), parseFloat(j[0].lon)] : null)
    )).then(coords => {
      const valid = coords.filter(Boolean);
      if (valid.length < 2) return document.getElementById("route-info").textContent = "NepodaÅ™ilo se urÄit vÅ¡echny adresy.";

      const line = L.polyline(valid, { color:"#6f42c1", weight:4 }).addTo(map);
      map.fitBounds(line.getBounds(), { padding:[30,30] });

      valid.forEach((p,i)=>{
        const info = i===0?"Start â€“ WGS BÄ›chovice":i===valid.length-1?"Konec â€“ nÃ¡vrat na sÃ­dlo":
          `${stops[i-1].zakaznik} (${stops[i-1].cas||"Äas ?"}) â€“ ${stops[i-1].adresa}`;
        L.marker(p).addTo(map).bindPopup(info);
      });

      const coordsStr = valid.map(c => `${c[1]},${c[0]}`).join(";");
      fetch(`https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=false`)
        .then(r=>r.json()).then(r=>{
          if(r.routes?.length){
            const km=(r.routes[0].distance/1000).toFixed(1);
            const min=Math.round(r.routes[0].duration/60);
            document.getElementById("route-info").textContent=`ğŸ›£ï¸ Celkem ${km} km | â±ï¸ cca ${min} min`;
          } else document.getElementById("route-info").textContent="Trasu se nepodaÅ™ilo spoÄÃ­tat.";
        });
    });
  };
}
</script>
