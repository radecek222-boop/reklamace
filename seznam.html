<!-- üü© C-1 + C-4: DETAIL Z√ÅKAZN√çKA (kalend√°≈ô vlevo + modern√≠ hodiny vpravo + dla≈ædicov√° tlaƒç√≠tka) -->
<script>
function openDetail(index) {
  const item = dataAll[index];
  if (!item) return;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  const adresaUpravena = normalizePrahaAddress(item.adresa || "");

  overlay.innerHTML = `
    <div class="detail-modal">
      <div class="grid-layout">

        <!-- üß≠ LEV√ù PANEL -->
        <div class="left-panel">

          <!-- üìÖ Kalend√°≈ô + ƒåas (vedle sebe) -->
          <div class="date-time-row">
            <div id="miniCalendar"></div>

            <div class="date-right-column">
              <div class="time-picker-modern">
                <button id="clockToggle" class="clock-button" title="Vybrat ƒças">
                  <svg xmlns="http://www.w3.org/2000/svg" class="clock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                  </svg>
                </button>
                <div class="time-dropdown" id="timeDropdown">
                  <select id="hours"></select>
                  <span>:</span>
                  <select id="minutes"></select>
                </div>
              </div>
              <div class="term-info-box" id="termInfoBox">Nen√≠ vybr√°n datum a ƒças</div>
            </div>
          </div>

          <!-- üü© BLOK TLAƒå√çTEK (dla≈ædice 2x3) -->
          <div class="button-grid">
            <button id="contactBtn" class="btn-tile gray">Kontaktovat z√°kazn√≠ka</button>
            <button id="closeBtn" class="btn-tile dark">Zpƒõt</button>
            <button id="saveTermBtn" class="btn-tile green">Ulo≈æit / Zmƒõnit term√≠n</button>
            <button id="waitBtn" class="btn-tile purple">Z√°kazn√≠k ƒçek√° na d√≠ly</button>
            <button id="startVisitBtn" class="btn-tile red">Zah√°jit n√°v≈°tƒõvu</button>
            <button id="createProtocolBtn" class="btn-tile blue">Vytvo≈ôit protokol</button>
          </div>
        </div>

        <!-- üßæ PRAV√ù PANEL -->
        <div class="right-panel">
          <div class="info-box" id="customerBox">
            <div class="box-header"><strong>Z√°kazn√≠k</strong></div>
            <div class="box-content">
              <p><strong>Jm√©no:</strong> ${item.zakaznik || "‚Äì"}</p>
              <p><strong>Adresa:</strong> ${adresaUpravena}</p>
              <p><strong>Telefon:</strong> ${(item.telefon || "‚Äì")}</p>
              <p><strong>Email:</strong> ${item.email || "‚Äì"}</p>
              <p><strong>Produkt / model:</strong> ${item.produkt || "‚Äì"}</p>
            </div>
          </div>

          <div class="info-box" id="popisBox">
            <div class="box-header"><strong>Popis z√°vady</strong></div>
            <div class="box-content" id="popisContent">${item.popis || "‚Äì"}</div>
          </div>

          <div class="distance-banner" id="mapDistance">üìç Poƒç√≠t√°m vzd√°lenost‚Ä¶</div>
          <div id="mapDetail"></div>
        </div>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  setTimeout(() => overlay.classList.add("active"), 10);

  initCalendarAndTime(overlay, item, index);
  initModernClock(overlay);  
  initMapForDetail(overlay, item);
  initDetailButtons(overlay, item, index);

  overlay.querySelector("#customerBox").onclick = () => openCustomerDetail(item, overlay);
  overlay.querySelector("#popisBox").onclick = () => openPopisEditor(item, overlay);
}
</script>

<script>
function initDetailButtons(overlay, item, index) {
  const id = item.cislo || `radek-${index}`;
  const infoBox = overlay.querySelector("#termInfoBox");

  overlay.querySelector("#saveTermBtn").onclick = () => {
    const datum = overlay.dataset.datum;
    const cas = `${overlay.querySelector("#hours").value}:${overlay.querySelector("#minutes").value}`;
    if (!datum || !cas) return alert("Vyberte datum a ƒças!");
    ulozitTerminNaGitHub(item, id, datum, cas, overlay, overlay.querySelector("#saveTermBtn"), infoBox);
  };

  overlay.querySelector("#waitBtn").onclick = async () => {
    try {
      stavy[id] = "ceka";
      item.stav = "ceka";
      const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "update", record: item })
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      setNextToast("üü£ Z√°kazn√≠k ƒçek√° na d√≠ly", "warning");
      overlay.remove();
      renderTable(dataAll);
    } catch (err) {
      alert("‚ùå Chyba p≈ôi ukl√°d√°n√≠: " + err.message);
    }
  };

  overlay.querySelector("#createProtocolBtn").onclick = () => {
    localStorage.setItem("protokolData", JSON.stringify(item));
    window.location.href = "protokol.html";
  };

  overlay.querySelector("#startVisitBtn").onclick = () => {
    localStorage.setItem("currentCustomer", JSON.stringify(item));
    window.location.href = "photocustomer.html";
  };

  overlay.querySelector("#contactBtn").onclick = () => openContactModal(item, index, overlay);
  overlay.querySelector("#closeBtn").onclick = () => overlay.remove();
}
</script>

<script>
function initModernClock(overlay) {
  const hoursSel = overlay.querySelector("#hours");
  const minutesSel = overlay.querySelector("#minutes");
  const dropdown = overlay.querySelector("#timeDropdown");
  const toggle = overlay.querySelector("#clockToggle");
  const infoBox = overlay.querySelector("#termInfoBox");

  for (let h = 7; h <= 19; h++) {
    const opt = document.createElement("option");
    opt.value = h;
    opt.textContent = String(h).padStart(2, "0");
    hoursSel.appendChild(opt);
  }
  for (let m = 0; m < 60; m += 5) {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = String(m).padStart(2, "0");
    minutesSel.appendChild(opt);
  }

  toggle.addEventListener("click", () => dropdown.classList.toggle("show"));

  const updateTime = () => {
    const d = overlay.dataset.datum;
    const h = hoursSel.value.padStart(2, "0");
    const m = minutesSel.value.padStart(2, "0");
    if (d) infoBox.textContent = `${new Date(d).toLocaleDateString("cs-CZ")} ${h}:${m}`;
    else infoBox.textContent = `${h}:${m}`;
  };

  hoursSel.addEventListener("change", updateTime);
  minutesSel.addEventListener("change", updateTime);
}
</script>

<style>
/* üìÖ Kalend√°≈ô a hodiny vedle sebe */
.date-time-row {
  display: grid;
  grid-template-columns: 1.15fr 0.85fr;
  gap: 10px;
  align-items: stretch;
  margin-bottom: 10px;
}

/* üïí Styl modern√≠ch hodin */
.time-picker-modern {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  height: 260px;
}
.clock-button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 10px;
  transition: transform .25s ease, opacity .25s ease;
}
.clock-button:hover { transform: scale(1.1); opacity: .8; }
.clock-icon {
  width: 72px;
  height: 72px;
  color: #111;
  stroke: #222;
  stroke-linecap: round;
  stroke-linejoin: round;
}
.time-dropdown {
  position: absolute;
  bottom: 6px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 6px 10px;
  display: none;
  box-shadow: 0 3px 10px rgba(0,0,0,.15);
  gap: 6px;
  font-weight: 600;
}
.time-dropdown.show {
  display: flex;
  align-items: center;
}
.time-dropdown select {
  font-size: 1em;
  padding: 4px 6px;
  border-radius: 6px;
  border: 1px solid #ddd;
}
.time-dropdown span {
  font-size: 1.1em;
  font-weight: 700;
  color: #222;
}
.term-info-box {
  background: #f3f3f3;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 6px 8px;
  text-align: center;
  font-weight: 600;
  color: #555;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 8px;
}
@media (max-width:700px){
  .date-time-row{grid-template-columns:1fr;}
  .clock-icon{width:56px;height:56px;}
  .time-picker-modern{height:auto;}
}
</style>
<!-- üü© KONEC C-1 + C-4 -->
