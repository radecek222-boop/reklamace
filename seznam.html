<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seznam reklamací – White Glove Service</title>

<!-- Leaflet mapa -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Vanilla Calendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.8.1/build/vanilla-calendar.min.css">
<script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.8.1/build/vanilla-calendar.min.js"></script>

<!-- PDF Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}
.wrapper {
  background: #fff;
  padding: 25px;
  margin: 40px 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 1200px;
  box-sizing: border-box;
}
h1 {
  text-align: center;
  font-size: 2.2em;
  font-weight: 900;
  color: #111;
  margin: 0 0 8px;
}
h2 {
  text-align: center;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  margin: 0 0 25px;
}
.actions {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 25px;
}
.btn {
  display: inline-block;
  text-decoration: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1em;
  border: none;
  cursor: pointer;
  transition: transform 0.15s ease-in-out, opacity 0.2s;
  color: white;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  min-width: 160px;
}
.btn:hover { transform: scale(1.04); opacity: 0.9; }
.btn-back { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
.btn-refresh { background: linear-gradient(135deg, #b80000, #ff3838); }
.btn-green { background: linear-gradient(135deg, #28a745, #60d06a); }
.btn-plan { background: linear-gradient(135deg, #0046ff, #357aff); }

#search {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  padding: 10px 8px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 0.95em;
  white-space: normal;
  line-height: 1.4em;
  color: #000;
}
th { background: #f8f8f8; font-weight: 700; color:#000; }
tr:hover { background: #f1f6ff; cursor: pointer; }

/* 🔹 Stavy */
.stav-novy { animation: blikani 1s infinite alternate; background: #ffdb4d !important; }
.stav-domluveno { background: #99b3ff !important; }
.stav-zruseno { background: #ff6666 !important; }
.stav-nezveda { background: #ffad33 !important; }

@keyframes blikani {
  from { background-color: #ffe066; }
  to { background-color: #fff280; }
}

/* 📱 Mobilní */
@media (max-width:700px){
  table { display:none; }
  .btn { width:100%; min-width:unset; text-align:center; }
}
</style>
</head>
<body>
  <div class="wrapper">
    <h1>WHITE GLOVE SERVICE</h1>
    <h2>Seznam reklamací a servisních požadavků</h2>

    <div class="actions">
      <a href="index.html" class="btn btn-back">Zpět</a>
      <button id="reloadBtn" class="btn btn-refresh">Načíst znovu</button>
      <a href="hotove.html" class="btn btn-green">Hotové reklamace</a>
      <button id="planBtn" class="btn btn-plan">Plán dne</button>
    </div>

    <input type="text" id="search" placeholder="🔍 Hledat podle jména, adresy nebo zadavatele...">
    <div id="tableContainer" class="loading">📦 Načítám data...</div>

<script>
const API_URL = "https://wgs-token.72nvwf4pb2.workers.dev/orders";
const tableContainer = document.getElementById("tableContainer");
const searchInput = document.getElementById("search");
const reloadBtn = document.getElementById("reloadBtn");
let dataAll = [];
let lastDataHash = "";
let stavy = JSON.parse(localStorage.getItem("stavyReklamaci") || "{}");

/* 🔄 Automatické načítání každé 2 minuty */
setInterval(loadData, 120000);

/* 🧩 Hash */
function hashData(arr){ return arr.map(r=>r.cislo||r.id||"").join("|"); }

/* 📅 Řazení */
function sortSmart(data){
  const today=new Date().toISOString().split("T")[0];
  return data.sort((a,b)=>{
    const sa=stavy[a.cislo]||"novy";
    const sb=stavy[b.cislo]||"novy";
    const da=a.datum===today?0:(sa==="zruseno"?2:1);
    const db=b.datum===today?0:(sb==="zruseno"?2:1);
    return da-db;
  });
}

/* 🧭 Adresa */
function simplifyAddress(addr){
  if(!addr)return "";
  const m=addr.match(/Praha\s*\d+/i);
  if(m)return m[0];
  if(addr.toLowerCase().includes("běchovice"))return "Praha 9";
  return addr.replace(/\d{3}\s?\d{2}$/,"").trim();
}

/* 🕓 CZ datum */
function formatCzDateShort(d,t){
  if(!d)return "";
  const dt=new Date(d+"T"+(t||"00:00"));
  const dn=["Ne","Po","Út","St","Čt","Pá","So"][dt.getDay()];
  const day=String(dt.getDate()).padStart(2,"0");
  const month=String(dt.getMonth()+1).padStart(2,"0");
  return `${dn} ${day}.${month}. ${t||""}`;
}

/* 🗺️ Načtení dat – funkční i na iPhone */
async function loadData(){
  tableContainer.innerHTML="<div class='loading'>📦 Načítám reklamace...</div>";
  try{
    const res=await fetch(API_URL+"?t="+Date.now(),{cache:"reload"});
    if(!res.ok)throw new Error("Server neodpověděl");
    const data=await res.json();
    if(!Array.isArray(data))throw new Error("Neplatný formát dat");
    dataAll=sortSmart(data.reverse());
    renderTable(dataAll);
  }catch(err){
    tableContainer.innerHTML=`<div class='loading' style='color:red;'>⚠️ Chyba načítání: ${err.message}<br><button id='retryBtn'>Zkusit znovu</button></div>`;
    document.getElementById("retryBtn").onclick=loadData;
  }
}

/* 📋 Vykreslení tabulky */
function renderTable(arr){
  if(!arr.length){ tableContainer.innerHTML="<div class='loading'>Žádné záznamy</div>"; return;}
  const saved=JSON.parse(localStorage.getItem("stavyReklamaciData")||"[]");
  let html=`<table><thead><tr><th>Zákazník</th><th>Adresa</th><th>Telefon</th><th>Stav</th></tr></thead><tbody>`;
  arr.forEach((r,i)=>{
    const id=r.cislo||`radek-${i}`;
    const stav=stavy[id]||"novy";
    const found=saved.find(z=>z.cislo===id);
    const adresa=r.adresa?`<a href="https://waze.com/ul?q=${encodeURIComponent(r.adresa)}" target="_blank" style="color:#0046ff;font-weight:600;">${simplifyAddress(r.adresa)}</a>`:"–";
    const tel=r.telefon?`<a href="tel:${r.telefon.replace('+420','').trim()}" style="color:#0046ff;font-weight:600;">${r.telefon.replace('+420','').trim()}</a>`:"–";
    let stavText=stav;
    if(stav==="domluveno"&&found)stavText=`Domluveno – ${formatCzDateShort(found.datum,found.cas)}`;
    html+=`<tr class="stav-${stav}" data-index="${i}" data-id="${id}"><td>${r.zakaznik||"–"}</td><td>${adresa}</td><td>${tel}</td><td style="font-weight:600;">${stavText}</td></tr>`;
  });
  html+="</tbody></table>";
  tableContainer.innerHTML=html;
  document.querySelectorAll("tbody tr").forEach(row=>row.addEventListener("click",()=>openDetail(row.dataset.index)));
}

/* 🔍 Vyhledávání */
searchInput.addEventListener("input",()=>{
  const q=searchInput.value.trim().toLowerCase();
  if(!q)return renderTable(dataAll);
  const f=dataAll.filter(r=>(r.zakaznik||"").toLowerCase().includes(q)||(r.adresa||"").toLowerCase().includes(q));
  renderTable(f);
});
reloadBtn.addEventListener("click",loadData);
window.addEventListener("DOMContentLoaded",loadData);
</script>
<script>
/* ============================= */
/* 💬 DETAIL ZÁKAZNÍKA – MODAL   */
/* ============================= */
function openDetail(index){
  const item = dataAll[index];
  if(!item) return;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  document.body.classList.add("modal-open");

  overlay.innerHTML = `
    <div class="detail-modal">
      <div class="detail-content">
        <div class="detail-info">
          <h2>${item.zakaznik || "Zákazník"}</h2>
          <p><strong>Adresa:</strong> 
            <a href="https://waze.com/ul?q=${encodeURIComponent(item.adresa||"")}" target="_blank">${item.adresa||"Neuvedeno"}</a></p>
          <p><strong>Telefon:</strong> 
            <a href="tel:${(item.telefon||"").replace("+420","").trim()}">${(item.telefon||"").replace("+420","").trim()}</a></p>
          <p><strong>Email:</strong> ${item.email || "–"}</p>
          <p><strong>Produkt / model:</strong> ${item.produkt || "–"}</p>
          <p><strong>Popis závady:</strong> ${item.popis || "–"}</p>
          <p><strong>Typ:</strong> ${item.typ || "–"}</p>

          ${ item.typ && item.typ.toLowerCase().includes("pozáruční")
              ? "" 
              : `<p><strong>Datum prodeje:</strong> ${item.datum_prodeje || "–"} | 
                 <strong>Datum reklamace:</strong> ${item.datum_reklamace || "–"}</p>` }

          ${
            item.fotky && item.fotky.length
            ? `<div class="foto-container">${item.fotky.map(f=>`<img src="foto/${f}" onclick="showPhoto(this.src)">`).join("")}</div>`
            : `<p style="color:#777;">📷 Žádné přiložené fotografie</p>`
          }

          <div class="btn-row">
            <button id="termBtn" class="btn-action btn-blue">Domluvit termín</button>
            <button id="protoBtn" class="btn-action btn-green">Přejít na protokol</button>
            <button id="closeBtn" class="btn-action btn-red">Zavřít</button>
          </div>

          <div id="termSection" class="term-section">
            <h3>Domluvit / Změnit termín</h3>
            <div class="term-center">
              <div id="miniCalendar" class="term-calendar"></div>
              <input type="hidden" id="datumTerminu">
              <div class="custom-time-picker">
                <select id="hours"></select><span>:</span><select id="minutes"></select>
              </div>
            </div>
            <div class="btn-row">
              <button id="saveTermBtn" class="btn-action btn-green">Uložit termín</button>
              <button id="noAnswerBtn" class="btn-action btn-orange">Nezvedá to</button>
              <button id="cancelBtn" class="btn-action btn-gray">Zákazník zrušil</button>
              <button id="backBtn" class="btn-action btn-red">Zpět</button>
            </div>
          </div>
        </div>
        <div class="detail-map">
          <div id="mapDetail"></div>
          <div id="mapDistance" class="map-distance"></div>
        </div>
      </div>
    </div>`;

  document.body.appendChild(overlay);
  setTimeout(()=>overlay.classList.add("active"),10);

  /* ⏰ Naplnění časů */
  const h=document.querySelector("#hours"), m=document.querySelector("#minutes");
  for(let i=7;i<20;i++)h.innerHTML+=`<option>${String(i).padStart(2,"0")}</option>`;
  for(let j=0;j<60;j+=5)m.innerHTML+=`<option>${String(j).padStart(2,"0")}</option>`;

  /* 🗓️ Mini kalendář */
  const miniCal = new VanillaCalendar("#miniCalendar",{
    settings:{lang:"cs",selection:{day:"single"}},
    actions:{
      clickDay(ev,self){
        const d=ev.target.dataset.calendarDay;
        if(d){ document.getElementById("datumTerminu").value=d; }
      }
    }
  });
  miniCal.init();

  /* 🗺️ Mapa */
  const mapBox = overlay.querySelector("#mapDetail");
  const wgs = [50.049,14.523];
  const map = L.map(mapBox).setView(wgs,9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OSM"}).addTo(map);
  const wgsMarker = L.marker(wgs).addTo(map).bindPopup("WGS – Do Dubče Praha 9");

  if(item.adresa){
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.adresa)}`)
    .then(r=>r.json()).then(data=>{
      if(data[0]){
        const cust=[parseFloat(data[0].lat),parseFloat(data[0].lon)];
        const cMarker=L.marker(cust,{icon:L.icon({
          iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
          iconSize:[28,28],iconAnchor:[14,28]
        })}).addTo(map).bindPopup(item.adresa);
        const group=L.featureGroup([wgsMarker,cMarker]);
        map.fitBounds(group.getBounds().pad(0.3));
        const dist=calcDistanceCoords(wgs[0],wgs[1],cust[0],cust[1]);
        overlay.querySelector("#mapDistance").innerHTML=`📍 ${dist.toFixed(1)} km od WGS`;
      }
    });
  }

  /* 💾 Uložení termínu */
  overlay.querySelector("#saveTermBtn").onclick=()=>{
    const d=document.getElementById("datumTerminu").value;
    const cas=`${h.value}:${m.value}`;
    if(!d||!cas) return alert("Vyberte datum i čas.");
    const id=item.cislo||`radek-${index}`;
    stavy[id]="domluveno";
    item.datum=d; item.cas=cas;
    ulozTermin(item);
    localStorage.setItem("stavyReklamaci",JSON.stringify(stavy));
    closeDetail();
    renderTable([...dataAll]);
  };

  overlay.querySelector("#noAnswerBtn").onclick=()=>{
    stavy[item.cislo]="nezveda";
    localStorage.setItem("stavyReklamaci",JSON.stringify(stavy));
    closeDetail(); renderTable(dataAll);
  };
  overlay.querySelector("#cancelBtn").onclick=()=>{
    stavy[item.cislo]="zruseno";
    localStorage.setItem("stavyReklamaci",JSON.stringify(stavy));
    closeDetail(); renderTable(dataAll);
  };

  overlay.querySelector("#termBtn").onclick=()=>overlay.querySelector("#termSection").style.display="block";
  overlay.querySelector("#backBtn").onclick=()=>overlay.querySelector("#termSection").style.display="none";
  overlay.querySelector("#protoBtn").onclick=()=>{
    localStorage.setItem("selectedRecord",JSON.stringify(item));
    window.location.href="protokol.html";
  };
  overlay.querySelector("#closeBtn").onclick=closeDetail;

  function closeDetail(){
    overlay.classList.remove("active");
    document.body.classList.remove("modal-open");
    setTimeout(()=>overlay.remove(),250);
  }
}

/* 🧮 Vzdálenost */
function calcDistanceCoords(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180, dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
</script>

<style>
.detail-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);
  display:none;justify-content:center;align-items:center;
  opacity:0;transition:opacity .25s ease;z-index:9999;
}
.detail-overlay.active{display:flex;opacity:1;}
body.modal-open{overflow:hidden;}
.detail-modal{
  background:#fff;border-radius:16px;max-width:950px;width:92%;
  padding:25px;box-shadow:0 10px 25px rgba(0,0,0,0.3);
  max-height:90vh;overflow-y:auto;animation:fadeIn .3s ease;
}
@keyframes fadeIn{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.detail-content{display:flex;flex-direction:row;gap:20px;}
.detail-info{flex:1.2;color:#000;}
.detail-map{flex:1;display:flex;flex-direction:column;align-items:center;}
#mapDetail{height:280px;width:100%;border:1px solid #ddd;border-radius:10px;}
.map-distance{text-align:center;color:#333;margin-top:6px;}
.foto-container{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:15px 0;}
.foto-container img{width:120px;height:120px;object-fit:cover;border-radius:8px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.btn-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:20px;}
.btn-action{
  flex:1;min-width:150px;padding:10px;border:none;border-radius:8px;
  font-weight:600;color:white;cursor:pointer;
  transition:transform .15s ease-in-out,opacity .2s;box-shadow:0 3px 8px rgba(0,0,0,0.15);
}
.btn-action:hover{transform:scale(1.05);opacity:0.9;}
.btn-blue{background:linear-gradient(135deg,#007bff,#399bff);}
.btn-green{background:linear-gradient(135deg,#28a745,#6fdd72);}
.btn-gray{background:linear-gradient(135deg,#6c757d,#9ca3af);}
.btn-orange{background:linear-gradient(135deg,#ff9800,#ffc270);color:#222;}
.btn-red{background:linear-gradient(135deg,#dc3545,#f87171);}
.term-section{display:none;margin-top:25px;padding-top:15px;border-top:1px solid #ddd;}
.term-calendar{min-height:280px;border:1px solid #ddd;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,0.1);}
.custom-time-picker{display:flex;align-items:center;gap:6px;margin-top:10px;}
.custom-time-picker select{font-size:1.2em;font-weight:600;border-radius:8px;padding:6px 12px;border:1px solid #ccc;}
@media(max-width:750px){
  .detail-content{flex-direction:column;}
  .detail-modal{width:94%;padding:20px;}
  .btn-row{flex-direction:column;}
  #mapDetail{height:300px;}
}
</style>
<style>
/* ✨ Plán dne modal */
#planModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 99999;
  opacity: 0;
  transition: opacity 0.25s ease;
}
#planModal.active {
  display: flex;
  opacity: 1;
}
#planModal .modal-inner {
  background: white;
  border-radius: 14px;
  padding: 20px;
  width: 95%;
  max-width: 1100px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
  gap: 20px;
}
#planModal h2 {
  text-align: center;
  font-size: 1.4em;
  font-weight: 700;
  margin: 5px 0 15px;
  color: #000;
}
.plan-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
#calendar {
  border: 1px solid #ddd;
  border-radius: 10px;
  overflow: hidden;
}
#map {
  height: 450px;
  border-radius: 10px;
}
.plan-list {
  max-height: 220px;
  overflow-y: auto;
  font-size: 0.95em;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 10px;
  color: #000;
}
.plan-list div {
  margin-bottom: 8px;
  padding: 4px 6px;
  border-bottom: 1px solid #eee;
}
.plan-list b { color: #000; }
.plan-actions {
  display: flex;
  justify-content: center;
  gap: 15px;
}

/* 📱 Mobilní rozložení */
@media (max-width: 750px) {
  .plan-content {
    display: flex;
    flex-direction: column;
  }
  #map {
    height: 320px;
  }
}
</style>

<script>
// =============================
// 🗓️ PLÁN DNE – MAPA + KALENDÁŘ
// =============================
const planBtn = document.getElementById("planBtn");

const planModalHTML = `
<div id="planModal">
  <div class="modal-inner">
    <h2>🗺️ Plán dne</h2>
    <div class="plan-content">
      <div id="calendar"></div>
      <div id="map"></div>
    </div>
    <div class="plan-list" id="planList">Vyberte den v kalendáři...</div>
    <div class="plan-actions">
      <button id="exportPlanPDF" class="btn-action btn-green">Exportovat do PDF</button>
      <button id="closeMap" class="btn-action btn-red">Zavřít</button>
    </div>
  </div>
</div>`;
document.body.insertAdjacentHTML("beforeend", planModalHTML);

let map, markersLayer, routeLayer;
const wgsCoords = [50.049, 14.523]; // WGS – Do Dubče Praha 9

function initCalendar() {
  const ulozene = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]");
  const dny = [...new Set(ulozene.map(z => z.datum))];

  const calendar = new VanillaCalendar("#calendar", {
    settings: { lang: "cs", visibility: { theme: "light" } },
    actions: {
      clickDay(event, self) {
        const date = event.target.dataset.calendarDay;
        if (date) showPlanForDay(date);
      }
    }
  });
  calendar.init();

  setTimeout(() => {
    document.querySelectorAll(".vanilla-calendar-day__btn").forEach(btn => {
      if (dny.includes(btn.dataset.calendarDay)) {
        btn.style.background = "#357aff";
        btn.style.color = "#fff";
        btn.style.borderRadius = "6px";
      }
    });
  }, 300);
}

async function showPlanForDay(date) {
  const planList = document.getElementById("planList");
  const terminy = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]").filter(t => t.datum === date);
  planList.innerHTML = "";

  if (!terminy.length) {
    planList.innerHTML = "<div style='color:#777;'>Žádné reklamace pro tento den.</div>";
    if (markersLayer) markersLayer.clearLayers();
    return;
  }

  if (!map) {
    map = L.map("map").setView([50.0755, 14.4378], 9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "© OpenStreetMap" }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    routeLayer = L.polyline([], { color: "purple", weight: 4 }).addTo(map);
  }

  const cache = JSON.parse(localStorage.getItem("geoCache") || "{}");
  let coords = [wgsCoords];

  const fetchCoords = async addr => {
    if (cache[addr]) return cache[addr];
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
    const data = await res.json();
    if (data[0]) {
      const c = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      cache[addr] = c;
      localStorage.setItem("geoCache", JSON.stringify(cache));
      return c;
    }
    return null;
  };

  for (const t of terminy) {
    const c = await fetchCoords(t.adresa);
    if (c) coords.push(c);
  }

  markersLayer.clearLayers();
  L.marker(wgsCoords, {
    title: "WGS – Do Dubče",
    icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png", iconSize: [28,28], iconAnchor: [14,28] })
  }).addTo(markersLayer).bindPopup("<b>WGS – Praha 9</b>");

  terminy.forEach(t => {
    const c = cache[t.adresa];
    if (c) {
      L.marker(c, {
        icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png", iconSize: [28,28], iconAnchor: [14,28] })
      }).addTo(markersLayer)
      .bindPopup(`<b>${t.zakaznik || "Zákazník"}</b><br>${t.adresa || ""}<br>${t.produkt || ""}`);
    }
  });

  const coordStr = coords.map(c => c[1] + "," + c[0]).join(";");
  const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson`);
  const data = await res.json();
  const route = data.routes[0];
  if (route) {
    const line = L.geoJSON(route.geometry, { color: "purple", weight: 5 });
    routeLayer.setLatLngs(line.getLatLngs());
    map.fitBounds(line.getBounds());
  }
  setTimeout(() => map.invalidateSize(), 300);

  planList.innerHTML = terminy.map(t => `
    <div>
      <b>${t.zakaznik || "Zákazník"}</b><br>
      📍 <a href="https://waze.com/ul?q=${encodeURIComponent(t.adresa)}" target="_blank" style="color:#0046ff;font-weight:600;">${t.adresa || ""}</a><br>
      📞 <a href="tel:${t.telefon?.replace("+420","").trim() || ""}" style="color:#0046ff;font-weight:600;">${t.telefon || ""}</a><br>
      🕐 ${t.cas || ""} 🪑 ${t.produkt || ""}
    </div>
  `).join("");
}

/* 🧾 Export plánu dne do PDF */
async function exportPlanToPDF() {
  const { jsPDF } = window.jspdf;
  const selected = document.querySelector(".vanilla-calendar-day__btn_selected");
  if (!selected) return alert("Vyberte den v kalendáři.");
  const date = selected.dataset.calendarDay;
  const terminy = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]").filter(t => t.datum === date);
  if (!terminy.length) return alert("Na tento den není žádný plán.");

  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text(`Plán dne – ${date}`, 14, 20);
  doc.setFontSize(11);
  let y = 30;
  terminy.forEach(t => {
    doc.text(`• ${t.zakaznik || "Zákazník"} – ${t.adresa || ""}`, 14, y);
    y += 6;
    doc.text(`   Model: ${t.produkt || ""}  |  Tel: ${t.telefon || ""}  |  Čas: ${t.cas || ""}`, 14, y);
    y += 8;
  });
  doc.save(`Plan_${date}.pdf`);
}

/* 🔘 Otevření modalu */
planBtn.onclick = () => {
  const modal = document.getElementById("planModal");
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("active"), 10);
  initCalendar();
};

/* ❌ Zavření modalu */
document.getElementById("closeMap").onclick = () => {
  const modal = document.getElementById("planModal");
  modal.classList.remove("active");
  setTimeout(() => (modal.style.display = "none"), 250);
};

/* 📤 Export PDF */
document.getElementById("exportPlanPDF").onclick = exportPlanToPDF;
</script>
<script>
/* =============================== */
/* 🖼️ FULLSCREEN NÁHLED FOTEK     */
/* =============================== */
function showPhoto(src) {
  const viewer = document.createElement("div");
  viewer.className = "photo-viewer";
  viewer.innerHTML = `
    <div class="photo-viewer-inner">
      <button class="viewer-btn prev">⟨</button>
      <img src="${src}" alt="">
      <button class="viewer-btn next">⟩</button>
      <button class="close-viewer">×</button>
    </div>`;
  document.body.appendChild(viewer);

  const images = Array.from(document.querySelectorAll(".foto-container img"));
  let index = images.findIndex(img => img.src === src);

  function updateImage() {
    viewer.querySelector("img").src = images[index].src;
  }

  viewer.querySelector(".next").onclick = () => {
    index = (index + 1) % images.length;
    updateImage();
  };
  viewer.querySelector(".prev").onclick = () => {
    index = (index - 1 + images.length) % images.length;
    updateImage();
  };
  viewer.querySelector(".close-viewer").onclick = () => viewer.remove();
  viewer.onclick = e => { if (e.target === viewer) viewer.remove(); };
}
</script>

<style>
/* =============================== */
/* 🖼️ STYL PRO FULLSCREEN FOTKY    */
/* =============================== */
.photo-viewer {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}
.photo-viewer-inner {
  position: relative;
  max-width: 92vw;
  max-height: 88vh;
}
.photo-viewer-inner img {
  width: 100%;
  height: auto;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
}
.close-viewer {
  position: absolute;
  top: -15px;
  right: -15px;
  background: #ff3b30;
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  font-size: 1.4em;
  font-weight: bold;
}
.viewer-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  font-size: 2em;
  font-weight: bold;
  padding: 0 12px;
  border-radius: 6px;
  cursor: pointer;
}
.viewer-btn:hover {
  background: rgba(255,255,255,0.4);
}
.viewer-btn.prev { left: -50px; }
.viewer-btn.next { right: -50px; }

@media (max-width: 750px) {
  .viewer-btn.prev { left: 10px; }
  .viewer-btn.next { right: 10px; }
}
</style>

<script>
/* =============================== */
/* 🔴 BLIKÁNÍ DNES DOMLUVENÝCH     */
/* =============================== */
function highlightTodayRows() {
  const today = new Date().toISOString().split("T")[0];
  const ulozene = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]");
  document.querySelectorAll("tbody tr").forEach(row => {
    const id = row.dataset.id;
    const found = ulozene.find(z => z.cislo === id);
    if (found && found.datum === today && stavy[id] === "domluveno") {
      row.classList.add("blink-today");
    } else {
      row.classList.remove("blink-today");
    }
  });
}
setInterval(highlightTodayRows, 30000);
window.addEventListener("storage", e => { if (e.key === "stavyReklamaci") highlightTodayRows(); });
</script>

<style>
/* 🔴 Efekt blikání dnešních záznamů */
@keyframes blinkToday {
  0% { background-color: #fff0f0; }
  50% { background-color: #ffd6d6; }
  100% { background-color: #fff0f0; }
}
.blink-today {
  animation: blinkToday 1.2s infinite;
}
</style>
<script>
/* 💾 ULOŽENÍ TERMÍNŮ */
function ulozTermin(zaznam) {
  let data = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]");
  const id = zaznam.cislo || zaznam.id;
  data = data.filter(z => z.cislo !== id);
  data.push(zaznam);
  localStorage.setItem("stavyReklamaciData", JSON.stringify(data));
}

/* ⏱️ KOLIZE TERMÍNŮ (2 h rozdíl) */
function checkOverlap(datum, cas) {
  const ulozene = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]");
  const nove = new Date(`${datum}T${cas}`);
  return ulozene.filter(z => {
    if (z.datum !== datum) return false;
    const exist = new Date(`${z.datum}T${z.cas}`);
    const diff = Math.abs((exist - nove) / 36e5);
    return diff < 2;
  });
}

/* 🚗 GEOCACHE (urychlení mapy a plánů) */
async function getCoords(addr) {
  const cache = JSON.parse(localStorage.getItem("geoCache") || "{}");
  if (cache[addr]) return cache[addr];
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
  const data = await res.json();
  if (data[0]) {
    const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    cache[addr] = coords;
    localStorage.setItem("geoCache", JSON.stringify(cache));
    return coords;
  }
  return null;
}

/* ⚠️ DETEKCE KOLIZE při ukládání termínu */
function validateAndSave(item, datum, cas) {
  const kolize = checkOverlap(datum, cas);
  if (kolize.length > 0) {
    const seznam = kolize.map(k => `📍 ${k.adresa} (${k.cas})`).join("\\n");
    const potvrdit = confirm(`⚠️ Termín koliduje s jinými záznamy:\\n\\n${seznam}\\n\\nPřesto uložit?`);
    if (!potvrdit) return false;
  }
  ulozTermin(item);
  return true;
}
</script>
<script>
/* ============================================ */
/* 🔘 OTEVŘENÍ MODALU „PLÁN DNE“ A ZOBRAZENÍ UI */
/* ============================================ */
const planBtn = document.getElementById("planBtn");

planBtn.addEventListener("click", () => {
  const modal = document.getElementById("planModal");
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("active"), 10);

  // Inicializace kalendáře po otevření
  initCalendar();

  // 👇 na mobilu scroll rovnou na kalendář
  if (window.innerWidth < 750) {
    setTimeout(() => {
      document.querySelector("#calendar").scrollIntoView({ behavior: "smooth", block: "center" });
    }, 500);
  }
});

/* ❌ Zavření modalu */
document.getElementById("closeMap").addEventListener("click", () => {
  const modal = document.getElementById("planModal");
  modal.classList.remove("active");
  setTimeout(() => (modal.style.display = "none"), 250);
});
</script>

<style>
/* 📱 Lepší mobilní rozvržení */
@media (max-width: 750px) {
  #planModal .modal-inner {
    width: 96%;
    padding: 15px;
  }
  #calendar {
    order: 1;
  }
  #map {
    order: 2;
  }
  #planList {
    order: 3;
    max-height: none;
  }
}
</style>
<script>
/* =============================== */
/* 📆 Kliknutí na den v kalendáři  */
/* =============================== */
async function showPlanForDay(date) {
  const planList = document.getElementById("planList");
  const terminy = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]")
    .filter(t => t.datum === date);

  planList.innerHTML = "";

  if (!terminy.length) {
    planList.innerHTML = "<div style='color:#777;'>Žádné reklamace pro tento den.</div>";
    if (markersLayer) markersLayer.clearLayers();
    return;
  }

  // 🔁 Map setup
  if (!map) {
    map = L.map("map").setView([50.0755, 14.4378], 9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    routeLayer = L.polyline([], { color: "purple", weight: 4 }).addTo(map);
  }

  const cache = JSON.parse(localStorage.getItem("geoCache") || "{}");
  let coords = [wgsCoords];

  const fetchCoords = async addr => {
    if (cache[addr]) return cache[addr];
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
    const data = await res.json();
    if (data[0]) {
      const c = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      cache[addr] = c;
      localStorage.setItem("geoCache", JSON.stringify(cache));
      return c;
    }
    return null;
  };

  for (const t of terminy) {
    const c = await fetchCoords(t.adresa);
    if (c) coords.push(c);
  }

  markersLayer.clearLayers();
  L.marker(wgsCoords, {
    title: "WGS – Praha 9",
    icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png", iconSize: [28,28], iconAnchor: [14,28] })
  }).addTo(markersLayer).bindPopup("<b>WGS – Praha 9</b>");

  terminy.forEach(t => {
    const c = cache[t.adresa];
    if (c) {
      L.marker(c, {
        icon: L.icon({ iconUrl: "https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png", iconSize: [28,28], iconAnchor: [14,28] })
      }).addTo(markersLayer)
      .bindPopup(`<b>${t.zakaznik || "Zákazník"}</b><br>${t.adresa}<br>${t.produkt || ""}`);
    }
  });

  // 🧭 OSRM trasa
  const coordStr = coords.map(c => c[1] + "," + c[0]).join(";");
  const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson`);
  const data = await res.json();
  const route = data.routes[0];
  if (route) {
    const line = L.geoJSON(route.geometry, { color: "purple", weight: 5 });
    routeLayer.setLatLngs(line.getLatLngs());
    map.fitBounds(line.getBounds());
  }
  setTimeout(() => map.invalidateSize(), 400);

  // 📋 Seznam zákazníků pod mapou
  planList.innerHTML = terminy.map(t => `
    <div>
      <b>${t.zakaznik}</b><br>
      📍 <a href="https://waze.com/ul?q=${encodeURIComponent(t.adresa)}" target="_blank" style="color:#0046ff;font-weight:600;">${t.adresa}</a><br>
      📞 <a href="tel:${t.telefon?.replace("+420","").trim()}" style="color:#0046ff;font-weight:600;">${t.telefon}</a><br>
      🕐 ${t.cas || ""} 🪑 ${t.produkt || ""}
    </div>
  `).join("");

  // 📱 Scroll dolů na mapu a seznam (mobil)
  if (window.innerWidth < 750) {
    setTimeout(() => {
      document.querySelector("#map").scrollIntoView({ behavior: "smooth", block: "start" });
    }, 600);
  }
}
</script>
<script>
/* =============================== */
/* 📄 EXPORT PLÁNU DNE DO PDF      */
/* =============================== */
async function exportPlanToPDF() {
  const { jsPDF } = window.jspdf;
  const selected = document.querySelector(".vanilla-calendar-day__btn_selected");
  if (!selected) return alert("Vyberte den v kalendáři.");
  const date = selected.dataset.calendarDay;

  const terminy = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]")
    .filter(t => t.datum === date);
  if (!terminy.length) return alert("Na tento den není žádný plán.");

  const doc = new jsPDF();
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text(`Plán dne – ${new Date(date).toLocaleDateString("cs-CZ")}`, 14, 18);

  doc.setFontSize(12);
  let y = 30;

  let totalKm = 0;

  for (let i = 0; i < terminy.length; i++) {
    const t = terminy[i];
    const dist = await getDistanceFromWGS(t.adresa);
    totalKm += dist || 0;

    doc.text(`${i+1}. ${t.zakaznik || "Zákazník"} – ${t.adresa || ""}`, 14, y);
    y += 6;
    doc.setFont("helvetica", "normal");
    doc.text(`Model: ${t.produkt || ""} | Tel: ${t.telefon || ""} | Čas: ${t.cas || ""}`, 14, y);
    if (dist) doc.text(`Vzdálenost od WGS: ${dist.toFixed(1)} km`, 14, y + 5);
    y += 12;
  }

  const totalHours = (totalKm / 50).toFixed(1); // přibližný odhad
  doc.setFont("helvetica", "bold");
  doc.text(`Celkem zákazníků: ${terminy.length}`, 14, y + 10);
  doc.text(`Celková trasa: ${totalKm.toFixed(1)} km`, 14, y + 16);
  doc.text(`Odhadovaný čas na cestě: ${totalHours} h`, 14, y + 22);

  doc.save(`Plan_${date}.pdf`);
}

/* 📏 Vzdálenost od WGS (počítaná pomocí OSRM nebo Haversine) */
async function getDistanceFromWGS(address) {
  const wgsCoords = [50.049, 14.523];
  const coords = await getCoords(address);
  if (!coords) return 0;

  try {
    const url = `https://router.project-osrm.org/route/v1/driving/${wgsCoords[1]},${wgsCoords[0]};${coords[1]},${coords[0]}?overview=false`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.routes && data.routes[0]) {
      return data.routes[0].distance / 1000; // v km
    }
  } catch (e) {
    // fallback na výpočet přímé vzdálenosti
    const R = 6371;
    const dLat = (coords[0] - wgsCoords[0]) * Math.PI / 180;
    const dLon = (coords[1] - wgsCoords[1]) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(wgsCoords[0]*Math.PI/180) * Math.cos(coords[0]*Math.PI/180) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }
  return 0;
}
</script>

<style>
/* 🧾 Styl souhrnu pod mapou */
.plan-summary {
  background: #f2f4ff;
  border: 1px solid #ccd5ff;
  border-radius: 10px;
  padding: 10px 14px;
  margin-top: 10px;
  font-size: 0.95em;
  color: #000;
  line-height: 1.5em;
}
</style>
<script>
/* =============================== */
/* 🧮 AUTOMATICKÝ PŘEPOČET TRASY   */
/* =============================== */
async function updatePlanSummary(date) {
  const terminy = JSON.parse(localStorage.getItem("stavyReklamaciData") || "[]")
    .filter(t => t.datum === date);
  if (!terminy.length) return;

  let totalKm = 0;
  for (const t of terminy) {
    const dist = await getDistanceFromWGS(t.adresa);
    totalKm += dist || 0;
  }
  const totalHours = (totalKm / 50).toFixed(1);

  let summaryBox = document.getElementById("planSummary");
  if (!summaryBox) {
    summaryBox = document.createElement("div");
    summaryBox.id = "planSummary";
    summaryBox.className = "plan-summary";
    document.querySelector("#planList").insertAdjacentElement("afterend", summaryBox);
  }
  summaryBox.innerHTML = `
    🚐 <b>Celkem zákazníků:</b> ${terminy.length}<br>
    📏 <b>Trasa celkem:</b> ${totalKm.toFixed(1)} km<br>
    ⏱️ <b>Odhadovaný čas na cestě:</b> ${totalHours} h
  `;
}

/* 📅 Přepočet po výběru dne */
document.addEventListener("click", e => {
  if (e.target.matches(".vanilla-calendar-day__btn")) {
    const d = e.target.dataset.calendarDay;
    if (d) setTimeout(() => updatePlanSummary(d), 1200);
  }
});

/* 🔄 Přepočet po změně termínu (uložení) */
window.addEventListener("storage", e => {
  if (e.key === "stavyReklamaciData") {
    const today = new Date().toISOString().split("T")[0];
    setTimeout(() => updatePlanSummary(today), 1000);
  }
});
</script>
<script>
/* ============================================ */
/* 🧩 FINÁLNÍ STABILIZACE NAČÍTÁNÍ A MAP        */
/* ============================================ */

/* 🔄 Bezpečné načtení mapy – fallback na timeout */
function safeInitMap(targetId, coords = [50.049, 14.523], zoom = 9) {
  try {
    const el = document.getElementById(targetId);
    if (!el) return null;
    const map = L.map(el).setView(coords, zoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
      crossOrigin: true
    }).addTo(map);
    setTimeout(() => map.invalidateSize(), 600);
    return map;
  } catch (e) {
    console.error("⚠️ Chyba při načítání mapy:", e);
    return null;
  }
}

/* 🚨 Pokud je OSRM offline → přímá trasa + výstraha */
async function safeRouteRequest(coordStr) {
  try {
    const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson`);
    if (!res.ok) throw new Error("OSRM server offline");
    const data = await res.json();
    return data.routes?.[0]?.geometry || null;
  } catch (e) {
    console.warn("⚠️ OSRM selhalo, použita přímá trasa:", e.message);
    const coords = coordStr.split(";").map(p => p.split(",").map(Number).reverse());
    return { type: "LineString", coordinates: coords };
  }
}

/* 🧭 Bezpečné zpracování dat o poloze zákazníků */
async function prepareRouteData(terminy) {
  const cache = JSON.parse(localStorage.getItem("geoCache") || "{}");
  const coords = [wgsCoords];
  for (const t of terminy) {
    const c = cache[t.adresa] || await getCoords(t.adresa);
    if (c) coords.push(c);
  }
  return coords;
}

/* 🧹 Automatické čištění zastaralé cache po 7 dnech */
(function cleanCache() {
  const key = "geoCacheLastClean";
  const last = localStorage.getItem(key);
  const now = Date.now();
  if (!last || now - Number(last) > 7 * 24 * 60 * 60 * 1000) {
    console.log("🧹 Čištění geoCache po 7 dnech...");
    localStorage.removeItem("geoCache");
    localStorage.setItem(key, now);
  }
})();
</script>
<script>
/* ============================================ */
/* 🔄 GLOBÁLNÍ KONTROLA A INTEGRACE FUNKCÍ       */
/* ============================================ */

/* 🧩 Po načtení celé stránky */
window.addEventListener("DOMContentLoaded", () => {
  console.log("✅ Seznam reklamací plně inicializován.");

  // Zvýraznit dnešní termíny po načtení
  setTimeout(highlightTodayRows, 500);

  // Ujistit se, že Plán dne modal existuje
  if (!document.getElementById("planModal")) {
    console.warn("⚠️ planModal chybí – přidávám znovu");
    document.body.insertAdjacentHTML("beforeend", planModalHTML);
  }

  // Oprava mapy po otevření modalu
  document.addEventListener("click", e => {
    if (e.target.closest("#planBtn")) {
      setTimeout(() => {
        const mapEl = document.getElementById("map");
        if (mapEl && map) map.invalidateSize();
      }, 600);
    }
  });

  // Automatické obnovení tabulky po změně dat
  window.addEventListener("storage", e => {
    if (["stavyReklamaci", "stavyReklamaciData"].includes(e.key)) {
      console.log("🔁 Detekována změna – aktualizuji seznam");
      setTimeout(loadData, 800);
    }
  });

  // 🩵 Zvukové potvrzení úspěšného načtení
  playNotification();
});

/* 🧠 Ukládání posledního záznamu */
function rememberLastCustomer(item) {
  localStorage.setItem("lastCustomer", JSON.stringify(item));
}
function getLastCustomer() {
  return JSON.parse(localStorage.getItem("lastCustomer") || "null");
}

/* 📡 Prevence duplicitního fetchování */
let fetchInProgress = false;
async function loadDataSafe() {
  if (fetchInProgress) return;
  fetchInProgress = true;
  try {
    await loadData();
  } finally {
    fetchInProgress = false;
  }
}

/* 🔔 Vylepšená notifikace o nových záznamech */
function showBanner(text, color = "#28a745") {
  const banner = document.createElement("div");
  banner.textContent = text;
  Object.assign(banner.style, {
    position: "fixed",
    top: "12px",
    left: "50%",
    transform: "translateX(-50%)",
    background: color,
    color: "#fff",
    padding: "10px 22px",
    borderRadius: "10px",
    boxShadow: "0 4px 8px rgba(0,0,0,0.2)",
    zIndex: "99999",
    fontWeight: "600",
    letterSpacing: "0.3px"
  });
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3200);
}

/* 🔄 Automatické obnovení po 2 min + okamžité zobrazení */
setInterval(loadDataSafe, 120000);
window.addEventListener("focus", () => setTimeout(loadDataSafe, 500));
</script>
