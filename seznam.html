<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seznam reklamací – White Glove Service</title>

<style>
body {
  font-family: "Inter", system-ui, sans-serif;
  background: #f6f7fb;
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}

.wrapper {
  background: #fff;
  padding: 25px;
  margin: 40px 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 1200px;
  position: relative;
  box-sizing: border-box;
}

h1 {
  text-align: center;
  font-size: 2.2em;
  font-weight: 900;
  color: #111;
  margin: 0 0 8px;
}
h2 {
  text-align: center;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  margin: 0 0 25px;
}

.actions {
  text-align: center;
  margin-bottom: 20px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
}

.btn {
  display: inline-block;
  text-decoration: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1em;
  border: none;
  cursor: pointer;
  transition: transform 0.15s ease-in-out, opacity 0.2s;
  color: white;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  min-width: 160px;
}
.btn:hover { transform: scale(1.04); opacity: 0.9; }

.btn-back { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
.btn-refresh { background: linear-gradient(135deg, #0046ff, #357aff); }
.btn-green { background: linear-gradient(135deg, #28a745, #60d06a); }

#search {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1em;
  box-sizing: border-box;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  padding: 10px 8px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 0.95em;
  word-break: break-word;
}
th { background: #f8f8f8; font-weight: 700; }
tr:hover { background: #f1f6ff; cursor: pointer; }

.stav-novy { animation: blikani 1s infinite alternate; background: #fffbe6 !important; }
.stav-domluveno { background: #e7f0ff !important; }
.stav-zruseno { background: #ffeaea !important; }
.stav-nezveda { background: #fff4e1 !important; }

@keyframes blikani {
  from { background-color: #fff3c4; }
  to { background-color: #fffbe6; }
}

@keyframes blinkRed {
  0% { background-color: #ffe0e0; }
  50% { background-color: #ffb3b3; }
  100% { background-color: #ffe0e0; }
}
.blink-today { animation: blinkRed 1.5s infinite; }

@media (max-width: 700px) {
  th, td { font-size: 0.8em; padding: 6px 4px; }
  td { white-space: normal; line-height: 1.3em; }
  .btn { width: 100%; min-width: unset; }
}
</style>
</head>
<body>
<div class="wrapper">
  <h1>WHITE GLOVE SERVICE</h1>
  <h2>Seznam reklamací a servisních požadavků</h2>

  <div class="actions">
    <a href="index.html" class="btn btn-back">Zpět</a>
    <button id="reloadBtn" class="btn btn-refresh">Načíst znovu</button>
    <a href="hotove.html" class="btn btn-green">Hotové reklamace</a>
  </div>

  <input type="text" id="search" placeholder="🔍 Hledat podle jména, adresy nebo zadavatele...">
  <div id="tableContainer" class="loading">Načítám data...</div>
</div>

<script>
const API_URL = "https://wgs-token.72nvwf4pb2.workers.dev/orders";
const tableContainer = document.getElementById("tableContainer");
const searchInput = document.getElementById("search");
const reloadBtn = document.getElementById("reloadBtn");
let dataAll = [];
let stavy = JSON.parse(localStorage.getItem("stavyReklamaci") || "{}");

// 🔹 Zkrácení adresy (Praha 1–10 + odstranění PSČ)
function simplifyAddress(addr) {
  if (!addr) return "";
  let upr = addr;
  if (addr.toLowerCase().includes("hlavní město praha")) {
    const prahaCislo = addr.match(/Praha\s*\d+/i);
    upr = prahaCislo ? prahaCislo[0] : "Praha";
  } else {
    upr = addr.replace(/\d{3}\s?\d{2}$/, "").trim();
  }
  return upr;
}

// 🔹 Načtení dat
async function loadData() {
  tableContainer.innerHTML = "<div class='loading'>Načítám data...</div>";
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error("Chyba při načítání dat");
    const data = await res.json();
    dataAll = data.reverse();
    renderTable(dataAll);
  } catch (err) {
    tableContainer.innerHTML = `<div class='loading' style='color:red;'>Chyba: ${err.message}</div>`;
  }
}

// 🔹 Tabulka
function renderTable(arr) {
  if (!arr.length) {
    tableContainer.innerHTML = "<div class='loading'>Žádné záznamy</div>";
    return;
  }

  let html = `
  <table>
    <thead>
      <tr>
        <th>Zákazník</th>
        <th>Adresa</th>
        <th>Telefon</th>
        <th>Stav</th>
      </tr>
    </thead><tbody>`;

  arr.forEach((r, i) => {
    const id = r.cislo || `radek-${i}`;
    const stav = stavy[id] || "novy";
    const adresa = r.adresa ? `<a href="https://waze.com/ul?q=${encodeURIComponent(r.adresa)}" target="_blank">${simplifyAddress(r.adresa)}</a>` : "";
    const telefon = r.telefon ? `<a href="tel:${r.telefon.replace('+420','').trim()}">${r.telefon.replace('+420','').trim()}</a>` : "";

    html += `
      <tr class="stav-${stav}" data-index="${i}" data-id="${id}">
        <td>${r.zakaznik || r["Jméno a příjmení zákazníka"] || ""}</td>
        <td>${adresa}</td>
        <td>${telefon}</td>
        <td style="font-weight:600;text-transform:capitalize;">${stav}</td>
      </tr>`;
  });

  html += "</tbody></table>";
  tableContainer.innerHTML = html;

  document.querySelectorAll("tbody tr").forEach(row => {
    row.addEventListener("click", () => {
      openDetail(row.dataset.index);
    });
  });
}

// 🔹 Filtrování
searchInput.addEventListener("input", () => {
  const q = searchInput.value.trim().toLowerCase();
  const f = dataAll.filter(r =>
    (r.zakaznik || "").toLowerCase().includes(q) ||
    (r.adresa || "").toLowerCase().includes(q)
  );
  renderTable(f);
});

// 🔹 Načíst znovu
reloadBtn.addEventListener("click", loadData);

// 🔹 Po startu
window.addEventListener("DOMContentLoaded", loadData);
</script>

<script>
// 🔵 Detailní modal
function openDetail(index) {
  const item = dataAll[index];
  if (!item) return;
  const id = item.cislo || `radek-${index}`;

  const overlay = document.createElement("div");
  overlay.className = "detail-overlay";
  overlay.innerHTML = `
  <div class="detail-modal">
    <h2>${item.zakaznik || "Zákazník"}</h2>
    <p><strong>Adresa:</strong> <a href="https://waze.com/ul?q=${encodeURIComponent(item.adresa)}" target="_blank">${item.adresa || "Neuvedeno"}</a></p>
    <p><strong>Telefon:</strong> <a href="tel:${(item.telefon || "").replace("+420","").trim()}">${(item.telefon || "").replace("+420","").trim()}</a></p>
    <p><strong>Email:</strong> ${item.email || "–"}</p>
    <p><strong>Produkt:</strong> ${item.produkt || "–"}</p>
    <p><strong>Popis závady:</strong> ${item.popis || "–"}</p>
    <div class="btn-row">
      <button id="termBtn" class="btn-action btn-blue">🔵 Domluvit termín</button>
      <button id="protoBtn" class="btn-action btn-green">🟢 Přejít na protokol</button>
      <button id="closeBtn" class="btn-action btn-gray">❌ Zavřít</button>
    </div>

    <div id="termSection" class="term-section">
      <h3>Domluvit / Změnit termín</h3>
      <div class="term-center">
        <input type="date" id="datumTerminu" class="term-date" />
        <div class="custom-time-picker">
          <select id="hours"></select><span>:</span><select id="minutes"></select>
        </div>
      </div>
      <div class="btn-row">
        <button id="saveTermBtn" class="btn-action btn-green">🟢 Uložit termín</button>
        <button id="noAnswerBtn" class="btn-action btn-orange">🟠 Nezvedá to</button>
        <button id="cancelBtn" class="btn-action btn-red">🔴 Zákazník zrušil</button>
        <button id="backBtn" class="btn-action btn-gray">↩️ Zpět</button>
      </div>
    </div>
  </div>`;

  document.body.appendChild(overlay);
  setTimeout(() => overlay.classList.add("active"), 10);

  // 🗓️ Po výběru datumu se kalendář zavře
  const dateInput = overlay.querySelector("#datumTerminu");
  dateInput.addEventListener("change", () => dateInput.blur());

  // 🕒 Rolovací hodiny
  const hoursSel = overlay.querySelector("#hours");
  const minsSel = overlay.querySelector("#minutes");
  for (let h = 0; h < 24; h++) {
    const o = document.createElement("option");
    o.value = o.textContent = String(h).padStart(2,"0");
    hoursSel.appendChild(o);
  }
  for (let m = 0; m < 60; m+=5) {
    const o = document.createElement("option");
    o.value = o.textContent = String(m).padStart(2,"0");
    minsSel.appendChild(o);
  }

  overlay.querySelector("#termBtn").onclick = () => overlay.querySelector("#termSection").style.display = "block";
  overlay.querySelector("#backBtn").onclick = () => overlay.querySelector("#termSection").style.display = "none";
  overlay.querySelector("#protoBtn").onclick = () => { localStorage.setItem("selectedRecord", JSON.stringify(item)); window.location.href="protokol.html"; };
  overlay.querySelector("#closeBtn").onclick = close;

  overlay.querySelector("#saveTermBtn").onclick = () => {
    const d = dateInput.value, c = `${hoursSel.value}:${minsSel.value}`;
    if(!d||!c)return alert("Vyplňte datum i čas!");
    stavy[id]="domluveno"; item.datum=d; item.cas=c;
    localStorage.setItem("stavyReklamaci",JSON.stringify(stavy));
    close(); renderTable(dataAll);
  };
  overlay.querySelector("#noAnswerBtn").onclick = () => { stavy[id]="nezveda"; localStorage.setItem("stavyReklamaci",JSON.stringify(stavy)); close(); renderTable(dataAll); };
  overlay.querySelector("#cancelBtn").onclick = () => { stavy[id]="zruseno"; localStorage.setItem("stavyReklamaci",JSON.stringify(stavy)); close(); renderTable(dataAll); };

  function close(){overlay.classList.remove("active");setTimeout(()=>overlay.remove(),250);}
}

// 🔴 Blikání dnešních termínů
function highlightTodayRows(){
  const today=new Date().toISOString().split("T")[0];
  document.querySelectorAll("tbody tr").forEach(row=>{
    const i=row.dataset.index;const it=dataAll[i];
    if(it?.datum===today && stavy[it.cislo||`radek-${i}`]==="domluveno"){
      row.classList.add("blink-today");
    }else row.classList.remove("blink-today");
  });
}
const orig=renderTable;
renderTable=function(a){orig(a);setTimeout(highlightTodayRows,200);}
window.addEventListener("storage",e=>{if(e.key==="stavyReklamaci")setTimeout(highlightTodayRows,300);});
setInterval(highlightTodayRows,30000);
</script>

<style>
.detail-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;opacity:0;transition:.25s;z-index:9999;}
.detail-overlay.active{opacity:1;}
.detail-modal{background:#fff;border-radius:16px;width:80%;max-width:780px;padding:25px 30px;box-shadow:0 10px 25px rgba(0,0,0,.3);overflow-y:auto;max-height:90vh;}
.detail-modal h2{text-align:center;font-size:1.6em;font-weight:800;}
.term-section{display:none;margin-top:20px;padding-top:15px;border-top:1px solid #ddd;}
.term-date{font-size:1.3em;padding:10px 14px;border-radius:10px;border:1px solid #ccc;text-align:center;font-weight:600;}
.custom-time-picker{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:10px;}
.custom-time-picker select{font-size:1.3em;font-weight:600;border-radius:10px;padding:6px 12px;border:1px solid #ccc;}
.btn-row{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin-top:20px;}
.btn-action{flex:1;min-width:150px;padding:10px;border:none;border-radius:8px;font-weight:600;color:white;cursor:pointer;}
.btn-blue{background:linear-gradient(135deg,#007bff,#399bff);}
.btn-green{background:linear-gradient(135deg,#28a745,#6fdd72);}
.btn-gray{background:linear-gradient(135deg,#6c757d,#9ca3af);}
.btn-orange{background:linear-gradient(135deg,#ff9800,#ffc270);color:#222;}
.btn-red{background:linear-gradient(135deg,#dc3545,#f87171);}
@media(max-width:700px){.detail-modal{width:94%;padding:20px;}.btn-row{flex-direction:column;}.btn-action{width:100%;font-size:.95em;}}
</style>
</body>
</html>
