<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nov√° reklamace ‚Äì White Glove Service</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background: #f6f7fb;
      margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: flex-start;
      min-height: 100vh;
    }
    .wrapper {
      background: #fff;
      padding: 30px; margin: 40px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      font-size: 1.9em;
      font-weight: 900;
      color: #111;
      margin-bottom: 4px;
    }
    h2 {
      text-align: center;
      font-size: 1.1em;
      font-weight: 500;
      color: #666;
      margin-top: 0;
      margin-bottom: 30px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
      transition: border-color 0.2s ease-in-out;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #0046ff;
      outline: none;
      box-shadow: 0 0 4px rgba(0,70,255,0.3);
    }
    textarea { min-height: 80px; }

    .row {
      display: flex;
      gap: 20px;
    }
    .row > div { flex: 1; }

    button, .btn {
      background: linear-gradient(135deg, #0046ff, #357aff);
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 25px;
      transition: transform 0.1s ease-in-out, opacity 0.2s;
    }
    button:hover { transform: scale(1.03); opacity: 0.9; }

    .note { color: #666; font-size: 0.9em; margin-top: 5px; }

    /* overlay */
    #overlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.85);
      backdrop-filter:blur(3px);
      justify-content:center;
      align-items:center;
      font-weight:600;
      color:#333;
      z-index:9999;
    }
    #overlay div {
      text-align:center;
    }
    #overlay-spinner {
      border:4px solid #ccc;
      border-top:4px solid #0046ff;
      border-radius:50%;
      width:45px;
      height:45px;
      margin:auto;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Fotky */
    .photo-preview {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .photo-item {
      position:relative;
      width:110px;
      height:110px;
      border:1px solid #ccc;
      border-radius:8px;
      overflow:hidden;
      background:#f8f8f8;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .photo-item img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .photo-remove {
      position:absolute;
      top:4px;
      right:4px;
      background:rgba(255,0,0,0.8);
      color:#fff;
      border:none;
      border-radius:50%;
      width:22px;
      height:22px;
      font-size:14px;
      cursor:pointer;
      line-height:18px;
    }
    .progress-bar {
      position:absolute;
      bottom:0;
      left:0;
      height:5px;
      background:linear-gradient(135deg,#00b36b,#3cd67a);
      width:0%;
      transition:width 0.3s;
    }

    .success-msg {
      background: #dfffe0;
      border-left: 4px solid #3cd67a;
      padding: 10px 15px;
      margin-top: 20px;
      color: #333;
      font-weight: 600;
      display:none;
      border-radius:8px;
    }

    .error-msg {
      background: #ffe0e0;
      border-left: 4px solid #ff3b3b;
      padding: 10px 15px;
      margin-top: 20px;
      color: #333;
      font-weight: 600;
      display:none;
      border-radius:8px;
    }

  </style>
</head>

<body>
<div class="wrapper">
  <h1>WHITE GLOVE SERVICE</h1>
  <h2>Nov√° reklamace</h2>

  <div id="overlay">
    <div>
      <div id="overlay-spinner"></div>
      <p>Naƒç√≠t√°m data‚Ä¶ pros√≠m ƒçekejte</p>
    </div>
  </div>

  <form id="reklForm">
    <label for="typ">Typ po≈æadavku</label>
    <select id="typ" name="typ" required>
      <option value="">-- Vyberte --</option>
      <option value="reklamace">Reklamace</option>
      <option value="servis">Servisn√≠ z√°sah</option>
    </select>

    <label for="contract">Zadavatel / showroom</label>
    <select id="contract" name="contract" required>
      <option value="">-- Vyberte zadavatele --</option>
      <option value="Natuzzi Editions - Strejcek">Natuzzi Editions - Strejcek</option>
      <option value="EXPO CM ƒåern√Ω Most">EXPO CM ƒåern√Ω Most</option>
      <option value="Cassonade Czech">Cassonade Czech</option>
      <option value="Jin√Ω">Jin√Ω zadavatel</option>
    </select>

    <div id="jinyZadavatelBox" style="display:none;">
      <label>Jm√©no jin√©ho zadavatele</label>
      <input type="text" id="jinyJmeno" placeholder="nap≈ô. Jan Nov√°k">
      <label>E-mail jin√©ho zadavatele</label>
      <input type="email" id="jinyEmail" placeholder="nap≈ô. jan.novak@firma.cz">
      <label>Telefon jin√©ho zadavatele</label>
      <input type="tel" id="jinyTelefon" placeholder="+420 777 888 999">
    </div>

    <div class="row">
      <div>
        <label for="zakaznik">Z√°kazn√≠k</label>
        <input type="text" id="zakaznik" placeholder="nap≈ô. Petr Svoboda" required>
      </div>
      <div>
        <label for="telefon">Telefon z√°kazn√≠ka</label>
        <input type="tel" id="telefon" placeholder="+420 123 456 789" required>
      </div>
    </div>

    <label for="email">E-mail z√°kazn√≠ka</label>
    <input type="email" id="email" placeholder="nap≈ô. petr@seznam.cz" required>

    <label for="adresa">Adresa</label>
    <input type="text" id="adresa" placeholder="Ulice, mƒõsto, PSƒå" required>

    <label for="produkt">Produkt / model</label>
    <input type="text" id="produkt" placeholder="nap≈ô. C142, F15, ...">

    <div class="row">
      <div>
        <label for="datum_prodeje">Datum prodeje</label>
        <input type="date" id="datum_prodeje">
      </div>
      <div>
        <label for="datum_reklamace">Datum reklamace</label>
        <input type="date" id="datum_reklamace">
      </div>
    </div>

    <label for="popis">Popis z√°vady / probl√©mu</label>
    <textarea id="popis" placeholder="Popi≈°te struƒçnƒõ probl√©m..." required></textarea>

    <label for="fotky">Fotodokumentace</label>
    <input type="file" id="fotky" multiple accept="image/*">
    <div class="note">Max. rozli≈°en√≠: 800 px, lze p≈ôet√°hnout v√≠ce fotek najednou</div>
    <div class="photo-preview" id="photoPreview"></div>

    <div id="progressInfo" class="note"></div>

    <button type="submit" id="submitBtn">Odeslat reklamaci</button>
    <div class="success-msg" id="successMsg">‚úÖ Reklamace √∫spƒõ≈°nƒõ zalo≈æena a ulo≈æena</div>
    <div class="error-msg" id="errorMsg"></div>
  </form>
</div>
<script>
const WORKER_URL = "https://wgs-token.72nvwf4pb2.workers.dev/orders";

// üéµ zvuk p≈ôi √∫spƒõ≈°n√©m odesl√°n√≠
const successSound = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");

// üì¶ Promƒõnn√©
const form = document.getElementById("reklForm");
const contractSelect = document.getElementById("contract");
const jinyBox = document.getElementById("jinyZadavatelBox");
const overlay = document.getElementById("overlay");
const successMsg = document.getElementById("successMsg");
const errorMsg = document.getElementById("errorMsg");
const photoInput = document.getElementById("fotky");
const photoPreview = document.getElementById("photoPreview");
const progressInfo = document.getElementById("progressInfo");

let resizedFiles = [];

// üß≠ zobraz/skryj jin√©ho zadavatele
contractSelect.addEventListener("change", () => {
  jinyBox.style.display = contractSelect.value === "Jin√Ω" ? "block" : "none";
});

// üì∑ zmen≈°en√≠ obr√°zk≈Ø p≈ôed uploadem
photoInput.addEventListener("change", async (e) => {
  const files = Array.from(e.target.files);
  photoPreview.innerHTML = "";
  resizedFiles = [];

  for (const file of files) {
    const preview = document.createElement("div");
    preview.className = "photo-item";
    const img = document.createElement("img");
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "√ó";
    removeBtn.className = "photo-remove";
    const bar = document.createElement("div");
    bar.className = "progress-bar";

    preview.appendChild(img);
    preview.appendChild(removeBtn);
    preview.appendChild(bar);
    photoPreview.appendChild(preview);

    // ƒçten√≠ obr√°zku
    const reader = new FileReader();
    reader.onload = async (ev) => {
      const image = new Image();
      image.src = ev.target.result;
      await new Promise(res => image.onload = res);
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const maxSize = 800;
      let width = image.width;
      let height = image.height;

      if (width > height) {
        if (width > maxSize) {
          height *= maxSize / width;
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width *= maxSize / height;
          height = maxSize;
        }
      }
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(image, 0, 0, width, height);

      const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.85));
      const resizedFile = new File([blob], file.name, { type: "image/jpeg" });
      img.src = URL.createObjectURL(resizedFile);
      resizedFiles.push({ file: resizedFile, bar });
      updateProgressText();

      removeBtn.onclick = () => {
        preview.remove();
        resizedFiles = resizedFiles.filter(f => f.file !== resizedFile);
        updateProgressText();
      };
    };
    reader.readAsDataURL(file);
  }
});

function updateProgressText() {
  progressInfo.textContent = resizedFiles.length
    ? `Vybr√°no ${resizedFiles.length} fotografi√≠`
    : "";
}

// üß© Validace pol√≠
function validateForm() {
  const required = ["typ","contract","zakaznik","telefon","email","adresa","popis"];
  for (const id of required) {
    const el = document.getElementById(id);
    if (!el.value.trim()) {
      showError(`Pole ‚Äû${id}‚Äú mus√≠ b√Ωt vyplnƒõno.`);
      el.focus();
      return false;
    }
  }

  const email = document.getElementById("email").value.trim();
  if (!email.includes("@") || email.includes(" ")) {
    showError("Zadejte platn√Ω e-mail ve form√°tu jmeno@domena.cz");
    return false;
  }

  const telefon = document.getElementById("telefon").value.trim();
  if (!/^[\d+\s]+$/.test(telefon)) {
    showError("Telefon m≈Ø≈æe obsahovat jen ƒç√≠sla, mezery a +420");
    return false;
  }

  const zakazaneZnaky = /[#%&*<>"'\\/]/;
  for (const id of required) {
    const val = document.getElementById(id).value;
    if (zakazaneZnaky.test(val)) {
      showError(`Pole ‚Äû${id}‚Äú obsahuje nepovolen√© znaky.`);
      return false;
    }
  }

  return true;
}

function showError(msg) {
  errorMsg.style.display = "block";
  errorMsg.textContent = "‚ùå " + msg;
  successMsg.style.display = "none";
  overlay.style.display = "none";
}

function showOverlay(show = true, text = "Naƒç√≠t√°m data‚Ä¶ pros√≠m ƒçekejte") {
  overlay.style.display = show ? "flex" : "none";
  overlay.querySelector("p").textContent = text;
}
// üì§ Odesl√°n√≠ formul√°≈ôe
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!validateForm()) return;

  overlay.style.display = "flex";
  showOverlay(true, "Odes√≠l√°m reklamaci‚Ä¶");

  try {
    // --- 1Ô∏è‚É£ Nahraj fotky ---
    const uploadedNames = [];
    for (const { file, bar } of resizedFiles) {
      const formData = new FormData();
      formData.append("file", file);

      const uploadRes = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/upload", {
        method: "POST",
        body: formData
      });

      if (!uploadRes.ok) {
        showError("Chyba p≈ôi nahr√°v√°n√≠ fotografi√≠");
        return;
      }

      const result = await uploadRes.json();
      uploadedNames.push(result.filename);

      // animace progress baru
      for (let i = 0; i <= 100; i += 5) {
        bar.style.width = i + "%";
        await new Promise(res => setTimeout(res, 15));
      }
    }

    // --- 2Ô∏è‚É£ Vytvo≈ô JSON dat reklamace ---
    const data = {
      typ: document.getElementById("typ").value,
      contract: document.getElementById("contract").value,
      cislo: document.getElementById("cislo").value,
      zakaznik: document.getElementById("zakaznik").value,
      adresa: document.getElementById("adresa").value,
      telefon: document.getElementById("telefon").value,
      email: document.getElementById("email").value,
      produkt: document.getElementById("produkt").value,
      datum_prodeje: document.getElementById("datum_prodeje").value,
      datum_reklamace: document.getElementById("datum_reklamace").value,
      popis: document.getElementById("popis").value,
      fotky: uploadedNames,
      jinaZadavatel: contractSelect.value === "Jin√Ω" ? {
        jmeno: document.getElementById("jiny_jmeno").value,
        email: document.getElementById("jiny_email").value,
        telefon: document.getElementById("jiny_telefon").value
      } : null
    };

    // --- 3Ô∏è‚É£ Z√°pis do Workeru ---
    const saveRes = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const saveResult = await saveRes.json();

    if (!saveResult.ok) {
      showError("Chyba p≈ôi ukl√°d√°n√≠ dat: " + (saveResult.error || ""));
      return;
    }

    // --- ‚úÖ Hotovo ---
    successMsg.style.display = "block";
    successMsg.textContent = "‚úÖ Reklamace √∫spƒõ≈°nƒõ zalo≈æena a ulo≈æena do syst√©mu.";
    errorMsg.style.display = "none";
    overlay.style.display = "none";
    successSound.play();

    form.reset();
    photoPreview.innerHTML = "";
    resizedFiles = [];
    progressInfo.textContent = "";
    window.scrollTo({ top: 0, behavior: "smooth" });

  } catch (err) {
    showError("Chyba p≈ôi odes√≠l√°n√≠: " + err.message);
  } finally {
    overlay.style.display = "none";
  }
});
</script>

</body>
</html>
