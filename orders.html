<!doctype html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WHITE GLOVE SERVICE ‚Äì Nov√° reklamace</title>
<style>
:root { font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
body { margin:0; padding:20px; background:#f6f7fb; }
h1 { text-align:center; font-size:2em; font-weight:900; margin:0 0 10px; }
h2 { text-align:center; font-size:1.1em; font-weight:600; margin:0 0 20px; color:#555; }

form {
  background:white; max-width:700px; margin:0 auto; padding:20px;
  border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1);
}
label { display:block; margin-top:10px; font-weight:600; }
input, textarea, select {
  width:100%; padding:10px; margin-top:4px;
  border:1px solid #ccc; border-radius:8px; font-size:15px;
}
textarea { min-height:80px; resize:vertical; }
button {
  display:block; width:100%; margin-top:20px;
  padding:12px; font-size:1em; font-weight:600; color:#fff;
  border:none; border-radius:8px; cursor:pointer;
  background:linear-gradient(135deg,#0046ff,#357aff);
  transition:opacity .2s;
}
button:hover { opacity:.9; }

#suggestions {
  position:absolute; background:#fff; border:1px solid #ddd; border-radius:6px;
  max-height:200px; overflow:auto; z-index:10; width:calc(100% - 22px);
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
.suggestion { padding:8px; cursor:pointer; }
.suggestion:hover { background:#eef3ff; }

.preview {
  display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
}
.preview img {
  max-width:100px; border-radius:6px; border:1px solid #ddd;
}
</style>
</head>
<body>

<h1>WHITE GLOVE SERVICE</h1>
<h2>Nov√° reklamace</h2>

<form id="reklForm">
  <label>ƒå√≠slo objedn√°vky</label>
  <input type="text" id="objednavka" required>

  <label>Z√°kazn√≠k</label>
  <input type="text" id="zakaznik" required>

  <label>Adresa</label>
  <div style="position:relative;">
    <input type="text" id="adresa" autocomplete="off" placeholder="Zaƒçni ps√°t ulici nebo mƒõsto..." required>
    <div id="suggestions"></div>
  </div>

  <label>Telefon</label>
  <input type="text" id="telefon" pattern="[0-9 +]{9,20}" required>

  <label>E-mail</label>
  <input type="email" id="email" required>

  <label>Popis z√°vady</label>
  <textarea id="popis" placeholder="Popi≈° zji≈°tƒõnou z√°vadu..." required></textarea>

  <label>Fotky (max. 3 soubory)</label>
  <input type="file" id="fotky" accept="image/*" multiple>
  <div class="preview" id="preview"></div>

  <button type="submit">üíæ Ulo≈æit reklamaci</button>
</form>

<script>
const GITHUB_USER = "radecek222-boop";
const REPO = "reklamace";
const TOKEN = "TV≈ÆJ_TOKEN";  // ‚ö†Ô∏è vlo≈æ sv≈Øj GitHub token
const ORDERS_FILE = "orders.json";

// üß© Mapy.cz API ‚Äì na≈°ept√°v√°n√≠ adres
const input = document.getElementById("adresa");
const box = document.getElementById("suggestions");
let timeout;
input.addEventListener("input", e => {
  clearTimeout(timeout);
  const q = e.target.value.trim();
  if (q.length < 3) { box.innerHTML=""; return; }
  timeout = setTimeout(async () => {
    try {
      const res = await fetch(`https://api.mapy.cz/geocode?query=${encodeURIComponent(q)}&format=json`);
      const data = await res.json();
      const list = data.result?.items || [];
      if (!list.length) { box.innerHTML=""; return; }
      box.innerHTML = list.map(i =>
        `<div class="suggestion" data-full="${i.name}">${i.name}</div>`
      ).join("");
    } catch { box.innerHTML=""; }
  }, 300);
});
box.addEventListener("click", e => {
  const el = e.target.closest(".suggestion");
  if (!el) return;
  input.value = el.dataset.full;
  box.innerHTML = "";
});
document.addEventListener("click", e => {
  if (!box.contains(e.target) && e.target !== input) box.innerHTML = "";
});

// üì∏ N√°hled fotek
const fotkyInput = document.getElementById("fotky");
const previewBox = document.getElementById("preview");
fotkyInput.addEventListener("change", () => {
  previewBox.innerHTML = "";
  Array.from(fotkyInput.files).slice(0,3).forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    previewBox.appendChild(img);
  });
});

// üíæ Ulo≈æen√≠ reklamace
document.getElementById("reklForm").addEventListener("submit", async e => {
  e.preventDefault();
  const form = e.target;

  const newItem = {
    "ƒå√≠slo objedn√°vky": form.objednavka.value.trim(),
    "ƒå√≠slo reklamace": "NBU-" + Date.now().toString().slice(-7),
    "Z√°kazn√≠k": form.zakaznik.value.trim(),
    "Adresa": form.adresa.value.trim(),
    "Telefon": form.telefon.value.trim(),
    "Email": form.email.value.trim(),
    "Popis CZ": form.popis.value.trim(),
    "Stav": "Nov√° reklamace",
    "Vy≈ôe≈°eno": "NE",
    "Datum pod√°n√≠ reklamace": new Date().toISOString().split("T")[0]
  };

  // ‚¨ÜÔ∏è Nahr√°t fotky do /uploads/
  const uploadedUrls = [];
  const files = Array.from(fotkyInput.files).slice(0,3);
  for (let i=0;i<files.length;i++){
    const url = await uploadFile(files[i]);
    uploadedUrls.push(url);
    newItem[`Foto${i+1}`] = url;
  }

  // ‚¨áÔ∏è Ulo≈æit do orders.json
  try {
    const res = await fetch(`https://raw.githubusercontent.com/${GITHUB_USER}/${REPO}/main/${ORDERS_FILE}?${Date.now()}`);
    const data = await res.json().catch(()=>[]);
    data.push(newItem);
    await updateFile(ORDERS_FILE, JSON.stringify(data, null, 2));
    alert("Reklamace byla √∫spƒõ≈°nƒõ ulo≈æena.");
    form.reset(); previewBox.innerHTML = "";
  } catch (err) {
    alert("Chyba p≈ôi ukl√°d√°n√≠: " + err.message);
  }
});

// üóÇÔ∏è Upload souboru do GitHub /uploads/
async function uploadFile(file){
  const reader = new FileReader();
  return new Promise((resolve,reject)=>{
    reader.onload = async ()=>{
      const base64 = reader.result.split(",")[1];
      const path = `uploads/${Date.now()}_${file.name}`;
      const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${path}`, {
        method:"PUT",
        headers:{
          Authorization:`token ${TOKEN}`,
          "Content-Type":"application/json"
        },
        body:JSON.stringify({
          message:`Nahr√°na fotka ${file.name}`,
          content:base64
        })
      });
      if(res.ok) resolve(`https://raw.githubusercontent.com/${GITHUB_USER}/${REPO}/main/${path}`);
      else reject("Chyba nahr√°v√°n√≠ obr√°zku");
    };
    reader.readAsDataURL(file);
  });
}

// ‚úèÔ∏è Update orders.json
async function updateFile(filename, content){
  const metaRes = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${filename}`, {
    headers: { Authorization:`token ${TOKEN}` }
  });
  const meta = await metaRes.json();
  await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${filename}`, {
    method:"PUT",
    headers:{
      Authorization:`token ${TOKEN}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      message:`P≈ôid√°na nov√° reklamace do ${filename}`,
      content:btoa(unescape(encodeURIComponent(content))),
      sha:meta.sha
    })
  });
}
</script>
</body>
</html>
