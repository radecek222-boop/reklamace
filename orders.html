<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WHITE GLOVE SERVICE ‚Äì Nov√° reklamace</title>
  <style>
    :root { font-family: "Inter", system-ui, sans-serif; color: #111; }
    body { margin: 0; padding: 20px; background: #f6f7fb; }
    .wrapper {
      max-width: 900px; margin: auto; background: #fff;
      border-radius: 16px; padding: 25px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    h1 { text-align: center; font-size: 1.8em; font-weight: 900; margin: 0; }
    h2 { text-align: center; font-size: 1em; font-weight: 500; color: #666; margin-bottom: 25px; }
    label { display: block; margin-top: 12px; font-weight: 600; color: #333; }
    input, textarea {
      width: 100%; padding: 10px; margin-top: 6px;
      border: 1px solid #ccc; border-radius: 8px;
      font-family: inherit; font-size: 15px; box-sizing: border-box;
    }
    textarea { resize: vertical; min-height: 80px; }
    input:invalid, textarea:invalid { border-color: #d9534f; background: #fff6f6; }
    input[type="file"] { border: none; }
    .buttons {
      margin-top: 25px; display: flex; flex-wrap: wrap;
      gap: 10px; justify-content: center;
    }
    .btn {
      border: none; color: white; padding: 10px 25px;
      border-radius: 12px; font-size: 15px;
      cursor: pointer; font-weight: 600; transition: 0.2s;
    }
    .btn-submit { background: linear-gradient(135deg, #5a8dee, #7b42f6); }
    .btn-back { background: linear-gradient(135deg, #9e9e9e, #6c757d); }
    .message { margin-top: 20px; font-weight: 600; text-align: center; color: #28a745; display: none; }
    .preview { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
    .preview img {
      width: 120px; height: 120px; object-fit: cover;
      border-radius: 8px; border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<div class="wrapper">
  <h1>Nov√° reklamace</h1>
  <h2>Formul√°≈ô pro zad√°n√≠ nov√©ho p≈ô√≠padu</h2>

  <form id="orderForm" novalidate>
    <label>ƒå√≠slo reklamace / ƒç√≠slo objedn√°vky:</label>
    <input type="text" name="cislo_reklamace" required placeholder="nap≈ô. R2025-001 / NBU26-000145">

    <label>Z√°kazn√≠k:</label>
    <input type="text" name="zakaznik" required>

    <label>Adresa:</label>
    <input type="text" name="adresa" required>

    <label>Telefon:</label>
    <input type="text" name="telefon" required>

    <label>E-mail:</label>
    <input type="email" name="email" required>

    <label>Znaƒçka:</label>
    <input type="text" name="znacka" required>

    <label>Model / N√°zev produktu:</label>
    <input type="text" name="model" required>

    <label>Datum n√°kupu:</label>
    <input type="date" name="datum_nakupu" required>

    <label>Popis z√°vady:</label>
    <textarea name="popis" placeholder="Popi≈°te z√°vadu nebo probl√©m" required></textarea>

    <label>P≈ôilo≈æit fotografie (max. 3):</label>
    <input type="file" id="photos" name="photos" accept="image/*" multiple>

    <div class="preview" id="preview"></div>

    <div class="buttons">
      <button type="button" class="btn btn-back" onclick="window.location.href='index.html'">Zpƒõt na hlavn√≠ str√°nku</button>
      <button type="submit" class="btn btn-submit">Odeslat reklamaci</button>
    </div>
  </form>

  <div class="message" id="message">Reklamace byla √∫spƒõ≈°nƒõ odesl√°na ‚úÖ</div>
</div>
<script>
  /*******************************************************
   üîë SEM VLO≈Ω NOV√ù TOKEN (mezi uvozovky n√≠≈æe)
   ‚ö†Ô∏è Pouze pro intern√≠ testov√°n√≠ ‚Äì nikdy neve≈ôejnƒõ!
  *******************************************************/
  const GITHUB_TOKEN = "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";

  const USERNAME = "radecek222";
  const REPO = "radecek222-boop";
  const FILE_PATH = "orders.json";

  const form = document.getElementById("orderForm");
  const preview = document.getElementById("preview");
  const message = document.getElementById("message");
  const photosInput = document.getElementById("photos");

  let photoFiles = [];

  // n√°hled fotek
  photosInput.addEventListener("change", () => {
    preview.innerHTML = "";
    photoFiles = Array.from(photosInput.files).slice(0, 3);
    photoFiles.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement("img");
        img.src = e.target.result;
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });

  // odesl√°n√≠ formul√°≈ôe
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = Object.fromEntries(new FormData(form).entries());
    if (Object.values(data).some(v => !v.trim())) {
      alert("Vypl≈à pros√≠m v≈°echna povinn√° pole.");
      return;
    }

    const now = new Date();
    data.id = "REQ-" + now.getTime();
    data.datum_podani_reklamace = now.toLocaleDateString("cs-CZ");
    data.fotky = [];

    // naƒçten√≠ orders.json
    const apiUrl = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${FILE_PATH}`;
    const res = await fetch(apiUrl, {
      headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    const file = await res.json();
    const oldData = file.content ? JSON.parse(atob(file.content)) : [];

    // upload fotek (max. 3)
    for (const fileObj of photoFiles) {
      const base64 = await toBase64(fileObj);
      const path = `uploads/${data.id}/${fileObj.name}`;
      await uploadFileToGitHub(path, base64, fileObj.name);
      data.fotky.push(path);
    }

    // p≈ôid√°n√≠ nov√© reklamace
    oldData.push(data);
    const newContent = btoa(JSON.stringify(oldData, null, 2));

    // z√°pis do GitHubu
    const update = await fetch(apiUrl, {
      method: "PUT",
      headers: {
        "Authorization": `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Nov√° reklamace od ${data.zakaznik}`,
        content: newContent,
        sha: file.sha
      })
    });

    if (update.ok) {
      message.style.display = "block";
      form.reset();
      preview.innerHTML = "";
      setTimeout(() => message.style.display = "none", 4000);
    } else {
      alert("Chyba p≈ôi z√°pisu do GitHubu. Zkontroluj token nebo opr√°vnƒõn√≠.");
    }
  });

  // p≈ôevod souboru na Base64
  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(",")[1]);
      reader.onerror = reject;
    });
  }

  // nahr√°n√≠ souboru na GitHub
  async function uploadFileToGitHub(path, base64, name) {
    const url = `https://api.github.com/repos/${USERNAME}/${REPO}/contents/${path}`;
    const upload = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Upload fotografie ${name}`,
        content: base64
      })
    });
    if (!upload.ok) console.error("Chyba p≈ôi nahr√°v√°n√≠ obr√°zku:", name);
  }
</script>

</body>
</html>
