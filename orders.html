<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nov√° reklamace ‚Äì White Glove Service</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{font-family:"Inter",system-ui,sans-serif;background:#f6f7fb;margin:0;padding:0;display:flex;justify-content:center;align-items:flex-start;min-height:100vh}
    .wrapper{background:#fff;padding:30px;margin:40px 15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);width:100%;max-width:700px;box-sizing:border-box}
    h1,h2{text-align:center;margin:0 0 20px}
    h1{font-size:2.6em;font-weight:900;color:#111}
    h2{font-size:1.2em;font-weight:500;color:#666;margin-bottom:25px}
    label{display:block;font-weight:600;margin-top:15px;margin-bottom:5px}
    input,textarea,select{width:100%;padding:10px;font-size:1em;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;transition:border .2s}
    textarea{height:100px;resize:vertical}
    .btn{display:inline-block;padding:12px 28px;border-radius:8px;font-weight:600;font-size:1em;border:none;cursor:pointer;color:#fff;box-shadow:0 3px 8px rgba(0,0,0,.15);transition:transform .15s,opacity .2s;min-width:140px}
    .btn:hover{transform:scale(1.04);opacity:.9}
    .btn-back{background:linear-gradient(135deg,#6c757d,#a0a4a7)}
    .btn-send{background:linear-gradient(135deg,#0046ff,#357aff)}
    .actions{text-align:center;margin-top:25px;display:flex;justify-content:center;gap:20px;flex-wrap:wrap}
    .preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .preview-item{width:90px;height:90px;position:relative;border-radius:8px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .preview-item img{width:100%;height:100%;object-fit:cover}
    .progress-bar{position:absolute;bottom:0;left:0;height:6px;background:linear-gradient(90deg,#ffb300,#ff9800);width:0%;transition:width .4s}
    .address-wrapper{position:relative}
    .suggestions{position:absolute;top:100%;left:0;width:100%;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 4px 10px rgba(0,0,0,.1);max-height:180px;overflow-y:auto;z-index:1000}
    .suggestions div{padding:8px;cursor:pointer}
    .suggestions div:hover{background:#f0f0f0}
    #mapPreview{width:100%;height:250px;margin-top:10px;border-radius:14px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.1);transition:height .3s}
    .wait-overlay{display:none;position:fixed;inset:0;background:rgba(255,255,255,.85);backdrop-filter:blur(2px);justify-content:center;align-items:center;z-index:2000;flex-direction:column;font-weight:600;color:#333}
    .wait-overlay.active{display:flex}
    .hourglass{border:4px solid #ccc;border-top:4px solid #0046ff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-bottom:10px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .success-check{display:none;position:fixed;inset:0;justify-content:center;align-items:center;background:rgba(255,255,255,.9);z-index:2100}
    .success-check.active{display:flex}
    .checkmark{width:80px;height:80px;stroke-width:3;stroke:url(#grad1);fill:none;stroke-dasharray:48;stroke-dashoffset:48;animation:draw 1s ease forwards}
    @keyframes draw{to{stroke-dashoffset:0}}
    @media(max-width:600px){#mapPreview{height:180px}.wrapper{padding:20px;margin:20px 10px}h1{font-size:2em}.preview-item{width:80px;height:80px}}
  </style>
</head>

<body>
<div class="wrapper">
  <h1>WHITE GLOVE SERVICE</h1><h2>Nov√° reklamace</h2>
  <form id="reklamaceForm" novalidate>
    <label>ƒå√≠slo reklamace / objedn√°vky:</label><input type="text" name="cislo" required>
    <label>Z√°kazn√≠k:</label><input type="text" name="zakaznik" required>
    <label>Ulice a ƒç√≠slo popisn√©:</label>
    <div class="address-wrapper">
      <input type="text" id="ulice" name="ulice" required placeholder="nap≈ô. Vinohradsk√° 120">
      <div id="suggestions" class="suggestions"></div>
    </div>
    <div id="mapPreview"></div>
    <label>Mƒõsto:</label><input type="text" id="mesto" name="mesto" required>
    <label>PSƒå:</label><input type="text" id="psc" name="psc" required pattern="\\d{3}\\s?\\d{2}">
    <label>Telefon:</label>
    <div style="display:flex;gap:8px;">
      <select id="predvolba" style="max-width:130px;"><option value="+420">üá®üáø +420</option><option value="+421">üá∏üá∞ +421</option><option value="+43">üá¶üáπ +43</option></select>
      <input type="tel" id="telefon" name="telefon" required placeholder="nap≈ô. 777123456">
    </div>
    <label>E-mail:</label><input type="email" id="email" name="email" required placeholder="nap≈ô. info@firma.cz">
    <label>Model / N√°zev produktu:</label><input type="text" name="produkt" required>
    <label>Datum prodeje:</label><input type="date" name="datum_prodeje" required>
    <label>Datum reklamace:</label><input type="date" name="datum_reklamace" required>
    <label>Popis z√°vady:</label><textarea name="popis" required></textarea>
    <label>P≈ôilo≈æit fotografie (max. 5):</label>
    <small>Podporovan√© form√°ty: JPG, PNG, HEIC (max. 5 MB / soubor)</small>
    <input type="file" id="fotky" accept="image/jpeg,image/png,image/heic" multiple>
    <div id="preview" class="preview"></div>
    <div class="actions"><a href="index.html" class="btn btn-back">Zpƒõt</a><button type="submit" class="btn btn-send">Odeslat</button></div>
  </form>
</div>

<div class="wait-overlay" id="waitOverlay"><div class="hourglass"></div><p>Pros√≠m ƒçekejte...</p></div>
<div class="success-check" id="successCheck">
  <svg class="checkmark" viewBox="0 0 52 52">
    <defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00d084"/><stop offset="100%" style="stop-color:#00a86b"/>
    </linearGradient></defs>
    <circle cx="26" cy="26" r="25" fill="none"/><path fill="none" d="M14 27l7 7 16-16" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>

<script>
/* ---------- GEOAPIFY + NOMINATIM ---------- */
const u=document.getElementById("ulice"),m=document.getElementById("mesto"),p=document.getElementById("psc"),sug=document.getElementById("suggestions");
let adresaOK=false;const api="b363199bb14e47189558d03b81ca9ba1";
u.addEventListener("input",async()=>{
  const q=u.value.trim();adresaOK=false;sug.innerHTML="";if(q.length<3)return;
  sug.innerHTML="<div style='padding:8px;color:#888'>Naƒç√≠t√°m‚Ä¶</div>";
  try{
    let r=await fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(q)}&filter=countrycode:cze,svk,aut&limit=5&lang=cs&apiKey=${api}`);
    if(!r.ok)throw 0;let d=await r.json();if(!d.features?.length)throw 1;
    render(d.features.map(f=>f.properties));
  }catch{
    try{
      let r2=await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=cz,sk,at&limit=5&q=${encodeURIComponent(q)}`);
      let d2=await r2.json();if(!d2.length){sug.innerHTML="<div style='padding:8px;color:#777'>≈Ω√°dn√© v√Ωsledky</div>";return;}
      render(d2.map(p=>({formatted:p.display_name,street:p.address.road,housenumber:p.address.house_number,city:p.address.city||p.address.town||p.address.village,postcode:p.address.postcode,lat:p.lat,lon:p.lon})));
    }catch{sug.innerHTML="<div style='padding:8px;color:red'>Chyba naƒç√≠t√°n√≠</div>";}
  }
});
function render(arr){
  sug.innerHTML="";arr.forEach(p=>{
    const d=document.createElement("div");d.textContent=p.formatted;
    d.onclick=()=>{
      u.value=`${p.street||""} ${p.housenumber||""}`;m.value=p.city||"";p.value=p.postcode||"";p.value=p.postcode||"";p.value=p.postcode||"";
      psc.value=p.postcode||"";adresaOK=true;sug.innerHTML="";
      const mapDiv=document.getElementById("mapPreview");mapDiv.innerHTML="";
      const lat=+p.lat,lon=+p.lon;const map=L.map(mapDiv,{center:[lat,lon],zoom:16,zoomControl:false,attributionControl:false});
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);L.marker([lat,lon]).addTo(map);setTimeout(()=>map.invalidateSize(),200);
    };
    sug.append(d);
  });
}
document.addEventListener("click",e=>{if(!sug.contains(e.target)&&e.target!==u)sug.innerHTML="";});

/* ---------- FOTO KOMPRESE + PREVIEW ---------- */
const fIn=document.getElementById("fotky"),prev=document.getElementById("preview");let files=[];
async function compress(file,max=1,dim=1280){
  const img=await createImageBitmap(file);const c=document.createElement("canvas");let[w,h]=[img.width,img.height];
  if(w>h&&w>dim){h*=dim/w;w=dim;}else if(h>dim){w*=dim/h;h=dim;}
  c.width=w;c.height=h;c.getContext("2d").drawImage(img,0,0,w,h);
  let q=.9,b=await new Promise(r=>c.toBlob(r,"image/jpeg",q));
  while(b.size/1024/1024>max&&q>.4){q-=.1;b=await new Promise(r=>c.toBlob(r,"image/jpeg",q));}
  return b;
}
fIn.addEventListener("change",async()=>{
  prev.innerHTML="";files=[];
  const arr=Array.from(fIn.files).slice(0,5);
  for(const f of arr){
    if(!f.type.startsWith("image/"))continue;
    const item=document.createElement("div");item.className="preview-item";
    const img=document.createElement("img");const bar=document.createElement("div");bar.className="progress-bar";
    item.append(bar);prev.append(item);
    const r=new FileReader();r.onload=e=>{img.src=e.target.result;item.append(img)};r.readAsDataURL(f);
    const blob=await compress(f);files.push({name:f.name,blob,bar});
    let w=0;const t=setInterval(()=>{w+=10;bar.style.width=w+"%";if(w>=100)clearInterval(t);},40);
  }
});

/* ---------- ZVUK + FAJFKA ---------- */
function sound(){try{const a=new(window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.type="sine";o.frequency.value=880;g.gain.value=.1;o.connect(g);g.connect(a.destination);o.start();o.stop(a.currentTime+.25);}catch{}}
function done(){sound();document.getElementById("waitOverlay").classList.remove("active");const s=document.getElementById("successCheck");s.classList.add("active");setTimeout(()=>location.href="index.html",2500);}

/* ---------- GITHUB UPLOAD ---------- */
async function upFile(owner,repo,path,blob,msg,token){
  const b64=await new Promise(r=>{const R=new FileReader();R.onloadend=()=>r(R.result.split(",")[1]);R.readAsDataURL(blob);});
  const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{method:"PUT",headers:{"Authorization":`token ${token}`,"Accept":"application/vnd.github.v3+json","Content-Type":"application/json"},body:JSON.stringify({message:msg,content:b64,branch:"main"})});
  if(!r.ok)throw new Error(await r.text());
}
async function upJSON(obj,owner,repo,path,msg,token){
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const r=await fetch(url,{headers:{"Authorization":`token ${token}`,"Accept":"application/vnd.github.v3+json"}});
  let c="[]",sha=null;if(r.ok){const j=await r.json();c=atob(j.content.replace(/\n/g,""));sha=j.sha;}
  const arr=JSON.parse(c);arr.push(obj);
  const newC=btoa(unescape(encodeURIComponent(JSON.stringify(arr,null,2))));
  const body={message:msg,content:newC,branch:"main"};if(sha)body.sha=sha;
  const p=await fetch(url,{method:"PUT",headers:{"Authorization":`token ${token}`,"Accept":"application/vnd.github.v3+json","Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!p.ok)throw new Error(await p.text());
}

/* ---------- SUBMIT ---------- */
document.getElementById("reklamaceForm").addEventListener("submit",async e=>{
  e.preventDefault();document.getElementById("waitOverlay").classList.add("active");
  const f=e.target;const token=prompt("Zadej GitHub token:");
  const data={typ:"reklamace",contract:"Nov√Ω z√°znam",cislo:f.cislo.value.trim().toUpperCase(),zakaznik:f.zakaznik.value,adresa:`${f.ulice.value}, ${f.mesto.value}, ${f.psc.value}`,telefon:f.telefon.value,email:f.email.value,produkt:f.produkt.value,datum_prodeje:f.datum_prodeje.value,datum_reklamace:f.datum_reklamace.value,popis:f.popis.value,fotky:[]};
  try{
    for(const fch of files){
      const safe=`${data.cislo}_${fch.name.replace(/\s+/g,"_")}`;
      await upFile("radecek222-boop","reklamace",`foto/${safe}`,fch.blob,`Foto ${data.cislo}`,token);
      data.fotky.push(safe);fch.bar.style.background="linear-gradient(90deg,#4caf50,#8bc34a)";
    }
    await upJSON(data,"radecek222-boop","reklamace","orders.json",`Nov√° reklamace ${data.cislo}`,token);
    done();f.reset();
  }catch(err){
    document.getElementById("waitOverlay").classList.remove("active");
    alert("Chyba: "+err.message);
  }
});
</script>
</body>
</html>
