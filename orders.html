<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nov√° reklamace ‚Äì White Glove Service</title>

  <!-- üìç Leaflet mapa -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- üìÖ Vanilla Calendar (lok√°ln√≠ verze) -->
  <link rel="stylesheet" href="vanilla-calendar.min.css">
  <script src="vanilla-calendar.min.js"></script>

  <style>
    body {
      font-family: "Inter", system-ui, sans-serif;
      background: #f6f7fb;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .wrapper {
      background: #fff;
      padding: 30px;
      margin: 40px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 700px;
      box-sizing: border-box;
    }
    h1, h2 { text-align: center; margin: 0 0 20px; }
    h1 { font-size: 2.6em; font-weight: 900; color: #111; }
    h2 { font-size: 1.2em; font-weight: 500; color: #666; margin-bottom: 25px; }

    label { display: block; font-weight: 600; margin-top: 15px; margin-bottom: 5px; }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      transition: border 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #0046ff; outline: none;
    }
    textarea { height: 100px; resize: vertical; }
    small { font-size: 0.8em; color: #666; }

    .invalid {
      border: 2px solid;
      border-image: linear-gradient(45deg, #ff4d4d, #ff7b7b) 1;
    }

    .btn {
      display: inline-block;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1em;
      transition: transform 0.15s ease-in-out, opacity 0.2s;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    .btn:hover { transform: scale(1.04); opacity: 0.9; }
    .btn-back { background: linear-gradient(135deg, #6c757d, #a0a4a7); }
    .btn-send { background: linear-gradient(135deg, #0046ff, #357aff); }

    .actions {
      text-align: center;
      margin-top: 25px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <h1>WHITE GLOVE SERVICE</h1>
    <h2>Nov√° reklamace</h2>

    <form id="reklamaceForm" novalidate>







            <!-- üì¶ ADRESA + MAPA -->
      <label>ƒå√≠slo reklamace / objedn√°vky:</label>
      <input type="text" name="cislo" required placeholder="nap≈ô. NBU25" />

      <label>Z√°kazn√≠k:</label>
      <input type="text" name="zakaznik" required placeholder="nap≈ô. Ji≈ô√≠ Nov√°k" />

      <label>Ulice a ƒç√≠slo popisn√©:</label>
      <div class="address-wrapper">
        <input type="text" id="ulice" name="ulice" required placeholder="nap≈ô. Vinohradsk√° 120" />
        <div id="suggestions" class="suggestions"></div>
      </div>
      <div id="mapPreview"></div>

      <label>Mƒõsto:</label>
      <input type="text" id="mesto" name="mesto" required placeholder="nap≈ô. Praha" />

      <label>PSƒå:</label>
      <input type="text" id="psc" name="psc" required pattern="\\d{3}\\s?\\d{2}" placeholder="nap≈ô. 110 00" />

      <style>
        /* üß≠ Mapov√Ω n√°hled */
        .address-wrapper { position: relative; }
        .suggestions {
          position: absolute; top: 100%; left: 0; width: 100%;
          background: #fff; border: 1px solid #ccc;
          border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
          max-height: 180px; overflow-y: auto; z-index: 1000;
        }
        .suggestions div { padding: 8px; cursor: pointer; }
        .suggestions div:hover { background: #f0f0f0; }

        #mapPreview {
          width: 100%;
          height: 250px;
          margin-top: 10px;
          border-radius: 14px;
          overflow: hidden;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
      </style>

      <script>
      // üåç Geoapify + mapa
      const uliceInput = document.getElementById("ulice");
      const mestoInput = document.getElementById("mesto");
      const suggestionContainer = document.getElementById("suggestions");
      let adresaPlatna = false;
      const GEOAPIFY_KEY = "b363199bb14e47189558d03b81ca9ba1";
      let suggestTimer = null;

      uliceInput.addEventListener("input", () => {
        clearTimeout(suggestTimer);
        suggestTimer = setTimeout(runAutocomplete, 300);
      });

      async function runAutocomplete() {
        const query = uliceInput.value.trim();
        adresaPlatna = false;
        suggestionContainer.innerHTML = "";
        if (query.length < 3) return;

        try {
          const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&lang=cs&limit=5&filter=countrycode:cze,svk,aut&apiKey=${GEOAPIFY_KEY}`;
          const res = await fetch(url);
          const data = await res.json();
          if (!data.features || !data.features.length) throw new Error();
          renderSuggestions(data.features.map(f => f.properties));
        } catch {
          try {
            const url2 = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=cz,sk,at&limit=5&q=${encodeURIComponent(query)}`;
            const res2 = await fetch(url2, { headers: { "Accept-Language": "cs" } });
            const data2 = await res2.json();
            if (data2.length)
              renderSuggestions(data2.map(n => ({
                formatted: n.display_name,
                street: n.address?.road,
                housenumber: n.address?.house_number,
                city: n.address?.city || n.address?.town || n.address?.village,
                postcode: n.address?.postcode,
                lat: n.lat,
                lon: n.lon
              })));
          } catch {
            suggestionContainer.innerHTML = "<div style='padding:8px;color:red'>Chyba naƒç√≠t√°n√≠</div>";
          }
        }
      }

      function renderSuggestions(items) {
        suggestionContainer.innerHTML = "";
        items.forEach(p => {
          const div = document.createElement("div");
          div.textContent = p.formatted || p.label;
          div.onclick = () => {
            uliceInput.value = `${p.street || ""} ${p.housenumber || ""}`.trim();
            mestoInput.value = p.city || "";
            document.getElementById("psc").value = p.postcode || "";
            adresaPlatna = true;
            suggestionContainer.innerHTML = "";

            const mapDiv = document.getElementById("mapPreview");
            mapDiv.innerHTML = "";
            const map = L.map(mapDiv, { center: [p.lat, p.lon], zoom: 16, zoomControl: false, attributionControl: false });
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
            L.marker([p.lat, p.lon]).addTo(map);
            setTimeout(() => map.invalidateSize(), 300);
          };
          suggestionContainer.appendChild(div);
        });
      }
      document.addEventListener("click", e => {
        if (!suggestionContainer.contains(e.target) && e.target !== uliceInput)
          suggestionContainer.innerHTML = "";
      });
      </script>





            <!-- üóìÔ∏è V√ùBƒöR DAT (PRODEJ / REKLAMACE) -->
      <div class="calendar-row">
        <div class="calendar-box">
          <label>Datum prodeje:</label>
          <input type="hidden" id="datum_prodeje" name="datum_prodeje" required />
          <button type="button" id="btnProdej" class="banner-btn">üìÖ Vyber datum prodeje</button>
        </div>

        <div class="calendar-box">
          <label>Datum reklamace:</label>
          <input type="hidden" id="datum_reklamace" name="datum_reklamace" required />
          <button type="button" id="btnReklamace" class="banner-btn">üìÖ Vyber datum reklamace</button>
        </div>
      </div>

      <!-- ü™ü MOD√ÅL KALEND√Å≈òE -->
      <div id="calendarModal" class="calendar-modal">
        <div class="calendar-content">
          <div id="vanillaCalendar"></div>
          <button id="closeCalendar" type="button" class="btn btn-back" style="margin-top:15px;width:100%">Zav≈ô√≠t</button>
        </div>
      </div>

      <style>
        /* üìÖ Bannery pro datum */
        .calendar-row {
          display: flex;
          justify-content: space-between;
          gap: 20px;
          flex-wrap: wrap;
          margin-top: 10px;
        }
        .calendar-box {
          flex: 1;
          min-width: 250px;
        }
        .banner-btn {
          display: block;
          width: 100%;
          padding: 14px;
          border-radius: 8px;
          font-weight: 600;
          font-size: 1em;
          text-align: center;
          border: 1px solid #ccc;
          background: linear-gradient(135deg, #f2f2f2, #dbdbdb);
          color: #111;
          cursor: pointer;
          transition: all 0.25s ease;
        }
        .banner-btn:hover {
          background: linear-gradient(135deg, #e9e9e9, #d0d0d0);
        }
      </style>

      <script>
      // üóìÔ∏è Inicializace mod√°ln√≠ho kalend√°≈ôe
      document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("calendarModal");
        const closeBtn = document.getElementById("closeCalendar");
        let targetInput = null;
        let targetButton = null;

        // ‚úÖ tlaƒç√≠tka nikdy nespust√≠ submit
        document.getElementById("btnProdej").setAttribute("type", "button");
        document.getElementById("btnReklamace").setAttribute("type", "button");
        closeBtn.setAttribute("type", "button");

        const calendar = new VanillaCalendar("#vanillaCalendar", {
          settings: { lang: "cs", selection: { day: "single" }, visibility: { theme: "light" } },
          actions: {
            clickDay: (e) => {
              const chosen = e.target.dataset.calendarDay;
              if (chosen && targetInput && targetButton) {
                targetInput.value = chosen;
                targetButton.textContent = chosen;
                modal.classList.remove("active"); // zav≈ôe po v√Ωbƒõru
              }
            }
          }
        });
        calendar.init();

        document.getElementById("btnProdej").addEventListener("click", (ev) => {
          ev.preventDefault();
          targetInput = document.getElementById("datum_prodeje");
          targetButton = document.getElementById("btnProdej");
          modal.classList.add("active");
        });

        document.getElementById("btnReklamace").addEventListener("click", (ev) => {
          ev.preventDefault();
          targetInput = document.getElementById("datum_reklamace");
          targetButton = document.getElementById("btnReklamace");
          modal.classList.add("active");
        });

        closeBtn.addEventListener("click", () => modal.classList.remove("active"));
      });
      </script>






            <!-- üßæ POPIS Z√ÅVADY -->
      <label>Popis z√°vady:</label>
      <textarea name="popis" required placeholder="Popi≈°te z√°vadu nebo probl√©m..."></textarea>

      <!-- üßç‚Äç‚ôÇÔ∏è ZADAVATEL -->
      <label>Objedn√°vku zpracoval:</label>
      <select id="zpracoval" name="zpracoval" required>
        <option value="">Vyber...</option>
        <option value="Natuzzi Editions - Strejcek">Natuzzi Editions ‚Äì Strejcek</option>
        <option value="Natuzzi Editions - Vimrova">Natuzzi Editions ‚Äì Vimrova</option>
        <option value="Natuzzi Italia - Bratislava">Natuzzi Italia ‚Äì Bratislava</option>
        <option value="Natuzzi Italia - Jama">Natuzzi Italia ‚Äì Jama</option>
        <option value="Natuzzi Italia - SOHO">Natuzzi Italia ‚Äì SOHO</option>
        <option value="Softaly - SOHO">Softaly ‚Äì SOHO</option>
        <option value="Phase - Klucarova">Phase ‚Äì Klucarova</option>
        <option value="Phase - Jancova">Phase ‚Äì Jancova</option>
        <option value="Jin√°">Jin√°</option>
      </select>

      <div id="jinaSekce" class="smooth" style="display:none;">
        <label>Zadej nov√Ω z√°pis zadavatele:</label>
        <input type="text" id="jinaJmeno" name="jinaJmeno" placeholder="Jm√©no zadavatele" />
        <label>E-mail zadavatele:</label>
        <input type="email" id="jinaEmail" name="jinaEmail" placeholder="nap≈ô. zadavatel@firma.cz" />
        <label>Telefon zadavatele:</label>
        <input type="tel" id="jinaTelefon" name="jinaTelefon" placeholder="nap≈ô. 777123456" />
      </div>

      <script>
      // üîπ Sekce ‚ÄûJin√°‚Äú ‚Äì zobraz√≠ se jen po v√Ωbƒõru mo≈ænosti
      const selectZpracoval = document.getElementById("zpracoval");
      const jinaSekce = document.getElementById("jinaSekce");

      selectZpracoval.addEventListener("change", () => {
        if (selectZpracoval.value === "Jin√°") {
          jinaSekce.style.display = "block";
        } else {
          jinaSekce.style.display = "none";
        }
      });
      </script>





            <!-- üì∏ NAHR√ÅV√ÅN√ç FOTEK (BANNER + MOD√ÅL) -->
      <div class="photo-upload-banner">
        <button id="openPhotoUpload" type="button" class="banner-btn">
          üì∑ Nahr√°t fotografie (0 / 6)
        </button>
      </div>

      <!-- ü™ü MOD√ÅL PRO NAHR√ÅV√ÅN√ç FOTEK -->
      <div id="photoModal" class="photo-modal">
        <div class="photo-modal-content">
          <h3>Nahr√°v√°n√≠ fotografi√≠</h3>
          <p>M≈Ø≈æete nahr√°t a≈æ <strong>6 fotografi√≠</strong> ve form√°tu JPG, PNG nebo HEIC.<br>
          Ka≈æd√° fotografie bude automaticky zmen≈°ena na max. 800√ó533 px a max. 500 KB.</p>

          <div class="photo-actions">
            <input type="file" id="photoInput" accept="image/jpeg,image/png,image/heic" multiple hidden>
            <button id="selectPhotosBtn" type="button" class="banner-btn">üìÇ Vyber fotky</button>
            <button id="uploadPhotosBtn" type="button" class="banner-btn" disabled>‚¨ÜÔ∏è Nahr√°t fotografie</button>
          </div>

          <div id="photoPreview" class="photo-preview"></div>

          <button id="closePhotoModal" type="button" class="btn btn-back" style="margin-top:15px;width:100%">Zav≈ô√≠t</button>
        </div>
      </div>

      <style>
        /* ü™ü MODAL ‚Äì fotky */
        .photo-modal {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.6);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
        }
        .photo-modal.active { display: flex; }
        .photo-modal-content {
          background: #fff;
          padding: 25px;
          border-radius: 12px;
          box-shadow: 0 6px 20px rgba(0,0,0,0.3);
          width: 90%;
          max-width: 500px;
          text-align: center;
          animation: fadeIn .25s ease;
        }
        @keyframes fadeIn {
          from { opacity:0; transform:scale(0.9); }
          to { opacity:1; transform:scale(1); }
        }

        /* üì∏ N√°hledy fotek */
        .photo-preview {
          display:flex;
          flex-wrap:wrap;
          justify-content:center;
          gap:12px;
          margin-top:15px;
        }
        .photo-item {
          position:relative;
          width:90px;
          height:90px;
          border-radius:10px;
          overflow:hidden;
          box-shadow:0 2px 6px rgba(0,0,0,0.15);
        }
        .photo-item img {
          width:100%;
          height:100%;
          object-fit:cover;
          border-radius:10px;
        }
        .photo-remove {
          position:absolute;
          top:4px;
          right:4px;
          background:rgba(255,255,255,0.85);
          border:none;
          border-radius:50%;
          width:20px;
          height:20px;
          font-weight:bold;
          color:#f00;
          cursor:pointer;
        }

        /* ‚è≥ Koleƒçko pr≈Øbƒõhu */
        .loader-ring {
          position:absolute;
          top:calc(50% - 18px);
          left:calc(50% - 18px);
          width:36px;
          height:36px;
          border:3px solid #ccc;
          border-top:3px solid #0046ff;
          border-radius:50%;
          animation:spin 1s linear infinite;
        }
        @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }

        .progress-text {
          position:absolute;
          bottom:6px;
          left:0;
          width:100%;
          font-size:0.75em;
          font-weight:600;
          text-align:center;
          color:#333;
        }

        /* ‚úÖ Fajfka */
        .checkmark-photo {
          position:absolute;
          top:calc(50% - 20px);
          left:calc(50% - 20px);
          width:40px;
          height:40px;
          stroke-width:3;
          stroke:#00a86b;
          fill:none;
          stroke-dasharray:48;
          stroke-dashoffset:48;
          animation:draw 1s ease forwards;
        }
        @keyframes draw { to { stroke-dashoffset: 0; } }
      </style>

      <script>
      const openPhotoUpload = document.getElementById("openPhotoUpload");
      const photoModal = document.getElementById("photoModal");
      const closePhotoModal = document.getElementById("closePhotoModal");
      const selectPhotosBtn = document.getElementById("selectPhotosBtn");
      const uploadPhotosBtn = document.getElementById("uploadPhotosBtn");
      const photoInput = document.getElementById("photoInput");
      const photoPreview = document.getElementById("photoPreview");

      window.uploadedPhotos = [];
      let selectedPhotos = [];

      // üü¢ Otev≈ô√≠t mod√°ln√≠ okno
      openPhotoUpload.addEventListener("click", e => {
        e.preventDefault();
        photoModal.classList.add("active");
      });

      // üî¥ Zav≈ô√≠t mod√°ln√≠ okno
      closePhotoModal.addEventListener("click", e => {
        e.preventDefault();
        photoModal.classList.remove("active");
      });

      // üìÇ Vybrat fotky
      selectPhotosBtn.addEventListener("click", e => {
        e.preventDefault();
        photoInput.click();
      });

      photoInput.addEventListener("change", async () => {
        const files = Array.from(photoInput.files).slice(0, 6);
        selectedPhotos = files;
        renderPhotoPreview();
      });

      // üñºÔ∏è N√°hledy miniatur
      function renderPhotoPreview() {
        photoPreview.innerHTML = "";
        selectedPhotos.forEach((file, idx) => {
          const item = document.createElement("div");
          item.className = "photo-item";

          const img = document.createElement("img");
          const reader = new FileReader();
          reader.onload = e => img.src = e.target.result;
          reader.readAsDataURL(file);

          const remove = document.createElement("button");
          remove.className = "photo-remove";
          remove.textContent = "√ó";
          remove.onclick = () => {
            selectedPhotos.splice(idx, 1);
            renderPhotoPreview();
          };

          item.appendChild(img);
          item.appendChild(remove);
          photoPreview.appendChild(item);
        });

        uploadPhotosBtn.disabled = selectedPhotos.length === 0;
        openPhotoUpload.textContent = `üì∑ Vybr√°no (${selectedPhotos.length} / 6)`;
      }
      </script>






            <script>
      // üß© Funkce pro kompresi obr√°zk≈Ø (do max 800 px, max 500 KB)
      async function compressImage(file, maxDim = 800, maxSizeKB = 500) {
        const img = await createImageBitmap(file);
        let { width, height } = img;
        if (width > height && width > maxDim) {
          height = Math.round(height * (maxDim / width));
          width = maxDim;
        } else if (height > maxDim) {
          width = Math.round(width * (maxDim / height));
          height = maxDim;
        }

        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        let quality = 0.9;
        let blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", quality));
        while (blob.size / 1024 > maxSizeKB && quality > 0.4) {
          quality -= 0.1;
          blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", quality));
        }
        return blob;
      }

      // üü¢ Upload fotek na server (Worker)
      uploadPhotosBtn.addEventListener("click", async e => {
        e.preventDefault();
        if (!selectedPhotos.length) return;

        uploadPhotosBtn.disabled = true;
        photoPreview.innerHTML = "";

        for (const [idx, file] of selectedPhotos.entries()) {
          const item = document.createElement("div");
          item.className = "photo-item";
          const img = document.createElement("img");
          const reader = new FileReader();
          reader.onload = e => (img.src = e.target.result);
          reader.readAsDataURL(file);

          const loader = document.createElement("div");
          loader.className = "loader-ring";
          const percent = document.createElement("div");
          percent.className = "progress-text";
          percent.textContent = "0%";

          item.append(img, loader, percent);
          photoPreview.appendChild(item);

          try {
            const blob = await compressImage(file);
            const formData = new FormData();
            formData.append("file", blob, file.name);

            // simulace procent pr≈Øbƒõhu (pomal√© zobrazen√≠)
            for (let i = 10; i <= 90; i += 10) {
              await new Promise(r => setTimeout(r, 150));
              percent.textContent = `${i}%`;
            }

            const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/upload", {
              method: "POST",
              body: formData
            });
            const json = await res.json();
            window.uploadedPhotos.push(json.filename);

            percent.textContent = "100%";
            loader.remove();

            const check = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            check.setAttribute("class", "checkmark-photo");
            check.setAttribute("viewBox", "0 0 52 52");
            check.innerHTML = `<path fill="none" stroke-linecap="round" stroke-linejoin="round" d="M14 27l7 7 16-16"/>`;
            item.appendChild(check);
          } catch (err) {
            percent.textContent = "‚ùå Chyba";
            console.error("Upload error:", err);
          }
        }

        uploadPhotosBtn.disabled = false;
        openPhotoUpload.textContent = `üì∑ Vybr√°no (${window.uploadedPhotos.length} / 6)`;
      });
      </script>






            <!-- üíæ OVERLAY NAƒå√çT√ÅN√ç -->
      <div class="wait-overlay" id="waitOverlay">
        <div class="hourglass"></div>
        <p>Pros√≠m ƒçekejte‚Ä¶</p>
      </div>

      <!-- ‚úÖ HOTOVO ANIMACE -->
      <div class="success-check" id="successCheck">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#00d084;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#00a86b;stop-opacity:1" />
            </linearGradient>
          </defs>
          <circle cx="26" cy="26" r="25" fill="none"/>
          <path fill="none" d="M14 27l7 7 16-16" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>

      <script>
      // üíæ ODESL√ÅN√ç DAT NA WORKER
      const reklamaceForm = document.getElementById("reklamaceForm");
      const waitOverlay = document.getElementById("waitOverlay");
      const successCheck = document.getElementById("successCheck");

      reklamaceForm.addEventListener("submit", async e => {
        e.preventDefault();
        waitOverlay.classList.add("active");

        const f = e.target;
        const dataObj = {
          typ: "reklamace",
          contract: f.zpracoval.value,
          cislo: f.cislo.value.trim().toUpperCase(),
          zakaznik: f.zakaznik.value,
          adresa: `${f.ulice.value}, ${f.mesto.value}, ${f.psc.value}`,
          telefon: `${document.getElementById("predvolba").value} ${f.telefon.value}`,
          email: f.email.value,
          produkt: f.produkt.value,
          datum_prodeje: f.datum_prodeje.value,
          datum_reklamace: f.datum_reklamace.value,
          popis: f.popis.value,
          fotky: window.uploadedPhotos || [],
          jinaZadavatel: f.jinaJmeno?.value || null,
          jinaEmail: f.jinaEmail?.value || null,
          jinaTelefon: f.jinaTelefon?.value || null,
          stav: "novy"
        };

        try {
          const res = await fetch("https://wgs-token.72nvwf4pb2.workers.dev/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataObj)
          });

          const json = await res.json();
          console.log("üì§ Odesl√°no:", json);

          waitOverlay.classList.remove("active");
          successCheck.classList.add("active");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 2500);

        } catch (err) {
          waitOverlay.classList.remove("active");
          alert("Chyba p≈ôi odes√≠l√°n√≠: " + err.message);
          console.error(err);
        }
      });
      </script>






            <!-- üìÖ BANNERY PRO KALEND√Å≈ò -->
      <div class="calendar-row">
        <div class="calendar-box">
          <label>Datum prodeje:</label>
          <input type="hidden" id="datum_prodeje" name="datum_prodeje" required />
          <button type="button" id="btnProdej" class="banner-btn">üìÜ Vyber datum prodeje</button>
        </div>

        <div class="calendar-box">
          <label>Datum reklamace:</label>
          <input type="hidden" id="datum_reklamace" name="datum_reklamace" required />
          <button type="button" id="btnReklamace" class="banner-btn">üìÜ Vyber datum reklamace</button>
        </div>
      </div>

      <!-- ü™ü MOD√ÅL PRO KALEND√Å≈ò -->
      <div id="calendarModal" class="calendar-modal">
        <div class="calendar-content">
          <h3>Vyberte datum</h3>
          <div id="vanillaCalendar"></div>
          <button id="closeCalendar" class="btn btn-back" style="margin-top:15px;width:100%">Zav≈ô√≠t</button>
        </div>
      </div>

      <style>
        /* üé® ≈†ed√© gradientn√≠ bannery */
        .banner-btn {
          display: block;
          width: 100%;
          padding: 14px;
          border-radius: 8px;
          font-size: 1em;
          font-weight: 600;
          background: linear-gradient(135deg, #e2e3e5, #f8f9fa);
          border: 1px solid #ccc;
          color: #111;
          cursor: pointer;
          text-align: center;
          transition: all 0.2s ease-in-out;
        }
        .banner-btn:hover {
          background: linear-gradient(135deg, #d7d8da, #f0f0f0);
        }

        /* ü™ü Modal kalend√°≈ôe */
        .calendar-modal {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.55);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
          opacity: 0;
          transition: opacity 0.25s ease;
        }
        .calendar-modal.active { display:flex; opacity: 1; }

        .calendar-content {
          background: #fff;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.25);
          animation: popIn 0.25s ease;
        }
        @keyframes popIn {
          from { transform:scale(0.9); opacity:0; }
          to { transform:scale(1); opacity:1; }
        }
      </style>

      <script>
      // üóìÔ∏è MOD√ÅLN√ç KALEND√Å≈ò
      document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("calendarModal");
        const closeBtn = document.getElementById("closeCalendar");
        const calendarEl = document.getElementById("vanillaCalendar");
        let targetInput = null;
        let targetButton = null;

        const calendar = new VanillaCalendar("#vanillaCalendar", {
          settings: {
            lang: "cs",
            selection: { day: "single" },
            visibility: { theme: "light" }
          },
          actions: {
            clickDay: (e) => {
              const chosen = e.target.dataset.calendarDay;
              if (chosen && targetInput && targetButton) {
                targetInput.value = chosen;
                targetButton.textContent = `üìÜ ${chosen}`;
                modal.classList.remove("active");
              }
            }
          }
        });
        calendar.init();

        document.getElementById("btnProdej").addEventListener("click", () => {
          targetInput = document.getElementById("datum_prodeje");
          targetButton = document.getElementById("btnProdej");
          modal.classList.add("active");
        });

        document.getElementById("btnReklamace").addEventListener("click", () => {
          targetInput = document.getElementById("datum_reklamace");
          targetButton = document.getElementById("btnReklamace");
          modal.classList.add("active");
        });

        closeBtn.addEventListener("click", () => modal.classList.remove("active"));
      });
      </script>





            <script>
      // üîß VALIDACE POL√ç
      const telefonInput = document.getElementById("telefon");
      const predvolba = document.getElementById("predvolba");
      const emailInput = document.getElementById("email");
      const pscInput = document.getElementById("psc");

      function validateTelefon() {
        return /^[0-9]{8,12}$/.test(telefonInput.value.trim());
      }
      function validateEmail() {
        return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailInput.value.trim());
      }
      function validatePSC() {
        return /^\d{3}\s?\d{2}$/.test(pscInput.value.trim());
      }

      // üîπ SEKC√ç ‚ÄûJIN√Å‚Äú
      const selectZpracoval = document.getElementById("zpracoval");
      const jinaSekce = document.getElementById("jinaSekce");
      const jinaInputs = jinaSekce.querySelectorAll("input");

      jinaSekce.style.display = "none";
      jinaInputs.forEach(i => i.required = false);

      selectZpracoval.addEventListener("change", () => {
        if (selectZpracoval.value === "Jin√°") {
          jinaSekce.style.display = "block";
          jinaInputs.forEach(i => i.required = true);
        } else {
          jinaSekce.style.display = "none";
          jinaInputs.forEach(i => i.required = false);
        }
      });

      // üåç GEOAPIFY ‚Äì MAPA ADRESY
      const uliceInput = document.getElementById("ulice");
      const mestoInput = document.getElementById("mesto");
      const suggestionContainer = document.getElementById("suggestions");
      let adresaPlatna = false;
      const GEOAPIFY_KEY = "b363199bb14e47189558d03b81ca9ba1";
      let suggestTimer = null;

      uliceInput.addEventListener("input", () => {
        clearTimeout(suggestTimer);
        suggestTimer = setTimeout(runAutocomplete, 300);
      });

      async function runAutocomplete() {
        const query = uliceInput.value.trim();
        adresaPlatna = false;
        suggestionContainer.innerHTML = "";
        if (query.length < 3) return;

        try {
          const url = `https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(query)}&lang=cs&limit=5&filter=countrycode:cze,svk,aut&apiKey=${GEOAPIFY_KEY}`;
          const res = await fetch(url);
          const data = await res.json();
          if (!data.features || !data.features.length) throw new Error();
          renderSuggestions(data.features.map(f => f.properties));
        } catch {
          try {
            const url2 = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&countrycodes=cz,sk,at&limit=5&q=${encodeURIComponent(query)}`;
            const res2 = await fetch(url2, { headers: { "Accept-Language": "cs" } });
            const data2 = await res2.json();
            if (data2.length)
              renderSuggestions(
                data2.map(n => ({
                  formatted: n.display_name,
                  street: n.address?.road,
                  housenumber: n.address?.house_number,
                  city: n.address?.city || n.address?.town || n.address?.village,
                  postcode: n.address?.postcode,
                  lat: n.lat,
                  lon: n.lon
                }))
              );
          } catch {
            suggestionContainer.innerHTML = "<div style='padding:8px;color:red'>Chyba naƒç√≠t√°n√≠</div>";
          }
        }
      }

      function renderSuggestions(items) {
        suggestionContainer.innerHTML = "";
        items.forEach(p => {
          const div = document.createElement("div");
          div.textContent = p.formatted || p.label;
          div.onclick = () => {
            uliceInput.value = `${p.street || ""} ${p.housenumber || ""}`.trim();
            mestoInput.value = p.city || "";
            pscInput.value = p.postcode || "";
            adresaPlatna = true;
            suggestionContainer.innerHTML = "";

            const mapDiv = document.getElementById("mapPreview");
            mapDiv.innerHTML = "";
            const map = L.map(mapDiv, {
              center: [p.lat, p.lon],
              zoom: 16,
              zoomControl: false,
              attributionControl: false
            });
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
            L.marker([p.lat, p.lon]).addTo(map);
            setTimeout(() => map.invalidateSize(), 300);
          };
          suggestionContainer.appendChild(div);
        });
      }

      document.addEventListener("click", e => {
        if (!suggestionContainer.contains(e.target) && e.target !== uliceInput)
          suggestionContainer.innerHTML = "";
      });
      </script>
    </div>
  </body>
</html>
